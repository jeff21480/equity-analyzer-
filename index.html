    <!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Equity Analyzer</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <link rel="icon" href="./icons/icon-192.png">

  <!-- STYLES WILL CONTINUE IN NEXT PARTS -->
  <style>
    :root{
      --bg0:#070a16;
      --bg1:#0b1230;
      --card:#0e1a3f;
      --stroke:rgba(255,255,255,.18);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --accent:#6d5efc;
      --accent2:#22d3ee;
      --radius:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 12% 8%, rgba(109,94,252,.35), transparent 60%),
        radial-gradient(900px 520px at 85% 18%, rgba(34,211,238,.25), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:18px 14px 40px;
    }
  </style>
</head>

<body>

  <!-- APP WRAPPER START -->
  <div class="wrap">

    <!-- CONTENT CONTINUES IN PART 2 --><!-- HEADER -->
    <div class="topbar">
      <div class="brand">
        <div class="title" id="ui_appTitle">Equity Analyzer</div>
        <div class="subtitle" id="ui_sub">Multi-Model Fair Value • Watchlist • Guide</div>
      </div>

      <div class="controls">

        <div class="pill">
          <div class="plbl">
            <span id="ui_langLbl">Language</span>
            <button class="hint" type="button" data-help="lang" aria-label="Language info">i</button>
          </div>
          <select id="langSel">
            <option value="en" selected>English</option>
            <option value="cz">Čeština</option>
          </select>
        </div>

        <div class="pill">
          <div class="plbl">
            <span id="ui_modeLbl">Mode</span>
            <button class="hint" type="button" data-help="mode" aria-label="Mode info">i</button>
          </div>
          <select id="modeSel">
            <option value="quick" selected>Quick</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>

        <div class="pill">
          <div class="plbl">
            <span id="ui_currLbl">Currency</span>
            <button class="hint" type="button" data-help="currency" aria-label="Currency info">i</button>
          </div>
          <select id="curSel">
            <option value="USD" selected>USD</option>
            <option value="EUR">EUR</option>
            <option value="CZK">CZK</option>
          </select>
        </div>

        <div class="pill">
          <div class="plbl">
            <span id="ui_mosLbl">Margin of Safety</span>
            <button class="hint" type="button" data-help="mos" aria-label="Margin of Safety info">i</button>
          </div>
          <select id="mosSel">
            <option value="off" selected>Off</option>
            <option value="10">10%</option>
            <option value="20">20%</option>
            <option value="30">30%</option>
          </select>
        </div>

      </div>
    </div>

    <div class="muted" id="ui_decimalTip" style="padding:0 6px 10px;">
      Tip: Use dot or comma for decimals (e.g., 5.5 or 5,5). You can also type 10k / 2.5m / 3b. Spaces are ignored.
    </div>

    <!-- ACCORDION WILL CONTINUE IN PART 3 --><!-- PART 3: STYLES + ACCORDION SKELETON -->
    <style>
      /* Header layout */
      .topbar{
        display:flex;
        gap:14px;
        align-items:flex-start;
        justify-content:space-between;
        flex-wrap:wrap;
        padding: 10px 6px 14px;
      }
      .brand{ display:flex; flex-direction:column; gap:6px; min-width: 280px; }
      .title{
        font-size: 38px;
        line-height: 1.05;
        font-weight: 900;
        letter-spacing: .3px;
        background: linear-gradient(90deg, #ffffff, #c7d2fe 35%, #a5b4fc 60%, #67e8f9 95%);
        -webkit-background-clip:text;
        background-clip:text;
        color: transparent;
        text-shadow: 0 0 24px rgba(109,94,252,.20);
      }
      .subtitle{ color: var(--muted); font-size: 13.5px; letter-spacing: .2px; }

      .controls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        justify-content:flex-end;
        align-items:flex-end;
      }

      .pill{
        border:1px solid rgba(255,255,255,.22);
        background: rgba(255,255,255,.06);
        border-radius: 16px;
        padding: 10px 12px;
        min-width: 160px;
        box-shadow: 0 10px 28px rgba(0,0,0,.24);
        backdrop-filter: blur(8px);
      }

      .plbl{
        font-size:12px;
        color: var(--muted);
        margin-bottom: 6px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }

      select{
        width:100%;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.18);
        color: var(--text);
        border-radius: 14px;
        padding: 10px 10px;
        outline:none;
        font-size: 14px;
      }

      /* Hint button */
      .hint{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        width: 22px; height: 22px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.22);
        background: rgba(255,255,255,.07);
        color: rgba(255,255,255,.92);
        font-size: 12px;
        cursor:pointer;
        padding:0;
      }

      /* Accordion */
      .accordion{ margin-top: 12px; }

      .acc{
        border:1px solid rgba(255,255,255,.22);
        border-radius: var(--radius);
        overflow:hidden;
        background: rgba(255,255,255,.04);
        box-shadow: 0 16px 44px rgba(0,0,0,.38);
        margin-top: 12px;
      }

      .acc .head{
        cursor:pointer;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:14px;
        padding: 16px 16px;
        background: linear-gradient(180deg, rgba(109,94,252,.22), rgba(34,211,238,.10));
        border-bottom: 1px solid rgba(255,255,255,.14);
        user-select:none;
      }

      .head .hleft{
        display:flex;
        flex-direction:column;
        gap:6px;
      }

      .head .hTitle{
        font-weight: 900;
        letter-spacing: .2px;
        font-size: 16px;
      }

      .head .tag{
        font-size: 12px;
        color: rgba(255,255,255,.82);
        padding: 4px 10px;
        border: 1px solid rgba(255,255,255,.20);
        background: rgba(255,255,255,.07);
        border-radius: 999px;
        width: fit-content;
      }

      .acc .chev{
        opacity:.95;
        transform: rotate(0deg);
        transition: transform .16s ease;
        font-size: 14px;
      }

      .acc .body{
        display:none;
        padding: 14px;
      }

      .acc.open .body{ display:block; }
      .acc.open .chev{ transform: rotate(180deg); }

      /* Cards + grid */
      .grid{
        display:grid;
        grid-template-columns: 1.12fr .88fr;
        gap: 12px;
      }
      @media (max-width: 920px){
        .grid{ grid-template-columns: 1fr; }
        .title{ font-size: 34px; }
      }

      .card{
        border: 1px solid rgba(255,255,255,.18);
        background: linear-gradient(180deg, rgba(14,26,63,.94), rgba(11,23,58,.94));
        border-radius: var(--radius);
        padding: 14px;
        box-shadow: 0 12px 30px rgba(0,0,0,.26);
      }
      .card h3{
        margin: 0 0 8px;
        font-size: 16px;
        letter-spacing: .2px;
        font-weight: 900;
      }

      /* Footer note */
      .footer{
        margin-top: 14px;
        color: rgba(255,255,255,.70);
        font-size: 12.5px;
        text-align:center;
      }

      /* Placeholder blocks (so layout looks “alive” even before we fill parts) */
      .placeholder{
        border:1px dashed rgba(255,255,255,.20);
        border-radius: 16px;
        padding: 14px;
        color: rgba(255,255,255,.70);
        background: rgba(255,255,255,.04);
        font-size: 13.5px;
        line-height: 1.35;
      }
    </style>

    <!-- ACCORDION START -->
    <div class="accordion" id="accordion">

      <!-- VALUATION -->
      <div class="acc open" id="acc_val">
        <div class="head" data-acc="val">
          <div class="hleft">
            <div class="hTitle" id="ui_valTitle">Fair Value Calculator</div>
            <div class="tag" id="ui_valTag">6 models • 3 scenarios</div>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="valBody">
          <div class="grid">
            <div class="card" id="valLeft">
              <h3 id="ui_introTitle">What is this?</h3>
              <div class="muted" id="ui_introText">
                Pick a model type and compute an estimated fair value in Bear/Base/Bull scenarios.
              </div>

              <div class="placeholder" style="margin-top:12px;">
                PART 4 will add: model buttons + all input rows (ticker/price + model-specific inputs) + number formatting (k/m/b).
              </div>
            </div>

            <div class="card" id="valRight">
              <h3 id="ui_inputsScen">Scenarios & Results</h3>
              <div class="muted" id="ui_inputsScenText">
                Quick mode uses Base and derives Bear/Bull automatically (±2). Advanced allows editing all.
              </div>

              <div class="placeholder" style="margin-top:12px;">
                PART 5 will add: scenario inputs + result tiles + target/range panel.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- WATCHLIST -->
      <div class="acc" id="acc_watch">
        <div class="head" data-acc="watch">
          <div class="hleft">
            <div class="hTitle" id="ui_watchTitle">Watchlist</div>
            <div class="tag" id="ui_watchTag">Local storage</div>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="watchBody">
          <div class="card">
            <h3 id="ui_watchIntroTitle">Saved valuations</h3>
            <div class="muted" id="ui_watchIntroText">
              Your saved items will appear here (stored locally in your browser).
            </div>
            <div class="placeholder" style="margin-top:12px;">
              PART 6 will add: full watchlist table + export CSV + print/PDF + delete rows.
            </div>
          </div>
        </div>
      </div>

      <!-- GUIDE -->
      <div class="acc" id="acc_guide">
        <div class="head" data-acc="guide">
          <div class="hleft">
            <div class="hTitle" id="ui_guideTitle">Guide</div>
            <div class="tag" id="ui_guideTag">How to choose a model</div>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="guideBody">
          <div class="card">
            <h3 id="ui_guideHead1">How to use Equity Analyzer</h3>
            <div class="muted" id="ui_guideText1">
              PART 7 will add: full guide for all 6 models + where to find inputs + disclaimers (EN/CZ).
            </div>
          </div>
        </div>
      </div>

    </div><!-- /accordion -->

    <!-- App footer (text will be i18n in later JS) -->
    <div class="footer" id="ui_footer">
      Educational tool • Not investment advice
    </div>

    <!-- PART 3 END --><!-- =========================
     EQUITY ANALYZER — PART 4/10
     Left panel (models + inputs) + CSS for form + unit selectors
========================= -->

<style>
  /* Form / inputs (bigger, clearer) */
  .row{ display:flex; gap:10px; }
  @media (max-width: 720px){ .row{ flex-direction:column; } }
  .field{ flex:1; }

  .lbl{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin: 10px 0 6px;
    font-size: 13px;
    color: rgba(255,255,255,.90);
  }

  .mini{ margin-top:6px; font-size: 12.5px; color: rgba(255,255,255,.70); line-height: 1.25; }

  .inputWrap{
    display:flex;
    gap:10px;
    align-items:center;
  }
  input{
    width:100%;
    height: 56px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 0 14px;
    font-size: 16px;
    outline: none;
  }
  input:focus{
    border-color: rgba(34,211,238,.60);
    box-shadow: 0 0 0 3px rgba(34,211,238,.12);
  }

  .unitSel{
    width: 110px;
    height: 56px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding: 0 10px;
    font-size: 14px;
    outline: none;
    flex: 0 0 auto;
  }

  /* Model buttons (6) */
  .modelRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top: 12px;
  }
  .mBtn{
    flex: 1 1 250px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.06);
    padding: 12px 12px;
    cursor:pointer;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    min-height: 66px;
    text-align:left;
  }
  .mBtn:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.30);
    background: rgba(255,255,255,.08);
  }
  .mBtn.active{
    border-color: rgba(109,94,252,.75);
    background: linear-gradient(180deg, rgba(109,94,252,.26), rgba(34,211,238,.12));
    box-shadow: 0 0 0 1px rgba(109,94,252,.35) inset;
  }
  .mBtn .t{ font-weight: 950; font-size: 14px; letter-spacing:.2px; }
  .mBtn .d{ margin-top: 6px; color: rgba(255,255,255,.74); font-size: 12.8px; line-height: 1.25; }

  /* section blocks */
  .sectionTitle{
    margin-top: 12px;
    font-weight: 950;
    letter-spacing:.2px;
  }
  .divider{
    height:1px;
    background: rgba(255,255,255,.12);
    margin: 12px 0;
  }

  .tipbox{
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    border-radius: 16px;
    padding: 10px 12px;
    margin-top: 12px;
    color: rgba(255,255,255,.86);
    font-size: 13px;
    line-height: 1.3;
  }
</style>

<script>
  // PART 4 injects the full LEFT PANEL into the existing #valLeft card (and removes only its placeholder).
  (function(){
    const left = document.getElementById("valLeft");
    if(!left) return;

    // remove ONLY placeholder inside valLeft (keep other placeholders for now)
    const ph = left.querySelector(".placeholder");
    if(ph) ph.remove();

    // insert the real left-panel HTML
    left.insertAdjacentHTML("beforeend", `
      <div class="tipbox" id="ui_disclaimerTop">
        <strong id="ui_disclaimerTopT">Educational tool.</strong>
        <span id="ui_disclaimerTopB">Not investment advice. Numbers are estimates and can be wrong.</span>
      </div>

      <div class="sectionTitle" id="ui_modelTitle" style="margin-top:14px;">Choose a model</div>

      <div class="modelRow" id="modelRow">
        <button class="mBtn active" type="button" data-model="standard">
          <div class="t" id="ui_m_standard_t">Standard (FCF DCF)</div>
          <div class="d" id="ui_m_standard_d">Non-financials with stable positive free cash flow.</div>
        </button>

        <button class="mBtn" type="button" data-model="financial">
          <div class="t" id="ui_m_fin_t">Financial (RIM)</div>
          <div class="d" id="ui_m_fin_d">Banks/insurers/fintech — value via BVPS and ROE scenarios.</div>
        </button>

        <button class="mBtn" type="button" data-model="reit">
          <div class="t" id="ui_m_reit_t">REIT (AFFO)</div>
          <div class="d" id="ui_m_reit_d">REITs — AFFO per share instead of FCF.</div>
        </button>

        <button class="mBtn" type="button" data-model="growth">
          <div class="t" id="ui_m_growth_t">Pre-FCF Growth</div>
          <div class="d" id="ui_m_growth_d">Revenue model → converts revenue into FCF via margin.</div>
        </button>

        <button class="mBtn" type="button" data-model="cyclical">
          <div class="t" id="ui_m_cyc_t">Cyclical</div>
          <div class="d" id="ui_m_cyc_d">Use normalized mid-cycle cash flow (avoid peak/trough).</div>
        </button>

        <button class="mBtn" type="button" data-model="utility">
          <div class="t" id="ui_m_util_t">Utility / Dividend</div>
          <div class="d" id="ui_m_util_d">Stable dividend model (DDM style) for mature utilities.</div>
        </button>
      </div>

      <div class="divider"></div>

      <div class="sectionTitle" id="ui_inputsMain">Core inputs</div>

      <div class="row">
        <div class="field">
          <div class="lbl">
            <span id="ui_tickerLbl">Ticker</span>
            <button class="hint" type="button" data-help="ticker">i</button>
          </div>
          <input id="in_ticker" placeholder="e.g., AAPL" />
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_priceLbl">Current price</span>
            <button class="hint" type="button" data-help="price">i</button>
          </div>
          <input id="in_price" placeholder="e.g., 180" inputmode="decimal"/>
        </div>
      </div>

      <!-- MODEL: STANDARD -->
      <div id="sec_standard" style="margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_fcfLbl">Free Cash Flow (total)</span>
              <button class="hint" type="button" data-help="fcf_total">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_fcf" placeholder="e.g., 10" inputmode="decimal"/>
              <select id="unit_fcf" class="unitSel" aria-label="FCF unit">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_fcfMini">Annual total company FCF. Use unit selector to avoid typing many zeros.</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_sharesLbl">Shares outstanding</span>
              <button class="hint" type="button" data-help="shares">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_shares" placeholder="e.g., 2" inputmode="decimal"/>
              <select id="unit_shares" class="unitSel" aria-label="Shares unit">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_sharesMini">Used to convert firm value to per-share value.</div>
          </div>
        </div>
      </div>

      <!-- MODEL: FINANCIAL -->
      <div id="sec_financial" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_bvpsLbl">Book Value per Share (BVPS)</span>
              <button class="hint" type="button" data-help="bvps">i</button>
            </div>
            <input id="in_bvps" placeholder="e.g., 6.95" inputmode="decimal"/>
            <div class="mini" id="ui_bvpsMini">For banks/insurers. ROE is set in scenarios (Bear/Base/Bull).</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_payoutLbl">Payout ratio (%)</span>
              <button class="hint" type="button" data-help="payout">i</button>
            </div>
            <input id="in_payout" placeholder="e.g., 20" value="20" inputmode="decimal"/>
            <div class="mini" id="ui_payoutMini">Percent of earnings paid out. The rest grows book value.</div>
          </div>
        </div>
      </div>

      <!-- MODEL: REIT -->
      <div id="sec_reit" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_affoLbl">AFFO per share</span>
              <button class="hint" type="button" data-help="affo">i</button>
            </div>
            <input id="in_affo" placeholder="e.g., 2.10" inputmode="decimal"/>
            <div class="mini" id="ui_affoMini">Preferred over FCF for REITs (AFFO/FFO).</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_reitNoteLbl">Note (optional)</span>
              <button class="hint" type="button" data-help="reit_note">i</button>
            </div>
            <input id="in_reit_note" placeholder="e.g., AFFO TTM" />
            <div class="mini" id="ui_reitNoteMini">Label only. Does not affect calculations.</div>
          </div>
        </div>
      </div>

      <!-- MODEL: PRE-FCF GROWTH (Revenue → FCF) -->
      <div id="sec_growth" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_revLbl">Revenue (total, TTM)</span>
              <button class="hint" type="button" data-help="rev_total">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_rev" placeholder="e.g., 300" inputmode="decimal"/>
              <select id="unit_rev" class="unitSel" aria-label="Revenue unit">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_revMini">Total revenue used as a base. Scenario inputs act as revenue growth.</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_fcfmLbl">Target FCF margin (%)</span>
              <button class="hint" type="button" data-help="fcf_margin">i</button>
            </div>
            <input id="in_fcfm" placeholder="e.g., 15" value="15" inputmode="decimal"/>
            <div class="mini" id="ui_fcfmMini">Revenue is converted into FCF via this margin.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <div class="lbl">
              <span id="ui_sharesGLbl">Shares outstanding</span>
              <button class="hint" type="button" data-help="shares_growth">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_shares_g" placeholder="e.g., 2" inputmode="decimal"/>
              <select id="unit_shares_g" class="unitSel" aria-label="Shares unit (growth)">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_sharesGMini">Needed to convert firm value to per-share value.</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_growthNoteLbl">Note</span>
              <button class="hint" type="button" data-help="growth_note">i</button>
            </div>
            <input id="in_growth_note" placeholder="optional" />
            <div class="mini" id="ui_growthNoteMini">Example: “Forward revenue”. Label only.</div>
          </div>
        </div>
      </div>

      <!-- MODEL: CYCLICAL (Normalized FCF DCF) -->
      <div id="sec_cyclical" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_nfcfLbl">Normalized FCF (total)</span>
              <button class="hint" type="button" data-help="nfcf_total">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_nfcf" placeholder="e.g., 5" inputmode="decimal"/>
              <select id="unit_nfcf" class="unitSel" aria-label="Normalized FCF unit">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_nfcfMini">Use mid-cycle normalized cash flow (not peak/trough).</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_sharesCLbl">Shares outstanding</span>
              <button class="hint" type="button" data-help="shares_cyc">i</button>
            </div>
            <div class="inputWrap">
              <input id="in_shares_c" placeholder="e.g., 2" inputmode="decimal"/>
              <select id="unit_shares_c" class="unitSel" aria-label="Shares unit (cyclical)">
                <option value="raw">Raw</option>
                <option value="k">K</option>
                <option value="m" selected>M</option>
                <option value="b">B</option>
              </select>
            </div>
            <div class="mini" id="ui_sharesCMini">Used to convert firm value to per-share value.</div>
          </div>
        </div>
      </div>

      <!-- MODEL: UTILITY / DIVIDEND (DDM style) -->
      <div id="sec_utility" style="display:none; margin-top:10px;">
        <div class="row">
          <div class="field">
            <div class="lbl">
              <span id="ui_dpsLbl">Dividend per share (annual)</span>
              <button class="hint" type="button" data-help="dps">i</button>
            </div>
            <input id="in_dps" placeholder="e.g., 2.10" inputmode="decimal"/>
            <div class="mini" id="ui_dpsMini">Annual dividend per share (TTM or forward).</div>
          </div>

          <div class="field">
            <div class="lbl">
              <span id="ui_utilNoteLbl">Note</span>
              <button class="hint" type="button" data-help="util_note">i</button>
            </div>
            <input id="in_util_note" placeholder="optional" />
            <div class="mini" id="ui_utilNoteMini">Label only (e.g., “Forward DPS”).</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- SHARED PROJECTION SETTINGS -->
      <div class="row" style="margin-top:10px;">
        <div class="field">
          <div class="lbl">
            <span id="ui_yearsLbl">Projection years</span>
            <button class="hint" type="button" data-help="years">i</button>
          </div>
          <input id="in_years" placeholder="10" value="10" inputmode="numeric"/>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_discLbl">Discount rate (%)</span>
            <button class="hint" type="button" data-help="disc">i</button>
          </div>
          <input id="in_disc" placeholder="9" value="9" inputmode="decimal"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="field">
          <div class="lbl">
            <span id="ui_termLbl">Terminal growth (%)</span>
            <button class="hint" type="button" data-help="term">i</button>
          </div>
          <input id="in_term" placeholder="2.5" value="2.5" inputmode="decimal"/>
          <div class="mini" id="ui_termMini">Used for Standard/REIT/Growth/Cyclical. For Financial (RIM) terminal residual income is conservatively 0.</div>
        </div>
      </div>
    `);
  })();
</script>

<!-- PART 4 END --><!-- =========================
     EQUITY ANALYZER — PART 5/10
     Right panel (scenarios + results + buttons) + CSS
========================= -->

<style>
  .btns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 12px;
  }
  button{
    border: 1px solid rgba(255,255,255,.22);
    background: linear-gradient(180deg, rgba(109,94,252,.42), rgba(34,211,238,.14));
    color: rgba(255,255,255,.95);
    padding: 12px 14px;
    border-radius: 16px;
    cursor:pointer;
    font-weight: 850;
    letter-spacing:.2px;
    font-size: 14px;
    min-height: 46px;
  }
  button:hover{ filter: brightness(1.05); }
  button:active{ transform: translateY(1px); }

  button.secondary{
    background: rgba(255,255,255,.06);
  }
  button.danger{
    background: rgba(239,68,68,.12);
    border-color: rgba(239,68,68,.35);
  }

  .results{
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .res{
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    border-radius: 16px;
    padding: 12px;
  }
  .res .k{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight: 900;
    letter-spacing:.2px;
    margin-bottom: 8px;
  }
  .res .v{
    font-size: 22px;
    font-weight: 950;
    letter-spacing:.2px;
  }
  .res .s{
    margin-top: 6px;
    color: rgba(255,255,255,.70);
    font-size: 12.5px;
  }

  .badgeBear,.badgeBase,.badgeBull{
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.08);
  }
  .badgeBear{ border-color: rgba(248,113,113,.45); background: rgba(248,113,113,.10); }
  .badgeBase{ border-color: rgba(34,211,238,.50); background: rgba(34,211,238,.10); }
  .badgeBull{ border-color: rgba(109,94,252,.55); background: rgba(109,94,252,.14); }

  .muted{ color: rgba(255,255,255,.72); font-size: 13px; line-height:1.3; }

  .outReadonly{
    height: 56px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.92);
    padding: 0 14px;
    font-size: 15px;
    width:100%;
  }

  .tipbox strong{ font-weight: 950; }
</style>

<script>
  // PART 5 injects the full RIGHT PANEL into the existing #valRight card (and removes only its placeholder).
  (function(){
    const right = document.getElementById("valRight");
    if(!right) return;

    const ph = right.querySelector(".placeholder");
    if(ph) ph.remove();

    right.insertAdjacentHTML("beforeend", `
      <div class="tipbox" id="ui_scenTip" style="margin-top:10px;">
        <span id="ui_scenTipText">Standard/REIT/Growth/Cyclical: scenario = growth %. Financial: scenario = ROE %.</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="field">
          <div class="lbl">
            <span id="ui_bearLbl">Bear</span>
            <button class="hint" type="button" data-help="bear">i</button>
          </div>
          <input id="in_bear" placeholder="2" value="2" inputmode="decimal"/>
          <div class="mini" id="ui_bearMini">Conservative scenario input.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_baseLbl">Base</span>
            <button class="hint" type="button" data-help="base">i</button>
          </div>
          <input id="in_base" placeholder="5" value="5" inputmode="decimal"/>
          <div class="mini" id="ui_baseMini">Main scenario input used for Target price.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_bullLbl">Bull</span>
            <button class="hint" type="button" data-help="bull">i</button>
          </div>
          <input id="in_bull" placeholder="8" value="8" inputmode="decimal"/>
          <div class="mini" id="ui_bullMini">Optimistic scenario input.</div>
        </div>
      </div>

      <div class="results" id="resultGrid" style="margin-top:12px;">
        <div class="res">
          <div class="k">
            <span class="badgeBear">BEAR</span>
            <span id="r_bear_pct">—</span>
          </div>
          <div class="v" id="r_bear">—</div>
          <div class="s" id="r_bear_s">—</div>
        </div>

        <div class="res">
          <div class="k">
            <span class="badgeBase">BASE</span>
            <span id="r_base_pct">—</span>
          </div>
          <div class="v" id="r_base">—</div>
          <div class="s" id="r_base_s">—</div>
        </div>

        <div class="res">
          <div class="k">
            <span class="badgeBull">BULL</span>
            <span id="r_bull_pct">—</span>
          </div>
          <div class="v" id="r_bull">—</div>
          <div class="s" id="r_bull_s">—</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3 id="ui_targetsTitle">Target & Range</h3>
        <div class="muted" id="ui_targetsText">
          Target price = Base with Margin of Safety. Range = Bear to Bull.
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <div class="lbl"><span id="ui_targetLbl">Target price</span></div>
            <input class="outReadonly" id="out_target" readonly placeholder="—"/>
          </div>
          <div class="field">
            <div class="lbl"><span id="ui_rangeLbl">Fair value range</span></div>
            <input class="outReadonly" id="out_range" readonly placeholder="—"/>
          </div>
        </div>
      </div>

      <div class="tipbox" id="ui_sanityBox" style="display:none; margin-top:12px;">
        <strong id="ui_sanityTitle">Sanity check:</strong>
        <div id="ui_sanityText" class="mini" style="margin-top:6px; color:rgba(255,255,255,.85)"></div>
      </div>

      <div class="btns">
        <button id="btn_calc" type="button">Calculate</button>
        <button class="secondary" id="btn_save" type="button">Save to Watchlist</button>
        <button class="secondary" id="btn_fillDemo" type="button">Demo values</button>
      </div>
      <div class="mini" id="ui_saveNote">Saves the latest computed result (Bear/Base/Bull).</div>
    `);
  })();
</script>

<!-- PART 5 END --><!-- =========================
     EQUITY ANALYZER — PART 5/10
     Right panel (scenarios + results + buttons) + CSS
========================= -->

<style>
  .btns{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 12px;
  }
  button{
    border: 1px solid rgba(255,255,255,.22);
    background: linear-gradient(180deg, rgba(109,94,252,.42), rgba(34,211,238,.14));
    color: rgba(255,255,255,.95);
    padding: 12px 14px;
    border-radius: 16px;
    cursor:pointer;
    font-weight: 850;
    letter-spacing:.2px;
    font-size: 14px;
    min-height: 46px;
  }
  button:hover{ filter: brightness(1.05); }
  button:active{ transform: translateY(1px); }

  button.secondary{
    background: rgba(255,255,255,.06);
  }
  button.danger{
    background: rgba(239,68,68,.12);
    border-color: rgba(239,68,68,.35);
  }

  .results{
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .res{
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    border-radius: 16px;
    padding: 12px;
  }
  .res .k{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight: 900;
    letter-spacing:.2px;
    margin-bottom: 8px;
  }
  .res .v{
    font-size: 22px;
    font-weight: 950;
    letter-spacing:.2px;
  }
  .res .s{
    margin-top: 6px;
    color: rgba(255,255,255,.70);
    font-size: 12.5px;
  }

  .badgeBear,.badgeBase,.badgeBull{
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(255,255,255,.08);
  }
  .badgeBear{ border-color: rgba(248,113,113,.45); background: rgba(248,113,113,.10); }
  .badgeBase{ border-color: rgba(34,211,238,.50); background: rgba(34,211,238,.10); }
  .badgeBull{ border-color: rgba(109,94,252,.55); background: rgba(109,94,252,.14); }

  .muted{ color: rgba(255,255,255,.72); font-size: 13px; line-height:1.3; }

  .outReadonly{
    height: 56px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.92);
    padding: 0 14px;
    font-size: 15px;
    width:100%;
  }

  .tipbox strong{ font-weight: 950; }
</style>

<script>
  // PART 5 injects the full RIGHT PANEL into the existing #valRight card (and removes only its placeholder).
  (function(){
    const right = document.getElementById("valRight");
    if(!right) return;

    const ph = right.querySelector(".placeholder");
    if(ph) ph.remove();

    right.insertAdjacentHTML("beforeend", `
      <div class="tipbox" id="ui_scenTip" style="margin-top:10px;">
        <span id="ui_scenTipText">Standard/REIT/Growth/Cyclical: scenario = growth %. Financial: scenario = ROE %.</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="field">
          <div class="lbl">
            <span id="ui_bearLbl">Bear</span>
            <button class="hint" type="button" data-help="bear">i</button>
          </div>
          <input id="in_bear" placeholder="2" value="2" inputmode="decimal"/>
          <div class="mini" id="ui_bearMini">Conservative scenario input.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_baseLbl">Base</span>
            <button class="hint" type="button" data-help="base">i</button>
          </div>
          <input id="in_base" placeholder="5" value="5" inputmode="decimal"/>
          <div class="mini" id="ui_baseMini">Main scenario input used for Target price.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_bullLbl">Bull</span>
            <button class="hint" type="button" data-help="bull">i</button>
          </div>
          <input id="in_bull" placeholder="8" value="8" inputmode="decimal"/>
          <div class="mini" id="ui_bullMini">Optimistic scenario input.</div>
        </div>
      </div>

      <div class="results" id="resultGrid" style="margin-top:12px;">
        <div class="res">
          <div class="k">
            <span class="badgeBear">BEAR</span>
            <span id="r_bear_pct">—</span>
          </div>
          <div class="v" id="r_bear">—</div>
          <div class="s" id="r_bear_s">—</div>
        </div>

        <div class="res">
          <div class="k">
            <span class="badgeBase">BASE</span>
            <span id="r_base_pct">—</span>
          </div>
          <div class="v" id="r_base">—</div>
          <div class="s" id="r_base_s">—</div>
        </div>

        <div class="res">
          <div class="k">
            <span class="badgeBull">BULL</span>
            <span id="r_bull_pct">—</span>
          </div>
          <div class="v" id="r_bull">—</div>
          <div class="s" id="r_bull_s">—</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3 id="ui_targetsTitle">Target & Range</h3>
        <div class="muted" id="ui_targetsText">
          Target price = Base with Margin of Safety. Range = Bear to Bull.
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <div class="lbl"><span id="ui_targetLbl">Target price</span></div>
            <input class="outReadonly" id="out_target" readonly placeholder="—"/>
          </div>
          <div class="field">
            <div class="lbl"><span id="ui_rangeLbl">Fair value range</span></div>
            <input class="outReadonly" id="out_range" readonly placeholder="—"/>
          </div>
        </div>
      </div>

      <div class="tipbox" id="ui_sanityBox" style="display:none; margin-top:12px;">
        <strong id="ui_sanityTitle">Sanity check:</strong>
        <div id="ui_sanityText" class="mini" style="margin-top:6px; color:rgba(255,255,255,.85)"></div>
      </div>

      <div class="btns">
        <button id="btn_calc" type="button">Calculate</button>
        <button class="secondary" id="btn_save" type="button">Save to Watchlist</button>
        <button class="secondary" id="btn_fillDemo" type="button">Demo values</button>
      </div>
      <div class="mini" id="ui_saveNote">Saves the latest computed result (Bear/Base/Bull).</div>
    `);
  })();
</script>

<!-- PART 5 END --><!-- ========================= -->
<!-- PART 6/10: WATCHLIST + GUIDE + MODAL + ACCORDION LOGIC -->
<!-- Paste this directly after:  <!-- PART 5 END --> -->
<!-- ========================= -->

  <!-- WATCHLIST -->
  <div class="acc" id="acc_watch">
    <div class="head" data-acc="watch">
      <div class="title">
        <span id="ui_watchTitle">Watchlist</span>
        <span class="tag" id="ui_watchTag">Local storage</span>
      </div>
      <div class="chev">▼</div>
    </div>

    <div class="body" id="watchBody" style="display:none;">
      <div class="card">
        <h3 id="ui_watchIntroTitle">Saved valuations</h3>
        <div class="muted" id="ui_watchIntroText">
          Your saved calculations are stored locally in your browser. You can delete items or export them.
        </div>

        <div class="btns" style="margin-top:10px;">
          <button class="secondary" id="btn_export_csv">Export CSV</button>
          <button class="secondary" id="btn_print_pdf">Print / PDF</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="overflow:auto;">
          <table id="watchTable">
            <thead>
              <tr>
                <th id="th_date">Date</th>
                <th id="th_ticker">Ticker</th>
                <th class="right" id="th_price">Price</th>
                <th class="right" id="th_model">Model</th>
                <th class="right" id="th_bear">Bear</th>
                <th class="right" id="th_base">Base</th>
                <th class="right" id="th_bull">Bull</th>
                <th class="right nowrap" id="th_target">Target</th>
                <th class="right nowrap" id="th_range">Range</th>
                <th class="right" id="th_action">Action</th>
              </tr>
            </thead>
            <tbody id="watchTbody">
              <tr><td colspan="10" class="muted" id="watchEmpty">No saved items yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="footer" id="ui_watchFooter">
        Note: Watchlist is stored locally (localStorage).
      </div>
    </div>
  </div>

  <!-- GUIDE -->
  <div class="acc" id="acc_guide">
    <div class="head" data-acc="guide">
      <div class="title">
        <span id="ui_guideTitle">How to choose a model</span>
        <span class="tag" id="ui_guideTag">Guide</span>
      </div>
      <div class="chev">▼</div>
    </div>

    <div class="body" id="guideBody" style="display:none;">
      <div class="card">
        <h3 id="ui_guideHead1">1) Switching models</h3>
        <div class="muted" id="ui_guideText1">
          Pick a company type at the top (Standard / Financial / REIT / Growth / Cyclical / Utility).
          Inputs and scenario meaning change by model.
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3 id="ui_guideHead2">2) When to use which model</h3>
        <div class="muted" id="ui_guideText2">
          <ul style="margin:0; padding-left:18px;">
            <li><strong>Standard (FCF DCF):</strong> stable cash-flow businesses (most non-financials).</li>
            <li><strong>Financial (RIM):</strong> banks/insurers/fintech — BVPS + ROE (+ payout).</li>
            <li><strong>REIT (AFFO):</strong> real estate trusts — AFFO per share.</li>
            <li><strong>Growth (Revenue/Margin):</strong> early growth, weak/negative FCF.</li>
            <li><strong>Cyclical:</strong> normalize earnings/FCF across a cycle.</li>
            <li><strong>Utility:</strong> stable cash/dividend style businesses.</li>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3 id="ui_guideHead3">3) Sanity check</h3>
        <div class="muted" id="ui_guideText3">
          If results look extreme, check: model choice, units (firm-level vs per-share), shares outstanding,
          and ensure terminal growth is lower than discount rate.
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3 id="ui_guideHead4">Sources for inputs</h3>
        <div class="muted" id="ui_guideText4">
          You can use annual reports (10-K / 20-F), investor presentations, and reputable data providers
          (company IR pages, SEC filings, stock exchanges, or trusted financial portals).
        </div>
      </div>
    </div>
  </div>

</div><!-- /accordion -->

<div class="footer" id="ui_footer">
  Educational tool • Not investment advice
</div>

</div><!-- /wrap -->

<div class="toast" id="toast"></div>

<div class="modalBackdrop" id="modalBackdrop" style="display:none;">
  <div class="modal">
    <div class="modalHead">
      <div class="t" id="modalTitle">Info</div>
      <button class="xbtn" id="modalClose">Close</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
/* =========================
   PART 6 JS: accordion + modal + watchlist utilities
   (calculation engine comes later)
   ========================= */

(function(){
  const $ = (id)=>document.getElementById(id);

  // ----- TOAST -----
  let toastTimer = null;
  window.toast = function(msg){
    const t = $("toast");
    if(!t) return;
    t.textContent = msg;
    t.style.display = "block";
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{
      t.classList.remove("show");
      setTimeout(()=>{ t.style.display="none"; }, 200);
    }, 1600);
  };

  // ----- MODAL -----
  function openModal(title, bodyHtml){
    $("modalTitle").textContent = title || "Info";
    $("modalBody").innerHTML = bodyHtml || "";
    $("modalBackdrop").style.display = "flex";
  }
  function closeModal(){
    $("modalBackdrop").style.display = "none";
  }
  window.openModal = openModal;
  window.closeModal = closeModal;

  $("modalClose")?.addEventListener("click", closeModal);
  $("modalBackdrop")?.addEventListener("click", (e)=>{
    if(e.target && e.target.id === "modalBackdrop") closeModal();
  });

  // ----- ACCORDION TOGGLE (fix for drawers not opening) -----
  function toggleAcc(key){
    const map = {
      val: $("valBody"),
      watch: $("watchBody"),
      guide: $("guideBody"),
    };
    const body = map[key];
    if(!body) return;

    const isOpen = body.style.display !== "none";
    body.style.display = isOpen ? "none" : "block";

    // update chevron
    const head = document.querySelector(`.head[data-acc="${key}"]`);
    if(head){
      const chev = head.querySelector(".chev");
      if(chev) chev.textContent = isOpen ? "▼" : "▲";
    }
  }

  document.querySelectorAll(".head[data-acc]").forEach(h=>{
    h.addEventListener("click", ()=>{
      const key = h.getAttribute("data-acc");
      toggleAcc(key);
    });
  });

  // ----- WATCHLIST STORAGE -----
  const LS_KEY = "ea_watchlist_v1";

  function readWatchlist(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }
  function writeWatchlist(items){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(items || [])); }catch(e){}
  }

  function fmtNum(x){
    if(!Number.isFinite(x)) return "—";
    // keep simple formatting; advanced formatting comes later
    return x.toLocaleString(undefined, {maximumFractionDigits: 2});
  }

  function renderWatchlist(){
    const tbody = $("watchTbody");
    const empty = $("watchEmpty");
    if(!tbody) return;

    const items = readWatchlist();
    tbody.innerHTML = "";

    if(!items.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 10;
      td.className = "muted";
      td.id = "watchEmpty";
      td.textContent = empty ? empty.textContent : "No saved items yet.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach((it, idx)=>{
      const tr = document.createElement("tr");

      const cells = [
        it.date || "",
        it.ticker || "",
        it.priceText || fmtNum(it.price),
        it.model || "",
        it.bearText || fmtNum(it.bear),
        it.baseText || fmtNum(it.base),
        it.bullText || fmtNum(it.bull),
        it.targetText || fmtNum(it.target),
        it.rangeText || (it.bear && it.bull ? `${fmtNum(it.bear)} – ${fmtNum(it.bull)}` : "—")
      ];

      cells.forEach((c, i)=>{
        const td = document.createElement("td");
        if(i>=2) td.classList.add("right");
        if(i===7 || i===8) td.classList.add("nowrap");
        td.textContent = String(c ?? "");
        tr.appendChild(td);
      });

      const tdAct = document.createElement("td");
      tdAct.className = "right";
      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.textContent = (window.TEXTS && window.TEXTS.en && window.TEXTS.en.del) ? window.TEXTS.en.del : "Delete";
      btn.addEventListener("click", ()=>{
        const arr = readWatchlist();
        arr.splice(idx,1);
        writeWatchlist(arr);
        renderWatchlist();
        toast("Deleted");
      });
      tdAct.appendChild(btn);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });
  }

  // Export CSV
  function exportCSV(){
    const items = readWatchlist();
    if(!items.length){ toast("Nothing to export"); return; }

    const headers = ["date","ticker","price","model","bear","base","bull","target","range"];
    const rows = [headers.join(",")];

    items.forEach(it=>{
      const r = [
        it.date||"",
        it.ticker||"",
        it.priceText||it.price||"",
        it.model||"",
        it.bearText||it.bear||"",
        it.baseText||it.base||"",
        it.bullText||it.bull||"",
        it.targetText||it.target||"",
        it.rangeText||""
      ].map(v => `"${String(v).replaceAll('"','""')}"`);
      rows.push(r.join(","));
    });

    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "equity-analyzer-watchlist.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("CSV exported");
  }

  // Print
  function printPDF(){
    window.print();
  }

  $("btn_export_csv")?.addEventListener("click", exportCSV);
  $("btn_print_pdf")?.addEventListener("click", printPDF);

  // Initial render
  renderWatchlist();

  // expose for later parts
  window.__EA = window.__EA || {};
  window.__EA.watch = { readWatchlist, writeWatchlist, renderWatchlist, LS_KEY };

})();
</script>

<!-- PART 6 END --><!-- ========================= -->
<!-- PART 7/10: LANGUAGE (EN/CZ) + HELPS + NUMBER PARSER (k/m/b) -->
<!-- Paste this directly after:  <!-- PART 6 END --> -->
<!-- ========================= -->

<script>
/* =========================
   PART 7 JS: texts + language switch + help hints + number parsing
   ========================= */
(function(){
  const $ = (id)=>document.getElementById(id);

  // global state (safe init)
  window.state = window.state || {
    lang: "en",        // default EN
    mode: "quick",
    model: "standard",
    curr: "USD",
    mos: false
  };

  // --- TEXTS (EN default + CZ optional) ---
  // Important: keep IDs consistent with your DOM: ui_* + th_* + watchEmpty etc.
  window.TEXTS = window.TEXTS || {};
  window.TEXTS.en = Object.assign({
    sub: "Multi-Model Fair Value • Watchlist • Guide",
    langLbl: "Language",
    modeLbl: "Mode",

    valTitle: "Fair value",
    valTag: "Models + 3 scenarios",

    watchTitle: "Watchlist",
    watchTag: "Local storage",

    guideTitle: "How to choose a model",
    guideTag: "Guide",

    introTitle: "What are we calculating?",
    introText: "Choose a company model and estimate fair value in 3 scenarios. Output is educational and scenario-based — not a recommendation.",

    currLbl: "Currency",
    mosLbl: "Margin of Safety",
    decimalTip: "Tip: You can use dot or comma decimals. For large numbers use k/m/b (e.g., 10b = 10,000,000,000).",

    // model cards
    m_standard_t: "Standard (FCF DCF)",
    m_standard_d: "Stable cash-flow businesses (non-financials).",
    m_fin_t: "Financial (RIM)",
    m_fin_d: "Banks/insurers/fintech — BVPS + ROE (+ payout).",
    m_reit_t: "REIT (AFFO)",
    m_reit_d: "REIT — use AFFO per share instead of FCF.",
    m_growth_t: "Growth (no FCF)",
    m_growth_d: "Revenue/Margin model (will be computed in later part).",
    m_cyc_t: "Cyclical",
    m_cyc_d: "Cycle normalization model (later part).",
    m_util_t: "Utility",
    m_util_d: "Stable cash/dividend model (later part).",

    inputsMain: "Core inputs",
    tickerLbl: "Ticker",
    priceLbl: "Current price",

    fcfLbl: "Free Cash Flow (FCF) — total",
    fcfMini: "Annual total company FCF (ideally average of 3–5 years). Use currency above.",
    sharesLbl: "Shares Outstanding",
    sharesMini: "Total shares outstanding (used to convert firm value to per-share).",

    bvpsLbl: "Book Value per Share (BVPS)",
    bvpsMini: "For banks/financials (RIM).",
    roeLbl: "ROE (%)",
    roeMini: "Return on Equity — used for residual income scenarios.",
    payoutLbl: "Payout ratio (%)",
    payoutMini: "Percent of earnings paid out. The rest increases BVPS.",
    sharesFinLbl: "Shares (optional)",
    sharesFinMini: "Not required for RIM. Leave empty.",

    affoLbl: "AFFO per share",
    affoMini: "REITs: AFFO/FFO is often better than FCF.",

    yearsLbl: "Projection years",
    discLbl: "Discount rate (%)",
    termLbl: "Terminal growth (%)",
    termMini: "Used in Standard/REIT. For Financial (RIM) terminal residual income is conservatively 0.",

    inputsScen: "Scenarios (annual)",
    inputsScenText: "Quick mode uses Base and auto-calculates Bear/Bull (±2). Advanced lets you set all manually.",
    scenTipText: "For Standard/REIT: growth of FCF/AFFO. For Financial: ROE scenarios.",
    bearLbl: "Bear",
    baseLbl: "Base",
    bullLbl: "Bull",

    targetsTitle: "Target & Range",
    targetsText: "Target = Base with Margin of Safety applied. Range = Bear → Bull.",
    targetLbl: "Target price",
    rangeLbl: "Fair Value Range",

    calc: "Calculate",
    save: "Save to Watchlist",
    demo: "Demo values",
    saveNote: "Saves the latest result (Bear/Base/Bull).",

    watchIntroTitle: "Saved valuations",
    watchIntroText: "Stored locally in your browser. You can delete items or export a table.",
    watchFooter: "Note: Watchlist is stored locally (localStorage).",
    empty: "No saved items yet.",
    exportCsv: "Export CSV",
    printPdf: "Print / PDF",
    del: "Delete",
    footer:"Educational tool • Not investment advice",

    th: { date:"Date", ticker:"Ticker", price:"Price", model:"Model", bear:"Bear", base:"Base", bull:"Bull", target:"Target", range:"Range", action:"Action" },

    sanityTitle: "Sanity check:",
    sanityLow: "Result looks extremely low. Check model choice, units (total vs per-share) and shares.",
    sanityHigh:"Result looks extremely high. Check growth, discount rate, and whether the business is cyclical.",

    helps: {
      ticker: {t:"Ticker", b:"Any label you want (e.g., AAPL). Used for watchlist."},
      price: {t:"Current price", b:"Market price used to calculate upside/downside vs fair value."},

      fcf_total: {t:"FCF (total)", b:"Enter annual total company free cash flow (e.g., 10b). App converts to per-share using shares."},
      shares: {t:"Shares", b:"Total shares outstanding. Tip: 13.2b instead of typing many zeros."},

      bvps: {t:"BVPS", b:"Book value per share (for banks/financial institutions)."},
      roe: {t:"ROE", b:"Return on equity. For financials, scenarios often make sense as ROE (e.g., 8 / 12 / 15%)."},
      payout: {t:"Payout ratio", b:"Percent of earnings paid out; the rest increases BVPS."},
      shares_fin: {t:"Shares (optional)", b:"Not required for RIM. Leave empty."},

      affo: {t:"AFFO per share", b:"Adjusted funds from operations per share. Often better than FCF for REITs."},
      reit_note: {t:"Note", b:"Optional label (e.g., AFFO TTM). Does not affect calculation."},

      years: {t:"Projection years", b:"How many years to project cash flows."},
      disc: {t:"Discount rate", b:"Required return / risk. Higher = more conservative."},
      term: {t:"Terminal growth", b:"Long-run growth after projection. Must be lower than discount rate."},

      bear: {t:"Bear", b:"Pessimistic scenario. For Standard/REIT = growth %, for Financial = ROE %."},
      base: {t:"Base", b:"Realistic scenario. For Standard/REIT = growth %, for Financial = ROE %."},
      bull: {t:"Bull", b:"Optimistic scenario. For Standard/REIT = growth %, for Financial = ROE %."}
    },

    guideHead1:"1) Switching models",
    guideText1:"Switch model at the top. Inputs and scenario meaning change by model.",
    guideHead2:"2) When to use which model",
    guideText2:"Use Standard for stable non-financials, Financial (RIM) for banks/insurers/fintech, REIT for real estate trusts.",
    guideHead3:"3) Sanity check",
    guideText3:"If result looks extreme, verify model, units, shares, discount and terminal growth.",
    guideHead4:"Sources for inputs",
    guideText4:"Use annual reports (10-K/20-F), investor relations pages, and reputable data providers."
  }, window.TEXTS.en);

  window.TEXTS.cz = Object.assign({
    sub: "Multi-Model Fair Value • Watchlist • Návod",
    langLbl: "Jazyk",
    modeLbl: "Mód",

    valTitle: "Výpočet férové ceny",
    valTag: "Modely + 3 scénáře",

    watchTitle: "Watchlist",
    watchTag: "Local storage",

    guideTitle: "Jak vybrat model",
    guideTag: "Návod",

    introTitle: "Co tady počítáme?",
    introText: "Vybereš typ firmy (model) a spočítáš férovou cenu ve 3 scénářích. Je to vzdělávací scénářový výstup — není to doporučení.",

    currLbl: "Měna",
    mosLbl: "Margin of Safety",
    decimalTip: "Tip: Můžeš psát desetinnou tečku nebo čárku. Pro velká čísla používej k/m/b (např. 10b = 10 000 000 000).",

    m_standard_t: "Standard (FCF DCF)",
    m_standard_d: "Klasické firmy se stabilním FCF (non-finance).",
    m_fin_t: "Finanční (RIM)",
    m_fin_d: "Banky/pojišťovny/fintech — BVPS + ROE (+ payout).",
    m_reit_t: "REIT (AFFO)",
    m_reit_d: "REIT — AFFO na akcii místo FCF.",
    m_growth_t: "Růstová bez FCF",
    m_growth_d: "Model Revenue/Margin (výpočet doplníme v další části).",
    m_cyc_t: "Cyklická",
    m_cyc_d: "Normalizace přes cyklus (doplníme v další části).",
    m_util_t: "Utility",
    m_util_d: "Stabilní cash/dividend (doplníme v další části).",

    inputsMain: "Základní vstupy",
    tickerLbl: "Ticker",
    priceLbl: "Aktuální cena",

    fcfLbl: "Free Cash Flow (FCF) — celkem",
    fcfMini: "Roční FCF celé firmy (ideálně průměr 3–5 let). Číslo v měně výše.",
    sharesLbl: "Shares Outstanding",
    sharesMini: "Počet akcií v oběhu (pro přepočet hodnoty na 1 akcii).",

    bvpsLbl: "Book Value / akcii (BVPS)",
    bvpsMini: "Pro banky/finanční instituce (RIM).",
    roeLbl: "ROE (%)",
    roeMini: "Návratnost vlastního kapitálu — pro scénáře reziduálního zisku.",
    payoutLbl: "Payout ratio (%)",
    payoutMini: "Kolik % zisku se vyplatí. Zbytek zvyšuje BVPS.",
    sharesFinLbl: "Shares (volitelné)",
    sharesFinMini: "U RIM není potřeba. Nech prázdné.",

    affoLbl: "AFFO / akcii",
    affoMini: "U REIT je AFFO/FFO často vhodnější než FCF.",

    yearsLbl: "Délka projekce (roky)",
    discLbl: "Diskontní sazba (%)",
    termLbl: "Terminální růst (%)",
    termMini: "Použije se u Standard/REIT. U Financial (RIM) je terminál konzervativně 0 reziduálního zisku.",

    inputsScen: "Scénáře (ročně)",
    inputsScenText: "Quick mód používá jen Base a Bear/Bull dopočítá automaticky (±2). Advanced umožní zadat vše ručně.",
    scenTipText: "U Standard/REIT je to růst FCF/AFFO. U Financial je to ROE scénář.",
    bearLbl: "Bear",
    baseLbl: "Base",
    bullLbl: "Bull",

    targetsTitle: "Target & Range",
    targetsText: "Target = Base se zapnutým Margin of Safety. Range = Bear → Bull.",
    targetLbl: "Target cena",
    rangeLbl: "Rozpětí férové ceny",

    calc: "Calculate",
    save: "Save to Watchlist",
    demo: "Demo values",
    saveNote: "Uloží se poslední výsledek (Bear/Base/Bull).",

    watchIntroTitle: "Uložené výpočty",
    watchIntroText: "Ukládá se lokálně v prohlížeči. Můžeš mazat položky a exportovat tabulku.",
    watchFooter: "Pozn.: Watchlist je uložen lokálně (localStorage).",
    empty: "Zatím nic uloženého.",
    exportCsv: "Export CSV",
    printPdf: "Print / PDF",
    del: "Smazat",
    footer:"Vzdělávací nástroj • Nejedná se o investiční doporučení",

    th: { date:"Datum", ticker:"Ticker", price:"Cena", model:"Model", bear:"Bear", base:"Base", bull:"Bull", target:"Target", range:"Range", action:"Akce" },

    sanityTitle: "Sanity check:",
    sanityLow: "Výsledek vychází extrémně nízko. Zkontroluj model, jednotky (celkem vs na akcii) a Shares.",
    sanityHigh:"Výsledek vychází extrémně vysoko. Zkontroluj růst, diskont a zda nejde o cyklickou firmu.",

    helps: {
      ticker: {t:"Ticker", b:"Zkratka akcie (např. AAPL). Slouží pro watchlist."},
      price: {t:"Aktuální cena", b:"Tržní cena pro výpočet % rozdílu vůči férové hodnotě."},

      fcf_total: {t:"FCF — celkem", b:"Roční FCF celé firmy (např. 10b). Aplikace pak dělí počtem akcií."},
      shares: {t:"Shares Outstanding", b:"Počet akcií v oběhu. Tip: 13.2b místo psaní mnoha nul."},

      bvps: {t:"BVPS", b:"Účetní hodnota na akcii (pro banky/finanční instituce)."},
      roe: {t:"ROE", b:"Návratnost vlastního kapitálu. U finančních firem dávají scénáře smysl jako ROE (např. 8 / 12 / 15 %)."},
      payout: {t:"Payout ratio", b:"Kolik % zisku se vyplatí. Zbytek zvyšuje BVPS."},
      shares_fin: {t:"Shares (volitelné)", b:"U RIM není potřeba. Nech prázdné."},

      affo: {t:"AFFO / akcii", b:"Adjusted FFO/AFFO na akcii — často vhodnější než FCF u REIT."},
      reit_note: {t:"Poznámka", b:"Volitelný label (např. AFFO TTM). Výpočty neovlivní."},

      years: {t:"Délka projekce", b:"Kolik let promítat cash-flow."},
      disc: {t:"Diskont", b:"Požadovaný výnos/riziko. Vyšší = konzervativnější."},
      term: {t:"Terminální růst", b:"Dlouhodobý růst po projekci. Musí být menší než diskont."},

      bear: {t:"Bear", b:"Pesimistický scénář. U Standard/REIT = růst %, u Financial = ROE %."},
      base: {t:"Base", b:"Realistický scénář. U Standard/REIT = růst %, u Financial = ROE %."},
      bull: {t:"Bull", b:"Optimistický scénář. U Standard/REIT = růst %, u Financial = ROE %."}
    },

    guideHead1:"1) Přepínání modelu",
    guideText1:"Model přepínáš nahoře. Po přepnutí se změní vstupy i význam scénářů.",
    guideHead2:"2) Kdy použít který model",
    guideText2:"Standard pro stabilní non-finance, Financial (RIM) pro banky/pojišťovny/fintech, REIT pro realitní trusty.",
    guideHead3:"3) Rychlá kontrola výsledku",
    guideText3:"Pokud výsledek vypadá extrémně, zkontroluj model, jednotky, shares, diskont a terminál.",
    guideHead4:"Zdroje pro vstupy",
    guideText4:"Použij výroční zprávy (10-K/20-F), IR stránky firem a ověřené zdroje dat."
  }, window.TEXTS.cz);

  // --- helper: set text content if element exists ---
  function setTxt(id, value){
    const el = $(id);
    if(!el) return;
    el.textContent = value;
  }

  // --- Apply current language to UI ---
  function applyTexts(){
    const t = window.TEXTS[window.state.lang] || window.TEXTS.en;

    // top/sub
    setTxt("ui_sub", t.sub);
    setTxt("ui_langLbl", t.langLbl);
    setTxt("ui_modeLbl", t.modeLbl);

    // drawers titles/tags
    setTxt("ui_valTitle", t.valTitle);
    setTxt("ui_valTag", t.valTag);

    setTxt("ui_watchTitle", t.watchTitle);
    setTxt("ui_watchTag", t.watchTag);

    setTxt("ui_guideTitle", t.guideTitle);
    setTxt("ui_guideTag", t.guideTag);

    // intro
    setTxt("ui_introTitle", t.introTitle);
    setTxt("ui_introText", t.introText);

    // general labels
    setTxt("ui_currLbl", t.currLbl);
    setTxt("ui_mosLbl", t.mosLbl);
    setTxt("ui_decimalTip", t.decimalTip);

    // model cards (if present)
    setTxt("m_standard_t", t.m_standard_t);
    setTxt("m_standard_d", t.m_standard_d);
    setTxt("m_fin_t", t.m_fin_t);
    setTxt("m_fin_d", t.m_fin_d);
    setTxt("m_reit_t", t.m_reit_t);
    setTxt("m_reit_d", t.m_reit_d);
    setTxt("m_growth_t", t.m_growth_t);
    setTxt("m_growth_d", t.m_growth_d);
    setTxt("m_cyc_t", t.m_cyc_t);
    setTxt("m_cyc_d", t.m_cyc_d);
    setTxt("m_util_t", t.m_util_t);
    setTxt("m_util_d", t.m_util_d);

    // inputs section labels
    setTxt("ui_inputsMain", t.inputsMain);
    setTxt("ui_tickerLbl", t.tickerLbl);
    setTxt("ui_priceLbl", t.priceLbl);

    setTxt("ui_fcfLbl", t.fcfLbl);
    setTxt("ui_fcfMini", t.fcfMini);
    setTxt("ui_sharesLbl", t.sharesLbl);
    setTxt("ui_sharesMini", t.sharesMini);

    setTxt("ui_bvpsLbl", t.bvpsLbl);
    setTxt("ui_bvpsMini", t.bvpsMini);
    setTxt("ui_roeLbl", t.roeLbl);
    setTxt("ui_roeMini", t.roeMini);
    setTxt("ui_payoutLbl", t.payoutLbl);
    setTxt("ui_payoutMini", t.payoutMini);
    setTxt("ui_sharesFinLbl", t.sharesFinLbl);
    setTxt("ui_sharesFinMini", t.sharesFinMini);

    setTxt("ui_affoLbl", t.affoLbl);
    setTxt("ui_affoMini", t.affoMini);

    setTxt("ui_yearsLbl", t.yearsLbl);
    setTxt("ui_discLbl", t.discLbl);
    setTxt("ui_termLbl", t.termLbl);
    setTxt("ui_termMini", t.termMini);

    // scenarios + targets
    setTxt("ui_inputsScen", t.inputsScen);
    setTxt("ui_inputsScenText", t.inputsScenText);
    setTxt("ui_scenTipText", t.scenTipText);
    setTxt("ui_bearLbl", t.bearLbl);
    setTxt("ui_baseLbl", t.baseLbl);
    setTxt("ui_bullLbl", t.bullLbl);

    setTxt("ui_targetsTitle", t.targetsTitle);
    setTxt("ui_targetsText", t.targetsText);
    setTxt("ui_targetLbl", t.targetLbl);
    setTxt("ui_rangeLbl", t.rangeLbl);

    // buttons
    setTxt("btn_calc", t.calc);
    setTxt("btn_save", t.save);
    setTxt("btn_fillDemo", t.demo);
    setTxt("ui_saveNote", t.saveNote);

    // watchlist texts
    setTxt("ui_watchIntroTitle", t.watchIntroTitle);
    setTxt("ui_watchIntroText", t.watchIntroText);
    setTxt("ui_watchFooter", t.watchFooter);
    setTxt("btn_export_csv", t.exportCsv);
    setTxt("btn_print_pdf", t.printPdf);
    const emptyEl = $("watchEmpty");
    if(emptyEl) emptyEl.textContent = t.empty;

    // table headers
    if(t.th){
      setTxt("th_date", t.th.date);
      setTxt("th_ticker", t.th.ticker);
      setTxt("th_price", t.th.price);
      setTxt("th_model", t.th.model);
      setTxt("th_bear", t.th.bear);
      setTxt("th_base", t.th.base);
      setTxt("th_bull", t.th.bull);
      setTxt("th_target", t.th.target);
      setTxt("th_range", t.th.range);
      setTxt("th_action", t.th.action);
    }

    // guide
    setTxt("ui_guideHead1", t.guideHead1);
    setTxt("ui_guideText1", t.guideText1);
    setTxt("ui_guideHead2", t.guideHead2);
    setTxt("ui_guideText2", t.guideText2);
    setTxt("ui_guideHead3", t.guideHead3);
    setTxt("ui_guideText3", t.guideText3);
    setTxt("ui_guideHead4", t.guideHead4);
    setTxt("ui_guideText4", t.guideText4);

    // footer
    setTxt("ui_footer", t.footer);

    // re-render watchlist with localized delete label
    if(window.__EA && window.__EA.watch && window.__EA.watch.renderWatchlist){
      window.__EA.watch.renderWatchlist();
    }
  }

  // --- Language controls binding (robust) ---
  // Supports:
  //  - elements with [data-lang="en"] / [data-lang="cz"]
  //  - ids: btn_lang_en / btn_lang_cz
  function bindLang(){
    const setLang = (lang)=>{
      window.state.lang = (lang === "cz") ? "cz" : "en";
      try{ localStorage.setItem("ea_lang", window.state.lang); }catch(e){}
      applyTexts();
      window.toast && window.toast(window.state.lang === "cz" ? "Čeština ✅" : "English ✅");
    };

    // restore saved
    try{
      const saved = localStorage.getItem("ea_lang");
      if(saved === "cz" || saved === "en") window.state.lang = saved;
    }catch(e){}

    document.querySelectorAll("[data-lang]").forEach(el=>{
      el.addEventListener("click", ()=> setLang(el.getAttribute("data-lang")));
    });

    $("btn_lang_en")?.addEventListener("click", ()=>setLang("en"));
    $("btn_lang_cz")?.addEventListener("click", ()=>setLang("cz"));

    applyTexts();
  }

  // --- Help hint binding (opens modal with localized help texts) ---
  function bindHelps(){
    document.querySelectorAll(".hint[data-help]").forEach(h=>{
      h.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const key = h.getAttribute("data-help");
        const t = window.TEXTS[window.state.lang] || window.TEXTS.en;
        const help = (t.helps && t.helps[key]) ? t.helps[key] : null;
        if(!help){
          window.openModal && window.openModal("Info", "<div class='muted'>No help text.</div>");
          return;
        }
        window.openModal && window.openModal(help.t, `<div class="muted">${help.b}</div>`);
      });
    });
  }

  // --- Number parsing with k/m/b, comma/dot, spaces ---
  function parseNum(raw){
    if(raw === null || raw === undefined) return NaN;
    let s = String(raw).trim();
    if(!s) return NaN;

    // allow spaces and underscores
    s = s.replaceAll(" ", "").replaceAll("_", "");

    // comma decimal support: "12,6" -> "12.6"
    // but keep thousands separators safe (we removed spaces; user may type 1,200.5 -> ambiguous)
    // approach: if contains both ',' and '.', assume ',' is thousands -> remove commas
    const hasComma = s.includes(",");
    const hasDot = s.includes(".");
    if(hasComma && hasDot){
      s = s.replaceAll(",", "");
    }else if(hasComma && !hasDot){
      s = s.replaceAll(",", ".");
    }

    // suffix
    let mult = 1;
    const m = s.match(/([kmb])$/i);
    if(m){
      const suf = m[1].toLowerCase();
      if(suf === "k") mult = 1e3;
      if(suf === "m") mult = 1e6;
      if(suf === "b") mult = 1e9;
      s = s.slice(0, -1);
    }

    const x = Number(s);
    if(!Number.isFinite(x)) return NaN;
    return x * mult;
  }

  // expose for compute engine later
  window.__EA = window.__EA || {};
  window.__EA.num = { parseNum };

  // Optional: attach small helper placeholder tip to specific fields if they exist
  function patchPlaceholders(){
    // make large numbers easier
    const fcf = $("in_fcf");
    if(fcf && !fcf.getAttribute("data-phpatched")){
      fcf.placeholder = "e.g. 10b";
      fcf.setAttribute("data-phpatched","1");
    }
    const shares = $("in_shares");
    if(shares && !s<!-- ========================= -->
<!-- PART 8/10: CORE UI LOGIC + ACCORDION + MODEL SWITCH + COMPUTE ENGINE -->
<!-- Paste this directly after:  <!-- PART 7 END --> -->
<!-- ========================= -->

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // Ensure globals exist
  window.__EA = window.__EA || {};
  window.__EA.num = window.__EA.num || {};
  const parseNum = window.__EA.num.parseNum || ((x)=>Number(x));

  // ---------- Toast + Modal (robust, even if missing earlier parts) ----------
  window.toast = window.toast || function(msg){
    const t = $("toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__EA._toastT);
    window.__EA._toastT = setTimeout(()=>t.classList.remove("show"), 2200);
  };

  window.openModal = window.openModal || function(title, html){
    const b = $("modalBackdrop");
    const tt = $("modalTitle");
    const body = $("modalBody");
    if(!b || !tt || !body) return;
    tt.textContent = title || "Info";
    body.innerHTML = html || "";
    b.classList.add("show");
  };

  function closeModal(){
    $("modalBackdrop")?.classList.remove("show");
  }
  $("modalClose")?.addEventListener("click", closeModal);
  $("modalBackdrop")?.addEventListener("click", (e)=>{
    if(e.target && e.target.id === "modalBackdrop") closeModal();
  });

  // ---------- State ----------
  window.state = window.state || {
    lang:"en",
    mode:"quick",
    model:"standard",
    curr:"USD",
    mos:false
  };

  // Restore saved preferences (safe)
  try{
    const savedModel = localStorage.getItem("ea_model");
    const savedMode  = localStorage.getItem("ea_mode");
    const savedCurr  = localStorage.getItem("ea_curr");
    const savedMos   = localStorage.getItem("ea_mos");
    if(savedModel) window.state.model = savedModel;
    if(savedMode) window.state.mode = savedMode;
    if(savedCurr) window.state.curr = savedCurr;
    if(savedMos === "1" || savedMos === "0") window.state.mos = (savedMos === "1");
  }catch(e){}

  // ---------- Accordion (fix: drawers not opening) ----------
  function bindAccordion(){
    document.querySelectorAll(".acc .head[data-acc]").forEach(head=>{
      head.addEventListener("click", ()=>{
        const key = head.getAttribute("data-acc"); // "val" | "watch" | "guide"
        const acc = head.closest(".acc");
        if(!acc) return;

        // toggle current
        const isOpen = acc.classList.contains("open");

        // close others
        document.querySelectorAll(".acc.open").forEach(a=>{
          if(a !== acc) a.classList.remove("open");
        });

        // open/close this
        acc.classList.toggle("open", !isOpen);

        // optional: scroll into view for mobile
        if(!isOpen){
          setTimeout(()=>acc.scrollIntoView({behavior:"smooth", block:"start"}), 120);
        }
      });
    });

    // Ensure at least "val" open by default
    const accVal = $("acc_val");
    if(accVal && !document.querySelector(".acc.open")){
      accVal.classList.add("open");
    }
  }

  // ---------- Currency + formatting ----------
  function getLocale(){
    return (window.state.lang === "cz") ? "cs-CZ" : "en-US";
  }
  function fmtMoney(x){
    if(!Number.isFinite(x)) return "—";
    const cur = window.state.curr || "USD";
    try{
      return new Intl.NumberFormat(getLocale(), {
        style:"currency",
        currency: cur,
        maximumFractionDigits: 2
      }).format(x);
    }catch(e){
      // fallback if bad currency code
      return new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x) + " " + cur;
    }
  }
  function fmtPct(x){
    if(!Number.isFinite(x)) return "";
    const sign = x > 0 ? "+" : "";
    return " " + sign + new Intl.NumberFormat(getLocale(), {maximumFractionDigits:1}).format(x) + "%";
  }

  // ---------- UI: set active model cards ----------
  function setActiveModelUI(){
    const model = window.state.model || "standard";

    // Sections
    const secStd = $("sec_standard");
    const secFin = $("sec_financial");
    const secReit = $("sec_reit");
    if(secStd) secStd.style.display = (model === "standard") ? "" : "none";
    if(secFin) secFin.style.display = (model === "financial") ? "" : "none";
    if(secReit) secReit.style.display = (model === "reit") ? "" : "none";

    // Card buttons: prefer [data-model], fallback to ids
    document.querySelectorAll("[data-model]").forEach(el=>{
      el.classList.toggle("active", el.getAttribute("data-model") === model);
    });

    // If some models are not implemented, compute will warn
    try{ localStorage.setItem("ea_model", model); }catch(e){}
  }

  function bindModelButtons(){
    // If you have cards with data-model="standard|financial|reit|growth|cyc|util"
    document.querySelectorAll("[data-model]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const m = btn.getAttribute("data-model");
        if(!m) return;

        // Not implemented yet:
        if(m === "growth" || m === "cyc" || m === "util"){
          window.state.model = m;
          setActiveModelUI();
          window.toast(window.state.lang === "cz"
            ? "Tenhle model doplníme v další části (coming soon)."
            : "This model will be added in the next part (coming soon)."
          );
          return;
        }

        window.state.model = m;
        setActiveModelUI();
      });
    });

    // fallback: if you have ids like btn_model_standard etc.
    $("btn_model_standard")?.addEventListener("click", ()=>{ window.state.model="standard"; setActiveModelUI(); });
    $("btn_model_financial")?.addEventListener("click", ()=>{ window.state.model="financial"; setActiveModelUI(); });
    $("btn_model_reit")?.addEventListener("click", ()=>{ window.state.model="reit"; setActiveModelUI(); });
  }

  // ---------- Mode: quick / advanced ----------
  function applyModeUI(){
    const isQuick = (window.state.mode === "quick");
    const inBear = $("in_bear");
    const inBull = $("in_bull");
    if(inBear) inBear.readOnly = isQuick;
    if(inBull) inBull.readOnly = isQuick;

    // In quick mode, recalc bear/bull from base
    if(isQuick){
      autoBearBullFromBase();
    }

    try{ localStorage.setItem("ea_mode", window.state.mode); }catch(e){}
  }

  function autoBearBullFromBase(){
    const base = parseNum($("in_base")?.value);
    if(!Number.isFinite(base)) return;
    const bear = Math.max(0, base - 2);
    const bull = base + 2;
    if($("in_bear")) $("in_bear").value = String(bear);
    if($("in_bull")) $("in_bull").value = String(bull);
  }

  function bindModeButtons(){
    // supports [data-mode] or ids
    document.querySelectorAll("[data-mode]").forEach(el=>{
      el.addEventListener("click", ()=>{
        window.state.mode = el.getAttribute("data-mode") === "advanced" ? "advanced" : "quick";
        applyModeUI();
      });
    });
    $("btn_mode_quick")?.addEventListener("click", ()=>{ window.state.mode="quick"; applyModeUI(); });
    $("btn_mode_advanced")?.addEventListener("click", ()=>{ window.state.mode="advanced"; applyModeUI(); });

    $("in_base")?.addEventListener("input", ()=>{
      if(window.state.mode === "quick") autoBearBullFromBase();
    });
  }

  // ---------- Currency + MOS toggles (if present) ----------
  function bindCurrencyAndMos(){
    // currency selector: supports [data-curr] OR select/input with id in_curr
    document.querySelectorAll("[data-curr]").forEach(el=>{
      el.addEventListener("click", ()=>{
        window.state.curr = el.getAttribute("data-curr") || "USD";
        try{ localStorage.setItem("ea_curr", window.state.curr); }catch(e){}
        window.toast(window.state.curr);
      });
    });

    const currSel = $("in_curr");
    if(currSel){
      currSel.addEventListener("change", ()=>{
        window.state.curr = currSel.value || "USD";
        try{ localStorage.setItem("ea_curr", window.state.curr); }catch(e){}
      });
    }

    // MOS toggle: supports [data-mos="on/off"] or id btn_mos
    document.querySelectorAll("[data-mos]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const v = el.getAttribute("data-mos");
        window.state.mos = (v === "on");
        try{ localStorage.setItem("ea_mos", window.state.mos ? "1":"0"); }catch(e){}
        window.toast(window.state.mos ? "MoS ON" : "MoS OFF");
      });
    });
    $("btn_mos")?.addEventListener("click", ()=>{
      window.state.mos = !window.state.mos;
      try{ localStorage.setItem("ea_mos", window.state.mos ? "1":"0"); }catch(e){}
    });
  }

  // ---------- Compute engines ----------
  function computeStandard(g){
    // Inputs
    const price = parseNum($("in_price")?.value);
    const fcfTotal = parseNum($("in_fcf")?.value);
    const shares = parseNum($("in_shares")?.value);
    const years = Math.round(parseNum($("in_years")?.value));
    const discPct = parseNum($("in_disc")?.value);
    const termPct = parseNum($("in_term")?.value);

    if(!Number.isFinite(fcfTotal) || fcfTotal <= 0) return {err:"FCF"};
    if(!Number.isFinite(shares) || shares <= 0) return {err:"Shares"};
    if(!Number.isFinite(years) || years <= 0) return {err:"Years"};
    if(!Number.isFinite(discPct) || discPct <= 0) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const disc = discPct / 100;
    const term = termPct / 100;
    const growth = (g || 0) / 100;

    if(disc <= term){
      return {err:"DiscTerm"};
    }

    // DCF (firm level -> per share)
    let pv = 0;
    let fcf = fcfTotal;

    for(let t=1; t<=years; t++){
      fcf = fcfTotal * Math.pow(1 + growth, t);
      pv += fcf / Math.pow(1 + disc, t);
    }

    const fcfN = fcfTotal * Math.pow(1 + growth, years);
    const tv = (fcfN * (1 + term)) / (disc - term);
    const pvTv = tv / Math.pow(1 + disc, years);

    const equity = pv + pvTv;
    const perShare = equity / shares;

    let pct = NaN;
    if(Number.isFinite(price) && price > 0){
      pct = ((perShare / price) - 1) * 100;
    }

    return {value: perShare, pct};
  }

  function computeREIT(g){
    const price = parseNum($("in_price")?.value);
    const affo = parseNum($("in_affo")?.value);
    const years = Math.round(parseNum($("in_years")?.value));
    const discPct = parseNum($("in_disc")?.value);
    const termPct = parseNum($("in_term")?.value);

    if(!Number.isFinite(affo) || affo <= 0) return {err:"AFFO"};
    if(!Number.isFinite(years) || years <= 0) return {err:"Years"};
    if(!Number.isFinite(discPct) || discPct <= 0) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const disc = discPct / 100;
    const term = termPct / 100;
    const growth = (g || 0) / 100;

    if(disc <= term) return {err:"DiscTerm"};

    let pv = 0;
    for(let t=1; t<=years; t++){
      const cf = affo * Math.pow(1 + growth, t);
      pv += cf / Math.pow(1 + disc, t);
    }

    const cfN = affo * Math.pow(1 + growth, years);
    const tv = (cfN * (1 + term)) / (disc - term);
    const pvTv = tv / Math.pow(1 + disc, years);

    const perShare = pv + pvTv;

    let pct = NaN;
    if(Number.isFinite(price) && price > 0){
      pct = ((perShare / price) - 1) * 100;
    }
    return {value: perShare, pct};
  }

  function computeFinancialRIM(roePct){
    const price = parseNum($("in_price")?.value);
    const bvps = parseNum($("in_bvps")?.value);
    const payoutPct = parseNum($("in_payout")?.value);
    const years = Math.round(parseNum($("in_years")?.value));
    const discPct = parseNum($("in_disc")?.value);

    if(!Number.isFinite(bvps) || bvps <= 0) return {err:"BVPS"};
    if(!Number.isFinite(roePct)) return {err:"ROE"};
    if(!Number.isFinite(payoutPct) || payoutPct < 0 || payoutPct > 100) return {err:"Payout"};
    if(!Number.isFinite(years) || years <= 0) return {err:"Years"};
    if(!Number.isFinite(discPct) || discPct <= 0) return {err:"Discount"};

    const roe = roePct / 100;
    const disc = discPct / 100;
    const payout = payoutPct / 100;
    const retain = 1 - payout;

    // Residual Income Model (per share)
    let pvRI = 0;
    let bv = bvps;

    for(let t=1; t<=years; t++){
      const ri = (roe - disc) * bv;     // residual income per share for year t (simplified)
      pvRI += ri / Math.pow(1 + disc, t);

      // grow BV by retained earnings: BV_{t} = BV_{t-1} + earnings*retain = BV*(1 + roe*retain)
      bv = bv * (1 + roe * retain);
    }

    // Terminal residual income assumed 0 (conservative)
    const value = bvps + pvRI;

    let pct = NaN;
    if(Number.isFinite(price) && price > 0){
      pct = ((value / price) - 1) * 100;
    }
    return {value, pct};
  }

  // ---------- Output rendering ----------
  function setRes(prefix, res){
    const vEl = $(prefix);
    const pEl = $(prefix + "_pct");
    const sEl = $(prefix + "_s");

    if(!res || !Number.isFinite(res.value)){
      if(vEl) vEl.textContent = "—";
      if(pEl) pEl.textContent = "";
      if(sEl) sEl.textContent = "—";
      return;
    }

    if(vEl) vEl.textContent = fmtMoney(res.value);
    if(pEl) pEl.textContent = fmtPct(res.pct);
    if(sEl){
      const price = parseNum($("in_price")?.value);
      if(Number.isFinite(price) && price > 0){
        sEl.textContent = (window.state.lang === "cz") ? "vs aktuální cena" : "vs current price";
      }else{
        sEl.textContent = (window.state.lang === "cz") ? "vyplň Current price" : "fill Current price";
      }
    }
  }

  function setTargets(baseValue, bearValue, bullValue){
    const mosPct = 0.15; // 15% default
    const target = window.state.mos ? baseValue * (1 - mosPct) : baseValue;
    if($("out_target")) $("out_target").value = Number.isFinite(target) ? fmtMoney(target) : "—";

    if($("out_range")){
      if(Number.isFinite(bearValue) && Number.isFinite(bullValue)){
        $("out_range").value = fmtMoney(bearValue) + " – " + fmtMoney(bullValue);
      }else{
        $("out_range").value = "—";
      }
    }
  }

  // ---------- Sanity check box ----------
  function sanityCheck(basePct){
    const box = $("ui_sanityBox");
    const title = $("ui_sanityTitle");
    const text = $("ui_sanityText");
    if(!box || !title || !text) return;

    const t = (window.TEXTS && window.TEXTS[window.state.lang]) ? window.TEXTS[window.state.lang] : (window.TEXTS?.en || {});
    if(!Number.isFinite(basePct)){
      box.style.display = "none";
      return;
    }

    if(basePct < -80){
      box.style.display = "";
      title.textContent = t.sanityTitle || "Sanity check:";
      text.textContent = t.sanityLow || "Result looks extremely low. Check inputs.";
    }else if(basePct > 200){
      box.style.display = "";
      title.textContent = t.sanityTitle || "Sanity check:";
      text.textContent = t.sanityHigh || "Result looks extremely high. Check inputs.";
    }else{
      box.style.display = "none";
    }
  }

  // ---------- Main compute router ----------
  function computeAll(){
    // Quick: ensure bear/bull updated
    if(window.state.mode === "quick") autoBearBullFromBase();

    const bear = parseNum($("in_bear")?.value);
    const base = parseNum($("in_base")?.value);
    const bull = parseNum($("in_bull")?.value);

    let resBear, resBase, resBull;

    if(window.state.model === "standard"){
      resBear = computeStandard(bear);
      resBase = computeStandard(base);
      resBull = computeStandard(bull);
    }else if(window.state.model === "reit"){
      resBear = computeREIT(bear);
      resBase = computeREIT(base);
      resBull = computeREIT(bull);
    }else if(window.state.model === "financial"){
      // Here scenarios represent ROE
      resBear = computeFinancialRIM(bear);
      resBase = computeFinancialRIM(base);
      resBull = computeFinancialRIM(bull);
    }else{
      window.toast(window.state.lang === "cz"
        ? "Tenhle model zatím není dopočítaný (coming soon)."
        : "This model is not computed yet (coming soon)."
      );
      return;
    }

    // handle common errors
    const err = resBear?.err || resBase?.err || resBull?.err;
    if(err){
      const msg = {
        FCF:  (window.state.lang==="cz") ? "Vyplň FCF (celkem)." : "Fill FCF (total).",
        Shares:(window.state.lang==="cz") ? "Vyplň Shares Outstanding." : "Fill Shares Outstanding.",
        AFFO:(window.state.lang==="cz") ? "Vyplň AFFO per share." : "Fill AFFO per share.",
        BVPS:(window.state.lang==="cz") ? "Vyplň BVPS." : "Fill BVPS.",
        ROE:(window.state.lang==="cz") ? "Vyplň ROE scénáře." : "Fill ROE scenarios.",
        Payout:(window.state.lang==="cz") ? "Payout musí být 0–100." : "Payout must be 0–100.",
        Years:(window.state.lang==="cz") ? "Zkontroluj počet let." : "Check projection years.",
        Discount:(window.state.lang==="cz") ? "Zkontroluj diskont." : "Check discount rate.",
        Terminal:(window.state.lang==="cz") ? "Zkontroluj terminální růst." : "Check terminal growth.",
        DiscTerm:(window.state.lang==="cz") ? "Diskont musí být vyšší než terminální růst." : "Discount rate must be higher than terminal growth."
      }[err] || (window.state.lang==="cz" ? "Zkontroluj vstupy." : "Check inputs.");

      window.toast(msg);
    }

    // render
    setRes("r_bear", resBear);
    setRes("r_base", resBase);
    setRes("r_bull", resBull);

    setTargets(resBase?.value, resBear?.value, resBull?.value);
    sanityCheck(resBase?.pct);

    return {resBear, resBase, resBull};
  }

  // ---------- Demo values ----------
  function fillDemo(){
    // keep your look: just fill depending on model
    if(!$("in_price")) return;

    $("in_price").value = "170";

    if(window.state.model === "standard"){
      $("in_fcf") && ($("in_fcf").value = "70b");
      $("in_shares") && ($("in_shares").value = "12.6b");
      $("in_term") && ($("in_term").value = "2.5");
    }
    if(window.state.model === "financial"){
      $("in_bvps") && ($("in_bvps").value = "6.97");
      $("in_payout") && ($("in_payout").value = "20");
      // scenarios as ROE
      $("in_bear") && ($("in_bear").value = "8");
      $("in_base") && ($("in_base").value = "12");
      $("in_bull") && ($("in_bull").value = "15");
    }
    if(window.state.model === "reit"){
      $("in_affo") && ($("in_affo").value = "2.10");
      $("in_term") && ($("in_term").value = "2.5");
    }

    $("in_years") && ($("in_years").value = "10");
    $("in_disc") && ($("in_disc").value = "9");

    // default scenarios for standard/reit: growth %
    if(window.state.model === "standard" || window.state.model === "reit"){
      $("in_base") && ($("in_base").value = "5");
      if(window.state.mode === "quick") autoBearBullFromBase();
    }

    window.toast(window.state.lang==="cz" ? "Demo vyplněno" : "Demo filled");
  }

  // ---------- Watchlist stub (render helper if your Part 9/10 extends it) ----------
  window.__EA.watch = window.__EA.watch || {};
  window.__EA.watch.renderWatchlist = window.__EA.watch.renderWatchlist || function(){
    // If you already have watchlist logic elsewhere, keep it. This is safe no-op.
  };

  // ---------- Bind buttons ----------
  function bindButtons(){
    $("btn_calc")?.addEventListener("click", (e)=>{ e.preventDefault(); computeAll(); });
    $("btn_fillDemo")?.addEventListener("click", (e)=>{ e.preventDefault(); fillDemo(); });
    // Save to watchlist handled in later part (or your existing code); keep compute now
    $("btn_save")?.addEventListener("click", ()=>{
      window.toast(window.state.lang==="cz"
        ? "Uložení do watchlistu doplníme v další části (nebo použij tvůj stávající kód)."
        : "Watchlist saving will be finalized in the next part (or your existing code)."
      );
    });
  }

  // ---------- Init ----------
  bindAccordion();
  bindModelButtons();
  bindModeButtons();
  bindCurrencyAndMos();

  setActiveModelUI();
  applyModeUI();
  bindButtons();

  // Make sure translations are applied (Part 7 defines applyTexts internally; here we just trigger by toggling language state)
 <!-- ========================= -->
<!-- PART 9/10: WATCHLIST (localStorage) + SAVE + DELETE + EXPORT + PRINT + i18n sync -->
<!-- Paste this directly after:  <!-- PART 8 END --> -->
<!-- ========================= -->

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // ---------- Shared helpers ----------
  const KEY = "ea_watchlist_v1";

  function getTexts(){
    const lang = (window.state && window.state.lang) ? window.state.lang : "en";
    return (window.TEXTS && window.TEXTS[lang]) ? window.TEXTS[lang] : (window.TEXTS?.en || {});
  }

  function getLocale(){
    return (window.state && window.state.lang === "cz") ? "cs-CZ" : "en-US";
  }

  function fmtMoney(x){
    if(!Number.isFinite(x)) return "—";
    const cur = (window.state && window.state.curr) ? window.state.curr : "USD";
    try{
      return new Intl.NumberFormat(getLocale(), {style:"currency", currency:cur, maximumFractionDigits:2}).format(x);
    }catch(e){
      return new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x) + " " + cur;
    }
  }

  function safeJSONParse(s, fallback){
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }

  function loadList(){
    try{
      const raw = localStorage.getItem(KEY);
      const arr = safeJSONParse(raw, []);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }

  function saveList(arr){
    try{
      localStorage.setItem(KEY, JSON.stringify(arr || []));
    }catch(e){}
  }

  function nowISO(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function modelLabel(model){
    const t = getTexts();
    if(model === "standard") return "Standard";
    if(model === "financial") return "Financial";
    if(model === "reit") return "REIT";
    if(model === "growth") return "Growth";
    if(model === "cyc") return "Cyclical";
    if(model === "util") return "Utility";
    return model || "—";
  }

  // ---------- Translate Watchlist UI (fix mixed EN/CZ) ----------
  function applyWatchI18n(){
    const t = getTexts();

    // titles / labels
    if($("ui_watchTitle")) $("ui_watchTitle").textContent = t.watchTitle || "Watchlist";
    if($("ui_watchTag")) $("ui_watchTag").textContent = t.watchTag || "Local storage";

    if($("ui_watchIntroTitle")) $("ui_watchIntroTitle").textContent = t.watchIntroTitle || "Saved calculations";
    if($("ui_watchIntroText")) $("ui_watchIntroText").textContent = t.watchIntroText || "Saved items appear here.";

    if($("btn_export_csv")) $("btn_export_csv").textContent = t.exportCsv || "Export CSV";
    if($("btn_print_pdf")) $("btn_print_pdf").textContent = t.printPdf || "Print / PDF";

    if($("ui_watchFooter")) $("ui_watchFooter").textContent = t.watchFooter || "Note: saved locally.";

    // table headers
    if(t.th){
      $("th_date") && ($("th_date").textContent = t.th.date || "Date");
      $("th_ticker") && ($("th_ticker").textContent = t.th.ticker || "Ticker");
      $("th_price") && ($("th_price").textContent = t.th.price || "Price");
      $("th_model") && ($("th_model").textContent = t.th.model || "Model");
      $("th_bear") && ($("th_bear").textContent = t.th.bear || "Bear");
      $("th_base") && ($("th_base").textContent = t.th.base || "Base");
      $("th_bull") && ($("th_bull").textContent = t.th.bull || "Bull");
      $("th_target") && ($("th_target").textContent = t.th.target || "Target");
      $("th_range") && ($("th_range").textContent = t.th.range || "Range");
      $("th_action") && ($("th_action").textContent = t.th.action || "Action");
    }

    // empty row (render sets too, but keep safe)
    const empty = $("watchEmpty");
    if(empty) empty.textContent = t.empty || "Nothing saved yet.";
  }

  // ---------- Render table ----------
  function renderWatchlist(){
    applyWatchI18n();

    const t = getTexts();
    const tbody = $("watchTbody");
    if(!tbody) return;

    const list = loadList();

    if(list.length === 0){
      tbody.innerHTML = `<tr><td colspan="10" class="muted" id="watchEmpty">${t.empty || "Nothing saved yet."}</td></tr>`;
      return;
    }

    const rows = list.map((it, idx)=>{
      const bear = Number.isFinite(it.bear) ? fmtMoney(it.bear) : "—";
      const base = Number.isFinite(it.base) ? fmtMoney(it.base) : "—";
      const bull = Number.isFinite(it.bull) ? fmtMoney(it.bull) : "—";
      const target = Number.isFinite(it.target) ? fmtMoney(it.target) : "—";
      const range = (Number.isFinite(it.bear) && Number.isFinite(it.bull)) ? `${fmtMoney(it.bear)} – ${fmtMoney(it.bull)}` : "—";

      const price = Number.isFinite(it.price) ? fmtMoney(it.price) : (it.priceRaw || "—");
      const ticker = (it.ticker || "—");

      const delLbl = t.del || "Delete";

      return `
        <tr data-idx="${idx}">
          <td class="nowrap">${it.date || "—"}</td>
          <td class="nowrap">${escapeHtml(ticker)}</td>
          <td class="right nowrap">${price}</td>
          <td class="right nowrap">${escapeHtml(modelLabel(it.model))}</td>
          <td class="right nowrap">${bear}</td>
          <td class="right nowrap">${base}</td>
          <td class="right nowrap">${bull}</td>
          <td class="right nowrap">${target}</td>
          <td class="right nowrap">${range}</td>
          <td class="right nowrap">
            <button class="secondary wl_del" data-del="${idx}">${delLbl}</button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.innerHTML = rows;

    // bind delete buttons
    tbody.querySelectorAll(".wl_del").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = parseInt(btn.getAttribute("data-del"), 10);
        if(!Number.isFinite(i)) return;
        const arr = loadList();
        arr.splice(i, 1);
        saveList(arr);
        renderWatchlist();
        window.toast && window.toast((window.state?.lang==="cz") ? "Smazáno" : "Deleted");
      });
    });
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Save current results ----------
  function getCurrentComputedValues(){
    // read from UI outputs (already formatted), but also keep numeric from compute step if available
    // we prefer numeric values stored in window.__EA.last if computeAll set it (PART 8 returns object but didn't store)
    // so we compute from displayed money strings only as fallback; best is: re-run computeAll if exists
    let computed = null;

    // If computeAll exists in global scope, call it and get numeric results
    try{
      if(typeof window.computeAll === "function"){
        computed = window.computeAll();
      }
    }catch(e){}

    // fallback: try reading internal last results if present
    if(!computed && window.__EA && window.__EA.last) computed = window.__EA.last;

    // fallback: nothing
    return computed;
  }

  function saveToWatchlist(){
    const t = getTexts();

    const ticker = String($("in_ticker")?.value || $("in_ticker")?.textContent || "").trim()
      || String($("in_ticker")?.getAttribute("value") || "").trim()
      || String($("ui_tickerVal")?.textContent || "").trim();

    const priceRaw = String($("in_price")?.value || "").trim();
    const price = (window.__EA?.num?.parseNum) ? window.__EA.num.parseNum(priceRaw) : Number(priceRaw);

    // Ensure results exist: trigger calculate if possible
    try{
      $("btn_calc")?.click();
    }catch(e){}

    // Read result numbers from PART 8 fields (strings) and try to parse from DOM
    // Best is to read numeric by re-running compute via btn_calc. If not possible, we store strings only.
    const getValText = (id)=>String($(id)?.textContent || "").trim();
    const bearTxt = getValText("r_bear");
    const baseTxt = getValText("r_base");
    const bullTxt = getValText("r_bull");

    // If still not computed, block save
    if(!bearTxt || bearTxt === "—" || !baseTxt || baseTxt === "—" || !bullTxt || bullTxt === "—"){
      window.toast && window.toast((window.state?.lang==="cz") ? "Nejdřív klikni Calculate." : "Click Calculate first.");
      return;
    }

    // We store numeric values only if we can (from internal recompute not guaranteed),
    // but we can parse by stripping non-numeric; currency parsing is messy across locales.
    // So: store formatted + also store raw inputs so user can re-check.
    const model = window.state?.model || "standard";

    const targetStr = String($("out_target")?.value || "").trim();
    const rangeStr  = String($("out_range")?.value || "").trim();

    // Build entry
    const entry = {
      date: nowISO(),
      ticker: ticker || (window.state?.lang==="cz" ? "Bez názvu" : "Untitled"),
      price: Number.isFinite(price) ? price : null,
      priceRaw: priceRaw || null,
      model,
      // keep formatted strings too for reliability
      bearStr: bearTxt, baseStr: baseTxt, bullStr: bullTxt,
      targetStr,
      rangeStr
    };

    // Try to also store numeric fair values from compute engine (best effort)
    try{
      // In PART 8, computeAll() returns {resBear,resBase,resBull} but isn't global.
      // We can approximate numeric by reading hidden: none. So leave numeric empty.
      entry.bear = null;
      entry.base = null;
      entry.bull = null;
      entry.target = null;
    }catch(e){}

    // Save
    const arr = loadList();
    arr.unshift(entry);
    saveList(arr);
    renderWatchlist();

    window.toast && window.toast(t.save ? t.save : "Saved");
  }

  // ---------- Export CSV ----------
  function exportCSV(){
    const list = loadList();
    const t = getTexts();

    if(list.length === 0){
      window.toast && window.toast((window.state?.lang==="cz") ? "Watchlist je prázdný." : "Watchlist is empty.");
      return;
    }

    const headers = ["Date","Ticker","Price","Model","Bear","Base","Bull","Target","Range"];
    const lines = [headers.join(",")];

    list.forEach(it=>{
      const row = [
        it.date || "",
        it.ticker || "",
        (it.priceRaw || (Number.isFinite(it.price) ? String(it.price) : "")),
        it.model || "",
        it.bearStr || "",
        it.baseStr || "",
        it.bullStr || "",
        it.targetStr || "",
        it.rangeStr || ""
      ].map(csvEscape).join(",");
      lines.push(row);
    });

    const csv = lines.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "equity-analyzer-watchlist.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    window.toast && window.toast((window.state?.lang==="cz") ? "CSV staženo" : "CSV downloaded");
  }

  function csvEscape(v){
    const s = String(v ?? "");
    if(s.includes(",") || s.includes('"') || s.includes("\n")){
      return '"' + s.replaceAll('"','""') + '"';
    }
    return s;
  }

  // ---------- Print / PDF ----------
  function printWatchlist(){
    // simplest: print current page; user can "Save as PDF"
    window.print();
  }

  // ---------- Bind buttons ----------
  function bindWatchButtons(){
    $("btn_save")?.addEventListener("click", (e)=>{
      e.preventDefault();
      saveToWatchlist();
    });

    $("btn_export_csv")?.addEventListener("click", (e)=>{
      e.preventDefault();
      exportCSV();
    });

    $("btn_print_pdf")?.addEventListener("click", (e)=>{
      e.preventDefault();
      printWatchlist();
    });
  }

  // expose for other parts
  window.__EA = window.__EA || {};
  window.__EA.watch = window.__EA.watch || {};
  window.__EA.watch.renderWatchlist = renderWatchlist;
  window.__EA.watch.saveToWatchlist = saveToWatchlist;

  // Init
  bindWatchButtons();
  renderWatchlist();

})();
</script>

<!-- PART 9 END --><!-- ========================= -->
<!-- PART 10/10: FIX i18n (EN default) + GLOBAL computeAll + INPUT BIG-NUM FORMAT + DISCLAIMER -->
<!-- Paste this directly after:  <!-- PART 9 END --> -->
<!-- ========================= -->

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  window.__EA = window.__EA || {};
  window.__EA.num = window.__EA.num || {};

  // ---------- Robust number parsing: supports 70b, 350m, 1.2k, 12.6b, commas/spaces ----------
  function parseSmartNumber(v){
    if(v === null || v === undefined) return NaN;
    let s = String(v).trim();
    if(!s) return NaN;

    // normalize spaces + comma decimals
    s = s.replace(/\s+/g,"").replace(",", ".");

    // suffix multipliers
    // k=1e3, m=1e6, b=1e9, t=1e12
    const m = s.match(/^(-?\d+(\.\d+)?)([kmbt])$/i);
    if(m){
      const n = Number(m[1]);
      if(!Number.isFinite(n)) return NaN;
      const suf = m[3].toLowerCase();
      const mult = (suf==="k")?1e3:(suf==="m")?1e6:(suf==="b")?1e9:(suf==="t")?1e12:1;
      return n * mult;
    }

    // plain number
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function formatCompact(n){
    if(!Number.isFinite(n)) return "";
    const abs = Math.abs(n);
    const sign = n < 0 ? "-" : "";
    const fmt = (x)=> new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x);

    if(abs >= 1e12) return sign + fmt(abs/1e12) + "t";
    if(abs >= 1e9)  return sign + fmt(abs/1e9)  + "b";
    if(abs >= 1e6)  return sign + fmt(abs/1e6)  + "m";
    if(abs >= 1e3)  return sign + fmt(abs/1e3)  + "k";
    return sign + fmt(abs);
  }

  window.__EA.num.parseNum = parseSmartNumber;

  // ---------- Locale + language ----------
  function getLocale(){
    return (window.state?.lang === "cz") ? "cs-CZ" : "en-US";
  }

  function getTexts(){
    const lang = window.state?.lang || "en";
    return (window.TEXTS && window.TEXTS[lang]) ? window.TEXTS[lang] : (window.TEXTS?.en || {});
  }

  // ---------- Force EN as default + persist ----------
  function initLanguageDefault(){
    try{
      const saved = localStorage.getItem("ea_lang");
      if(saved === "cz" || saved === "en"){
        window.state.lang = saved;
      }else{
        window.state.lang = "en"; // default EN
        localStorage.setItem("ea_lang","en");
      }
    }catch(e){
      window.state.lang = "en";
    }
  }

  // ---------- Apply all UI texts (full pass, avoids mixed EN/CZ) ----------
  function applyAllTexts(){
    const t = getTexts();

    // Top / global labels
    $("ui_sub") && ($("ui_sub").textContent = t.sub || "");
    $("ui_langLbl") && ($("ui_langLbl").textContent = t.langLbl || "Language");
    $("ui_modeLbl") && ($("ui_modeLbl").textContent = t.modeLbl || "Mode");

    $("ui_valTitle") && ($("ui_valTitle").textContent = t.valTitle || "Fair value");
    $("ui_valTag") && ($("ui_valTag").textContent = t.valTag || "");

    $("ui_inputsMain") && ($("ui_inputsMain").textContent = t.inputsMain || "Core inputs");
    $("ui_tickerLbl") && ($("ui_tickerLbl").textContent = t.tickerLbl || "Ticker");
    $("ui_priceLbl") && ($("ui_priceLbl").textContent = t.priceLbl || "Current price");

    $("ui_fcfLbl") && ($("ui_fcfLbl").textContent = t.fcfLbl || "FCF (total)");
    $("ui_fcfMini") && ($("ui_fcfMini").textContent = t.fcfMini || "");
    $("ui_sharesLbl") && ($("ui_sharesLbl").textContent = t.sharesLbl || "Shares Outstanding");
    $("ui_sharesMini") && ($("ui_sharesMini").textContent = t.sharesMini || "");

    $("ui_bvpsLbl") && ($("ui_bvpsLbl").textContent = t.bvpsLbl || "BVPS");
    $("ui_roeLbl") && ($("ui_roeLbl").textContent = t.roeLbl || "ROE (%)");
    $("ui_payoutLbl") && ($("ui_payoutLbl").textContent = t.payoutLbl || "Payout (%)");
    $("ui_sharesFinLbl") && ($("ui_sharesFinLbl").textContent = t.sharesFinLbl || "Shares (optional)");

    $("ui_affoLbl") && ($("ui_affoLbl").textContent = t.affoLbl || "AFFO per share");

    $("ui_yearsLbl") && ($("ui_yearsLbl").textContent = t.yearsLbl || "Projection years");
    $("ui_discLbl") && ($("ui_discLbl").textContent = t.discLbl || "Discount rate (%)");
    $("ui_termLbl") && ($("ui_termLbl").textContent = t.termLbl || "Terminal growth (%)");
    $("ui_termMini") && ($("ui_termMini").textContent = t.termMini || "");

    $("ui_inputsScen") && ($("ui_inputsScen").textContent = t.inputsScen || "Scenarios");
    $("ui_inputsScenText") && ($("ui_inputsScenText").textContent = t.inputsScenText || "");
    $("ui_scenTipText") && ($("ui_scenTipText").textContent = t.scenTipText || "");

    $("ui_bearLbl") && ($("ui_bearLbl").textContent = t.bearLbl || "Bear");
    $("ui_baseLbl") && ($("ui_baseLbl").textContent = t.baseLbl || "Base");
    $("ui_bullLbl") && ($("ui_bullLbl").textContent = t.bullLbl || "Bull");

    $("ui_targetsTitle") && ($("ui_targetsTitle").textContent = t.targetsTitle || "Target & Range");
    $("ui_targetsText") && ($("ui_targetsText").textContent = t.targetsText || "");
    $("ui_targetLbl") && ($("ui_targetLbl").textContent = t.targetLbl || "Target price");
    $("ui_rangeLbl") && ($("ui_rangeLbl").textContent = t.rangeLbl || "Fair value range");

    $("btn_calc") && ($("btn_calc").textContent = t.calc || "Calculate");
    $("btn_save") && ($("btn_save").textContent = t.save || "Save to Watchlist");
    $("btn_fillDemo") && ($("btn_fillDemo").textContent = t.demo || "Demo values");
    $("ui_saveNote") && ($("ui_saveNote").textContent = t.saveNote || "");

    // Watchlist drawer
    $("ui_watchTitle") && ($("ui_watchTitle").textContent = t.watchTitle || "Watchlist");
    $("ui_watchTag") && ($("ui_watchTag").textContent = t.watchTag || "Local storage");
    $("ui_watchIntroTitle") && ($("ui_watchIntroTitle").textContent = t.watchIntroTitle || "");
    $("ui_watchIntroText") && ($("ui_watchIntroText").textContent = t.watchIntroText || "");
    $("btn_export_csv") && ($("btn_export_csv").textContent = t.exportCsv || "Export CSV");
    $("btn_print_pdf") && ($("btn_print_pdf").textContent = t.printPdf || "Print / PDF");
    $("ui_watchFooter") && ($("ui_watchFooter").textContent = t.watchFooter || "");

    // Guide drawer headings
    $("ui_guideTitle") && ($("ui_guideTitle").textContent = t.guideTitle || "Guide");
    $("ui_guideTag") && ($("ui_guideTag").textContent = t.guideTag || "");
    $("ui_guideHead1") && ($("ui_guideHead1").textContent = t.guideHead1 || "");
    $("ui_guideHead2") && ($("ui_guideHead2").textContent = t.guideHead2 || "");
    $("ui_guideHead3") && ($("ui_guideHead3").textContent = t.guideHead3 || "");

    // Footer disclaimer (force correct for Play Store)
    const extraDisclaimerEN =
      "Educational tool only • Not financial advice • No guarantees • Use at your own risk.";
    const extraDisclaimerCZ =
      "Pouze vzdělávací nástroj • Nejedná se o finanční doporučení • Bez záruk • Použití na vlastní riziko.";
    $("ui_footer") && ($("ui_footer").textContent = (window.state.lang==="cz")
      ? (t.footer || extraDisclaimerCZ)
      : (t.footer || extraDisclaimerEN)
    );

    // Make sure Watchlist table gets re-rendered with language labels
    window.__EA?.watch?.renderWatchlist && window.__EA.watch.renderWatchlist();
  }

  // ---------- Language switch binding ----------
  function bindLangSelector(){
    const sel = $("langSel");
    if(!sel) return;

    // keep select value aligned
    sel.value = window.state.lang || "en";

    sel.addEventListener("change", ()=>{
      window.state.lang = sel.value === "cz" ? "cz" : "en";
      try{ localStorage.setItem("ea_lang", window.state.lang); }catch(e){}
      applyAllTexts();
      // also refresh hint titles
      bindHints();
      window.toast && window.toast(window.state.lang==="cz" ? "Čeština" : "English");
    });
  }

  // ---------- Hint click opens modal; hover shows title in quick mode ----------
  function bindHints(){
    const t = getTexts();
    document.querySelectorAll(".hint[data-help]").forEach(h=>{
      h.onclick = null;
      h.onmouseenter = null;

      h.addEventListener("click", ()=>{
        const key = h.getAttribute("data-help");
        const help = t.helps && t.helps[key];
        if(!help) return;
        window.openModal(help.t, `<div style="opacity:.95; line-height:1.35">${help.b}</div>`);
      });

      h.addEventListener("mouseenter", ()=>{
        if(window.state?.mode !== "quick") return;
        const key = h.getAttribute("data-help");
        const help = t.helps && t.helps[key];
        if(!help) return;
        h.setAttribute("title", help.b);
      });
    });
  }

  // ---------- Make computeAll GLOBAL + store last result (fix: classic calc not working / save needs values) ----------
  // Re-implement compute using the working engines from PART 8, but accessible globally here.
  function computeStandardDCF(growthPct){
    const price = parseSmartNumber($("in_price")?.value);
    const fcf = parseSmartNumber($("in_fcf")?.value);
    const shares = parseSmartNumber($("in_shares")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);
    const termPct = parseSmartNumber($("in_term")?.value);

    if(!(fcf > 0)) return {err:"FCF"};
    if(!(shares > 0)) return {err:"Shares"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const r = discPct/100;
    const gT = termPct/100;
    const g = (growthPct||0)/100;
    if(r <= gT) return {err:"DiscTerm"};

    let pv = 0;
    for(let y=1; y<=years; y++){
      const cf = fcf * Math.pow(1+g, y);
      pv += cf / Math.pow(1+r, y);
    }
    const cfN = fcf * Math.pow(1+g, years);
    const tv = (cfN * (1+gT)) / (r - gT);
    const pvTv = tv / Math.pow(1+r, years);

    const perShare = (pv + pvTv) / shares;
    const pct = (Number.isFinite(price) && price>0) ? ((perShare/price)-1)*100 : NaN;
    return {value: perShare, pct};
  }

  function computeReitDCF(growthPct){
    const price = parseSmartNumber($("in_price")?.value);
    const affo = parseSmartNumber($("in_affo")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);
    const termPct = parseSmartNumber($("in_term")?.value);

    if(!(affo > 0)) return {err:"AFFO"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const r = discPct/100;
    const gT = termPct/100;
    const g = (growthPct||0)/100;
    if(r <= gT) return {err:"DiscTerm"};

    let pv = 0;
    for(let y=1; y<=years; y++){
      const cf = affo * Math.pow(1+g, y);
      pv += cf / Math.pow(1+r, y);
    }
    const cfN = affo * Math.pow(1+g, years);
    const tv = (cfN * (1+gT)) / (r - gT);
    const pvTv = tv / Math.pow(1+r, years);

    const perShare = pv + pvTv;
    const pct = (Number.isFinite(price) && price>0) ? ((perShare/price)-1)*100 : NaN;
    return {value: perShare, pct};
  }

  function computeFinancialRIM(roePct){
    const price = parseSmartNumber($("in_price")?.value);
    const bvps = parseSmartNumber($("in_bvps")?.value);
    const payoutPct = parseSmartNumber($("in_payout")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);

    if(!(bvps > 0)) return {err:"BVPS"};
    if(!Number.isFinite(roePct)) return {err:"ROE"};
    if(!(payoutPct >= 0 && payoutPct <= 100)) return {err:"Payout"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};

    const r = discPct/100;
    const roe = roePct/100;
    const payout = payoutPct/100;
    const retain = 1 - payout;

    let bv = bvps;
    let pvRI = 0;

    for(let y=1; y<=years; y++){
      const ri = (roe - r) * bv;             // residual income per share
      pvRI += ri / Math.pow(1+r, y);
      bv = bv * (1 + roe * retain);         // grow BV
    }

    const value = bvps + pvRI;              // terminal RI assumed 0
    const pct = (Number.isFinite(price) && price>0) ? ((value/price)-1)*100 : NaN;
    return {value, pct};
  }

  function fmtMoney(x){
    if(!Number.isFinite(x)) return "—";
    const cur = window.state?.curr || "USD";
    try{
      return new Intl.NumberFormat(getLocale(), {
        style:"currency", currency:cur, maximumFractionDigits:2
      }).format(x);
    }catch(e){
      return new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x) + " " + cur;
    }
  }

  function fmtPct(x){
    if(!Number.isFinite(x)) return "";
    const sign = x > 0 ? "+" : "";
    return " " + sign + new Intl.NumberFormat(getLocale(), {maximumFractionDigits:1}).format(x) + "%";
  }

  function paint(prefix, obj){
    const v = $(prefix);
    const p = $(prefix + "_pct");
    const s = $(prefix + "_s");
    if(!obj || !Number.isFinite(obj.value)){
      v && (v.textContent="—");
      p && (p.textContent="");
      s && (s.textContent="—");
      return;
    }
    v && (v.textContent = fmtMoney(obj.value));
    p && (p.textContent = fmtPct(obj.pct));
    s && (s.textContent = (window.state.lang==="cz") ? "vs aktuální cena" : "vs current price");
  }

  function setTargets(baseVal, bearVal, bullVal){
    const outT = $("out_target");
    const outR = $("out_range");
    // default MoS 15% (can be changed later)
    const mos = window.state?.mos ? 0.15 : 0;
    const target = Number.isFinite(baseVal) ? baseVal * (1 - mos) : NaN;
    outT && (outT.value = Number.isFinite(target) ? fmtMoney(target) : "—");
    outR && (outR.value = (Number.isFinite(bearVal) && Number.isFinite(bullVal))
      ? (fmtMoney(bearVal) + " – " + fmtMoney(bullVal))
      : "—"
    );
  }

  function autoQuickBearBull(){
    if(window.state?.mode !== "quick") return;
    const base = parseSmartNumber($("in_base")?.value);
    if(!Number.isFinite(base)) return;
    $("in_bear") && ($("in_bear").value = String(Math.max(0, base - 2)));
    $("in_bull") && ($("in_bull").value = String(base + 2));
  }

  // GLOBAL computeAll used by Save/Watchlist
  window.computeAll = function(){
    autoQuickBearBull();

    const t = getTexts();

    const bear = parseSmartNumber($("in_bear")?.value);
    const base = parseSmartNumber($("in_base")?.value);
    const bull = parseSmartNumber($("in_bull")?.value);

    let rb, r0, ru;

    const model = window.state?.model || "standard";
    if(model === "standard"){
      rb = computeStandardDCF(bear);
      r0 = computeStandardDCF(base);
      ru = computeStandardDCF(bull);
    }else if(model === "reit"){
      rb = computeReitDCF(bear);
      r0 = computeReitDCF(base);
      ru = computeReitDCF(bull);
    }else if(model === "financial"){
      rb = computeFinancialRIM(bear);
      r0 = computeFinancialRIM(base);
      ru = computeFinancialRIM(bull);
    }else{
      window.toast && window.toast(window.state.lang==="cz"
        ? "Tenhle model doplníme později (coming soon)."
        : "This model will be added later (coming soon)."
      );
      return null;
    }

    const err = rb?.err || r0?.err || ru?.err;
    if(err){
      const msg = {
        FCF: (window.state.lang==="cz") ? "Vyplň FCF (celkem). Můžeš psát např. 70b." : "Fill FCF (total). You can type e.g. 70b.",
        Shares: (window.state.lang==="cz") ? "Vyplň Shares. Můžeš psát např. 12.6b." : "Fill Shares. You can type e.g. 12.6b.",
        AFFO: (window.state.lang==="cz") ? "Vyplň AFFO/akcii." : "Fill AFFO per share.",
        BVPS: (window.state.lang==="cz") ? "Vyplň BVPS." : "Fill BVPS.",
        ROE: (window.state.lang==="cz") ? "Vyplň scénáře (ROE)." : "Fill scenarios (ROE).",
        Payout: (window.state.lang==="cz") ? "Payout musí být 0–100." : "Payout must be 0–100.",
        Years: (window.state.lang==="cz") ? "Zkontroluj roky (1–30)." : "Check years (1–30).",
        Discount: (window.state.lang==="cz") ? "Zkontroluj diskont." : "Check discount rate.",
        Terminal: (window.state.lang==="cz") ? "Zkontroluj terminální růst." : "Check terminal growth.",
        DiscTerm: (window.state.lang==="cz") ? "Diskont musí být > terminál." : "Discount must be > terminal."
      }[err] || (window.state.lang==="cz" ? "Zkontroluj vstupy." : "Check inputs.");
      window.toast && window.toast(msg);
      // still paint blanks to be safe
    }

    paint("r_bear", rb);
    paint("r_base", r0);
    paint("r_bull", ru);
    setTargets(r0?.value, rb?.value, ru?.value);

    // store last numeric result for watchlist
    window.__EA.lastResult = {
      ts: Date.now(),
      ticker: String($("in_ticker")?.value || "").trim().toUpperCase(),
      model,
      currency: window.state?.curr || "USD",
      price: parseSmartNumber($("in_price")?.value),
      bear: rb?.value, base: r0?.value, bull: ru?.value,
      target: (window.state?.mos ? (r0?.value * (1-0.15)) : r0?.value)
    };

    window.toast && window.toast(window.state.lang==="cz" ? "Hotovo ✅" : "Done ✅");
    return {rb, r0, ru};
  };

  // Ensure Calculate button uses global computeAll
  $("btn_calc")?.addEventListener("click", (e)=>{
    e.preventDefault();
    window.computeAll();
  });

  // ---------- Improve Watchlist saving to store numeric fair values too ----------
  // Patch PART 9 save if present
  if(window.__EA?.watch?.saveToWatchlist){
    const origSave = window.__EA.watch.saveToWatchlist;
    window.__EA.watch.saveToWatchlist = function(){
      // compute first to guarantee numeric lastResult
      window.computeAll && window.computeAll();

      // If PART 9 saves strings only, we add numeric fields on top
      origSave();

      // After save, patch the newest item with numeric values if possible
      try{
        const KEY = "ea_watchlist_v1";
        const raw = localStorage.getItem(KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if(Array.isArray(arr) && arr.length && window.__EA.lastResult){
          arr[0].bear = window.__EA.lastResult.bear;
          arr[0].base = window.__EA.lastResult.base;
          arr[0].bull = window.__EA.lastResult.bull;
          arr[0].target = window.__EA.lastResult.target;
          arr[0].price = window.__EA.lastResult.price;
          localStorage.setItem(KEY, JSON.stringify(arr));
          window.__EA.watch.renderWatchlist && window.__EA.watch.renderWatchlist();
        }
      }catch(e){}
    };
  }

  // ---------- Input beautifier: on blur convert large raw number to compact suffix ----------
  function bindBigNumberInputs(){
    const ids = ["in_fcf","in_shares","in_affo","in_bvps","in_price"];
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;

      el.addEventListener("blur", ()=>{
        const n = parseSmartNumber(el.value);
        if(!Number.isFinite(n)) return;
        // For shares/FCF, compact is helpful; for price/bvps keep normal if small
        if(id === "in_price" || id === "in_bvps" || id === "in_affo"){
          // keep as normal number with locale decimals
          el.value = new Intl.NumberFormat(getLocale(), {maximumFractionDigits:4}).format(n);
        }else{
          el.value = formatCompact(n);
        }
      });
    });

    // update quick bear/bull when base changes
    $("in_base")?.addEventListener("input", ()=>autoQuickBearBull());
  }

  // ---------- Guide disclaimer injection (Play Store safe) ----------
  function injectDisclaimerIntoGuide(){
    const guideBody = $("guideBody");
    if(!guideBody) return;

    // avoid duplicate insert
    if($("ea_disclaimer_block")) return;

    const block = document.createElement("div");
    block.className = "card";
    block.id = "ea_disclaimer_block";
    block.style.marginTop = "12px";

    const isCZ = (window.state.lang === "cz");
    block.innerHTML = `
      <h3>${isCZ ? "4) Důležité upozornění" : "4) Important disclaimer"}</h3>
      <div class="muted"<!-- ========================= -->
<!-- PART 10/10: FIX i18n (EN default) + GLOBAL computeAll + INPUT BIG-NUM FORMAT + DISCLAIMER -->
<!-- Paste this directly after:  <!-- PART 9 END --> -->
<!-- ========================= -->

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  window.__EA = window.__EA || {};
  window.__EA.num = window.__EA.num || {};

  // ---------- Robust number parsing: supports 70b, 350m, 1.2k, 12.6b, commas/spaces ----------
  function parseSmartNumber(v){
    if(v === null || v === undefined) return NaN;
    let s = String(v).trim();
    if(!s) return NaN;

    // normalize spaces + comma decimals
    s = s.replace(/\s+/g,"").replace(",", ".");

    // suffix multipliers
    // k=1e3, m=1e6, b=1e9, t=1e12
    const m = s.match(/^(-?\d+(\.\d+)?)([kmbt])$/i);
    if(m){
      const n = Number(m[1]);
      if(!Number.isFinite(n)) return NaN;
      const suf = m[3].toLowerCase();
      const mult = (suf==="k")?1e3:(suf==="m")?1e6:(suf==="b")?1e9:(suf==="t")?1e12:1;
      return n * mult;
    }

    // plain number
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function formatCompact(n){
    if(!Number.isFinite(n)) return "";
    const abs = Math.abs(n);
    const sign = n < 0 ? "-" : "";
    const fmt = (x)=> new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x);

    if(abs >= 1e12) return sign + fmt(abs/1e12) + "t";
    if(abs >= 1e9)  return sign + fmt(abs/1e9)  + "b";
    if(abs >= 1e6)  return sign + fmt(abs/1e6)  + "m";
    if(abs >= 1e3)  return sign + fmt(abs/1e3)  + "k";
    return sign + fmt(abs);
  }

  window.__EA.num.parseNum = parseSmartNumber;

  // ---------- Locale + language ----------
  function getLocale(){
    return (window.state?.lang === "cz") ? "cs-CZ" : "en-US";
  }

  function getTexts(){
    const lang = window.state?.lang || "en";
    return (window.TEXTS && window.TEXTS[lang]) ? window.TEXTS[lang] : (window.TEXTS?.en || {});
  }

  // ---------- Force EN as default + persist ----------
  function initLanguageDefault(){
    try{
      const saved = localStorage.getItem("ea_lang");
      if(saved === "cz" || saved === "en"){
        window.state.lang = saved;
      }else{
        window.state.lang = "en"; // default EN
        localStorage.setItem("ea_lang","en");
      }
    }catch(e){
      window.state.lang = "en";
    }
  }

  // ---------- Apply all UI texts (full pass, avoids mixed EN/CZ) ----------
  function applyAllTexts(){
    const t = getTexts();

    // Top / global labels
    $("ui_sub") && ($("ui_sub").textContent = t.sub || "");
    $("ui_langLbl") && ($("ui_langLbl").textContent = t.langLbl || "Language");
    $("ui_modeLbl") && ($("ui_modeLbl").textContent = t.modeLbl || "Mode");

    $("ui_valTitle") && ($("ui_valTitle").textContent = t.valTitle || "Fair value");
    $("ui_valTag") && ($("ui_valTag").textContent = t.valTag || "");

    $("ui_inputsMain") && ($("ui_inputsMain").textContent = t.inputsMain || "Core inputs");
    $("ui_tickerLbl") && ($("ui_tickerLbl").textContent = t.tickerLbl || "Ticker");
    $("ui_priceLbl") && ($("ui_priceLbl").textContent = t.priceLbl || "Current price");

    $("ui_fcfLbl") && ($("ui_fcfLbl").textContent = t.fcfLbl || "FCF (total)");
    $("ui_fcfMini") && ($("ui_fcfMini").textContent = t.fcfMini || "");
    $("ui_sharesLbl") && ($("ui_sharesLbl").textContent = t.sharesLbl || "Shares Outstanding");
    $("ui_sharesMini") && ($("ui_sharesMini").textContent = t.sharesMini || "");

    $("ui_bvpsLbl") && ($("ui_bvpsLbl").textContent = t.bvpsLbl || "BVPS");
    $("ui_roeLbl") && ($("ui_roeLbl").textContent = t.roeLbl || "ROE (%)");
    $("ui_payoutLbl") && ($("ui_payoutLbl").textContent = t.payoutLbl || "Payout (%)");
    $("ui_sharesFinLbl") && ($("ui_sharesFinLbl").textContent = t.sharesFinLbl || "Shares (optional)");

    $("ui_affoLbl") && ($("ui_affoLbl").textContent = t.affoLbl || "AFFO per share");

    $("ui_yearsLbl") && ($("ui_yearsLbl").textContent = t.yearsLbl || "Projection years");
    $("ui_discLbl") && ($("ui_discLbl").textContent = t.discLbl || "Discount rate (%)");
    $("ui_termLbl") && ($("ui_termLbl").textContent = t.termLbl || "Terminal growth (%)");
    $("ui_termMini") && ($("ui_termMini").textContent = t.termMini || "");

    $("ui_inputsScen") && ($("ui_inputsScen").textContent = t.inputsScen || "Scenarios");
    $("ui_inputsScenText") && ($("ui_inputsScenText").textContent = t.inputsScenText || "");
    $("ui_scenTipText") && ($("ui_scenTipText").textContent = t.scenTipText || "");

    $("ui_bearLbl") && ($("ui_bearLbl").textContent = t.bearLbl || "Bear");
    $("ui_baseLbl") && ($("ui_baseLbl").textContent = t.baseLbl || "Base");
    $("ui_bullLbl") && ($("ui_bullLbl").textContent = t.bullLbl || "Bull");

    $("ui_targetsTitle") && ($("ui_targetsTitle").textContent = t.targetsTitle || "Target & Range");
    $("ui_targetsText") && ($("ui_targetsText").textContent = t.targetsText || "");
    $("ui_targetLbl") && ($("ui_targetLbl").textContent = t.targetLbl || "Target price");
    $("ui_rangeLbl") && ($("ui_rangeLbl").textContent = t.rangeLbl || "Fair value range");

    $("btn_calc") && ($("btn_calc").textContent = t.calc || "Calculate");
    $("btn_save") && ($("btn_save").textContent = t.save || "Save to Watchlist");
    $("btn_fillDemo") && ($("btn_fillDemo").textContent = t.demo || "Demo values");
    $("ui_saveNote") && ($("ui_saveNote").textContent = t.saveNote || "");

    // Watchlist drawer
    $("ui_watchTitle") && ($("ui_watchTitle").textContent = t.watchTitle || "Watchlist");
    $("ui_watchTag") && ($("ui_watchTag").textContent = t.watchTag || "Local storage");
    $("ui_watchIntroTitle") && ($("ui_watchIntroTitle").textContent = t.watchIntroTitle || "");
    $("ui_watchIntroText") && ($("ui_watchIntroText").textContent = t.watchIntroText || "");
    $("btn_export_csv") && ($("btn_export_csv").textContent = t.exportCsv || "Export CSV");
    $("btn_print_pdf") && ($("btn_print_pdf").textContent = t.printPdf || "Print / PDF");
    $("ui_watchFooter") && ($("ui_watchFooter").textContent = t.watchFooter || "");

    // Guide drawer headings
    $("ui_guideTitle") && ($("ui_guideTitle").textContent = t.guideTitle || "Guide");
    $("ui_guideTag") && ($("ui_guideTag").textContent = t.guideTag || "");
    $("ui_guideHead1") && ($("ui_guideHead1").textContent = t.guideHead1 || "");
    $("ui_guideHead2") && ($("ui_guideHead2").textContent = t.guideHead2 || "");
    $("ui_guideHead3") && ($("ui_guideHead3").textContent = t.guideHead3 || "");

    // Footer disclaimer (force correct for Play Store)
    const extraDisclaimerEN =
      "Educational tool only • Not financial advice • No guarantees • Use at your own risk.";
    const extraDisclaimerCZ =
      "Pouze vzdělávací nástroj • Nejedná se o finanční doporučení • Bez záruk • Použití na vlastní riziko.";
    $("ui_footer") && ($("ui_footer").textContent = (window.state.lang==="cz")
      ? (t.footer || extraDisclaimerCZ)
      : (t.footer || extraDisclaimerEN)
    );

    // Make sure Watchlist table gets re-rendered with language labels
    window.__EA?.watch?.renderWatchlist && window.__EA.watch.renderWatchlist();
  }

  // ---------- Language switch binding ----------
  function bindLangSelector(){
    const sel = $("langSel");
    if(!sel) return;

    // keep select value aligned
    sel.value = window.state.lang || "en";

    sel.addEventListener("change", ()=>{
      window.state.lang = sel.value === "cz" ? "cz" : "en";
      try{ localStorage.setItem("ea_lang", window.state.lang); }catch(e){}
      applyAllTexts();
      // also refresh hint titles
      bindHints();
      window.toast && window.toast(window.state.lang==="cz" ? "Čeština" : "English");
    });
  }

  // ---------- Hint click opens modal; hover shows title in quick mode ----------
  function bindHints(){
    const t = getTexts();
    document.querySelectorAll(".hint[data-help]").forEach(h=>{
      h.onclick = null;
      h.onmouseenter = null;

      h.addEventListener("click", ()=>{
        const key = h.getAttribute("data-help");
        const help = t.helps && t.helps[key];
        if(!help) return;
        window.openModal(help.t, `<div style="opacity:.95; line-height:1.35">${help.b}</div>`);
      });

      h.addEventListener("mouseenter", ()=>{
        if(window.state?.mode !== "quick") return;
        const key = h.getAttribute("data-help");
        const help = t.helps && t.helps[key];
        if(!help) return;
        h.setAttribute("title", help.b);
      });
    });
  }

  // ---------- Make computeAll GLOBAL + store last result (fix: classic calc not working / save needs values) ----------
  // Re-implement compute using the working engines from PART 8, but accessible globally here.
  function computeStandardDCF(growthPct){
    const price = parseSmartNumber($("in_price")?.value);
    const fcf = parseSmartNumber($("in_fcf")?.value);
    const shares = parseSmartNumber($("in_shares")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);
    const termPct = parseSmartNumber($("in_term")?.value);

    if(!(fcf > 0)) return {err:"FCF"};
    if(!(shares > 0)) return {err:"Shares"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const r = discPct/100;
    const gT = termPct/100;
    const g = (growthPct||0)/100;
    if(r <= gT) return {err:"DiscTerm"};

    let pv = 0;
    for(let y=1; y<=years; y++){
      const cf = fcf * Math.pow(1+g, y);
      pv += cf / Math.pow(1+r, y);
    }
    const cfN = fcf * Math.pow(1+g, years);
    const tv = (cfN * (1+gT)) / (r - gT);
    const pvTv = tv / Math.pow(1+r, years);

    const perShare = (pv + pvTv) / shares;
    const pct = (Number.isFinite(price) && price>0) ? ((perShare/price)-1)*100 : NaN;
    return {value: perShare, pct};
  }

  function computeReitDCF(growthPct){
    const price = parseSmartNumber($("in_price")?.value);
    const affo = parseSmartNumber($("in_affo")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);
    const termPct = parseSmartNumber($("in_term")?.value);

    if(!(affo > 0)) return {err:"AFFO"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};
    if(!Number.isFinite(termPct)) return {err:"Terminal"};

    const r = discPct/100;
    const gT = termPct/100;
    const g = (growthPct||0)/100;
    if(r <= gT) return {err:"DiscTerm"};

    let pv = 0;
    for(let y=1; y<=years; y++){
      const cf = affo * Math.pow(1+g, y);
      pv += cf / Math.pow(1+r, y);
    }
    const cfN = affo * Math.pow(1+g, years);
    const tv = (cfN * (1+gT)) / (r - gT);
    const pvTv = tv / Math.pow(1+r, years);

    const perShare = pv + pvTv;
    const pct = (Number.isFinite(price) && price>0) ? ((perShare/price)-1)*100 : NaN;
    return {value: perShare, pct};
  }

  function computeFinancialRIM(roePct){
    const price = parseSmartNumber($("in_price")?.value);
    const bvps = parseSmartNumber($("in_bvps")?.value);
    const payoutPct = parseSmartNumber($("in_payout")?.value);
    const years = Math.round(parseSmartNumber($("in_years")?.value));
    const discPct = parseSmartNumber($("in_disc")?.value);

    if(!(bvps > 0)) return {err:"BVPS"};
    if(!Number.isFinite(roePct)) return {err:"ROE"};
    if(!(payoutPct >= 0 && payoutPct <= 100)) return {err:"Payout"};
    if(!(years >= 1 && years <= 30)) return {err:"Years"};
    if(!(discPct > 0 && discPct <= 40)) return {err:"Discount"};

    const r = discPct/100;
    const roe = roePct/100;
    const payout = payoutPct/100;
    const retain = 1 - payout;

    let bv = bvps;
    let pvRI = 0;

    for(let y=1; y<=years; y++){
      const ri = (roe - r) * bv;             // residual income per share
      pvRI += ri / Math.pow(1+r, y);
      bv = bv * (1 + roe * retain);         // grow BV
    }

    const value = bvps + pvRI;              // terminal RI assumed 0
    const pct = (Number.isFinite(price) && price>0) ? ((value/price)-1)*100 : NaN;
    return {value, pct};
  }

  function fmtMoney(x){
    if(!Number.isFinite(x)) return "—";
    const cur = window.state?.curr || "USD";
    try{
      return new Intl.NumberFormat(getLocale(), {
        style:"currency", currency:cur, maximumFractionDigits:2
      }).format(x);
    }catch(e){
      return new Intl.NumberFormat(getLocale(), {maximumFractionDigits:2}).format(x) + " " + cur;
    }
  }

  function fmtPct(x){
    if(!Number.isFinite(x)) return "";
    const sign = x > 0 ? "+" : "";
    return " " + sign + new Intl.NumberFormat(getLocale(), {maximumFractionDigits:1}).format(x) + "%";
  }

  function paint(prefix, obj){
    const v = $(prefix);
    const p = $(prefix + "_pct");
    const s = $(prefix + "_s");
    if(!obj || !Number.isFinite(obj.value)){
      v && (v.textContent="—");
      p && (p.textContent="");
      s && (s.textContent="—");
      return;
    }
    v && (v.textContent = fmtMoney(obj.value));
    p && (p.textContent = fmtPct(obj.pct));
    s && (s.textContent = (window.state.lang==="cz") ? "vs aktuální cena" : "vs current price");
  }

  function setTargets(baseVal, bearVal, bullVal){
    const outT = $("out_target");
    const outR = $("out_range");
    // default MoS 15% (can be changed later)
    const mos = window.state?.mos ? 0.15 : 0;
    const target = Number.isFinite(baseVal) ? baseVal * (1 - mos) : NaN;
    outT && (outT.value = Number.isFinite(target) ? fmtMoney(target) : "—");
    outR && (outR.value = (Number.isFinite(bearVal) && Number.isFinite(bullVal))
      ? (fmtMoney(bearVal) + " – " + fmtMoney(bullVal))
      : "—"
    );
  }

  function autoQuickBearBull(){
    if(window.state?.mode !== "quick") return;
    const base = parseSmartNumber($("in_base")?.value);
    if(!Number.isFinite(base)) return;
    $("in_bear") && ($("in_bear").value = String(Math.max(0, base - 2)));
    $("in_bull") && ($("in_bull").value = String(base + 2));
  }

  // GLOBAL computeAll used by Save/Watchlist
  window.computeAll = function(){
    autoQuickBearBull();

    const t = getTexts();

    const bear = parseSmartNumber($("in_bear")?.value);
    const base = parseSmartNumber($("in_base")?.value);
    const bull = parseSmartNumber($("in_bull")?.value);

    let rb, r0, ru;

    const model = window.state?.model || "standard";
    if(model === "standard"){
      rb = computeStandardDCF(bear);
      r0 = computeStandardDCF(base);
      ru = computeStandardDCF(bull);
    }else if(model === "reit"){
      rb = computeReitDCF(bear);
      r0 = computeReitDCF(base);
      ru = computeReitDCF(bull);
    }else if(model === "financial"){
      rb = computeFinancialRIM(bear);
      r0 = computeFinancialRIM(base);
      ru = computeFinancialRIM(bull);
    }else{
      window.toast && window.toast(window.state.lang==="cz"
        ? "Tenhle model doplníme později (coming soon)."
        : "This model will be added later (coming soon)."
      );
      return null;
    }

    const err = rb?.err || r0?.err || ru?.err;
    if(err){
      const msg = {
        FCF: (window.state.lang==="cz") ? "Vyplň FCF (celkem). Můžeš psát např. 70b." : "Fill FCF (total). You can type e.g. 70b.",
        Shares: (window.state.lang==="cz") ? "Vyplň Shares. Můžeš psát např. 12.6b." : "Fill Shares. You can type e.g. 12.6b.",
        AFFO: (window.state.lang==="cz") ? "Vyplň AFFO/akcii." : "Fill AFFO per share.",
        BVPS: (window.state.lang==="cz") ? "Vyplň BVPS." : "Fill BVPS.",
        ROE: (window.state.lang==="cz") ? "Vyplň scénáře (ROE)." : "Fill scenarios (ROE).",
        Payout: (window.state.lang==="cz") ? "Payout musí být 0–100." : "Payout must be 0–100.",
        Years: (window.state.lang==="cz") ? "Zkontroluj roky (1–30)." : "Check years (1–30).",
        Discount: (window.state.lang==="cz") ? "Zkontroluj diskont." : "Check discount rate.",
        Terminal: (window.state.lang==="cz") ? "Zkontroluj terminální růst." : "Check terminal growth.",
        DiscTerm: (window.state.lang==="cz") ? "Diskont musí být > terminál." : "Discount must be > terminal."
      }[err] || (window.state.lang==="cz" ? "Zkontroluj vstupy." : "Check inputs.");
      window.toast && window.toast(msg);
      // still paint blanks to be safe
    }

    paint("r_bear", rb);
    paint("r_base", r0);
    paint("r_bull", ru);
    setTargets(r0?.value, rb?.value, ru?.value);

    // store last numeric result for watchlist
    window.__EA.lastResult = {
      ts: Date.now(),
      ticker: String($("in_ticker")?.value || "").trim().toUpperCase(),
      model,
      currency: window.state?.curr || "USD",
      price: parseSmartNumber($("in_price")?.value),
      bear: rb?.value, base: r0?.value, bull: ru?.value,
      target: (window.state?.mos ? (r0?.value * (1-0.15)) : r0?.value)
    };

    window.toast && window.toast(window.state.lang==="cz" ? "Hotovo ✅" : "Done ✅");
    return {rb, r0, ru};
  };

  // Ensure Calculate button uses global computeAll
  $("btn_calc")?.addEventListener("click", (e)=>{
    e.preventDefault();
    window.computeAll();
  });

  // ---------- Improve Watchlist saving to store numeric fair values too ----------
  // Patch PART 9 save if present
  if(window.__EA?.watch?.saveToWatchlist){
    const origSave = window.__EA.watch.saveToWatchlist;
    window.__EA.watch.saveToWatchlist = function(){
      // compute first to guarantee numeric lastResult
      window.computeAll && window.computeAll();

      // If PART 9 saves strings only, we add numeric fields on top
      origSave();

      // After save, patch the newest item with numeric values if possible
      try{
        const KEY = "ea_watchlist_v1";
        const raw = localStorage.getItem(KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if(Array.isArray(arr) && arr.length && window.__EA.lastResult){
          arr[0].bear = window.__EA.lastResult.bear;
          arr[0].base = window.__EA.lastResult.base;
          arr[0].bull = window.__EA.lastResult.bull;
          arr[0].target = window.__EA.lastResult.target;
          arr[0].price = window.__EA.lastResult.price;
          localStorage.setItem(KEY, JSON.stringify(arr));
          window.__EA.watch.renderWatchlist && window.__EA.watch.renderWatchlist();
        }
      }catch(e){}
    };
  }

  // ---------- Input beautifier: on blur convert large raw number to compact suffix ----------
  function bindBigNumberInputs(){
    const ids = ["in_fcf","in_shares","in_affo","in_bvps","in_price"];
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;

      el.addEventListener("blur", ()=>{
        const n = parseSmartNumber(el.value);
        if(!Number.isFinite(n)) return;
        // For shares/FCF, compact is helpful; for price/bvps keep normal if small
        if(id === "in_price" || id === "in_bvps" || id === "in_affo"){
          // keep as normal number with locale decimals
          el.value = new Intl.NumberFormat(getLocale(), {maximumFractionDigits:4}).format(n);
        }else{
          el.value = formatCompact(n);
        }
      });
    });

    // update quick bear/bull when base changes
    $("in_base")?.addEventListener("input", ()=>autoQuickBearBull());
  }

  // ---------- Guide disclaimer injection (Play Store safe) ----------
  function injectDisclaimerIntoGuide(){
    const guideBody = $("guideBody");
    if(!guideBody) return;

    // avoid duplicate insert
    if($("ea_disclaimer_block")) return;

    const block = document.createElement("div");
    block.className = "card";
    block.id = "ea_disclaimer_block";
    block.style.marginTop = "12px";

    const isCZ = (window.state.lang === "cz");
    block.innerHTML = `
      <h3>${isCZ ? "4) Důležité upozornění" : "4) Important disclaimer"}</h3>
      <div class="muted"
    


  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





