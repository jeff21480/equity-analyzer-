<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equity Analyzer – DCF (CZ/EN)</title>
  <style>
    :root{
      --bgA:#070816;
      --bgB:#0b0b22;
      --bgC:#110a2c;

      --card: rgba(16, 10, 44, .78);
      --card2: rgba(18, 10, 52, .66);
      --stroke: rgba(160, 120, 255, .25);
      --stroke2: rgba(0,0,0,.35);

      --text: rgba(255,255,255,.95);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);

      --good:#2cff9a;
      --bad:#ff5d7d;
      --warn:#ffd166;

      --radius: 22px;
      --shadow: 0 22px 70px rgba(5,3,20,.55);
      --shadow2: 0 14px 40px rgba(5,3,20,.45);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(120, 90, 255, .25), transparent 55%),
        radial-gradient(900px 650px at 90% 20%, rgba(60, 180, 255, .18), transparent 60%),
        linear-gradient(145deg, var(--bgA), var(--bgB) 55%, var(--bgC));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 50px;
    }

    /* Screens */
    .screen{ display:none; }
    .screen.active{ display:block; animation: pop .16s ease-out; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }

    /* Top bar */
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.06));
      border: 1px solid rgba(255,255,255,.20);
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      backdrop-filter: blur(14px);
    }
    .topRow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .pill{
      opacity:.92;
      font-weight:900;
      letter-spacing:.6px;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      flex: 0 0 auto;
    }
    h1{
      margin: 6px 0 8px;
      font-size: clamp(30px, 6vw, 52px);
      line-height: 1.05;
      letter-spacing: .2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      line-height: 1.5;
      max-width: 70ch;
      font-size: 16px;
    }

    .navRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.14);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .08s ease, opacity .12s ease, border-color .12s ease;
      box-shadow: var(--shadow2);
      font-weight: 700;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(180,140,255,.35); }
    .btn:active{ transform: translateY(0); opacity:.9; }
    .btn.primary{
      background: linear-gradient(180deg, rgba(130,90,255,.35), rgba(0,0,0,.16));
      border-color: rgba(170,130,255,.45);
    }
    .btn.ghost{
      background: rgba(0,0,0,.08);
      box-shadow:none;
    }

    .seg{
      display:flex;
      gap:8px;
      padding:8px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
    }
    .seg .btn{
      padding: 8px 10px;
      border-radius: 14px;
      box-shadow:none;
    }
    .seg .btn.on{
      background: rgba(130,90,255,.28);
      border-color: rgba(200,170,255,.40);
      opacity: 1;
    }
    .seg .btn.off{ opacity:.55; }

    /* Cards / sections */
    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      backdrop-filter: blur(14px);
    }
    .cardTitle{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .cardTitle h2{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }

    /* Form grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
    }

    .field{
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 10px 10px 12px;
    }
    .labelRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    label{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 13px;
      color: var(--muted);
    }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    input::placeholder{ color: rgba(255,255,255,.40); }
    .helpBtn{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      line-height: 1;
    }
    .helpBtn:hover{ border-color: rgba(200,170,255,.35); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .hint{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted2);
      line-height: 1.45;
    }

    /* Results */
    .resultsGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 760px){
      .resultsGrid{ grid-template-columns: 1fr; }
    }
    .resCard{
      padding: 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
    }
    .resTop{
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom: 10px;
      gap: 10px;
    }
    .resLabel{
      font-weight: 900;
      letter-spacing: .4px;
      color: var(--muted);
      text-transform: uppercase;
      font-size: 12px;
    }
    .chip{
      font-weight: 900;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.10);
      white-space: nowrap;
    }
    .chip.good{ border-color: rgba(44,255,154,.35); color: var(--good); }
    .chip.bad{ border-color: rgba(255,93,125,.35); color: var(--bad); }
    .chip.warn{ border-color: rgba(255,209,102,.35); color: var(--warn); }

    .resValue{
      font-size: 22px;
      font-weight: 950;
      letter-spacing:.2px;
      margin-bottom: 8px;
    }
    .resSub{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    /* Watchlist */
    .watchItem{
      display:flex;
      justify-content: space-between;
      align-items: stretch;
      gap: 10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      margin-bottom: 10px;
    }
    .watchMain{
      flex: 1 1 auto;
      cursor:pointer;
    }
    .watchTitle{
      font-weight: 950;
      letter-spacing:.2px;
      margin-bottom: 4px;
    }
    .watchSub{
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.35;
      margin-bottom: 8px;
    }
    .watchVals{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .watchBtns{
      display:flex;
      flex-direction: column;
      gap: 8px;
      flex: 0 0 auto;
      min-width: 120px;
    }
    .btnSmall{
      padding: 10px 10px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      color: var(--text);
      cursor:pointer;
    }
    .btnSmall:hover{ border-color: rgba(200,170,255,.35); }
    .btnDanger{ border-color: rgba(255,93,125,.35); color: var(--bad); }
    .btnOk{ border-color: rgba(44,255,154,.35); color: var(--good); }

    .empty{
      text-align:center;
      padding: 22px 10px;
      color: var(--muted2);
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 18px;
      background: rgba(0,0,0,.08);
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 1000;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(10,8,28,.92);
      box-shadow: 0 25px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      justify-content: space-between;
      align-items:center;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .modalTitle{
      margin: 0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .x{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      color: var(--text);
      cursor:pointer;
      font-size: 18px;
      font-weight: 900;
    }
    .modalBody{
      padding: 14px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 15px;
    }
    .modalBody b{ color: var(--text); }
    .modalBody code{
      background: rgba(0,0,0,.22);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
    }
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="topRow">
        <div class="pill" id="t_pill">DCF • Watchlist • PDF</div>

        <div class="row">
          <div class="seg" aria-label="Language">
            <button class="btn ghost" id="btnCZ" type="button" onclick="setLang('cs')">CZ</button>
            <button class="btn ghost" id="btnEN" type="button" onclick="setLang('en')">EN</button>
          </div>

          <div class="seg" aria-label="Currency">
            <button class="btn ghost" id="btnUSD" type="button" onclick="setCcy('USD')">USD</button>
            <button class="btn ghost" id="btnEUR" type="button" onclick="setCcy('EUR')">EUR</button>
          </div>
        </div>
      </div>

      <h1 id="t_h1">Analýza akcií – DCF</h1>
      <p class="sub" id="t_sub">
        Rychlý odhad férové ceny přes DCF ve 3 scénářích (Bear/Base/Bull), ukládání do Watchlistu a export do PDF.
      </p>

      <div class="navRow">
        <button class="btn primary" type="button" onclick="go('dcf')" id="t_navDCF">DCF</button>
        <button class="btn" type="button" onclick="go('watch')" id="t_navWatch">Watchlist</button>
        <button class="btn" type="button" onclick="go('about')" id="t_navAbout">O aplikaci</button>
      </div>
    </div>

    <!-- SCREEN: DCF -->
    <div class="screen active" id="screen-dcf">
      <div class="card">
        <div class="cardTitle">
          <h2 id="t_dcfTitle">Vstupy</h2>
          <div class="row">
            <button class="btn" type="button" onclick="calc()" id="t_btnCalc">Spočítat</button>
            <button class="btn" type="button" onclick="saveCurrent()" id="t_btnSave">Uložit do Watchlistu</button>
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <div class="labelRow">
              <label id="t_lblTicker">Ticker / Název</label>
              <button class="helpBtn" onclick="help('ticker')">?</button>
            </div>
            <input id="inp_ticker" placeholder="AAPL / Apple..." />
            <div class="hint" id="t_hintTicker">Používá se pro pojmenování položky ve Watchlistu.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblPrice">Aktuální cena (volitelně)</label>
              <button class="helpBtn" onclick="help('price')">?</button>
            </div>
            <input id="inp_price" inputmode="decimal" placeholder="např. 180" />
            <div class="hint" id="t_hintPrice">Když vyplníš, ukážeme podhodnocení/nadhodnocení.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblFCF">FCF (poslední rok)</label>
              <button class="helpBtn" onclick="help('fcf')">?</button>
            </div>
            <input id="inp_fcf" inputmode="decimal" placeholder="např. 1000000000" />
            <div class="hint" id="t_hintFCF">Zadej v měně, kterou počítáš (USD/EUR).</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblYears">Počet let projekce</label>
              <button class="helpBtn" onclick="help('years')">?</button>
            </div>
            <input id="inp_years" inputmode="numeric" placeholder="např. 10" />
            <div class="hint" id="t_hintYears">Typicky 5–10 let.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblWacc">Diskontní sazba (WACC / r) %</label>
              <button class="helpBtn" onclick="help('wacc')">?</button>
            </div>
            <input id="inp_wacc" inputmode="decimal" placeholder="např. 9" />
            <div class="hint" id="t_hintWacc">Vyšší sazba = nižší férová hodnota.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblTG">Terminal growth %</label>
              <button class="helpBtn" onclick="help('tg')">?</button>
            </div>
            <input id="inp_tg" inputmode="decimal" placeholder="např. 2.5" />
            <div class="hint" id="t_hintTG">Dlouhodobý růst po projekci.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblNetDebt">Net debt / Cash úprava</label>
              <button class="helpBtn" onclick="help('netDebt')">?</button>
            </div>
            <input id="inp_netDebt" inputmode="decimal" placeholder="např. 5000000000 (cash zadej záporně)" />
            <div class="hint" id="t_hintNetDebt">Dluh přičti (+), čistý cash zadej jako záporné číslo (-).</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblShares">Počet akcií (Shares outstanding)</label>
              <button class="helpBtn" onclick="help('shares')">?</button>
            </div>
            <input id="inp_shares" inputmode="decimal" placeholder="např. 16000000000" />
            <div class="hint" id="t_hintShares">Když vyplníš, počítáme férovou cenu na akcii.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblBear">Růst FCF – Bear %</label>
              <button class="helpBtn" onclick="help('growth')">?</button>
            </div>
            <input id="inp_bear" inputmode="decimal" placeholder="např. 4" />
            <div class="hint" id="t_hintScen">3 scénáře: Bear / Base / Bull.</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblBase">Růst FCF – Base %</label>
              <button class="helpBtn" onclick="help('growth')">?</button>
            </div>
            <input id="inp_base" inputmode="decimal" placeholder="např. 8" />
            <div class="hint" class="muted2">&nbsp;</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblBull">Růst FCF – Bull %</label>
              <button class="helpBtn" onclick="help('growth')">?</button>
            </div>
            <input id="inp_bull" inputmode="decimal" placeholder="např. 12" />
            <div class="hint" class="muted2">&nbsp;</div>
          </div>

          <div class="field">
            <div class="labelRow">
              <label id="t_lblCcy">Měna</label>
              <button class="helpBtn" onclick="help('ccy')">?</button>
            </div>
            <input id="inp_ccy" type="hidden" value="USD" />
            <div class="row">
              <span class="muted2" id="t_ccyNote">Formátování výsledků / Watchlist / PDF</span>
            </div>
            <div class="hint" id="t_hintCcy">Měna je jen označení (žádný FX převod).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">
          <h2 id="t_resTitle">Výsledky</h2>
          <div class="muted2" id="t_resHint">Zobrazí se po výpočtu (Bear/Base/Bull).</div>
        </div>
        <div id="resultsBox" class="empty">Zatím žádný výpočet.</div>
      </div>
    </div>

    <!-- SCREEN: WATCHLIST -->
    <div class="screen" id="screen-watch">
      <div class="card">
        <div class="cardTitle">
          <h2 id="t_watchTitle">Watchlist</h2>
          <button class="btn" type="button" onclick="clearAll()" id="t_btnClear">Smazat vše</button>
        </div>
        <div id="watchBox" class="empty">Zatím nic uloženého.</div>
        <div class="hint" id="t_watchHint">
          Klikni na položku pro načtení vstupů. Tlačítkem „PDF“ otevřeš tisk (uložíš jako PDF).
        </div>
      </div>
    </div>

    <!-- SCREEN: ABOUT -->
    <div class="screen" id="screen-about">
      <div class="card">
        <div class="cardTitle">
          <h2 id="t_aboutTitle">O aplikaci</h2>
          <button class="btn" type="button" onclick="help('about')" id="t_btnAboutHelp">Zobrazit popis</button>
        </div>

        <div class="muted" id="aboutText" style="line-height:1.7;">
          <p><b>Jednoduchý DCF odhad</b> férové ceny ve 3 scénářích (Bear/Base/Bull).</p>
          <ul>
            <li>Vysvětlivky u vstupů (CZ/EN)</li>
            <li>Watchlist (ukládání do prohlížeče)</li>
            <li>Export jedné položky do PDF (tisk)</li>
          </ul>
          <div class="hr"></div>
          <p class="muted2">Tip: Používej realistický WACC (např. kolem 9 %) a terminal growth 1–3 %.</p>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div class="modalBack" id="modalBack" onclick="closeModalFromBg(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalTop">
          <h3 class="modalTitle" id="modalTitle">Nápověda</h3>
          <button class="x" onclick="closeModal()">×</button>
        </div>
        <div class="modalBody" id="modalBody"></div>
      </div>
    </div>

  </div>
<script>
/* ========= State ========= */
const STORE_KEY = 'equity_analyzer_watchlist_v1';
let LANG = 'cs';
let CCY  = 'USD';
let LAST = null;

/* ========= i18n UI ========= */
const UI = {
  cs: {
    pill: "DCF • Watchlist • PDF",
    h1: "Analýza akcií – DCF",
    sub: "Rychlý odhad férové ceny přes DCF ve 3 scénářích (Bear/Base/Bull), ukládání do Watchlistu a export do PDF.",
    navDCF:"DCF", navWatch:"Watchlist", navAbout:"O aplikaci",
    dcfTitle:"Vstupy", btnCalc:"Spočítat", btnSave:"Uložit do Watchlistu",
    lblTicker:"Ticker / Název", hintTicker:"Používá se pro pojmenování položky ve Watchlistu.",
    lblPrice:"Aktuální cena (volitelně)", hintPrice:"Když vyplníš, ukážeme podhodnocení/nadhodnocení.",
    lblFCF:"FCF (poslední rok)", hintFCF:"Zadej v měně, kterou počítáš (USD/EUR).",
    lblYears:"Počet let projekce", hintYears:"Typicky 5–10 let.",
    lblWacc:"Diskontní sazba (WACC / r) %", hintWacc:"Vyšší sazba = nižší férová hodnota.",
    lblTG:"Terminal growth %", hintTG:"Dlouhodobý růst po projekci.",
    lblNetDebt:"Net debt / Cash úprava", hintNetDebt:"Dluh přičti (+), čistý cash zadej jako záporné číslo (-).",
    lblShares:"Počet akcií (Shares outstanding)", hintShares:"Když vyplníš, počítáme férovou cenu na akcii.",
    lblBear:"Růst FCF – Bear %", lblBase:"Růst FCF – Base %", lblBull:"Růst FCF – Bull %", hintScen:"3 scénáře: Bear / Base / Bull.",
    lblCcy:"Měna", ccyNote:"Formátování výsledků / Watchlist / PDF", hintCcy:"Měna je jen označení (žádný FX převod).",
    resTitle:"Výsledky", resHint:"Zobrazí se po výpočtu (Bear/Base/Bull).",
    watchTitle:"Watchlist", btnClear:"Smazat vše",
    watchEmpty:"Zatím nic uloženého.",
    watchHint:"Klikni na položku pro načtení vstupů. Tlačítkem „PDF“ otevřeš tisk (uložíš jako PDF).",
    aboutTitle:"O aplikaci", btnAboutHelp:"Zobrazit popis",
    emptyCalc:"Zatím žádný výpočet.",
    saved:"Uloženo",
    savedMsg:"<p>Výsledek byl uložen do Watchlistu.</p>",
    cantSave:"Nelze uložit",
    cantSaveMsg:"<p>Nejdřív spočítej výsledek (tlačítko Spočítat).</p>",
    loaded:"Načteno",
    loadedMsg:"<p>Načteno z Watchlistu.</p>",
    confirmClear:"Opravdu smazat celý Watchlist?",
    pdfTitle:"Výpočet – DCF (3 scénáře)",
    btnPDF:"PDF",
    btnLoad:"Načíst",
    btnDel:"Smazat",
    badgeUndervalued:"Podhodnocené",
    badgeOvervalued:"Nadhodnocené",
    badgeNoprice:"Bez ceny",
  },
  en: {
    pill: "DCF • Watchlist • PDF",
    h1: "Stock Analysis – DCF",
    sub: "Quick fair value estimate via DCF in 3 scenarios (Bear/Base/Bull), Watchlist saving, and PDF export.",
    navDCF:"DCF", navWatch:"Watchlist", navAbout:"About",
    dcfTitle:"Inputs", btnCalc:"Calculate", btnSave:"Save to Watchlist",
    lblTicker:"Ticker / Name", hintTicker:"Used to label the item in the Watchlist.",
    lblPrice:"Current price (optional)", hintPrice:"If filled, we show under/overvaluation.",
    lblFCF:"FCF (last year)", hintFCF:"Enter in the currency you’re using (USD/EUR).",
    lblYears:"Projection years", hintYears:"Typically 5–10 years.",
    lblWacc:"Discount rate (WACC / r) %", hintWacc:"Higher rate = lower fair value.",
    lblTG:"Terminal growth %", hintTG:"Long-term growth after projection.",
    lblNetDebt:"Net debt / Cash adjustment", hintNetDebt:"Add debt (+). Enter net cash as a negative number (-).",
    lblShares:"Shares outstanding", hintShares:"If filled, we compute fair value per share.",
    lblBear:"FCF growth – Bear %", lblBase:"FCF growth – Base %", lblBull:"FCF growth – Bull %", hintScen:"3 scenarios: Bear / Base / Bull.",
    lblCcy:"Currency", ccyNote:"Formatting for Results / Watchlist / PDF", hintCcy:"Currency is labeling only (no FX conversion).",
    resTitle:"Results", resHint:"Shown after calculation (Bear/Base/Bull).",
    watchTitle:"Watchlist", btnClear:"Delete all",
    watchEmpty:"Nothing saved yet.",
    watchHint:"Tap an item to load inputs. “PDF” opens print dialog (save as PDF).",
    aboutTitle:"About", btnAboutHelp:"Show description",
    emptyCalc:"No calculation yet.",
    saved:"Saved",
    savedMsg:"<p>Result has been saved to the Watchlist.</p>",
    cantSave:"Can't save",
    cantSaveMsg:"<p>Please calculate first (press Calculate).</p>",
    loaded:"Loaded",
    loadedMsg:"<p>Loaded from Watchlist.</p>",
    confirmClear:"Delete the entire Watchlist?",
    pdfTitle:"DCF Report (3 scenarios)",
    btnPDF:"PDF",
    btnLoad:"Load",
    btnDel:"Delete",
    badgeUndervalued:"Undervalued",
    badgeOvervalued:"Overvalued",
    badgeNoprice:"No price",
  }
};

function t(key){ return (UI[LANG] && UI[LANG][key]) ? UI[LANG][key] : (UI.cs[key] || key); }

function setLang(lang){
  LANG = (lang === 'en') ? 'en' : 'cs';
  document.documentElement.lang = LANG;

  const cz = document.getElementById('btnCZ');
  const en = document.getElementById('btnEN');
  if(cz && en){
    cz.classList.toggle('on', LANG==='cs'); cz.classList.toggle('off', LANG!=='cs');
    en.classList.toggle('on', LANG==='en'); en.classList.toggle('off', LANG!=='en');
  }

  applyLang();
  if(LAST) renderResults(LAST);
  renderWatchlist();
}

function setCcy(ccy){
  CCY = (ccy === 'EUR') ? 'EUR' : 'USD';
  const u = document.getElementById('btnUSD');
  const e = document.getElementById('btnEUR');
  if(u && e){
    u.classList.toggle('on', CCY==='USD'); u.classList.toggle('off', CCY!=='USD');
    e.classList.toggle('on', CCY==='EUR'); e.classList.toggle('off', CCY!=='EUR');
  }
  const h = document.getElementById('inp_ccy');
  if(h) h.value = CCY;

  if(LAST) renderResults(LAST);
  renderWatchlist();
}

function applyLang(){
  document.getElementById('t_pill').textContent = t('pill');
  document.getElementById('t_h1').textContent = t('h1');
  document.getElementById('t_sub').textContent = t('sub');

  document.getElementById('t_navDCF').textContent = t('navDCF');
  document.getElementById('t_navWatch').textContent = t('navWatch');
  document.getElementById('t_navAbout').textContent = t('navAbout');

  document.getElementById('t_dcfTitle').textContent = t('dcfTitle');
  document.getElementById('t_btnCalc').textContent = t('btnCalc');
  document.getElementById('t_btnSave').textContent = t('btnSave');

  document.getElementById('t_lblTicker').textContent = t('lblTicker');
  document.getElementById('t_hintTicker').textContent = t('hintTicker');

  document.getElementById('t_lblPrice').textContent = t('lblPrice');
  document.getElementById('t_hintPrice').textContent = t('hintPrice');

  document.getElementById('t_lblFCF').textContent = t('lblFCF');
  document.getElementById('t_hintFCF').textContent = t('hintFCF');

  document.getElementById('t_lblYears').textContent = t('lblYears');
  document.getElementById('t_hintYears').textContent = t('hintYears');

  document.getElementById('t_lblWacc').textContent = t('lblWacc');
  document.getElementById('t_hintWacc').textContent = t('hintWacc');

  document.getElementById('t_lblTG').textContent = t('lblTG');
  document.getElementById('t_hintTG').textContent = t('hintTG');

  document.getElementById('t_lblNetDebt').textContent = t('lblNetDebt');
  document.getElementById('t_hintNetDebt').textContent = t('hintNetDebt');

  document.getElementById('t_lblShares').textContent = t('lblShares');
  document.getElementById('t_hintShares').textContent = t('hintShares');

  document.getElementById('t_lblBear').textContent = t('lblBear');
  document.getElementById('t_lblBase').textContent = t('lblBase');
  document.getElementById('t_lblBull').textContent = t('lblBull');
  document.getElementById('t_hintScen').textContent = t('hintScen');

  document.getElementById('t_lblCcy').textContent = t('lblCcy');
  document.getElementById('t_ccyNote').textContent = t('ccyNote');
  document.getElementById('t_hintCcy').textContent = t('hintCcy');

  document.getElementById('t_resTitle').textContent = t('resTitle');
  document.getElementById('t_resHint').textContent = t('resHint');

  document.getElementById('t_watchTitle').textContent = t('watchTitle');
  document.getElementById('t_btnClear').textContent = t('btnClear');
  document.getElementById('t_watchHint').textContent = t('watchHint');

  document.getElementById('t_aboutTitle').textContent = t('aboutTitle');
  document.getElementById('t_btnAboutHelp').textContent = t('btnAboutHelp');

  const resBox = document.getElementById('resultsBox');
  if(resBox && resBox.classList.contains('empty')) resBox.textContent = t('emptyCalc');
}

/* ========= HELP TEXTS (CZ/EN) ========= */
const HELP = {
  ticker: {
    cs:{ title:"Ticker / Název", body:`
      <p><b>Ticker</b> je zkratka akcie (např. AAPL). Můžeš vyplnit i název firmy.</p>
      <p>Použije se pro pojmenování položky ve Watchlistu.</p>
    `},
    en:{ title:"Ticker / Name", body:`
      <p><b>Ticker</b> is the stock symbol (e.g., AAPL). You can also enter the company name.</p>
      <p>It is used to label the item in the Watchlist.</p>
    `}
  },
  fcf: {
    cs:{ title:"FCF (Free Cash Flow)", body:`
      <p><b>FCF</b> je volné cash flow – hotovost, kterou firma generuje po investicích.</p>
      <p>DCF typicky diskontuje budoucí FCF do dneška.</p>
      <p><i>Tip:</i> Zadej poslední roční FCF (TTM / FY).</p>
    `},
    en:{ title:"FCF (Free Cash Flow)", body:`
      <p><b>FCF</b> is free cash flow — cash generated after investments.</p>
      <p>DCF discounts future FCF back to today.</p>
      <p><i>Tip:</i> Enter the latest annual FCF (TTM / FY).</p>
    `}
  },
  growth: {
    cs:{ title:"Růst FCF (CAGR)", body:`
      <p>Zadej očekávaný roční růst FCF pro 3 scénáře: <b>Bear / Base / Bull</b>.</p>
      <p>Např. Bear 4 %, Base 8 %, Bull 12 %.</p>
    `},
    en:{ title:"FCF Growth (CAGR)", body:`
      <p>Enter expected annual FCF growth for 3 scenarios: <b>Bear / Base / Bull</b>.</p>
      <p>Example: Bear 4%, Base 8%, Bull 12%.</p>
    `}
  },
  years: {
    cs:{ title:"Počet let projekce", body:`
      <p>Kolik let dopředu projektujeme FCF.</p>
      <p>Čím delší horizont, tím víc nejistoty. Typicky 5–10.</p>
    `},
    en:{ title:"Projection years", body:`
      <p>How many years of FCF you project.</p>
      <p>Longer horizon = more uncertainty. Typically 5–10.</p>
    `}
  },
  wacc: {
    cs:{ title:"Diskontní sazba (WACC / r)", body:`
      <p>Diskontní sazba vyjadřuje požadovaný výnos (riziko).</p>
      <p><b>Vyšší sazba</b> = <b>nižší</b> férová hodnota.</p>
      <p>Často se používá cca <b>9 %</b> (záleží na firmě).</p>
    `},
    en:{ title:"Discount rate (WACC / r)", body:`
      <p>Discount rate reflects required return (risk).</p>
      <p><b>Higher rate</b> = <b>lower</b> fair value.</p>
      <p>Many use around <b>9%</b> (depends on the company).</p>
    `}
  },
  tg: {
    cs:{ title:"Terminal growth", body:`
      <p>Dlouhodobý růst po skončení projekce.</p>
      <p>Neměl by výrazně převyšovat dlouhodobý růst ekonomiky (často 1–3 %).</p>
    `},
    en:{ title:"Terminal growth", body:`
      <p>Long-term growth after the explicit forecast period.</p>
      <p>Usually should not exceed long-term economy growth (often 1–3%).</p>
    `}
  },
  netDebt: {
    cs:{ title:"Net debt / Cash úprava", body:`
      <p>Přechod z <b>Enterprise Value</b> na <b>Equity Value</b>.</p>
      <p>Pokud má firma <b>net debt</b>, zadej kladně (+) a odečte se od EV.</p>
      <p>Pokud má firma <b>čistý cash</b>, zadej záporně (-) a přičte se k EV.</p>
    `},
    en:{ title:"Net debt / Cash adjustment", body:`
      <p>Converts <b>Enterprise Value</b> to <b>Equity Value</b>.</p>
      <p>If company has <b>net debt</b>, enter positive (+) and it will be subtracted from EV.</p>
      <p>If company has <b>net cash</b>, enter negative (-) and it will be added to EV.</p>
    `}
  },
  shares: {
    cs:{ title:"Počet akcií (Shares outstanding)", body:`
      <p>Pro výpočet <b>férové ceny na akcii</b> potřebujeme počet akcií.</p>
      <p>Když ho nevyplníš, zobrazíme výsledek jako <b>Enterprise/Equity Value</b>.</p>
    `},
    en:{ title:"Shares outstanding", body:`
      <p>Needed to compute <b>fair value per share</b>.</p>
      <p>If not provided, we display results as <b>Enterprise/Equity Value</b>.</p>
    `}
  },
  price: {
    cs:{ title:"Aktuální cena", body:`
      <p>Slouží pro porovnání, jestli je akcie pod / nad férovou cenou.</p>
      <p>Když cenu nevyplníš, výpočet běží dál (jen bez badge).</p>
    `},
    en:{ title:"Current price", body:`
      <p>Used to compare whether the stock is under/over the fair value.</p>
      <p>If price is empty, calculation still works (just no badge).</p>
    `}
  },
  ccy: {
    cs:{ title:"Měna", body:`
      <p>Tahle volba pouze <b>označuje měnu</b> a formátování výsledků jako <b>$</b> nebo <b>€</b>.</p>
      <p>Výpočet je v měně, ve které zadáš vstupy.</p>
    `},
    en:{ title:"Currency", body:`
      <p>This only <b>labels the currency</b> and formats values as <b>$</b> or <b>€</b>.</p>
      <p>The model calculates in the currency you enter.</p>
    `}
  },
  watch: {
    cs:{ title:"Watchlist", body:`
      <p>Uloží výsledek výpočtu (Bear/Base/Bull) do prohlížeče.</p>
      <p>V seznamu můžeš položky mazat po jedné a exportovat do PDF.</p>
    `},
    en:{ title:"Watchlist", body:`
      <p>Saves your results (Bear/Base/Bull) to your browser storage.</p>
      <p>You can delete items one-by-one and export them to PDF.</p>
    `}
  },
  about: {
    cs:{ title:"O aplikaci", body:`
      <p><b>Jednoduchý DCF odhad</b> férové ceny ve 3 scénářích.</p>
      <ul>
        <li>DCF výpočet + vysvětlivky</li>
        <li>Watchlist uložených analýz</li>
        <li>Možnost exportu do PDF</li>
      </ul>
      <p class="muted2">Určeno pro rychlé porovnání, ne investiční doporučení.</p>
    `},
    en:{ title:"About", body:`
      <p><b>Simple DCF estimate</b> of fair value across 3 scenarios.</p>
      <ul>
        <li>DCF calculator + inline explanations</li>
        <li>Saved Watchlist analyses</li>
        <li>PDF export via print</li>
      </ul>
      <p class="muted2">For quick comparison only, not investment advice.</p>
    `}
  }
};

function help(key){
  const item = HELP[key];
  if(!item){
    openModal("Help", "<p>No help text.</p>");
    return;
  }
  const pack = item[LANG] || item.cs;
  openModal(pack.title, pack.body);
}

/* ========= Modal ========= */
function openModal(title, html){
  const back = document.getElementById('modalBack');
  const tEl = document.getElementById('modalTitle');
  const bEl = document.getElementById('modalBody');
  if(!back || !tEl || !bEl) return;
  tEl.textContent = title;
  bEl.innerHTML = html;
  back.classList.add('show');
}
function closeModal(){
  const back = document.getElementById('modalBack');
  if(back) back.classList.remove('show');
}
function closeModalFromBg(e){
  if(e && e.target && e.target.id === 'modalBack') closeModal();
}

/* ========= Navigation ========= */
function go(name){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + name);
  if(el) el.classList.add('active');
  if(name === 'watch') renderWatchlist();
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ========= Formatting ========= */
function fmt(n){
  if(n === null || n === undefined || !isFinite(Number(n))) return "—";
  const x = Number(n);
  return x.toLocaleString(LANG === 'cs' ? 'cs-CZ' : 'en-US', { maximumFractionDigits: 2 });
}
function fmtMoney(n, maxFrac=2){
  if(n === null || n === undefined || !isFinite(Number(n))) return "—";
  const x = Number(n);
  return new Intl.NumberFormat(LANG === 'cs' ? 'cs-CZ' : 'en-US', {
    style:'currency',
    currency: CCY,
    maximumFractionDigits: maxFrac
  }).format(x);
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ========= DCF calc ========= */
function numFromInput(id){
  const el = document.getElementById(id);
  if(!el) return null;
  const raw = String(el.value || "").trim().replace(",", ".");
  if(raw === "") return null;
  const x = Number(raw);
  return isFinite(x) ? x : null;
}

function calcScenario(fcf0, gPct, years, rPct, tgPct){
  const g = (gPct||0)/100;
  const r = (rPct||0)/100;
  const tg = (tgPct||0)/100;

  let pv = 0;
  let fcf = fcf0;

  for(let i=1;i<=years;i++){
    fcf = fcf * (1 + g);
    pv += fcf / Math.pow(1 + r, i);
  }

  const fcfN = fcf * (1 + tg);
  let tv = null;
  if((r - tg) > 0.000001){
    tv = fcfN / (r - tg);
  }else{
    tv = null;
  }

  const pvTv = (tv === null) ? null : (tv / Math.pow(1 + r, years));
  return { pvCashflows: pv, tv, pvTv, ev: (pvTv===null? null : (pv + pvTv)) };
}

function calc(){
  const ticker = (document.getElementById('inp_ticker')?.value || "").trim();
  const price  = numFromInput('inp_price');
  const fcf0   = numFromInput('inp_fcf');
  const years  = numFromInput('inp_years');
  const wacc   = numFromInput('inp_wacc');
  const tg     = numFromInput('inp_tg');
  const netDebt= numFromInput('inp_netDebt') ?? 0;
  const shares = numFromInput('inp_shares');
  const bearG  = numFromInput('inp_bear');
  const baseG  = numFromInput('inp_base');
  const bullG  = numFromInput('inp_bull');
  const ccy    = (document.getElementById('inp_ccy')?.value || CCY || 'USD');

  if(fcf0 === null || years === null || wacc === null || tg === null || bearG === null || baseG === null || bullG === null){
    openModal("⚠️", LANG==='cs'
      ? "<p>Doplň prosím všechna hlavní pole: <b>FCF, roky, WACC, TG, Bear/Base/Bull</b>.</p>"
      : "<p>Please fill the main fields: <b>FCF, years, WACC, TG, Bear/Base/Bull</b>.</p>"
    );
    return;
  }

  const bear = calcScenario(fcf0, bearG, years, wacc, tg);
  const base = calcScenario(fcf0, baseG, years, wacc, tg);
  const bull = calcScenario(fcf0, bullG, years, wacc, tg);

  function toEquity(ev){
    if(ev === null) return null;
    return ev - netDebt;
  }

  const bearEQ = toEquity(bear.ev);
  const baseEQ = toEquity(base.ev);
  const bullEQ = toEquity(bull.ev);

  const bearPS = (shares && shares>0 && bearEQ!==null) ? (bearEQ / shares) : null;
  const basePS = (shares && shares>0 && baseEQ!==null) ? (baseEQ / shares) : null;
  const bullPS = (shares && shares>0 && bullEQ!==null) ? (bullEQ / shares) : null;

  LAST = {
    ts: Date.now(),
    ticker,
    ccy,
    inputs: { price, fcf0, years, wacc, tg, netDebt, shares, bearG, baseG, bullG },
    ev: { bear: bear.ev, base: base.ev, bull: bull.ev },
    eq: { bear: bearEQ, base: baseEQ, bull: bullEQ },
    ps: { bear: bearPS, base: basePS, bull: bullPS }
  };

  setCcy(ccy);
  renderResults(LAST);
}

function renderResults(res){
  const box = document.getElementById('resultsBox');
  if(!box) return;

  const price = res.inputs.price ?? null;
  const hasPS = (res.inputs.shares && res.inputs.shares>0);

  const prev = CCY;
  CCY = res.ccy || prev;

  const badge = (fair) => {
    if(price === null || price === undefined || !isFinite(Number(price))) return `<span class="chip warn">${escapeHtml(t('badgeNoprice'))}</span>`;
    const p = Number(price);
    const f = Number(fair);
    if(!isFinite(p) || !isFinite(f) || p<=0) return `<span class="chip warn">${escapeHtml(t('badgeNoprice'))}</span>`;
    const diff = (f - p) / p * 100;
    const sign = diff >= 0 ? "+" : "";
    if(diff >= 10) return `<span class="chip good">${escapeHtml(t('badgeUndervalued'))} ${escapeHtml(sign + fmt(diff))}%</span>`;
    if(diff <= -10) return `<span class="chip bad">${escapeHtml(t('badgeOvervalued'))} ${escapeHtml(sign + fmt(diff))}%</span>`;
    return `<span class="chip warn">${escapeHtml(sign + fmt(diff))}%</span>`;
  };

  function card(label, fairPS, ev, eq){
  const big = hasPS ? fmtMoney(fairPS, 2) : fmtMoney(ev, 0);
  let sub = "";

  if(hasPS){
    sub += `<div>${escapeHtml(LANG==='cs' ? 'Equity Value' : 'Equity Value')}: <b>${escapeHtml(fmtMoney(eq, 0))}</b></div>`;
    sub += `<div>${escapeHtml(LANG==='cs' ? 'Enterprise Value' : 'Enterprise Value')}: <b>${escapeHtml(fmtMoney(ev, 0))}</b></div>`;
    if(price !== null && isFinite(Number(price))){
      sub += `<div>${escapeHtml(t('lblPrice'))}: <b>${escapeHtml(fmtMoney(price, 2))}</b></div>`;
    }
  } else {
    sub += `<div>${escapeHtml(LANG==='cs' ? 'Enterprise Value' : 'Enterprise Value')}: <b>${escapeHtml(fmtMoney(ev, 0))}</b></div>`;
    sub += `<div class="muted2">${escapeHtml(LANG==='cs' ? 'Vyplň shares pro cenu na akcii.' : 'Fill shares for per-share fair value.')}</div>`;
  }

  const chip = hasPS
    ? badge(fairPS)
    : `<span class="chip warn">${escapeHtml(t('badgeNoprice'))}</span>`;

  return `
    <div class="resCard">
      <div class="resTop">
        <div class="resLabel">${escapeHtml(label)}</div>
        ${chip}
      </div>
      <div class="resValue">${escapeHtml(big)}</div>
      <div class="resSub">${sub}</div>
    </div>
  `;
}

box.classList.remove('empty');
box.innerHTML = `
  <div class="resultsGrid">
    ${card("Bear", res.ps.bear, res.ev.bear, res.eq.bear)}
    ${card("Base", res.ps.base, res.ev.base, res.eq.base)}
    ${card("Bull", res.ps.bull, res.ev.bull, res.eq.bull)}
  </div>
  <div class="hint" style="margin-top:10px;">
    ${escapeHtml(LANG==='cs'
      ? "Pozn.: Jde o zjednodušený model. Měna je jen formátování (bez FX převodu)."
      : "Note: Simplified model. Currency is formatting only (no FX conversion).")}
  </div>
`;

CCY = prev;
}

/* ========= Watchlist (localStorage) ========= */
function loadWatch(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}

function saveWatch(arr){
  localStorage.setItem(STORE_KEY, JSON.stringify(arr));
}

function addToWatchlist(item){
  const arr = loadWatch();
  arr.unshift(item);
  saveWatch(arr);
  renderWatchlist();
}

function removeFromWatchlist(idx){
  const arr = loadWatch();
  arr.splice(idx, 1);
  saveWatch(arr);
  renderWatchlist();
}

function clearAll(){
  if(!confirm(t('confirmClear'))) return;
  saveWatch([]);
  renderWatchlist();
}

/* ========= Save / Load current ========= */
function saveCurrent(){
  if(!LAST){
    openModal(t('cantSave'), t('cantSaveMsg'));
    return;
  }

  const it = {
    ts: Date.now(),
    ccy: LAST.ccy,
    ticker: (document.getElementById('inp_ticker')?.value || "").trim(),
    inputs: { ...LAST.inputs },
    results: {
      ev: { ...LAST.ev },
      eq: { ...LAST.eq },
      ps: { ...LAST.ps }
    }
  };

  addToWatchlist(it);
  openModal(t('saved'), t('savedMsg'));
}

function loadItem(idx){
  const arr = loadWatch();
  const it = arr[idx];
  if(!it) return;

  setCcy(it.ccy || 'USD');

  if(document.getElementById('inp_ticker'))  document.getElementById('inp_ticker').value  = it.ticker || "";
  if(document.getElementById('inp_price'))   document.getElementById('inp_price').value   = (it.inputs.price ?? "");
  if(document.getElementById('inp_fcf'))     document.getElementById('inp_fcf').value     = (it.inputs.fcf0 ?? "");
  if(document.getElementById('inp_years'))   document.getElementById('inp_years').value   = (it.inputs.years ?? "");
  if(document.getElementById('inp_wacc'))    document.getElementById('inp_wacc').value    = (it.inputs.wacc ?? "");
  if(document.getElementById('inp_tg'))      document.getElementById('inp_tg').value      = (it.inputs.tg ?? "");
  if(document.getElementById('inp_netDebt')) document.getElementById('inp_netDebt').value = (it.inputs.netDebt ?? 0);
  if(document.getElementById('inp_shares'))  document.getElementById('inp_shares').value  = (it.inputs.shares ?? "");
  if(document.getElementById('inp_bear'))    document.getElementById('inp_bear').value    = (it.inputs.bearG ?? "");
  if(document.getElementById('inp_base'))    document.getElementById('inp_base').value    = (it.inputs.baseG ?? "");
  if(document.getElementById('inp_bull'))    document.getElementById('inp_bull').value    = (it.inputs.bullG ?? "");

  LAST = {
    ts: it.ts,
    ticker: it.ticker,
    ccy: it.ccy,
    inputs: { ...it.inputs },
    ev: { ...it.results.ev },
    eq: { ...it.results.eq },
    ps: { ...it.results.ps }
  };

  go('dcf');
  renderResults(LAST);
  openModal(t('loaded'), t('loadedMsg'));
}

/* ========= Render Watchlist ========= */
function renderWatchlist(){
  const box = document.getElementById('watchBox');
  if(!box) return;

  const arr = loadWatch();
  if(!arr.length){
    box.classList.add('empty');
    box.textContent = t('watchEmpty');
    return;
  }
  box.classList.remove('empty');

  box.innerHTML = arr.map((it, i) => {
    const title = escapeHtml(it.ticker || "—");
    const date  = it.ts ? new Date(it.ts).toLocaleString(LANG === 'cs' ? 'cs-CZ' : 'en-US') : "";

    const prev = CCY;
    CCY = it.ccy || prev;

    const hasPS = (it.inputs.shares && it.inputs.shares > 0);
    const baseVal = hasPS ? fmtMoney(it.results.ps.base, 2) : fmtMoney(it.results.ev.base, 0);

    const price = it.inputs.price ?? null;
    const priceTxt = (price === null || price === "" || !isFinite(Number(price))) ? "—" : fmtMoney(price, 2);

    const vals = `
      <span>Bear: <b>${escapeHtml(hasPS ? fmtMoney(it.results.ps.bear,2) : fmtMoney(it.results.ev.bear,0))}</b></span>
      <span>Base: <b>${escapeHtml(baseVal)}</b></span>
      <span>Bull: <b>${escapeHtml(hasPS ? fmtMoney(it.results.ps.bull,2) : fmtMoney(it.results.ev.bull,0))}</b></span>
      <span>${escapeHtml(LANG==='cs' ? 'Cena' : 'Price')}: <b>${escapeHtml(priceTxt)}</b></span>
      <span>${escapeHtml(LANG==='cs' ? 'Měna' : 'CCY')}: <b>${escapeHtml(it.ccy || 'USD')}</b></span>
    `;

    CCY = prev;

    return `
      <div class="watchItem">
        <div class="watchMain" onclick="loadItem(${i})" role="button" tabindex="0">
          <div class="watchTitle">${title}</div>
          <div class="watchSub">${escapeHtml(date)}</div>
          <div class="watchVals">${vals}</div>
        </div>
        <div class="watchBtns">
          <button class="btnSmall btnOk" type="button" onclick="event.stopPropagation(); loadItem(${i})">${escapeHtml(t('btnLoad'))}</button>
          <button class="btnSmall" type="button" onclick="event.stopPropagation(); exportPDF(${i})">${escapeHtml(t('btnPDF'))}</button>
          <button class="btnSmall btnDanger" type="button" onclick="event.stopPropagation(); removeFromWatchlist(${i})">${escapeHtml(t('btnDel'))}</button>
        </div>
      </div>
    `;
  }).join('');
}

/* ========= PDF Export ========= */
function exportPDF(idx){
  const arr = loadWatch();
  const it = arr[idx];
  if(!it) return;

  const prev = CCY;
  CCY = it.ccy || 'USD';

  const hasPS = (it.inputs.shares && it.inputs.shares > 0);

  const title = (it.ticker || "DCF").trim();
  const date  = it.ts ? new Date(it.ts).toLocaleString(LANG === 'cs' ? 'cs-CZ' : 'en-US') : "";

  const rows = [
    [t('lblFCF'), fmtMoney(it.inputs.fcf0, 0)],
    [t('lblYears'), escapeHtml(String(it.inputs.years ?? ""))],
    [t('lblWacc'), escapeHtml(String(it.inputs.wacc ?? "")) + " %"],
    [t('lblTG'), escapeHtml(String(it.inputs.tg ?? "")) + " %"],
    [t('lblNetDebt'), fmtMoney(it.inputs.netDebt ?? 0, 0)],
    [t('lblShares'), escapeHtml(String(it.inputs.shares ?? ""))],
    [t('lblBear'), escapeHtml(String(it.inputs.bearG ?? "")) + " %"],
    [t('lblBase'), escapeHtml(String(it.inputs.baseG ?? "")) + " %"],
    [t('lblBull'), escapeHtml(String(it.inputs.bullG ?? "")) + " %"],
    [t('lblPrice'), (it.inputs.price===null || it.inputs.price==="" || !isFinite(Number(it.inputs.price))) ? "—" : fmtMoney(it.inputs.price, 2)],
    [t('lblCcy'), escapeHtml(it.ccy || 'USD')]
  ].map(r => `<tr><td style="padding:8px 10px;border:1px solid #ddd;"><b>${escapeHtml(r[0])}</b></td><td style="padding:8px 10px;border:1px solid #ddd;">${r[1]}</td></tr>`).join('');

  const resRow = (label, fairPS, ev, eq) => {
    const main = hasPS ? fmtMoney(fairPS, 2) : fmtMoney(ev, 0);
    const extra = hasPS
      ? `<div style="color:#444;font-size:12px;margin-top:4px;">Equity Value: <b>${escapeHtml(fmtMoney(eq,0))}</b> • EV: <b>${escapeHtml(fmtMoney(ev,0))}</b></div>`
      : `<div style="color:#444;font-size:12px;margin-top:4px;">Enterprise Value: <b>${escapeHtml(fmtMoney(ev,0))}</b></div>`;
    return `
      <div style="border:1px solid #ddd;border-radius:12px;padding:12px;margin-bottom:10px;">
        <div style="font-weight:900;letter-spacing:.3px;color:#222;margin-bottom:6px;">${escapeHtml(label)}</div>
        <div style="font-size:20px;font-weight:900;color:#000;">${escapeHtml(main)}</div>
        ${extra}
      </div>
    `;
  };

  const html = `
  <html>
    <head>
      <meta charset="utf-8"/>
      <title>${escapeHtml(t('pdfTitle'))} – ${escapeHtml(title)}</title>
      <style>
        body{ font-family: Arial, sans-serif; padding: 18px; color:#111; }
        h1{ margin:0 0 4px; font-size: 22px; }
        .muted{ color:#555; font-size: 13px; margin-bottom: 14px; }
        table{ border-collapse: collapse; width: 100%; margin: 10px 0 14px; }
        .grid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
        @media print{ button{ display:none } }
      </style>
    </head>
    <body>
      <h1>${escapeHtml(title)} – ${escapeHtml(t('pdfTitle'))}</h1>
      <div class="muted">${escapeHtml(date)} • ${escapeHtml(it.ccy || 'USD')} • ${escapeHtml(LANG.toUpperCase())}</div>

      <h2 style="font-size:16px;margin:10px 0 6px;">${escapeHtml(LANG==='cs' ? 'Vstupy' : 'Inputs')}</h2>
      <table>${rows}</table>

      <h2 style="font-size:16px;margin:10px 0 6px;">${escapeHtml(LANG==='cs' ? 'Výsledky' : 'Results')}</h2>
      <div class="grid">
        ${resRow('Bear', it.results.ps.bear, it.results.ev.bear, it.results.eq.bear)}
        ${resRow('Base', it.results.ps.base, it.results.ev.base, it.results.eq.base)}
        ${resRow('Bull', it.results.ps.bull, it.results.ev.bull, it.results.eq.bull)}
      </div>

      <div class="muted" style="margin-top:14px;">
        ${escapeHtml(LANG==='cs'
          ? "Pozn.: Zjednodušený model, měna je pouze formátování (bez FX převodu)."
          : "Note: Simplified model, currency is formatting only (no FX conversion).")}
      </div>

      <button onclick="window.print()" style="padding:10px 12px;font-weight:800;border:1px solid #222;border-radius:10px;background:#fff;cursor:pointer;">
        ${escapeHtml(LANG==='cs' ? 'Tisk / Uložit jako PDF' : 'Print / Save as PDF')}
      </button>
    </body>
  </html>
  `;

  const w = window.open("", "_blank");
  if(!w){
    openModal("PDF", LANG==='cs'
      ? "<p>Prohlížeč zablokoval nové okno. Povol vyskakovací okna a zkus to znovu.</p>"
      : "<p>Your browser blocked the popup. Allow popups and try again.</p>"
    );
    CCY = prev;
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();

  CCY = prev;
}

/* ========= Init ========= */
(function init(){
  document.getElementById('btnCZ')?.classList.add('on');
  document.getElementById('btnEN')?.classList.add('off');

  setCcy(document.getElementById('inp_ccy')?.value || 'USD');

  applyLang();
  renderWatchlist();
})();



    

        
    

    

    

    
        


        

    
    
    

      



    
        








    

    

    

 


        


        



  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





