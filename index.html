 <!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equity Analyzer – DCF</title>
  <style>
    :root{
      --bg0:#070814;
      --bg1:#0b0d22;
      --card:#101339cc;
      --card2:#0d1033cc;
      --text:#eef0ff;
      --muted:#aab0d6;
      --muted2:#7d84b8;
      --line:#232a5f;
      --accent:#7c4dff;
      --accent2:#00d1ff;
      --good:#2ef2a7;
      --warn:#ffd36a;
      --bad:#ff5b8a;

      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 26px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,77,255,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(0,209,255,.20), transparent 55%),
        radial-gradient(900px 600px at 60% 90%, rgba(124,77,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 50px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(16,19,57,.75), rgba(9,10,26,.55));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 220px;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,77,255,.9), rgba(0,209,255,.75));
      box-shadow: 0 10px 28px rgba(124,77,255,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      background: rgba(9,10,26,.35);
      border:1px solid rgba(255,255,255,.10);
    }

    h1{
      margin:0;
      font-size: clamp(18px, 2.5vw, 22px);
      letter-spacing: .2px;
      line-height:1.1;
    }
    .sub{
      margin:2px 0 0 0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.3;
      max-width: 52ch;
    }

    .ctrls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(8,10,24,.35);
      backdrop-filter: blur(8px);
    }

    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(7,8,20,.55);
    }
    .seg button{
      border:0;
      padding:9px 12px;
      color:var(--muted);
      background: transparent;
      cursor:pointer;
      font-weight:600;
      font-size: 13px;
    }
    .seg button.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(124,77,255,.9), rgba(0,209,255,.55));
    }

    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,19,57,.75), rgba(9,10,26,.55));
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
    }
    .btn:hover{ filter: brightness(1.08); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      border-color: rgba(124,77,255,.45);
      background: linear-gradient(135deg, rgba(124,77,255,.95), rgba(0,209,255,.55));
      box-shadow: 0 16px 40px rgba(124,77,255,.22);
    }
    .btnGhost{
      background: rgba(10,12,35,.35);
      box-shadow:none;
    }

    .grid{
      margin-top: 16px;
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }

    .drawerBar{
      display:flex;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }

    .drawer{
      flex:1 1 260px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(16,19,57,.60), rgba(9,10,26,.45));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .drawerHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      cursor:pointer;
      user-select:none;
    }
    .drawerTitle{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .tag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius: 999px;
      background: rgba(7,8,20,.35);
    }
    .chev{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(7,8,20,.35);
      display:grid;
      place-items:center;
      color: var(--muted);
      transition: transform .18s ease;
    }
    .drawer.open .chev{ transform: rotate(180deg); }

    .drawerBody{
      display:none;
      border-top: 1px solid rgba(35,42,95,.75);
      padding: 14px;
    }
    .drawer.open .drawerBody{ display:block; }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(10,12,35,.45);
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      padding: 14px;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width: 900px){
      .twoCol{ grid-template-columns: 1.2fr .8fr; }
    }

    .sectionTitle{
      font-weight:900;
      font-size: 14px;
      margin: 0 0 10px 0;
      color: var(--text);
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      font-weight:600;
    }

    .form{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 700px){
      .form{ grid-template-columns: repeat(2, 1fr); }
    }

    .field{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px 8px;
      background: rgba(7,8,20,.35);
    }
    .labelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .helpBtn{
      border:0;
      cursor:pointer;
      background: transparent;
      color: var(--muted2);
      font-weight:900;
      font-size: 12px;
      padding: 0;
    }
    .helpBtn:hover{ color: var(--text); }

    input, select{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      font-weight: 700;
      padding: 6px 2px;
    }
    input::placeholder{ color: rgba(170,176,214,.65); }

    .rowActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .resultsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 700px){
      .resultsGrid{ grid-template-columns: repeat(3, 1fr); }
    }

    .resCard{
      border:1px solid rgba(124,77,255,.25);
      border-radius: 18px;
      background:
        radial-gradient(400px 180px at 20% 0%, rgba(124,77,255,.20), transparent 60%),
        radial-gradient(400px 180px at 80% 0%, rgba(0,209,255,.16), transparent 60%),
        rgba(7,8,20,.35);
      padding: 12px;
      position:relative;
      overflow:hidden;
    }
    .resTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom: 8px;
    }
    .resLabel{
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .chip{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }
    .chip.good{ color: var(--good); border-color: rgba(46,242,167,.25); }
    .chip.warn{ color: var(--warn); border-color: rgba(255,211,106,.28); }
    .chip.bad{ color: var(--bad); border-color: rgba(255,91,138,.25); }

    .resValue{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: .2px;
      line-height:1.1;
    }
    .resSub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }

    .empty{
      color: var(--muted);
      padding: 14px;
      text-align:center;
      border: 1px dashed rgba(35,42,95,.8);
      border-radius: 18px;
      background: rgba(7,8,20,.25);
    }

    .watchItem{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: rgba(7,8,20,.30);
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
    }
    .watchMain{
      flex:1;
      cursor:pointer;
      min-width: 0;
    }
    .watchTitle{
      font-weight: 1000;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .watchSub{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .watchVals{
      margin-top: 8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .watchVals b{ color: var(--text); }
    .watchBtns{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width: 120px;
    }
    .btnSmall{
      padding:9px 10px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 900;
    }
    .btnDanger{
      border-color: rgba(255,91,138,.25);
      background: rgba(255,91,138,.12);
      color: var(--text);
      box-shadow:none;
    }

    /* MODAL */
    .modalBack{
      position:fixed;
      inset:0;
      display:none;
      background: rgba(0,0,0,.55);
      padding: 18px;
      z-index: 1000;
    }
    .modalBack.show{ display:grid; place-items:center; }
    .modal{
      width:min(720px, 100%);
      border:1px solid rgba(35,42,95,.9);
      border-radius: 22px;
      background:
        radial-gradient(800px 340px at 20% 0%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(800px 340px at 80% 0%, rgba(0,209,255,.18), transparent 60%),
        rgba(8,10,24,.92);
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(35,42,95,.85);
    }
    .modalTitle{
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .x{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border:1px solid rgba(35,42,95,.95);
      background: rgba(7,8,20,.35);
      color: var(--text);
      cursor:pointer;
      font-weight: 1000;
    }
    .modalBody{
      padding: 14px;
      color: var(--text);
    }
    .modalBody p{ margin: 0 0 10px 0; color: var(--muted); line-height:1.5; }
    .modalBody b{ color: var(--text); }
    .modalBody ul{ margin: 8px 0 0 18px; color: var(--muted); }

    /* PRINT (PDF) */
    @media print{
      body{ background:#fff !important; color:#111 !important; }
      .noPrint{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar noPrint">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="t_h1">Analýza akcií – DCF</h1>
          <div class="sub" id="t_sub">Rychlý odhad férové ceny přes jednoduchý DCF (Bear/Base/Bull) + Watchlist.</div>
        </div>
      </div>

      <div class="ctrls">
        <div class="pill">
          <span style="font-weight:900;color:var(--muted);font-size:12px;" id="t_lang">Jazyk</span>
          <div class="seg" role="tablist" aria-label="Language">
            <button id="btnLangCS" class="active" onclick="setLang('cs')">CZ</button>
            <button id="btnLangEN" onclick="setLang('en')">EN</button>
          </div>
        </div>

        <div class="pill">
          <span style="font-weight:900;color:var(--muted);font-size:12px;" id="t_ccy">Měna</span>
          <div class="seg" role="tablist" aria-label="Currency">
            <button id="btnCcyUSD" class="active" onclick="setCcy('USD')">USD</button>
            <button id="btnCcyEUR" onclick="setCcy('EUR')">EUR</button>
          </div>
        </div>

        <button class="btn btnGhost" onclick="openHelp('about')" id="btnAbout">O aplikaci</button>
      </div>
    </div>

    <div class="drawerBar noPrint">
      <div class="drawer open" id="drawerDCF">
        <div class="drawerHead" onclick="toggleDrawer('drawerDCF')">
          <div class="drawerTitle">
            <span id="t_navDCF">DCF</span>
            <span class="tag" id="t_navDCFtag">Výpočet</span>
          </div>
          <div class="chev">⌄</div>
        </div>
        <div class="drawerBody">
          <div class="twoCol">
            <div class="card">
              <div class="sectionTitle">
                <span id="t_inputs">Vstupy</span>
                <span class="hint" id="t_inputsHint">Klikni na “?” pro vysvětlivku.</span>
              </div>

              <div class="form">
                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_ticker">Ticker / Název</label>
                    <button class="helpBtn" onclick="openHelp('ticker')" type="button">?</button>
                  </div>
                  <input id="inp_ticker" placeholder="AAPL / Apple" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_fcf">Poslední roční FCF</label>
                    <button class="helpBtn" onclick="openHelp('fcf')" type="button">?</button>
                  </div>
                  <input id="inp_fcf" inputmode="decimal" placeholder="např. 9500000000" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_years">Počet let projekce</label>
                    <button class="helpBtn" onclick="openHelp('years')" type="button">?</button>
                  </div>
                  <input id="inp_years" inputmode="numeric" placeholder="10" value="10" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_wacc">Diskontní sazba (WACC / r) %</label>
                    <button class="helpBtn" onclick="openHelp('wacc')" type="button">?</button>
                  </div>
                  <input id="inp_wacc" inputmode="decimal" placeholder="9" value="9" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_tg">Terminal growth %</label>
                    <button class="helpBtn" onclick="openHelp('tg')" type="button">?</button>
                  </div>
                  <input id="inp_tg" inputmode="decimal" placeholder="2.5" value="2.5" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_netDebt">Net debt / Cash úprava</label>
                    <button class="helpBtn" onclick="openHelp('netDebt')" type="button">?</button>
                  </div>
                  <input id="inp_netDebt" inputmode="decimal" placeholder="0" value="0" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_shares">Počet akcií (Shares)</label>
                    <button class="helpBtn" onclick="openHelp('shares')" type="button">?</button>
                  </div>
                  <input id="inp_shares" inputmode="decimal" placeholder="např. 16000000000" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_price">Aktuální cena (volitelné)</label>
                    <button class="helpBtn" onclick="openHelp('price')" type="button">?</button>
                  </div>
                  <input id="inp_price" inputmode="decimal" placeholder="např. 190" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_bear">Růst FCF Bear %</label>
                    <button class="helpBtn" onclick="openHelp('growth')" type="button">?</button>
                  </div>
                  <input id="inp_bear" inputmode="decimal" placeholder="např. 4" value="4" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_base">Růst FCF Base %</label>
                    <button class="helpBtn" onclick="openHelp('growth')" type="button">?</button>
                  </div>
                  <input id="inp_base" inputmode="decimal" placeholder="např. 8" value="8" />
                </div>

                <div class="field">
                  <div class="labelRow">
                    <label id="lbl_bull">Růst FCF Bull %</label>
                    <button class="helpBtn" onclick="openHelp('growth')" type="button">?</button>
                  </div>
                  <input id="inp_bull" inputmode="decimal" placeholder="např. 12" value="12" />
                </div>
              </div>

              <div class="rowActions">
                <button class="btn btnPrimary" onclick="calcDCF()" id="btnCalc">Spočítat</button>
                <button class="btn" onclick="saveCurrent()" id="btnSave">Uložit do Watchlistu</button>
                <button class="btn btnGhost" onclick="exportCurrentPDF()" id="btnPDF">PDF (tisk)</button>
              </div>
            </div>

            <div class="card">
              <div class="sectionTitle">
                <span id="t_results">Výsledky</span>
                <span class="hint" id="t_resultsHint">Bear / Base / Bull</span>
              </div>

              <div id="resultsBox">
                <div class="empty" id="t_resultsEmpty">Zatím nic. Vyplň vstupy a klikni na „Spočítat“.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="drawer" id="drawerWATCH">
        <div class="drawerHead" onclick="toggleDrawer('drawerWATCH')">
          <div class="drawerTitle">
            <span id="t_navWatch">Watchlist</span>
            <span class="tag" id="t_navWatchtag">Uložené</span>
          </div>
          <div class="chev">⌄</div>
        </div>

        <div class="drawerBody">
          <div class="card">
            <div class="sectionTitle">
              <span id="t_watchTitle">Uložené výpočty</span>
              <span class="hint" id="t_watchHint">Klikni na položku pro načtení do DCF.</span>
            </div>
            <div id="watchBox"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div class="modalBack" id="modalBack" onclick="closeModalFromBg(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalTop">
          <div class="modalTitle" id="modalTitle">Info</div>
          <button class="x" onclick="closeModal()">×</button>
        </div>
        <div class="modalBody" id="modalBody"></div>
      </div>
    </div>

  </div>

<script>
/* ========= State ========= */
const STORE_KEY = 'equity_analyzer_watchlist_v2';
let LANG = 'cs';
let CCY = 'USD';
let LAST = null;

/* ========= i18n UI ========= */
const UI = {
  cs: {
    h1: "Analýza akcií – DCF",
    sub: "Rychlý odhad férové ceny přes jednoduchý DCF (Bear/Base/Bull) + Watchlist.",
    lang: "Jazyk",
    ccy: "Měna",
    about: "O aplikaci",
    navDCF: "DCF",
    navDCFtag: "Výpočet",
    navWatch: "Watchlist",
    navWatchtag: "Uložené",
    inputs: "Vstupy",
    inputsHint: "Klikni na “?” pro vysvětlivku.",
    results: "Výsledky",
    resultsHint: "Bear / Base / Bull",
    resultsEmpty: "Zatím nic. Vyplň vstupy a klikni na „Spočítat“.",
    btnCalc: "Spočítat",
    btnSave: "Uložit do Watchlistu",
    btnPDF: "PDF (tisk)",
    watchTitle: "Uložené výpočty",
    watchHint: "Klikni na položku pro načtení do DCF.",
    emptyWatch: "Zatím nic uloženého. Po výpočtu klikni na „Uložit do Watchlistu“.",
    load: "Načíst",
    pdf: "PDF",
    del: "Smazat",
    saved: "Uloženo",
    cannotSave: "Nelze uložit",
    needCalc: "<p>Nejdřív klikni na <b>Spočítat</b>, ať máme výsledky.</p>",
    loaded: "Načteno",
    loadedMsg: "<p>Výpočet byl načten z Watchlistu do DCF vstupů.</p>",
    removed: "Smazáno",
    removedMsg: "<p>Položka byla odstraněna z Watchlistu.</p>",
    err: "Chyba",
    errMsg: "<p>Něco se nepovedlo. Zkontroluj vstupy (čísla) a zkus to znovu.</p>",
    fairPerShare: "Férová cena / akcii",
    equityValue: "Equity value",
    evValue: "Enterprise value",
    noteNoShares: "Nemáš vyplněné Shares – zobrazujeme EV/Equity (bez ceny na akcii).",
    lblPriceLine: "Cena: ",
    discount: "Diskont",
    upside: "Upside",
    downside: "Downside",
    printHint: "Otevře se report – v prohlížeči dej Tisk → Uložit jako PDF.",
  },
  en: {
    h1: "Equity Analyzer – DCF",
    sub: "Quick fair value estimate using a simple DCF (Bear/Base/Bull) + Watchlist.",
    lang: "Language",
    ccy: "Currency",
    about: "About",
    navDCF: "DCF",
    navDCFtag: "Calculator",
    navWatch: "Watchlist",
    navWatchtag: "Saved",
    inputs: "Inputs",
    inputsHint: "Tap “?” for explanations.",
    results: "Results",
    resultsHint: "Bear / Base / Bull",
    resultsEmpty: "No results yet. Fill inputs and click “Calculate”.",
    btnCalc: "Calculate",
    btnSave: "Save to Watchlist",
    btnPDF: "PDF (print)",
    watchTitle: "Saved calculations",
    watchHint: "Click an item to load it back into the DCF inputs.",
    emptyWatch: "Nothing saved yet. After calculating, click “Save to Watchlist”.",
    load: "Load",
    pdf: "PDF",
    del: "Delete",
    saved: "Saved",
    cannotSave: "Cannot save",
    needCalc: "<p>First click <b>Calculate</b> so we have results to store.</p>",
    loaded: "Loaded",
    loadedMsg: "<p>The calculation was loaded from Watchlist into the DCF inputs.</p>",
    removed: "Deleted",
    removedMsg: "<p>The item was removed from the Watchlist.</p>",
    err: "Error",
    errMsg: "<p>Something went wrong. Check numeric inputs and try again.</p>",
    fairPerShare: "Fair value / share",
    equityValue: "Equity value",
    evValue: "Enterprise value",
    noteNoShares: "Shares are missing — showing EV/Equity (no per-share value).",
    lblPriceLine: "Price: ",
    discount: "Discount",
    upside: "Upside",
    downside: "Downside",
    printHint: "A report opens — use Print → Save as PDF in your browser.",
  }
};

function t(key){
  return (UI[LANG] && UI[LANG][key]) ? UI[LANG][key] : (UI.cs[key] || key);
}

function setLang(l){
  LANG = (l === 'en') ? 'en' : 'cs';
  document.getElementById('btnLangCS').classList.toggle('active', LANG==='cs');
  document.getElementById('btnLangEN').classList.toggle('active', LANG==='en');
  applyText();
  renderResults(LAST);
  renderWatchlist();
}

function setCcy(c){
  CCY = (c === 'EUR') ? 'EUR' : 'USD';
  document.getElementById('btnCcyUSD').classList.toggle('active', CCY==='USD');
  document.getElementById('btnCcyEUR').classList.toggle('active', CCY==='EUR');
  renderResults(LAST);
  renderWatchlist();
}

function applyText(){
  document.documentElement.lang = LANG;
  document.getElementById('t_h1').textContent = t('h1');
  document.getElementById('t_sub').textContent = t('sub');
  document.getElementById('t_lang').textContent = t('lang');
  document.getElementById('t_ccy').textContent = t('ccy');
  document.getElementById('btnAbout').textContent = t('about');

  document.getElementById('t_navDCF').textContent = t('navDCF');
  document.getElementById('t_navDCFtag').textContent = t('navDCFtag');
  document.getElementById('t_navWatch').textContent = t('navWatch');
  document.getElementById('t_navWatchtag').textContent = t('navWatchtag');

  document.getElementById('t_inputs').textContent = t('inputs');
  document.getElementById('t_inputsHint').textContent = t('inputsHint');
  document.getElementById('t_results').textContent = t('results');
  document.getElementById('t_resultsHint').textContent = t('resultsHint');

  const emptyEl = document.getElementById('t_resultsEmpty');
  if (emptyEl) emptyEl.textContent = t('resultsEmpty');

  document.getElementById('btnCalc').textContent = t('btnCalc');
  document.getElementById('btnSave').textContent = t('btnSave');
  document.getElementById('btnPDF').textContent = t('btnPDF');

  document.getElementById('t_watchTitle').textContent = t('watchTitle');
  document.getElementById('t_watchHint').textContent = t('watchHint');

  document.getElementById('lbl_ticker').textContent = (LANG==='cs') ? "Ticker / Název" : "Ticker / Name";
  document.getElementById('lbl_fcf').textContent = (LANG==='cs') ? "Poslední roční FCF" : "Latest annual FCF";
  document.getElementById('lbl_years').textContent = (LANG==='cs') ? "Počet let projekce" : "Projection years";
  document.getElementById('lbl_wacc').textContent = (LANG==='cs') ? "Diskontní sazba (WACC / r) %" : "Discount rate (WACC / r) %";
  document.getElementById('lbl_tg').textContent = (LANG==='cs') ? "Terminal growth %" : "Terminal growth %";
  document.getElementById('lbl_netDebt').textContent = (LANG==='cs') ? "Net debt / Cash úprava" : "Net debt / Cash adjustment";
  document.getElementById('lbl_shares').textContent = (LANG==='cs') ? "Počet akcií (Shares)" : "Shares outstanding";
  document.getElementById('lbl_price').textContent = (LANG==='cs') ? "Aktuální cena (volitelné)" : "Current price (optional)";
  document.getElementById('lbl_bear').textContent = (LANG==='cs') ? "Růst FCF Bear %" : "FCF growth Bear %";
  document.getElementById('lbl_base').textContent = (LANG==='cs') ? "Růst FCF Base %" : "FCF growth Base %";
  document.getElementById('lbl_bull').textContent = (LANG==='cs') ? "Růst FCF Bull %" : "FCF growth Bull %";
}

/* ========= Drawers ========= */
function toggleDrawer(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.toggle('open');
}

/* ========= Helpers / Parsing ========= */
function num(v){
  if(v === null || v === undefined) return null;
  if(typeof v === 'number') return isFinite(v) ? v : null;
  const s = String(v).trim().replace(/\s/g,'').replace(',', '.');
  if(!s) return null;
  const x = Number(s);
  return isFinite(x) ? x : null;
}

function fmtMoney(x, decimals=0){
  if(x === null || x === undefined || !isFinite(Number(x))) return "–";
  const n = Number(x);
  return n.toLocaleString(LANG==='cs' ? 'cs-CZ' : 'en-US', {
    maximumFractionDigits: decimals,
    minimumFractionDigits: decimals
  }) + " " + CCY;
}

function fmtPct(x, decimals=1){
  if(x === null || x === undefined || !isFinite(Number(x))) return "–";
  const n = Number(x);
  return n.toLocaleString(LANG==='cs' ? 'cs-CZ' : 'en-US', {
    maximumFractionDigits: decimals,
    minimumFractionDigits: decimals
  }) + "%";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ========= DCF Core ========= */
function dcfScenario({fcf, g, years, r, tg}){
  const N = years;
  let pv = 0;
  for(let t=1; t<=N; t++){
    const fcf_t = fcf * Math.pow(1+g, t);
    pv += fcf_t / Math.pow(1+r, t);
  }
  const fcfN1 = fcf * Math.pow(1+g, N+1);
  const tv = fcfN1 / Math.max(1e-9, (r - tg));
  const pvTV = tv / Math.pow(1+r, N);
  return { ev: pv + pvTV, pvFCF: pv, pvTV };
}

function calcDCF(){
  try{
    const ticker = document.getElementById('inp_ticker').value.trim();
    const fcf = num(document.getElementById('inp_fcf').value);
    const years = num(document.getElementById('inp_years').value);
    const waccPct = num(document.getElementById('inp_wacc').value);
    const tgPct = num(document.getElementById('inp_tg').value);
    const netDebt = num(document.getElementById('inp_netDebt').value) ?? 0;
    const shares = num(document.getElementById('inp_shares').value);
    const price = num(document.getElementById('inp_price').value);

    const bearG = num(document.getElementById('inp_bear').value);
    const baseG = num(document.getElementById('inp_base').value);
    const bullG = num(document.getElementById('inp_bull').value);

    if(fcf === null || years === null || waccPct === null || tgPct === null || bearG===null || baseG===null || bullG===null){
      openModal(t('err'), t('errMsg'));
      return;
    }

    const r = waccPct / 100;
    const tg = tgPct / 100;

    const resBear = dcfScenario({ fcf, g: bearG/100, years: Math.max(1, Math.round(years)), r, tg });
    const resBase = dcfScenario({ fcf, g: baseG/100, years: Math.max(1, Math.round(years)), r, tg });
    const resBull = dcfScenario({ fcf, g: bullG/100, years: Math.max(1, Math.round(years)), r, tg });

    const toEquity = (ev) => ev - (netDebt ?? 0);

    const eqBear = toEquity(resBear.ev);
    const eqBase = toEquity(resBase.ev);
    const eqBull = toEquity(resBull.ev);

    const fairPS = (eq) => (shares && shares>0) ? (eq / shares) : null;

    LAST = {
      ts: Date.now(),
      ccy: CCY,
      lang: LANG,
      ticker,
      inputs: {
        fcf, years: Math.max(1, Math.round(years)),
        waccPct, tgPct, netDebt, shares, price,
        bearG, baseG, bullG
      },
      out: {
        ev: { bear: resBear.ev, base: resBase.ev, bull: resBull.ev },
        eq: { bear: eqBear, base: eqBase, bull: eqBull },
        ps: { bear: fairPS(eqBear), base: fairPS(eqBase), bull: fairPS(eqBull) }
      }
    };

    renderResults(LAST);

    const d = document.getElementById('drawerDCF');
    if(d && !d.classList.contains('open')) d.classList.add('open');
  }catch(e){
    openModal(t('err'), t('errMsg'));
  }
}

function renderResults(res){
  const box = document.getElementById('resultsBox');
  if(!box) return;

  if(!res){
    box.innerHTML = `<div class="empty" id="t_resultsEmpty">${escapeHtml(t('resultsEmpty'))}</div>`;
    return;
  }

  const prevCcy = CCY;
  CCY = res.ccy || prevCcy;

  const price = (res.inputs && res.inputs.price != null) ? Number(res.inputs.price) : null;
  const shares = (res.inputs && res.inputs.shares != null) ? Number(res.inputs.shares) : null;
  const hasPS = !!(shares && isFinite(shares) && shares > 0);

  const badge = (fair) => {
    if(price === null || !isFinite(price) || fair === null || !isFinite(fair) || price<=0)
      return `<span class="chip">${escapeHtml(t('discount'))}: –</span>`;
    const diff = (fair - price) / price * 100;
    const sign = diff >= 0 ? "+" : "";
    let cls = "warn";
    if(diff >= 15) cls = "good";
    if(diff <= -15) cls = "bad";
    const label = diff >= 0 ? t('upside') : t('downside');
    return `<span class="chip ${cls}">${escapeHtml(label)}: ${escapeHtml(sign + fmtPct(diff,1))}</span>`;
  };

  function card(label, fairPS, ev, eq){
    const big = hasPS ? fmtMoney(fairPS, 2) : fmtMoney(eq, 0);
    let sub = "";
    if(hasPS){
      sub += `<div>${escapeHtml(t('equityValue'))}: <b>${escapeHtml(fmtMoney(eq,0))}</b></div>`;
      sub += `<div>${escapeHtml(t('evValue'))}: <b>${escapeHtml(fmtMoney(ev,0))}</b></div>`;
      if(price !== null && isFinite(price)) sub += `<div>${escapeHtml(t('lblPriceLine'))}<b>${escapeHtml(fmtMoney(price,2))}</b></div>`;
    }else{
      sub += `<div class="resSub">${escapeHtml(t('noteNoShares'))}</div>`;
      sub += `<div class="resSub">${escapeHtml(t('equityValue'))}: <b>${escapeHtml(fmtMoney(eq,0))}</b></div>`;
      sub += `<div class="resSub">${escapeHtml(t('evValue'))}: <b>${escapeHtml(fmtMoney(ev,0))}</b></div>`;
    }

    const chip = hasPS ? badge(fairPS) : `<span class="chip">${escapeHtml(t('equityValue'))}</span>`;

    return `
      <div class="resCard">
        <div class="resTop">
          <div class="resLabel">${escapeHtml(label)}</div>
          ${chip}
        </div>
        <div class="resValue">${escapeHtml(big)}</div>
        <div class="resSub">${hasPS ? escapeHtml(t('fairPerShare')) : ""}</div>
        <div class="resSub">${sub}</div>
      </div>
    `;
  }

  const out = res.out;
  box.innerHTML = `
    <div class="resultsGrid">
      ${card("Bear", out.ps.bear, out.ev.bear, out.eq.bear)}
      ${card("Base", out.ps.base, out.ev.base, out.eq.base)}
      ${card("Bull", out.ps.bull, out.ev.bull, out.eq.bull)}
    </div>
  `;

  CCY = prevCcy;
}

/* ========= Watchlist (localStorage) ========= */
function loadWatch(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}

function saveWatch(arr){
  localStorage.setItem(STORE_KEY, JSON.stringify(arr));
}

function addToWatchlist(item){
  const arr = loadWatch();
  arr.unshift(item);
  saveWatch(arr);
  renderWatchlist();
}

function removeFromWatchlist(idx){
  const arr = loadWatch();
  arr.splice(idx, 1);
  saveWatch(arr);
  renderWatchlist();
  openModal(t('removed'), t('removedMsg'));
}

function loadItem(idx){
  const arr = loadWatch();
  const it = arr[idx];
  if(!it) return;

  if(it.ccy) setCcy(it.ccy);

  document.getElementById('inp_ticker').value = it.ticker || "";
  document.getElementById('inp_fcf').value = it.inputs?.fcf ?? "";
  document.getElementById('inp_years').value = it.inputs?.years ?? 10;
  document.getElementById('inp_wacc').value = it.inputs?.waccPct ?? 9;
  document.getElementById('inp_tg').value = it.inputs?.tgPct ?? 2.5;
  document.getElementById('inp_netDebt').value = it.inputs?.netDebt ?? 0;
  document.getElementById('inp_shares').value = it.inputs?.shares ?? "";
  document.getElementById('inp_price').value = it.inputs?.price ?? "";
  document.getElementById('inp_bear').value = it.inputs?.bearG ?? 4;
  document.getElementById('inp_base').value = it.inputs?.baseG ?? 8;
  document.getElementById('inp_bull').value = it.inputs?.bullG ?? 12;

  LAST = it;

  document.getElementById('drawerDCF').classList.add('open');
  document.getElementById('drawerWATCH').classList.remove('open');

  renderResults(LAST);
  openModal(t('loaded'), t('loadedMsg'));
}

function renderWatchlist(){
  const box = document.getElementById('watchBox');
  if(!box) return;

  const arr = loadWatch();
  if(!arr.length){
    box.innerHTML = `<div class="empty">${escapeHtml(t('emptyWatch'))}</div>`;
    return;
  }

  box.innerHTML = arr.map((it, i) => {
    const title = escapeHtml(it.ticker || "—");
    const dt = it.ts ? new Date(it.ts) : null;
    const when = dt ? dt.toLocaleString(LANG==='cs' ? 'cs-CZ' : 'en-US') : "";
    const ccy = it.ccy || CCY;

    const prev = CCY;
    CCY = ccy;

    const hasPS = it.inputs?.shares && isFinite(Number(it.inputs.shares)) && Number(it.inputs.shares) > 0;
    const bear = hasPS ? fmtMoney(it.out?.ps?.bear, 2) : fmtMoney(it.out?.eq?.bear, 0);
    const base = hasPS ? fmtMoney(it.out?.ps?.base, 2) : fmtMoney(it.out?.eq?.base, 0);
    const bull = hasPS ? fmtMoney(it.out?.ps?.bull, 2) : fmtMoney(it.out?.eq?.bull, 0);

    CCY = prev;

    return `
      <div class="watchItem">
        <div class="watchMain" onclick="loadItem(${i})" title="${title}">
          <div class="watchTitle">${title}</div>
          <div class="watchSub">
            <span>${escapeHtml(when)}</span>
            <span>•</span>
            <span>${escapeHtml(ccy)}</span>
          </div>
          <div class="watchVals">
            <span>Bear: <b>${escapeHtml(bear)}</b></span>
            <span>Base: <b>${escapeHtml(base)}</b></span>
            <span>Bull: <b>${escapeHtml(bull)}</b></span>
          </div>
        </div>
        <div class="watchBtns">
          <button class="btn btnSmall" onclick="event.stopPropagation(); loadItem(${i});">${escapeHtml(t('load'))}</button>
          <button class="btn btnSmall btnGhost" onclick="event.stopPropagation(); exportItemPDF(${i});">${escapeHtml(t('pdf'))}</button>
          <button class="btn btnSmall btnDanger" onclick="event.stopPropagation(); removeFromWatchlist(${i});">${escapeHtml(t('del'))}</button>
        </div>
      </div>
    `;
  }).join("");
}

function saveCurrent(){
  if(!LAST){
    openModal(t('cannotSave'), t('needCalc'));
    return;
  }
  addToWatchlist(LAST);
  openModal(t('saved'), `<p><b>${escapeHtml(LAST.ticker || "—")}</b> — ${escapeHtml(t('saved'))}.</p>`);
}

/* ========= PDF Export (Print-to-PDF) ========= */
function buildReportHTML(item){
  const prevLang = LANG;
  const prevCcy = CCY;

  LANG = item.lang || LANG;
  CCY = item.ccy || CCY;

  const hasPS = item.inputs?.shares && isFinite(Number(item.inputs.shares)) && Number(item.inputs.shares) > 0;

  const rows = [
    ["Ticker", item.ticker || "—"],
    [(LANG==='cs' ? "Měna" : "Currency"), item.ccy || "—"],
    [(LANG==='cs' ? "FCF" : "FCF"), fmtMoney(item.inputs?.fcf, 0)],
    [(LANG==='cs' ? "Růst Bear/Base/Bull" : "Growth Bear/Base/Bull"),
      `${fmtPct(item.inputs?.bearG,1)} / ${fmtPct(item.inputs?.baseG,1)} / ${fmtPct(item.inputs?.bullG,1)}`],
    [(LANG==='cs' ? "Roky" : "Years"), String(item.inputs?.years ?? "")],
    [(LANG==='cs' ? "Diskont (WACC)" : "Discount (WACC)"), fmtPct(item.inputs?.waccPct,1)],
    [(LANG==='cs' ? "Terminal growth" : "Terminal growth"), fmtPct(item.inputs?.tgPct,1)],
    [(LANG==='cs' ? "Net debt" : "Net debt"), fmtMoney(item.inputs?.netDebt, 0)],
    [(LANG==='cs' ? "Shares" : "Shares"), item.inputs?.shares ? item.inputs.shares.toLocaleString() : "—"],
    [(LANG==='cs' ? "Aktuální cena" : "Current price"), item.inputs?.price ? fmtMoney(item.inputs?.price,2) : "—"]
  ];

  const bear = hasPS ? fmtMoney(item.out?.ps?.bear, 2) : fmtMoney(item.out?.eq?.bear, 0);
  const base = hasPS ? fmtMoney(item.out?.ps?.base, 2) : fmtMoney(item.out?.eq?.base, 0);
  const bull = hasPS ? fmtMoney(item.out?.ps?.bull, 2) : fmtMoney(item.out?.eq?.bull, 0);

  const title = (LANG==='cs' ? "DCF report" : "DCF Report");
  const subtitle = hasPS ? (LANG==='cs' ? "Férová cena / akcii" : "Fair value per share")
                         : (LANG==='cs' ? "Equity value" : "Equity value");

  const html = `
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>${escapeHtml(title)}</title>
    <style>
      body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:24px; color:#111; }
      h1{ margin:0 0 6px 0; }
      .muted{ color:#555; margin:0 0 18px 0; }
      .box{ border:1px solid #ddd; border-radius:14px; padding:14px; margin:14px 0; }
      table{ width:100%; border-collapse:collapse; }
      td{ padding:8px 6px; border-bottom:1px solid #eee; vertical-align:top; }
      td:first-child{ width:240px; color:#444; font-weight:700; }
      .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
      .card{ border:1px solid #ddd; border-radius:14px; padding:12px; }
      .label{ font-weight:900; }
      .value{ font-size:20px; font-weight:1000; margin-top:6px; }
      .small{ color:#555; font-size:12px; margin-top:6px; }
      @media print{ button{ display:none; } }
    </style>
  </head>
  <body>
    <h1>${escapeHtml(item.ticker || "—")} — ${escapeHtml(title)}</h1>
    <p class="muted">${escapeHtml(subtitle)} • ${escapeHtml(new Date(item.ts || Date.now()).toLocaleString(LANG==='cs'?'cs-CZ':'en-US'))}</p>

    <div class="box">
      <h3 style="margin:0 0 10px 0;">${escapeHtml(LANG==='cs' ? "Vstupy" : "Inputs")}</h3>
      <table>
        ${rows.map(r => `<tr><td>${escapeHtml(r[0])}</td><td>${escapeHtml(String(r[1]))}</td></tr>`).join("")}
      </table>
    </div>

    <div class="box">
      <h3 style="margin:0 0 10px 0;">${escapeHtml(LANG==='cs' ? "Výsledky" : "Results")}</h3>
      <div class="grid">
        <div class="card"><div class="label">Bear</div><div class="value">${escapeHtml(bear)}</div></div>
        <div class="card"><div class="label">Base</div><div class="value">${escapeHtml(base)}</div></div>
        <div class="card"><div class="label">Bull</div><div class="value">${escapeHtml(bull)}</div></div>
      </div>
      <div class="small">${escapeHtml(t('printHint'))}</div>
      <button onclick="window.print()" style="margin-top:12px;padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#f6f6f6;cursor:pointer;font-weight:800;">
        ${escapeHtml(LANG==='cs' ? "Tisk / Uložit jako PDF" : "Print / Save as PDF")}
      </button>
    </div>
  </body>
  </html>
  `;

  LANG = prevLang;
  CCY = prevCcy;
  return html;
  }


    
    

        
    

    

    

    
        


        

    
    
    

      



    
        








    

    

    

 


        


        



  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





