<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Equity Analyzer</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6d28d9">
  <link rel="icon" sizes="192x192" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <style>
    :root{
      --bg0:#060314;
      --bg1:#12062c;
      --bg2:#1a0a3a;

      --cardA: rgba(255,255,255,.10);
      --cardB: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);

      --vio1:#7c3aed;
      --vio2:#a78bfa;
      --cyan:#22d3ee;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --radius2: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(124,58,237,.55), transparent 60%),
        radial-gradient(900px 600px at 10% 20%, rgba(34,211,238,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(167,139,250,.18), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg2));
      overflow-x:hidden;
    }

    .wrap{
      width:min(980px, 92vw);
      margin: 18px auto 28px;
      padding-bottom: 24px;
    }

    .topHero{
      border-radius: 28px;
      padding: 26px 22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    .brandRow{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
      flex-wrap:wrap;
    }

    .brandTitle{
      font-weight: 860;
      letter-spacing: .2px;
      font-size: clamp(30px, 4.6vw, 44px);
      line-height: 1.05;
      color: rgba(255,255,255,.96);
      text-shadow: 0 10px 40px rgba(0,0,0,.55);
    }
    .brandSub{
      margin-top:6px;
      color: rgba(255,255,255,.62);
      font-size: 13.5px;
    }

    .pillRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:18px}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
    }
    .pill .lbl{color: rgba(255,255,255,.62); font-size:13px}
    select{
      appearance:none;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 700;
      outline:none;
      min-width: 90px;
    }

    .accordion{margin-top:18px; display:flex; flex-direction:column; gap:12px;}
    .acc{
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .head{
      padding: 16px 18px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      user-select:none;
    }
    .head .title{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .head .title h2{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
    }
    .tag{
      font-size:12px;
      color: rgba(255,255,255,.78);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(124,58,237,.18);
      border: 1px solid rgba(167,139,250,.28);
    }
    .chev{opacity:.8}
    .body{display:none; padding: 0 18px 18px}
    .acc.open .body{display:block}

    .grid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1.15fr .95fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border-radius: var(--radius);
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
    }
    .card h3{
      margin:0 0 10px;
      font-size: 15.5px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .muted{color: rgba(255,255,255,.68); font-size: 13.5px; line-height: 1.45}
    .mini{color: rgba(255,255,255,.58); font-size: 12.5px; line-height:1.35; margin-top:6px}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap: 12px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .lbl{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight: 800;
      font-size: 13.5px;
      color: rgba(255,255,255,.86);
    }

    input{
      width:100%;
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px 14px;
      outline:none;
      font-size: 16px;
    }
    input::placeholder{color: rgba(255,255,255,.42)}
    input[readonly]{opacity:.92}

    .hint{
      width: 24px; height: 24px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 10px;
      border:1px solid rgba(167,139,250,.35);
      background: rgba(124,58,237,.20);
      color: rgba(255,255,255,.90);
      font-weight: 900;
      font-size: 13px;
      flex: 0 0 auto;
      cursor:pointer;
    }

    .tipbox{
      padding: 12px 14px;
      border-radius: 18px;
      border:1px solid rgba(167,139,250,.28);
      background: rgba(124,58,237,.14);
      color: rgba(255,255,255,.78);
      font-size: 13.5px;
      line-height:1.45;
    }

    .modelGrid{
      display:flex; flex-direction:column; gap:10px;
      margin-top: 12px;
    }
    .mBtn{
      text-align:left;
      border-radius: 20px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      cursor:pointer;
      color: rgba(255,255,255,.90);
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .mBtn:hover{transform: translateY(-1px); border-color: rgba(167,139,250,.34)}
    .mBtn.active{
      border-color: rgba(167,139,250,.55);
      background: rgba(124,58,237,.18);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .mBtn .t{font-weight: 900; font-size: 15px}
    .mBtn .d{color: rgba(255,255,255,.66); font-size: 13px; margin-top:4px}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px}
    button{
      border:none;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      color: rgba(255,255,255,.95);
      background: linear-gradient(180deg, rgba(124,58,237,.95), rgba(124,58,237,.70));
      box-shadow: 0 18px 45px rgba(0,0,0,.40);
    }
    button.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: rgba(255,255,255,.90);
    }
    button.danger{
      background: rgba(220,38,38,.20);
      border:1px solid rgba(220,38,38,.35);
      box-shadow:none;
    }

    .results{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .res{
      border-radius: 20px;
      padding: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
    }
    .res .k{
      display:flex; align-items:center; justify-content:space-between;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      font-weight: 900;
      letter-spacing:.3px;
    }
    .badgeBear,.badgeBase,.badgeBull{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid rgba(255,255,255,.12);
    }
    .badgeBear{background: rgba(244,63,94,.15); border-color: rgba(244,63,94,.28)}
    .badgeBase{background: rgba(124,58,237,.16); border-color: rgba(167,139,250,.30)}
    .badgeBull{background: rgba(16,185,129,.14); border-color: rgba(16,185,129,.25)}

    .res .v{
      font-size: 34px;
      font-weight: 950;
      letter-spacing:.2px;
      margin-top: 8px;
    }
    .res .s{
      margin-top: 4px;
      color: rgba(255,255,255,.62);
      font-size: 13px;
    }

    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.10); font-size: 13px}
    th{color: rgba(255,255,255,.76); text-align:left}
    td.right, th.right{text-align:right}
    .nowrap{white-space:nowrap}

    .footer{
      margin-top: 12px;
      text-align:center;
      color: rgba(255,255,255,.55);
      font-size: 12.5px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.50);
      border:1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      padding: 10px 14px;
      border-radius: 14px;
      backdrop-filter: blur(12px);
      display:none;
      z-index: 50;
      max-width: 92vw;
    }

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      z-index: 80;
      padding: 18px;
    }
    .modal{
      width:min(560px, 96vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .modalHead .t{font-weight: 950}
    .xbtn{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.90);
      font-weight: 900;
      cursor:pointer;
    }
    .modalBody{padding: 14px}
  </style>
</head><body>
  <div class="wrap">

    <div class="topHero">
      <div class="brandRow">
        <div>
          <div class="brandTitle" id="ui_brandTitle">Equity Analyzer</div>
          <div class="brandSub" id="ui_sub">Multi-Model Fair Value • Watchlist • Guide</div>
        </div>
      </div>

      <div class="pillRow">
        <div class="pill">
          <div class="lbl" id="ui_langLbl">Language</div>
          <select id="langSel">
            <option value="en" selected>EN</option>
            <option value="cz">CZ</option>
          </select>
        </div>

        <div class="pill">
          <div class="lbl" id="ui_modeLbl">Mode</div>
          <select id="modeSel">
            <option value="quick" selected>Quick</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
      </div>
    </div>

    <div class="accordion">

      <!-- VALUATION -->
      <div class="acc open" id="acc_val">
        <div class="head" data-acc="val">
          <div class="title">
            <h2 id="ui_valTitle">Fair value</h2>
            <span class="tag" id="ui_valTag">Models + 3 scenarios</span>
          </div>
          <div class="chev">▲</div>
        </div>

        <div class="body" id="valBody">
          <div class="grid">

            <!-- LEFT -->
            <div class="card">
              <h3 id="ui_introTitle">What are we calculating?</h3>
              <div class="muted" id="ui_introText"></div>

              <div class="tipbox" style="margin-top:10px;" id="ui_disclaimerBox"></div>

              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_currLbl">Currency</span>
                    <span class="hint" data-help="currency">i</span>
                  </div>
                  <select id="curSel">
                    <option value="USD" selected>USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CZK">CZK</option>
                    <option value="GBP">GBP</option>
                  </select>
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_mosLbl">Margin of Safety</span>
                    <span class="hint" data-help="mos">i</span>
                  </div>
                  <select id="mosSel">
                    <option value="off" selected>Off</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                    <option value="20">20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                  </select>
                </div>
              </div>

              <div class="tipbox" style="margin-top:12px;" id="ui_decimalTip"></div>

              <div class="modelGrid" style="margin-top:12px;">
                <div class="mBtn active" data-model="standard">
                  <div class="t" id="ui_m_standard_t">Standard (FCF DCF)</div>
                  <div class="d" id="ui_m_standard_d"></div>
                </div>
                <div class="mBtn" data-model="financial">
                  <div class="t" id="ui_m_fin_t">Financial (RIM)</div>
                  <div class="d" id="ui_m_fin_d"></div>
                </div>
                <div class="mBtn" data-model="reit">
                  <div class="t" id="ui_m_reit_t">REIT (AFFO)</div>
                  <div class="d" id="ui_m_reit_d"></div>
                </div>
                <div class="mBtn" data-model="growth">
                  <div class="t" id="ui_m_growth_t">Pre-FCF growth</div>
                  <div class="d" id="ui_m_growth_d"></div>
                </div>
                <div class="mBtn" data-model="cyclical">
                  <div class="t" id="ui_m_cyc_t">Cyclical</div>
                  <div class="d" id="ui_m_cyc_d"></div>
                </div>
                <div class="mBtn" data-model="utility">
                  <div class="t" id="ui_m_util_t">Utility</div>
                  <div class="d" id="ui_m_util_d"></div>
                </div>
              </div>

              <h3 style="margin-top:14px" id="ui_inputsMain">Core inputs</h3>

              <div class="row">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_tickerLbl">Ticker</span>
                    <span class="hint" data-help="ticker">i</span>
                  </div>
                  <input id="in_ticker" placeholder="e.g. AAPL" />
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_priceLbl">Current price</span>
                    <span class="hint" data-help="price">i</span>
                  </div>
                  <input id="in_price" placeholder="e.g. 180" inputmode="decimal" />
                </div>
              </div>

              <!-- model sections start here --><!-- STANDARD -->
              <div id="sec_standard" style="margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_fcfLbl">Free Cash Flow (FCF) – total</span>
                      <span class="hint" data-help="fcf_total">i</span>
                    </div>
                    <input id="in_fcf" placeholder="e.g. 10b or 10000000000" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_fcfMini"></div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesLbl">Shares Outstanding</span>
                      <span class="hint" data-help="shares">i</span>
                    </div>
                    <input id="in_shares" placeholder="e.g. 13.0b or 13000000000" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_sharesMini"></div>
                  </div>
                </div>
              </div>

              <!-- FINANCIAL -->
              <div id="sec_financial" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_bvpsLbl">Book Value / share (BVPS)</span>
                      <span class="hint" data-help="bvps">i</span>
                    </div>
                    <input id="in_bvps" placeholder="e.g. 6.95" inputmode="decimal" />
                    <div class="mini" id="ui_bvpsMini"></div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_roeLbl">ROE (%)</span>
                      <span class="hint" data-help="roe">i</span>
                    </div>
                    <input id="in_roe" placeholder="e.g. 12" inputmode="decimal" />
                    <div class="mini" id="ui_roeMini"></div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_payoutLbl">Payout ratio (%)</span>
                      <span class="hint" data-help="payout">i</span>
                    </div>
                    <input id="in_payout" placeholder="e.g. 20" value="20" inputmode="decimal" />
                    <div class="mini" id="ui_payoutMini"></div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesFinLbl">Shares (optional)</span>
                      <span class="hint" data-help="shares_fin">i</span>
                    </div>
                    <input id="in_shares_fin" placeholder="leave empty" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_sharesFinMini"></div>
                  </div>
                </div>
              </div>

              <!-- REIT -->
              <div id="sec_reit" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_affoLbl">AFFO / share</span>
                      <span class="hint" data-help="affo">i</span>
                    </div>
                    <input id="in_affo" placeholder="e.g. 2.10" inputmode="decimal" />
                    <div class="mini" id="ui_affoMini"></div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_reitNoteLbl">Note</span>
                      <span class="hint" data-help="reit_note">i</span>
                    </div>
                    <input id="in_reit_note" placeholder="(optional)" />
                    <div class="mini" id="ui_reitNoteMini"></div>
                  </div>
                </div>
              </div>

              <!-- GROWTH -->
              <div id="sec_growth" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_revLbl">Revenue (total)</span>
                      <span class="hint" data-help="rev">i</span>
                    </div>
                    <input id="in_rev" placeholder="e.g. 300b" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_revMini"></div>
                  </div>
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesGLabel">Shares Outstanding</span>
                      <span class="hint" data-help="shares_g">i</span>
                    </div>
                    <input id="in_shares_g" placeholder="e.g. 13b" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_sharesGMini"></div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_marginLbl">Target FCF margin (%)</span>
                      <span class="hint" data-help="fcf_margin">i</span>
                    </div>
                    <input id="in_fcf_margin" placeholder="e.g. 15" value="15" inputmode="decimal"/>
                    <div class="mini" id="ui_marginMini"></div>
                  </div>
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_marginYearsLbl">Margin ramp years</span>
                      <span class="hint" data-help="margin_years">i</span>
                    </div>
                    <input id="in_margin_years" placeholder="e.g. 5" value="5" inputmode="numeric"/>
                    <div class="mini" id="ui_marginYearsMini"></div>
                  </div>
                </div>
              </div>

              <!-- CYCLICAL -->
              <div id="sec_cyclical" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_normFcfLbl">Normalized FCF (total)</span>
                      <span class="hint" data-help="norm_fcf">i</span>
                    </div>
                    <input id="in_norm_fcf" placeholder="e.g. 6b" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_normFcfMini"></div>
                  </div>
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesCLbl">Shares Outstanding</span>
                      <span class="hint" data-help="shares_c">i</span>
                    </div>
                    <input id="in_shares_c" placeholder="e.g. 3.2b" inputmode="decimal" data-format="big"/>
                    <div class="mini" id="ui_sharesCMini"></div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_cycleAdjLbl">Cycle adjustment (%)</span>
                      <span class="hint" data-help="cycle_adj">i</span>
                    </div>
                    <input id="in_cycle_adj" placeholder="e.g. -10" value="0" inputmode="decimal"/>
                    <div class="mini" id="ui_cycleAdjMini"></div>
                  </div>
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_cycNoteLbl">Note</span>
                      <span class="hint" data-help="cyc_note">i</span>
                    </div>
                    <input id="in_cyc_note" placeholder="(optional)" />
                    <div class="mini" id="ui_cycNoteMini"></div>
                  </div>
                </div>
              </div>

              <!-- UTILITY -->
              <div id="sec_utility" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_divLbl">Dividend / share (annual)</span>
                      <span class="hint" data-help="div">i</span>
                    </div>
                    <input id="in_div" placeholder="e.g. 3.10" inputmode="decimal"/>
                    <div class="mini" id="ui_divMini"></div>
                  </div>
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_payoutUtilLbl">Payout ratio (%)</span>
                      <span class="hint" data-help="payout_util">i</span>
                    </div>
                    <input id="in_payout_util" placeholder="e.g. 60" value="60" inputmode="decimal"/>
                    <div class="mini" id="ui_payoutUtilMini"></div>
                  </div>
                </div>
              </div>

              <!-- shared projection settings -->
              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_yearsLbl">Projection years</span>
                    <span class="hint" data-help="years">i</span>
                  </div>
                  <input id="in_years" placeholder="10" value="10" inputmode="numeric"/>
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_discLbl">Discount rate (%)</span>
                    <span class="hint" data-help="disc">i</span>
                  </div>
                  <input id="in_disc" placeholder="9" value="9" inputmode="decimal"/>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_termLbl">Terminal growth (%)</span>
                    <span class="hint" data-help="term">i</span>
                  </div>
                  <input id="in_term" placeholder="2.5" value="2.5" inputmode="decimal"/>
                  <div class="mini" id="ui_termMini"></div>
                </div>
                <div class="field">
                  <div class="lbl">
                    <span id="ui_inputsHintLbl">Inputs tip</span>
                    <span class="hint" data-help="sources">i</span>
                  </div>
                  <input id="in_dummy_sources" readonly placeholder="Tap i for sources" />
                  <div class="mini" id="ui_inputsHintMini"></div>
                </div>
              </div>

              <div class="btns">
                <button id="btn_calc">Calculate</button>
                <button class="secondary" id="btn_save">Save to Watchlist</button>
                <button class="secondary" id="btn_fillDemo">Demo values</button>
              </div>
              <div class="mini" id="ui_saveNote"></div>
            </div>

            <!-- RIGHT -->
            <div class="card">
              <h3 id="ui_inputsScen">Scenarios (annual)</h3>
              <div class="muted" id="ui_inputsScenText"></div>

              <div class="tipbox" id="ui_scenTip" style="margin-top:10px;">
                <span id="ui_scenTipText"></span>
              </div>

              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_bearLbl">Bear</span>
                    <span class="hint" data-help="bear">i</span>
                  </div>
                  <input id="in_bear" placeholder="2" value="2" inputmode="decimal"/>
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_baseLbl">Base</span>
                    <span class="hint" data-help="base">i</span>
                  </div>
                  <input id="in_base" placeholder="5" value="5" inputmode="decimal"/>
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_bullLbl">Bull</span>
                    <span class="hint" data-help="bull">i</span>
                  </div>
                  <input id="in_bull" placeholder="8" value="8" inputmode="decimal"/>
                </div>
              </div>

              <div class="results" id="resultGrid" style="margin-top:12px;">
                <div class="res">
                  <div class="k"><span class="badgeBear">BEAR</span><span id="r_bear_pct"></span></div>
                  <div class="v" id="r_bear">—</div>
                  <div class="s" id="r_bear_s">—</div>
                </div>
                <div class="res">
                  <div class="k"><span class="badgeBase">BASE</span><span id="r_base_pct"></span></div>
                  <div class="v" id="r_base">—</div>
                  <div class="s" id="r_base_s">—</div>
                </div>
                <div class="res">
                  <div class="k"><span class="badgeBull">BULL</span><span id="r_bull_pct"></span></div>
                  <div class="v" id="r_bull">—</div>
                  <div class="s" id="r_bull_s">—</div>
                </div>
              </div>

              <div class="card" style="margin-top:12px;">
                <h3 id="ui_targetsTitle">Target & Range</h3>
                <div class="muted" id="ui_targetsText"></div>
                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl"><span id="ui_targetLbl">Target price</span></div>
                    <input id="out_target" readonly placeholder="—"/>
                  </div>
                  <div class="field">
                    <div class="lbl"><span id="ui_rangeLbl">Fair value range</span></div>
                    <input id="out_range" readonly placeholder="—"/>
                  </div>
                </div>
              </div>

              <div class="tipbox" id="ui_sanityBox" style="display:none; margin-top:12px;">
                <strong id="ui_sanityTitle"></strong>
                <div id="ui_sanityText" class="mini" style="margin-top:6px; color:rgba(255,255,255,.85)"></div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- WATCHLIST -->
      <div class="acc" id="acc_watch">
        <div class="head" data-acc="watch">
          <div class="title">
            <h2 id="ui_watchTitle">Watchlist</h2>
            <span class="tag" id="ui_watchTag">Local storage</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="watchBody">
          <div class="card">
            <h3 id="ui_watchIntroTitle">Saved valuations</h3>
            <div class="muted" id="ui_watchIntroText"></div>

            <div class="btns" style="margin-top:10px;">
              <button class="secondary" id="btn_export_csv">Export CSV</button>
              <button class="secondary" id="btn_print_pdf">Print / PDF</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div style="overflow:auto;">
              <table id="watchTable">
                <thead>
                  <tr>
                    <th id="th_date">Date</th>
                    <th id="th_ticker">Ticker</th>
                    <th class="right" id="th_price">Price</th>
                    <th class="right" id="th_model">Model</th>
                    <th class="right" id="th_bear">Bear</th>
                    <th class="right" id="th_base">Base</th>
                    <th class="right" id="th_bull">Bull</th>
                    <th class="right nowrap" id="th_target">Target</th>
                    <th class="right nowrap" id="th_range">Range</th>
                    <th class="right" id="th_action">Action</th>
                  </tr>
                </thead>
                <tbody id="watchTbody">
                  <tr><td colspan="10" class="muted" id="watchEmpty">No saved items yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="footer" id="ui_watchFooter"></div>
        </div>
      </div>

      <!-- GUIDE -->
      <div class="acc" id="acc_guide">
        <div class="head" data-acc="guide">
          <div class="title">
            <h2 id="ui_guideTitle">How to choose a model</h2>
            <span class="tag" id="ui_guideTag">Guide</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="guideBody">
          <div class="card">
            <h3 id="ui_guideHead1">1) Switching models</h3>
            <div class="muted" id="ui_guideText1"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 id="ui_guideHead2">2) Which model for which company</h3>
            <div class="muted" id="ui_guideText2"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 id="ui_guideHead3">3) Where to find inputs</h3>
            <div class="muted" id="ui_guideText3"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 id="ui_guideHead4">4) Sanity check</h3>
            <div class="muted" id="ui_guideText4"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 id="ui_guideHead5">5) Important disclaimer</h3>
            <div class="muted" id="ui_guideText5"></div>
          </div>
        </div>
      </div>

    </div>

    <div class="footer" id="ui_footer"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div class="t" id="modalTitle">Info</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>const TEXTS = {
    en: {
      sub: "Multi-Model Fair Value • Watchlist • Guide",
      valTitle: "Fair value",
      valTag: "Models + 3 scenarios",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "How to choose a model",
      guideTag: "Guide",

      langLbl: "Language",
      modeLbl: "Mode",

      introTitle: "What are we calculating?",
      introText:
        "Choose a company type (model) and estimate fair value in 3 scenarios. Output is educational and scenario-based — not a recommendation.",
      disclaimerBox:
        "Educational tool only. This app does NOT provide financial advice, does NOT recommend buying/selling any security, and does NOT consider your personal situation. You are responsible for your own decisions.",

      currLbl: "Currency",
      mosLbl: "Margin of Safety",
      decimalTip:
        "Tip: You can type decimals with dot or comma. For big numbers you can also use k / m / b (e.g., 13.2b shares). After leaving the field it formats for readability.",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Non-financial companies with stable positive FCF.",
      m_fin_t:"Financial (RIM)",
      m_fin_d:"Banks/insurers/fintech — value via BVPS + ROE.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REITs — AFFO per share instead of FCF.",
      m_growth_t:"Pre-FCF growth",
      m_growth_d:"Revenue + margin path to FCF (simplified).",
      m_cyc_t:"Cyclical",
      m_cyc_d:"Normalize FCF across a cycle (simplified).",
      m_util_t:"Utility",
      m_util_d:"Dividend/earnings stability (simplified).",

      inputsMain:"Core inputs",
      tickerLbl:"Ticker",
      priceLbl:"Current price",

      fcfLbl:"Free Cash Flow (FCF) – total",
      fcfMini:"Annual total company FCF (ideally 3–5y average). Use total, not per-share.",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Total shares outstanding. Tip: use 13.2b instead of typing many zeros.",

      bvpsLbl:"Book Value / share (BVPS)",
      bvpsMini:"Book value per share (banks/financials).",
      roeLbl:"ROE (%)",
      roeMini:"Return on equity. For Financial model, scenarios represent ROE.",
      payoutLbl:"Payout ratio (%)",
      payoutMini:"% of earnings paid out (rest increases BVPS). If unsure, try 0–30%.",
      sharesFinLbl:"Shares (optional)",
      sharesFinMini:"Not required for RIM. Leave empty.",

      affoLbl:"AFFO / share",
      affoMini:"Adjusted Funds From Operations per share (REIT).",
      reitNoteLbl:"Note",
      reitNoteMini:"Optional label only (e.g., AFFO TTM).",

      revLbl:"Revenue (total)",
      revMini:"Annual revenue (total). Use k/m/b for readability.",
      sharesGLabel:"Shares Outstanding",
      sharesGMini:"Needed to convert firm value to per-share value.",
      marginLbl:"Target FCF margin (%)",
      marginMini:"Long-run FCF margin once the company matures (rough assumption).",
      marginYearsLbl:"Margin ramp years",
      marginYearsMini:"How many years it takes to reach the target margin.",

      normFcfLbl:"Normalized FCF (total)",
      normFcfMini:"Cycle-average FCF (e.g., avg of a full cycle).",
      sharesCLbl:"Shares Outstanding",
      sharesCMini:"Shares used to convert to per-share value.",
      cycleAdjLbl:"Cycle adjustment (%)",
      cycleAdjMini:"Optional stress/boost for normalized FCF (e.g., -10% for conservative).",
      cycNoteLbl:"Note",
      cycNoteMini:"Optional label only.",

      divLbl:"Dividend / share (annual)",
      divMini:"Annual dividend per share (or proxy cash return).",
      payoutUtilLbl:"Payout ratio (%)",
      payoutUtilMini:"Used as a stability proxy (higher payout = more utility-like).",

      yearsLbl:"Projection years",
      discLbl:"Discount rate (%)",
      termLbl:"Terminal growth (%)",
      termMini:"Used for Standard/REIT/Growth/Cyclical. Must be lower than discount rate.",

      inputsHintLbl:"Inputs tip",
      inputsHintMini:"Tap the i icon for where to find inputs.",

      inputsScen:"Scenarios (annual)",
      inputsScenText:"Quick uses Base and auto-derives Bear/Bull (±2). Advanced lets you set all three.",
      scenTipText:"Standard/REIT/Growth/Cyclical/Utility: scenario is growth %. Financial: scenario is ROE %.",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base with Margin of Safety applied. Range = Bear to Bull.",
      targetLbl:"Target price",
      rangeLbl:"Fair value range",

      calc:"Calculate",
      save:"Save to Watchlist",
      demo:"Demo values",
      saveNote:"Saves the latest result (Bear/Base/Bull).",

      watchIntroTitle:"Saved valuations",
      watchIntroText:"Saved rows are stored locally in your browser (localStorage).",
      watchFooter:"Note: Watchlist is stored locally (localStorage).",
      empty:"No saved items yet.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Delete",

      th:{date:"Date", ticker:"Ticker", price:"Price", model:"Model", bear:"Bear", base:"Base", bull:"Bull", target:"Target", range:"Range", action:"Action"},

      guideHead1:"1) Switching models",
      guideText1:"Use the big model buttons. Inputs and scenario meaning will change accordingly.",
      guideHead2:"2) Which model to use",
      guideText2:
        "<ul>" +
        "<li><strong>Standard (FCF DCF):</strong> companies with stable positive free cash flow. Inputs: total FCF + shares.</li>" +
        "<li><strong>Financial (RIM):</strong> banks/insurers/fintech. Inputs: BVPS + ROE (+ payout). Scenarios are ROE.</li>" +
        "<li><strong>REIT (AFFO):</strong> REITs. Input: AFFO per share. Scenarios are AFFO growth.</li>" +
        "<li><strong>Pre-FCF Growth:</strong> high-growth firms not yet stable in FCF. Input: revenue + path to FCF margin.</li>" +
        "<li><strong>Cyclical:</strong> cyclicals (commodities/semis/industrial). Use normalized cycle-average FCF.</li>" +
        "<li><strong>Utility:</strong> stable cash/dividend profiles. Uses a conservative dividend/cash-return approach.</li>" +
        "</ul>",

      guideHead3:"3) Where to find inputs",
      guideText3:
        "<ul>" +
        "<li><strong>FCF / Revenue:</strong> company filings (10-K/Annual report) → cash flow statement / income statement.</li>" +
        "<li><strong>Shares:</strong> filings, investor relations, or data sites (e.g., market data providers).</li>" +
        "<li><strong>BVPS / ROE:</strong> financial statements (balance sheet + income statement), annual reports.</li>" +
        "<li><strong>AFFO:</strong> REIT supplemental / earnings release (often reported as AFFO/FFO).</li>" +
        "</ul>",

      guideHead4:"4) Sanity check",
      guideText4:
        "<ul>" +
        "<li>Use the correct model for the company type.</li>" +
        "<li>Units matter: Standard uses <strong>total</strong> FCF, not per-share.</li>" +
        "<li>Discount rate must be higher than terminal growth.</li>" +
        "<li>If output is extreme, re-check inputs and consider a more conservative scenario.</li>" +
        "</ul>",

      guideHead5:"5) Important disclaimer",
      guideText5:
        "This app is educational only and not investment advice. No personalized recommendations. " +
        "You bear full responsibility for using the results. Consider consulting a licensed professional if needed.",

      sanityTitle:"Sanity check:",
      sanityLow:"Result looks extremely low. Check model choice, units (total vs per-share) and shares.",
      sanityHigh:"Result looks extremely high. Check growth/discount assumptions and company type.",

      helps:{
        currency:{t:"Currency", b:"Select currency used for displaying the output. Inputs should be in the same currency."},
        mos:{t:"Margin of Safety", b:"A conservative haircut applied to the Base fair value to produce a 'target' price. Example: Base $100, MoS 20% → Target $80."},
        ticker:{t:"Ticker", b:"Any label you want (e.g., AAPL). Used for watchlist."},
        price:{t:"Current price", b:"Market price used to calculate upside/downside vs fair value."},

        fcf_total:{t:"FCF (total)", b:"Enter annual total company free cash flow. Tip: 10b = 10,000,000,000."},
        shares:{t:"Shares", b:"Total shares outstanding. Tip: 13.2b instead of typing many zeros."},

        bvps:{t:"BVPS", b:"Book value per share. Used for financials in Residual Income Model (RIM)."},
        roe:{t:"ROE", b:"Return on equity. In Financial model, Bear/Base/Bull are ROE scenarios (e.g., 8/12/15%)."},
        payout:{t:"Payout ratio", b:"Percent of earnings paid out (dividends/buybacks). The rest increases BVPS in the model."},
        shares_fin:{t:"Shares (optional)", b:"Not needed for RIM. Leave empty."},

        affo:{t:"AFFO per share", b:"Adjusted Funds From Operations per share (or FFO/AFFO). Prefer for REIT valuation."},
        reit_note:{t:"Note", b:"Optional label only."},

        rev:{t:"Revenue (total)", b:"Annual revenue total. Tip: 300b = 300,000,000,000."},
        shares_g:{t:"Shares", b:"Needed to convert firm value to per-share value in Growth model."},
        fcf_margin:{t:"Target FCF margin", b:"Long-run FCF margin (% of revenue) after maturity. Rough assumption."},
        margin_years:{t:"Margin ramp years", b:"How many years to reach the target margin from today's level (simplified ramp)."},
        norm_fcf:{t:"Normalized FCF", b:"Cycle-average FCF (e.g., average of a full cycle)."},
        shares_c:{t:"Shares", b:"Shares outstanding for cyclical model."},
        cycle_adj:{t:"Cycle adjustment", b:"Extra stress/boost to normalized FCF. Example: -10 makes it more conservative."},
        cyc_note:{t:"Note", b:"Optional label only."},
        div:{t:"Dividend per share", b:"Annual dividend per share (or proxy cash return). Used in Utility model."},
        payout_util:{t:"Payout ratio", b:"Used as a stability proxy; utility-like firms often pay a higher, stable payout."},

        years:{t:"Projection years", b:"How many years to project cash flows."},
        disc:{t:"Discount rate", b:"Required return / risk. Higher = more conservative."},
        term:{t:"Terminal growth", b:"Long-run growth after projection. Must be lower than discount rate."},
        sources:{t:"Where to find inputs", b:"Use annual reports / 10-K filings (cash flow statement, income statement, balance sheet). Shares and price can be from market data providers. REIT AFFO often in earnings releases."},

        bear:{t:"Bear", b:"Conservative scenario. Usually growth % (or ROE % for Financial)."},
        base:{t:"Base", b:"Realistic scenario. Usually growth % (or ROE % for Financial)."},
        bull:{t:"Bull", b:"Optimistic scenario. Usually growth % (or ROE % for Financial)."},
      },

      footer:"Educational tool • Not investment advice • No personalized recommendations"
    },

    cz: {
      sub: "Multi-Model Fair Value • Watchlist • Návod",
      valTitle: "Výpočet férové ceny",
      valTag: "Modely + 3 scénáře",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "Jak vybrat model",
      guideTag: "Návod",

      langLbl: "Jazyk",
      modeLbl: "Mód",

      introTitle: "Co tady počítáme?",
      introText:
        "Vybereš typ firmy (model) a spočítáš férovou cenu ve 3 scénářích. Výsledek je vzdělávací a scénářový — není to doporučení.",
      disclaimerBox:
        "Pouze vzdělávací nástroj. Aplikace NENÍ finanční poradenství, nedává doporučení koupit/prodat a nezohledňuje tvou osobní situaci. Za svá rozhodnutí odpovídáš ty.",

      currLbl: "Měna",
      mosLbl: "Margin of Safety",
      decimalTip:
        "Tip: Můžeš psát desetinnou tečkou nebo čárkou. U velkých čísel můžeš použít k / m / b (např. 13,2b akcií). Po opuštění pole se číslo zformátuje pro přehlednost.",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Klasické firmy se stabilním FCF.",
      m_fin_t:"Finanční (RIM)",
      m_fin_d:"Banka/pojišťovna/fintech — přes BVPS + ROE.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REIT — AFFO na akcii místo FCF.",
      m_growth_t:"Růstová bez FCF",
      m_growth_d:"Revenue + cesta k FCF marži (zjednodušeně).",
      m_cyc_t:"Cyklická",
      m_cyc_d:"Normalizace FCF přes cyklus (zjednodušeně).",
      m_util_t:"Utility",
      m_util_d:"Stabilní cash/dividend (zjednodušeně).",

      inputsMain:"Základní vstupy",
      tickerLbl:"Ticker",
      priceLbl:"Aktuální cena",

      fcfLbl:"Free Cash Flow (FCF) – celkem",
      fcfMini:"Roční FCF celé firmy (ideálně průměr 3–5 let). Zadávej celkem, ne na akcii.",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Počet akcií v oběhu. Tip: 13,2b místo psaní mnoha nul.",

      bvpsLbl:"Book Value / akcii (BVPS)",
      bvpsMini:"Účetní hodnota na akcii (banky/finance).",
      roeLbl:"ROE (%)",
      roeMini:"Návratnost vlastního kapitálu. U Financial jsou scénáře ROE.",
      payoutLbl:"Payout ratio (%)",
      payoutMini:"Kolik % zisku se vyplatí (zbytek zvyšuje BVPS). Pokud nevíš, zkus 0–30 %.",
      sharesFinLbl:"Shares (volitelné)",
      sharesFinMini:"U RIM není potřeba. Nech prázdné.",

      affoLbl:"AFFO / akcii",
      affoMini:"AFFO na akcii (u REIT).",
      reitNoteLbl:"Poznámka",
      reitNoteMini:"Jen popisek (např. AFFO TTM).",

      revLbl:"Revenue (celkem)",
      revMini:"Roční tržby celkem. Tip: 300b = 300 miliard.",
      sharesGLabel:"Shares Outstanding",
      sharesGMini:"Potřeba pro přepočet na 1 akcii u Growth modelu.",
      marginLbl:"Cílová FCF marže (%)",
      marginMini:"Dlouhodobá FCF marže po „dozrání“ firmy (odhad).",
      marginYearsLbl:"Roky do cílové marže",
      marginYearsMini:"Za kolik let se má marže dostat na cíl (zjednodušený ramp).",

      normFcfLbl:"Normalizované FCF (celkem)",
      normFcfMini:"FCF průměr přes celý cyklus (odhad).",
      sharesCLbl:"Shares Outstanding",
      sharesCMini:"Počet akcií pro cyklický model.",
      cycleAdjLbl:"Úprava cyklu (%)",
      cycleAdjMini:"Volitelný stres/boost (např. -10 % konzervativně).",
      cycNoteLbl:"Poznámka",
      cycNoteMini:"Jen popisek.",

      divLbl:"Dividenda / akcii (ročně)",
      divMini:"Roční dividenda na akcii (nebo proxy cash return).",
      payoutUtilLbl:"Payout ratio (%)",
      payoutUtilMini:"Proxy stability; utility často mají stabilní vyšší payout.",

      yearsLbl:"Délka projekce (roky)",
      discLbl:"Diskontní sazba (%)",
      termLbl:"Terminální růst (%)",
      termMini:"Použije se u Standard/REIT/Growth/Cyclical/Utility. Musí být menší než diskont.",

      inputsHintLbl:"Tip na vstupy",
      inputsHintMini:"Klikni na i pro zdroje.",

      inputsScen:"Scénáře (ročně)",
      inputsScenText:"Quick používá jen Base a Bear/Bull dopočítá automaticky (±2). Advanced umožní zadat vše ručně.",
      scenTipText:"Standard/REIT/Growth/Cyclical/Utility: scénář je růst %. Financial: scénář je ROE %.",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base se zapnutým Margin of Safety. Range = Bear až Bull.",
      targetLbl:"Target cena",
      rangeLbl:"Férové pásmo",

      calc:"Calculate",
      save:"Save to Watchlist",
      demo:"Demo values",
      saveNote:"Uloží se poslední výsledek (Bear/Base/Bull).",

      watchIntroTitle:"Uložené výpočty",
      watchIntroText:"Položky se ukládají lokálně v prohlížeči (localStorage).",
      watchFooter:"Pozn.: Watchlist je uložen lokálně (localStorage).",
      empty:"Zatím nic uloženého.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Smazat",

      th:{date:"Datum", ticker:"Ticker", price:"Cena", model:"Model", bear:"Bear", base:"Base", bull:"Bull", target:"Target", range:"Range", action:"Akce"},

      guideHead1:"1) Přepínání modelu",
      guideText1:"Model přepínáš přes velká tlačítka. Po přepnutí se změní vstupy i význam scénářů.",
      guideHead2:"2) Kdy použít který model",
      guideText2:
        "<ul>" +
        "<li><strong>Standard (FCF DCF):</strong> firmy se stabilním pozitivním FCF. Vstupy: FCF celkem + akcie.</li>" +
        "<li><strong>Finanční (RIM):</strong> banky/pojišťovny/fintech. Vstupy: BVPS + ROE (+ payout). Scénáře jsou ROE.</li>" +
        "<li><strong>REIT (AFFO):</strong> REIT. Vstup: AFFO na akcii. Scénáře jsou růst AFFO.</li>" +
        "<li><strong>Růstová bez FCF:</strong> rychle rostoucí firmy. Vstup: tržby + cesta k FCF marži.</li>" +
        "<li><strong>Cyklická:</strong> cyklické obory. Použij normalizované FCF přes cyklus.</li>" +
        "<li><strong>Utility:</strong> stabilní cash/dividend profily. Konzervativní dividendový přístup.</li>" +
        "</ul>",

      guideHead3:"3) Kde najít vstupy",
      guideText3:
        "<ul>" +
        "<li><strong>FCF / Revenue:</strong> výroční zprávy / 10-K → cash flow statement / income statement.</li>" +
        "<li><strong>Shares:</strong> výroční zprávy, investor relations, nebo datové servery.</li>" +
        "<li><strong>BVPS / ROE:</strong> účetní výkazy (balance sheet + income statement).</li>" +
        "<li><strong>AFFO:</strong> earnings release / supplemental u REIT (AFFO/FFO).</li>" +
        "</ul>",

      guideHead4:"4) Rychlá kontrola (sanity check)",
      guideText4:
        "<ul>" +
        "<li>Zvol správný model pro typ firmy.</li>" +
        "<li>Jednotky: Standard používá <strong>FCF celkem</strong>, ne na akcii.</li>" +
        "<li>Diskont musí být vyšší než terminální růst.</li>" +
        "<li>Když je výsledek extrémní, zkonzervativni vstupy.</li>" +
        "</ul>",

      guideHead5:"5) Důležité upozornění",
      guideText5:
        "Aplikace je pouze vzdělávací a není investiční doporučení. Nedává personalizované rady. " +
        "Za použití výsledků odpovídáš ty. V případě potřeby zvaž licencovaného poradce.",

      sanityTitle:"Sanity check:",
      sanityLow:"Výsledek vychází extrémně nízko. Zkontroluj model, jednotky a akcie.",
      sanityHigh:"Výsledek vychází extrémně vysoko. Zkontroluj růst/diskont a typ firmy.",

      helps:{} // CZ uses EN helps automatically (set below)
    }
  };

  // reuse EN helps for CZ (same keys)
  TEXTS.cz.helps = TEXTS.en.helps;

  const LS_KEY = "ea_watchlist_v3";

  const state = {
    lang: "en",
    mode: "quick",
    currency: "USD",
    mos: "off",
    model: "standard",
    lastResult: null
  };

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display="none", 2200);
  }

  function openModal(title, body){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = body;
    $("modalBackdrop").style.display = "flex";
  }
  function closeModal(){ $("modalBackdrop").style.display = "none"; }

  $("modalBackdrop").addEventListener("click", (e)=>{
    if (e.target === $("modalBackdrop")) closeModal();
  });
  $("modalClose").addEventListener("click", closeModal);function normalizeNumText(v){
    return String(v ?? "")
      .trim()
      .replace(/\s+/g,"")
      .replace(/_/g,"")
      .replace(",",".");
  }

  // supports: 1200000000, 1.2b, 850m, 12k
  function parseHuman(v){
    const s0 = normalizeNumText(v).toLowerCase();
    if (!s0) return NaN;

    const m = s0.match(/^(-?\d+(\.\d+)?)([kmb])?$/i);
    if (!m) return Number.isFinite(Number(s0)) ? Number(s0) : NaN;

    const num = Number(m[1]);
    if (!Number.isFinite(num)) return NaN;

    const suf = (m[3] || "").toLowerCase();
    const mult = suf === "k" ? 1e3 : suf === "m" ? 1e6 : suf === "b" ? 1e9 : 1;
    return num * mult;
  }

  function parseNum(v){
    const n = parseHuman(v);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtMoney(n, cur){
    if (!Number.isFinite(n)) return "—";
    try{
      return new Intl.NumberFormat(state.lang === "cz" ? "cs-CZ" : "en-US", {
        style:"currency", currency: cur, maximumFractionDigits: 2
      }).format(n);
    }catch{
      return `${n.toFixed(2)} ${cur}`;
    }
  }

  function fmtPct(n){
    if (!Number.isFinite(n)) return "—";
    const sign = n > 0 ? "+" : "";
    return `${sign}${n.toFixed(1)}%`;
  }

  function fmtBig(n){
    if (!Number.isFinite(n)) return "";
    // grouping only; keep full number
    return new Intl.NumberFormat(state.lang === "cz" ? "cs-CZ" : "en-US", {
      maximumFractionDigits: 0
    }).format(Math.round(n));
  }

  function bindBigNumberFormatting(){
    document.querySelectorAll('input[data-format="big"]').forEach(inp=>{
      inp.addEventListener("blur", ()=>{
        const n = parseNum(inp.value);
        if (!Number.isFinite(n)) return;
        // keep as grouped full number (no suffix) for readability
        inp.value = fmtBig(n);
      });
      inp.addEventListener("focus", ()=>{
        // on focus, keep it as is (user may type 13.2b)
      });
    });
  }

  // accordion
  document.querySelectorAll(".acc .head").forEach(h=>{
    h.addEventListener("click", ()=>{
      const acc = h.closest(".acc");
      acc.classList.toggle("open");
      const chev = acc.querySelector(".chev");
      if (chev) chev.textContent = acc.classList.contains("open") ? "▲" : "▼";
    });
  });

  function bindHintTitles(){
    document.querySelectorAll(".hint").forEach(h=>{
      h.onclick = null;
      h.addEventListener("click", ()=>{
        const key = h.getAttribute("data-help");
        const help = TEXTS[state.lang].helps?.[key];
        if (!help) return;
        openModal(help.t, `<div style="color:rgba(255,255,255,.92); line-height:1.5">${help.b}</div>`);
      });
    });
  }

  function setModel(m){
    state.model = m;

    document.querySelectorAll(".mBtn").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-model") === m);
    });

    $("sec_standard").style.display  = (m === "standard") ? "" : "none";
    $("sec_financial").style.display = (m === "financial") ? "" : "none";
    $("sec_reit").style.display      = (m === "reit") ? "" : "none";
    $("sec_growth").style.display    = (m === "growth") ? "" : "none";
    $("sec_cyclical").style.display  = (m === "cyclical") ? "" : "none";
    $("sec_utility").style.display   = (m === "utility") ? "" : "none";

    $("ui_scenTipText").textContent = TEXTS[state.lang].scenTipText;
  }

  document.querySelectorAll(".mBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      setModel(b.getAttribute("data-model"));
    });
  });

  function applyMode(){
    const isQuick = state.mode === "quick";
    $("in_bear").disabled = isQuick;
    $("in_bull").disabled = isQuick;
    $("in_bear").style.opacity = isQuick ? 0.65 : 1;
    $("in_bull").style.opacity = isQuick ? 0.65 : 1;
  }

  function applyLang(){
    const t = TEXTS[state.lang];

    $("ui_sub").textContent = t.sub;
    $("ui_valTitle").textContent = t.valTitle;
    $("ui_valTag").textContent = t.valTag;

    $("ui_watchTitle").textContent = t.watchTitle;
    $("ui_watchTag").textContent = t.watchTag;

    $("ui_guideTitle").textContent = t.guideTitle;
    $("ui_guideTag").textContent = t.guideTag;

    $("ui_langLbl").textContent = t.langLbl;
    $("ui_modeLbl").textContent = t.modeLbl;

    $("ui_introTitle").textContent = t.introTitle;
    $("ui_introText").textContent = t.introText;
    $("ui_disclaimerBox").textContent = t.disclaimerBox;

    $("ui_currLbl").textContent = t.currLbl;
    $("ui_mosLbl").textContent = t.mosLbl;
    $("ui_decimalTip").textContent = t.decimalTip;

    $("ui_m_standard_t").textContent = t.m_standard_t;
    $("ui_m_standard_d").textContent = t.m_standard_d;
    $("ui_m_fin_t").textContent = t.m_fin_t;
    $("ui_m_fin_d").textContent = t.m_fin_d;
    $("ui_m_reit_t").textContent = t.m_reit_t;
    $("ui_m_reit_d").textContent = t.m_reit_d;
    $("ui_m_growth_t").textContent = t.m_growth_t;
    $("ui_m_growth_d").textContent = t.m_growth_d;
    $("ui_m_cyc_t").textContent = t.m_cyc_t;
    $("ui_m_cyc_d").textContent = t.m_cyc_d;
    $("ui_m_util_t").textContent = t.m_util_t;
    $("ui_m_util_d").textContent = t.m_util_d;

    $("ui_inputsMain").textContent = t.inputsMain;
    $("ui_tickerLbl").textContent = t.tickerLbl;
    $("ui_priceLbl").textContent = t.priceLbl;

    $("ui_fcfLbl").textContent = t.fcfLbl;
    $("ui_fcfMini").textContent = t.fcfMini;
    $("ui_sharesLbl").textContent = t.sharesLbl;
    $("ui_sharesMini").textContent = t.sharesMini;

    $("ui_bvpsLbl").textContent = t.bvpsLbl;
    $("ui_bvpsMini").textContent = t.bvpsMini;
    $("ui_roeLbl").textContent = t.roeLbl;
    $("ui_roeMini").textContent = t.roeMini;
    $("ui_payoutLbl").textContent = t.payoutLbl;
    $("ui_payoutMini").textContent = t.payoutMini;
    $("ui_sharesFinLbl").textContent = t.sharesFinLbl;
    $("ui_sharesFinMini").textContent = t.sharesFinMini;

    $("ui_affoLbl").textContent = t.affoLbl;
    $("ui_affoMini").textContent = t.affoMini;
    $("ui_reitNoteLbl").textContent = t.reitNoteLbl;
    $("ui_reitNoteMini").textContent = t.reitNoteMini;

    $("ui_revLbl").textContent = t.revLbl;
    $("ui_revMini").textContent = t.revMini;
    $("ui_sharesGLabel").textContent = t.sharesGLabel;
    $("ui_sharesGMini").textContent = t.sharesGMini;
    $("ui_marginLbl").textContent = t.marginLbl;
    $("ui_marginMini").textContent = t.marginMini;
    $("ui_marginYearsLbl").textContent = t.marginYearsLbl;
    $("ui_marginYearsMini").textContent = t.marginYearsMini;

    $("ui_normFcfLbl").textContent = t.normFcfLbl;
    $("ui_normFcfMini").textContent = t.normFcfMini;
    $("ui_sharesCLbl").textContent = t.sharesCLbl;
    $("ui_sharesCMini").textContent = t.sharesCMini;
    $("ui_cycleAdjLbl").textContent = t.cycleAdjLbl;
    $("ui_cycleAdjMini").textContent = t.cycleAdjMini;
    $("ui_cycNoteLbl").textContent = t.cycNoteLbl;
    $("ui_cycNoteMini").textContent = t.cycNoteMini;

    $("ui_divLbl").textContent = t.divLbl;
    $("ui_divMini").textContent = t.divMini;
    $("ui_payoutUtilLbl").textContent = t.payoutUtilLbl;
    $("ui_payoutUtilMini").textContent = t.payoutUtilMini;

    $("ui_yearsLbl").textContent = t.yearsLbl;
    $("ui_discLbl").textContent = t.discLbl;
    $("ui_termLbl").textContent = t.termLbl;
    $("ui_termMini").textContent = t.termMini;

    $("ui_inputsHintLbl").textContent = t.inputsHintLbl;
    $("ui_inputsHintMini").textContent = t.inputsHintMini;

    $("ui_inputsScen").textContent = t.inputsScen;
    $("ui_inputsScenText").textContent = t.inputsScenText;
    $("ui_scenTipText").textContent = t.scenTipText;
    $("ui_bearLbl").textContent = t.bearLbl;
    $("ui_baseLbl").textContent = t.baseLbl;
    $("ui_bullLbl").textContent = t.bullLbl;

    $("ui_targetsTitle").textContent = t.targetsTitle;
    $("ui_targetsText").textContent = t.targetsText;
    $("ui_targetLbl").textContent = t.targetLbl;
    $("ui_rangeLbl").textContent = t.rangeLbl;

    $("btn_calc").textContent = t.calc;
    $("btn_save").textContent = t.save;
    $("btn_fillDemo").textContent = t.demo;
    $("ui_saveNote").textContent = t.saveNote;

    $("ui_watchIntroTitle").textContent = t.watchIntroTitle;
    $("ui_watchIntroText").textContent = t.watchIntroText;
    $("btn_export_csv").textContent = t.exportCsv;
    $("btn_print_pdf").textContent = t.printPdf;
    $("ui_watchFooter").textContent = t.watchFooter;

    $("th_date").textContent = t.th.date;
    $("th_ticker").textContent = t.th.ticker;
    $("th_price").textContent = t.th.price;
    $("th_model").textContent = t.th.model;
    $("th_bear").textContent = t.th.bear;
    $("th_base").textContent = t.th.base;
    $("th_bull").textContent = t.th.bull;
    $("th_target").textContent = t.th.target;
    $("th_range").textContent = t.th.range;
    $("th_action").textContent = t.th.action;

    $("ui_guideHead1").textContent = t.guideHead1;
    $("ui_guideText1").innerHTML = t.guideText1;
    $("ui_guideHead2").textContent = t.guideHead2;
    $("ui_guideText2").innerHTML = t.guideText2;
    $("ui_guideHead3").textContent = t.guideHead3;
    $("ui_guideText3").innerHTML = t.guideText3;
    $("ui_guideHead4").textContent = t.guideHead4;
    $("ui_guideText4").innerHTML = t.guideText4;
    $("ui_guideHead5").textContent = t.guideHead5;
    $("ui_guideText5").innerHTML = t.guideText5;

    $("ui_footer").textContent = t.footer;

    renderWatchlist();
  }

  $("langSel").addEventListener("change", ()=>{
    state.lang = $("langSel").value;
    applyLang();
  });

  $("modeSel").addEventListener("change", ()=>{
    state.mode = $("modeSel").value;
    applyMode();
    if (state.mode === "quick"){
      const base = parseNum($("in_base").value);
      if (Number.isFinite(base)){
        $("in_bear").value = String(Math.max(base - 2, -50));
        $("in_bull").value = String(base + 2);
      }
    }
  });

  $("curSel").addEventListener("change", ()=>{
    state.currency = $("curSel").value;
    if (state.lastResult) paintResults(state.lastResult);
    renderWatchlist();
  });

  $("mosSel").addEventListener("change", ()=>{
    state.mos = $("mosSel").value;
    if (state.lastResult) paintResults(state.lastResult);
  });// -------- MODELS --------

  // Standard firm-level DCF => per share
  function modelStandardDCF({ fcfTotal, shares, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(fcfTotal > 0) || !(shares > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let f = fcfTotal;

    for (let y=1; y<=years; y++){
      f = f * (1 + g);
      pv += f / Math.pow(1 + r, y);
    }

    const terminal = (f * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return (pv + pvTerminal) / shares;
  }

  // REIT AFFO per share DCF (no shares)
  function modelReitAffo({ affoPerShare, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(affoPerShare > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let a = affoPerShare;

    for (let y=1; y<=years; y++){
      a = a * (1 + g);
      pv += a / Math.pow(1 + r, y);
    }

    const terminal = (a * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return pv + pvTerminal;
  }

  // Financial RIM (terminal residual income = 0)
  // BV_t = BV_{t-1} + EPS*(1-payout)
  // EPS_t = ROE * BV_{t-1}
  // RI_t  = EPS_t - r * BV_{t-1}
  // Fair = BV_0 + Σ PV(RI_t)
  function modelFinancialRIM({ bvps, roePct, payoutPct, years, discPct }){
    const r = discPct / 100;
    const roe = roePct / 100;
    const payout = Math.min(Math.max(payoutPct / 100, 0), 1);

    if (!(bvps > 0) || !(years >= 1) || !(r > 0)) return NaN;

    let BV = bvps;
    let pvRI = 0;

    for (let y=1; y<=years; y++){
      const EPS = roe * BV;
      const RI = EPS - r * BV;
      pvRI += RI / Math.pow(1 + r, y);
      BV = BV + EPS * (1 - payout);
    }
    return bvps + pvRI;
  }

  // Growth (simplified): revenue grows, FCF margin ramps to target, then DCF on FCF
  function modelGrowthRevenueMargin({ revenueTotal, shares, years, discPct, termPct, growthPct, targetFcfMarginPct, marginRampYears }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;
    const mTarget = targetFcfMarginPct / 100;
    const ramp = Math.max(1, Math.round(marginRampYears));

    if (!(revenueTotal > 0) || !(shares > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let rev = revenueTotal;
    let fcf = 0;

    for (let y=1; y<=years; y++){
      rev = rev * (1 + g);

      // linear ramp of margin 0 -> target over ramp years (simple, conservative)
      const m = (y >= ramp) ? mTarget : (mTarget * (y / ramp));
      fcf = rev * m;

      pv += fcf / Math.pow(1 + r, y);
    }

    const terminalFcf = fcf * (1 + gT);
    const terminal = terminalFcf / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return (pv + pvTerminal) / shares;
  }

  // Cyclical: normalized FCF adjusted by cycleAdj, then standard DCF on that level
  function modelCyclicalNormalized({ normFcfTotal, shares, years, discPct, termPct, growthPct, cycleAdjPct }){
    const adj = 1 + (cycleAdjPct / 100);
    return modelStandardDCF({
      fcfTotal: normFcfTotal * adj,
      shares,
      years,
      discPct,
      termPct,
      growthPct
    });
  }

  // Utility: dividend discount proxy (Gordon), plus short projection
  // We project dividend growth then terminal via Gordon (very simplified).
  function modelUtilityDividend({ divPerShare, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(divPerShare > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let d = divPerShare;

    for (let y=1; y<=years; y++){
      d = d * (1 + g);
      pv += d / Math.pow(1 + r, y);
    }

    const terminal = (d * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return pv + pvTerminal;
  }function computeAll(){
    const t = TEXTS[state.lang];

    const ticker = String($("in_ticker").value || "").trim().toUpperCase();
    const price  = parseNum($("in_price").value);
    const years  = Math.round(parseNum($("in_years").value));
    const disc   = parseNum($("in_disc").value);
    const term   = parseNum($("in_term").value);

    let base = parseNum($("in_base").value);
    let bear = parseNum($("in_bear").value);
    let bull = parseNum($("in_bull").value);
    if (!Number.isFinite(base)) base = 5;

    if (state.mode === "quick"){
      bear = base - 2;
      bull = base + 2;
      $("in_bear").value = String(Math.max(bear, -50));
      $("in_bull").value = String(bull);
    }

    const errors = [];
    if (!ticker) errors.push("Ticker");
    if (!Number.isFinite(price) || price <= 0) errors.push("Price");
    if (!Number.isFinite(years) || years < 1 || years > 30) errors.push("Years");
    if (!Number.isFinite(disc) || disc <= 0 || disc > 40) errors.push("Discount");
    if (!Number.isFinite(term) || term < -5 || term > 10) errors.push("Terminal");

    let vBear = NaN, vBase = NaN, vBull = NaN;

    if (state.model === "standard"){
      const fcf = parseNum($("in_fcf").value);
      const shares = parseNum($("in_shares").value);
      if (!Number.isFinite(fcf) || fcf <= 0) errors.push("FCF");
      if (!Number.isFinite(shares) || shares <= 0) errors.push("Shares");

      if (!errors.length){
        vBear = modelStandardDCF({fcfTotal: fcf, shares, years, discPct:disc, termPct:term, growthPct:bear});
        vBase = modelStandardDCF({fcfTotal: fcf, shares, years, discPct:disc, termPct:term, growthPct:base});
        vBull = modelStandardDCF({fcfTotal: fcf, shares, years, discPct:disc, termPct:term, growthPct:bull});
      }
    }

    if (state.model === "reit"){
      const affo = parseNum($("in_affo").value);
      if (!Number.isFinite(affo) || affo <= 0) errors.push("AFFO");

      if (!errors.length){
        vBear = modelReitAffo({affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:bear});
        vBase = modelReitAffo({affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:base});
        vBull = modelReitAffo({affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:bull});
      }
    }

    if (state.model === "financial"){
      const bvps = parseNum($("in_bvps").value);
      const payout = parseNum($("in_payout").value);
      if (!Number.isFinite(bvps) || bvps <= 0) errors.push("BVPS");
      if (!Number.isFinite(payout) || payout < 0 || payout > 100) errors.push("Payout");

      if (!errors.length){
        vBear = modelFinancialRIM({bvps, roePct:bear, payoutPct:payout, years, discPct:disc});
        vBase = modelFinancialRIM({bvps, roePct:base, payoutPct:payout, years, discPct:disc});
        vBull = modelFinancialRIM({bvps, roePct:bull, payoutPct:payout, years, discPct:disc});
      }
    }

    if (state.model === "growth"){
      const rev = parseNum($("in_rev").value);
      const shares = parseNum($("in_shares_g").value);
      const m = parseNum($("in_fcf_margin").value);
      const rampYears = parseNum($("in_margin_years").value);

      if (!Number.isFinite(rev) || rev <= 0) errors.push("Revenue");
      if (!Number.isFinite(shares) || shares <= 0) errors.push("Shares");
      if (!Number.isFinite(m) || m < 0 || m > 60) errors.push("FCF margin");
      if (!Number.isFinite(rampYears) || rampYears < 1 || rampYears > 20) errors.push("Ramp years");

      if (!errors.length){
        vBear = modelGrowthRevenueMargin({revenueTotal:rev, shares, years, discPct:disc, termPct:term, growthPct:bear, targetFcfMarginPct:m, marginRampYears:rampYears});
        vBase = modelGrowthRevenueMargin({revenueTotal:rev, shares, years, discPct:disc, termPct:term, growthPct:base, targetFcfMarginPct:m, marginRampYears:rampYears});
        vBull = modelGrowthRevenueMargin({revenueTotal:rev, shares, years, discPct:disc, termPct:term, growthPct:bull, targetFcfMarginPct:m, marginRampYears:rampYears});
      }
    }

    if (state.model === "cyclical"){
      const nfcf = parseNum($("in_norm_fcf").value);
      const shares = parseNum($("in_shares_c").value);
      const adj = parseNum($("in_cycle_adj").value);

      if (!Number.isFinite(nfcf) || nfcf <= 0) errors.push("Norm FCF");
      if (!Number.isFinite(shares) || shares <= 0) errors.push("Shares");
      if (!Number.isFinite(adj) || adj < -80 || adj > 80) errors.push("Adj");

      if (!errors.length){
        vBear = modelCyclicalNormalized({normFcfTotal:nfcf, shares, years, discPct:disc, termPct:term, growthPct:bear, cycleAdjPct:adj});
        vBase = modelCyclicalNormalized({normFcfTotal:nfcf, shares, years, discPct:disc, termPct:term, growthPct:base, cycleAdjPct:adj});
        vBull = modelCyclicalNormalized({normFcfTotal:nfcf, shares, years, discPct:disc, termPct:term, growthPct:bull, cycleAdjPct:adj});
      }
    }

    if (state.model === "utility"){
      const div = parseNum($("in_div").value);
      if (!Number.isFinite(div) || div <= 0) errors.push("Dividend");

      if (!errors.length){
        vBear = modelUtilityDividend({divPerShare:div, years, discPct:disc, termPct:term, growthPct:bear});
        vBase = modelUtilityDividend({divPerShare:div, years, discPct:disc, termPct:term, growthPct:base});
        vBull = modelUtilityDividend({divPerShare:div, years, discPct:disc, termPct:term, growthPct:bull});
      }
    }

    if (errors.length){
      toast((state.lang === "cz") ? ("Chybí/neplatné: " + errors.join(", ")) : ("Missing/invalid: " + errors.join(", ")));
      return null;
    }

    if (![vBear, vBase, vBull].every(Number.isFinite)){
      toast((state.lang === "cz")
        ? "Výpočet selhal: zkontroluj vstupy (např. diskont > terminál)."
        : "Calculation failed: check inputs (e.g., discount > terminal)."
      );
      return null;
    }

    return {
      id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
      dt: new Date().toISOString(),
      ticker,
      currency: state.currency,
      model: state.model,
      inputs: {
        price, years, disc, term, bear, base, bull,
        fcf: parseNum($("in_fcf")?.value),
        shares: parseNum($("in_shares")?.value),
        bvps: parseNum($("in_bvps")?.value),
        payout: parseNum($("in_payout")?.value),
        affo: parseNum($("in_affo")?.value),
        rev: parseNum($("in_rev")?.value),
        shares_g: parseNum($("in_shares_g")?.value),
        fcf_margin: parseNum($("in_fcf_margin")?.value),
        margin_years: parseNum($("in_margin_years")?.value),
        norm_fcf: parseNum($("in_norm_fcf")?.value),
        shares_c: parseNum($("in_shares_c")?.value),
        cycle_adj: parseNum($("in_cycle_adj")?.value),
        div: parseNum($("in_div")?.value)
      },
      values: { bear: vBear, base: vBase, bull: vBull }
    };
  }

  function paintResults(res){
    const t = TEXTS[state.lang];
    const cur = res.currency;

    const price = res.inputs.price;
    const bear = res.values.bear;
    const base = res.values.base;
    const bull = res.values.bull;

    $("r_bear").textContent = fmtMoney(bear, cur);
    $("r_base").textContent = fmtMoney(base, cur);
    $("r_bull").textContent = fmtMoney(bull, cur);

    $("r_bear_pct").textContent = fmtPct(((bear/price)-1)*100);
    $("r_base_pct").textContent = fmtPct(((base/price)-1)*100);
    $("r_bull_pct").textContent = fmtPct(((bull/price)-1)*100);

    $("r_bear_s").textContent = (state.lang === "cz") ? "vs aktuální cena" : "vs current price";
    $("r_base_s").textContent = (state.lang === "cz") ? "vs aktuální cena" : "vs current price";
    $("r_bull_s").textContent = (state.lang === "cz") ? "vs aktuální cena" : "vs current price";

    const mos = state.mos === "off" ? 0 : (parseInt(state.mos,10)/100);
    const target = base * (1 - mos);
    $("out_target").value = fmtMoney(target, cur);
    $("out_range").value = `${fmtMoney(bear, cur)} – ${fmtMoney(bull, cur)}`;

    // sanity check
    const sanityBox = $("ui_sanityBox");
    const sanityText = $("ui_sanityText");
    const sanityTitle = $("ui_sanityTitle");
    sanityBox.style.display = "none";
    sanityTitle.textContent = t.sanityTitle;

    const ratio = base / price;
    if (Number.isFinite(ratio)){
      if (ratio < 0.2){
        sanityText.textContent = t.sanityLow;
        sanityBox.style.display = "";
      } else if (ratio > 5){
        sanityText.textContent = t.sanityHigh;
        sanityBox.style.display = "";
      }
    }

    state.lastResult = res;
  }

  $("btn_calc").addEventListener("click", ()=>{
    const res = computeAll();
    if (!res) return;
    paintResults(res);
    toast((state.lang === "cz") ? "Hotovo ✅" : "Done ✅");
  });

  $("btn_fillDemo").addEventListener("click", ()=>{
    $("in_ticker").value = "DEMO";
    $("in_price").value = "100";
    $("in_years").value = "10";
    $("in_disc").value = "9";
    $("in_term").value = "2.5";

    if (state.model === "standard"){
      $("in_fcf").value = "10b";
      $("in_shares").value = "2b";
      $("in_base").value = "6";
    }
    if (state.model === "reit"){
      $("in_affo").value = "2.10";
      $("in_base").value = "4";
    }
    if (state.model === "financial"){
      $("in_bvps").value = "7.00";
      $("in_payout").value = "20";
      $("in_base").value = "12";
    }
    if (state.model === "growth"){
      $("in_rev").value = "300b";
      $("in_shares_g").value = "13b";
      $("in_fcf_margin").value = "15";
      $("in_margin_years").value = "5";
      $("in_base").value = "10";
    }
    if (state.model === "cyclical"){
      $("in_norm_fcf").value = "6b";
      $("in_shares_c").value = "3b";
      $("in_cycle_adj").value = "-10";
      $("in_base").value = "3";
    }
    if (state.model === "utility"){
      $("in_div").value = "3.10";
      $("in_base").value = "3";
    }

    if (state.mode === "quick"){
      const b = parseNum($("in_base").value);
      $("in_bear").value = String(Math.max(b - 2, -50));
      $("in_bull").value = String(b + 2);
    }

    bindBigNumberFormatting();
    toast((state.lang === "cz") ? "Demo vyplněno" : "Demo filled");
  });function loadWatchlist(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }

  function saveWatchlist(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  $("btn_save").addEventListener("click", ()=>{
    if (!state.lastResult){
      toast((state.lang === "cz") ? "Nejdřív spočítej výsledek." : "Calculate first.");
      return;
    }
    const arr = loadWatchlist();
    arr.unshift(state.lastResult);
    saveWatchlist(arr);
    renderWatchlist();
    toast((state.lang === "cz") ? "Uloženo ✅" : "Saved ✅");
  });

  function modelLabel(m){
    const t = TEXTS[state.lang];
    if (m === "standard") return t.m_standard_t;
    if (m === "financial") return t.m_fin_t;
    if (m === "reit") return t.m_reit_t;
    if (m === "growth") return t.m_growth_t;
    if (m === "cyclical") return t.m_cyc_t;
    if (m === "utility") return t.m_util_t;
    return m;
  }

  function renderWatchlist(){
    const t = TEXTS[state.lang];
    const arr = loadWatchlist();
    const tb = $("watchTbody");
    tb.innerHTML = "";

    if (!arr.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 10;
      td.className = "muted";
      td.textContent = t.empty;
      tr.appendChild(td);
      tb.appendChild(tr);
      return;
    }

    for (const item of arr){
      const tr = document.createElement("tr");

      const d = new Date(item.dt);
      const dateStr = (state.lang === "cz")
        ? d.toLocaleString("cs-CZ", {year:"numeric", month:"2-digit", day:"2-digit"})
        : d.toLocaleString("en-US", {year:"numeric", month:"2-digit", day:"2-digit"});

      const price = item.inputs.price;
      const bear = item.values.bear;
      const base = item.values.base;
      const bull = item.values.bull;

      const mos = state.mos === "off" ? 0 : (parseInt(state.mos,10)/100);
      const target = base * (1 - mos);
      const range = `${fmtMoney(bear, item.currency)} – ${fmtMoney(bull, item.currency)}`;

      tr.innerHTML = `
        <td class="nowrap">${dateStr}</td>
        <td class="nowrap"><strong>${item.ticker}</strong><div class="mini">${item.currency}</div></td>
        <td class="right nowrap">${fmtMoney(price, item.currency)}</td>
        <td class="right nowrap"><div class="mini" style="margin:0; color:rgba(255,255,255,.85)">${modelLabel(item.model)}</div></td>
        <td class="right nowrap">${fmtMoney(bear, item.currency)}<div class="mini">${fmtPct(((bear/price)-1)*100)}</div></td>
        <td class="right nowrap">${fmtMoney(base, item.currency)}<div class="mini">${fmtPct(((base/price)-1)*100)}</div></td>
        <td class="right nowrap">${fmtMoney(bull, item.currency)}<div class="mini">${fmtPct(((bull/price)-1)*100)}</div></td>
        <td class="right nowrap">${fmtMoney(target, item.currency)}</td>
        <td class="right nowrap">${range}</td>
        <td class="right nowrap">
          <button class="danger" data-del="${item.id}">${t.del}</button>
        </td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        const arr2 = loadWatchlist().filter(x => x.id !== id);
        saveWatchlist(arr2);
        renderWatchlist();
        toast((state.lang === "cz") ? "Smazáno" : "Deleted");
      });
    });
  }

  $("btn_export_csv").addEventListener("click", ()=>{
    const t = TEXTS[state.lang];
    const arr = loadWatchlist();
    if (!arr.length){
      toast((state.lang==="cz") ? "Watchlist je prázdný." : "Watchlist is empty.");
      return;
    }

    const mos = state.mos === "off" ? 0 : (parseInt(state.mos,10)/100);
    const rows = [];
    rows.push(["date","ticker","currency","model","price","bear","base","bull","target(mos)","range"].join(","));

    for (const it of arr){
      const target = it.values.base * (1 - mos);
      const range = `${it.values.bear} - ${it.values.bull}`;
      rows.push([
        new Date(it.dt).toISOString(),
        it.ticker,
        it.currency,
        it.model,
        it.inputs.price,
        it.values.bear,
        it.values.base,
        it.values.bull,
        target,
        `"${range}"`
      ].join(","));
    }

    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "equity-analyzer-watchlist.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    toast((state.lang==="cz") ? "CSV staženo ✅" : "CSV downloaded ✅");
  });

  $("btn_print_pdf").addEventListener("click", ()=>{
    const arr = loadWatchlist();
    if (!arr.length){
      toast((state.lang==="cz") ? "Watchlist je prázdný." : "Watchlist is empty.");
      return;
    }

    const mos = state.mos === "off" ? 0 : (parseInt(state.mos,10)/100);

    const html = `
      <html>
      <head>
        <meta charset="utf-8"/>
        <title>Equity Analyzer – Watchlist</title>
        <style>
          body{font-family: Arial, sans-serif; padding:18px;}
          h1{margin:0 0 10px;}
          table{width:100%; border-collapse:collapse;}
          th,td{border:1px solid #ddd; padding:8px; font-size:12px;}
          th{background:#f3f3f3;}
        </style>
      </head>
      <body>
        <h1>Equity Analyzer – Watchlist</h1>
        <p>Generated: ${new Date().toLocaleString()}</p>
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Ticker</th><th>Cur</th><th>Model</th><th>Price</th>
              <th>Bear</th><th>Base</th><th>Bull</th>
              <th>Target (MoS)</th><th>Range</th>
            </tr>
          </thead>
          <tbody>
            ${arr.map(it=>{
              const d = new Date(it.dt).toISOString().slice(0,10);
              const target = (it.values.base * (1 - mos)).toFixed(2);
              const range = `${it.values.bear.toFixed(2)} - ${it.values.bull.toFixed(2)}`;
              return `<tr>
                <td>${d}</td><td>${it.ticker}</td><td>${it.currency}</td><td>${it.model}</td><td>${it.inputs.price}</td>
                <td>${it.values.bear.toFixed(2)}</td><td>${it.values.base.toFixed(2)}</td><td>${it.values.bull.toFixed(2)}</td>
                <td>${target}</td><td>${range}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      </body>
      </html>
    `;

    const w = window.open("", "_blank");
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  });

  function init(){
    state.lang = $("langSel").value; // default EN
    state.mode = $("modeSel").value;
    state.currency = $("curSel").value;
    state.mos = $("mosSel").value;

    applyMode();
    applyLang();
    bindHintTitles();
    bindBigNumberFormatting();

    setModel("standard");
    renderWatchlist();

    // quick derive at start
    if (state.mode === "quick"){
      const base = parseNum($("in_base").value);
      if (Number.isFinite(base)){
        $("in_bear").value = String(Math.max(base - 2, -50));
        $("in_bull").value = String(base + 2);
      }
    }
  }

  init();
  </script>
</body>
</html>
  

    
    

    

    


  
    
    
    
      
    
        

      
          
  

    



    





  
  


  





        


        



  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





