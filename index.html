<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Equity Analyzer</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Equity Analyzer" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Play/Legal safe meta -->
  <meta name="description" content="Educational equity valuation tool. Not financial, investment, legal, or tax advice." />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f172a;
      --text:#e6eefc;
      --muted:rgba(230,238,252,.72);
      --muted2:rgba(230,238,252,.55);
      --line:rgba(255,255,255,.10);
      --accent:#60a5fa;
      --green:#34d399;
      --red:#fb7185;
      --yellow:#fbbf24;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(52,211,153,.12), transparent 55%),
                  radial-gradient(1200px 900px at 50% 120%, rgba(251,191,36,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px}
    .topbar{
      display:flex;gap:12px;align-items:flex-end;justify-content:space-between;
      padding:14px 14px;border:1px solid var(--line);border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(16,26,51,.75), rgba(16,26,51,.55));
      box-shadow: var(--shadow);
    }
    .brand h1{margin:0;font-size:22px;letter-spacing:.2px}
    .brand .sub{margin-top:4px;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .control{
      display:flex;flex-direction:column;gap:6px;min-width:140px;
      padding:10px 10px;border:1px solid var(--line);border-radius:14px;
      background: rgba(15,23,42,.55);
    }
    .control label{font-size:12px;color:var(--muted2)}
    select, input{
      width:100%;
      background: rgba(9,14,30,.85);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{color:rgba(230,238,252,.35)}
    button{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(96,165,250,.14);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
    }
    button:hover{background: rgba(96,165,250,.22)}
    button.secondary{background: rgba(255,255,255,.06)}
    button.secondary:hover{background: rgba(255,255,255,.10)}
    button.danger{background: rgba(251,113,133,.15);border-color: rgba(251,113,133,.25)}
    button.danger:hover{background: rgba(251,113,133,.22)}

    .accordion{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .acc{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: rgba(16,26,51,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .acc .head{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 14px;cursor:pointer;
      background: linear-gradient(180deg, rgba(16,26,51,.75), rgba(16,26,51,.45));
    }
    .acc .title{display:flex;gap:10px;align-items:center}
    .acc .title .tag{
      font-size:12px;color:rgba(230,238,252,.75);
      padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background: rgba(15,23,42,.65);
    }
    .acc .chev{opacity:.8}
    .acc .body{display:none;padding:14px 14px 16px}
    .acc.open .body{display:block}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      background: rgba(15,23,42,.55);
      border-radius: var(--radius);
      padding:14px 14px;
    }
    .card h3{margin:0 0 10px;font-size:16px}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .mini{color:rgba(230,238,252,.70);font-size:12px;line-height:1.35;margin-top:6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    .field .lbl{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .field .lbl span{font-size:13px;color:rgba(230,238,252,.92)}
    .hint{
      display:inline-flex;align-items:center;justify-content:center;
      width:18px;height:18px;border-radius:999px;
      font-size:12px;cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      color:rgba(230,238,252,.92);
      background: rgba(255,255,255,.05);
      user-select:none;
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    .models{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px
    }
    @media (max-width:900px){.models{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.models{grid-template-columns:1fr}}
    .mBtn{
      text-align:left;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(9,14,30,.35);
      cursor:pointer;
      transition: .15s;
    }
    .mBtn:hover{transform: translateY(-1px);background: rgba(9,14,30,.55)}
    .mBtn.active{
      border-color: rgba(96,165,250,.55);
      background: rgba(96,165,250,.14);
    }
    .mBtn .t{font-weight:700;font-size:14px}
    .mBtn .d{margin-top:6px;color:rgba(230,238,252,.70);font-size:12px;line-height:1.25}

    .results{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:520px){.results{grid-template-columns:1fr}}
    .res{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(9,14,30,.35);
      padding:12px 12px;
    }
    .res .k{display:flex;gap:8px;align-items:center;font-size:12px;color:rgba(230,238,252,.85)}
    .res .v{margin-top:8px;font-size:18px;font-weight:800;letter-spacing:.2px}
    .res .s{margin-top:4px;font-size:12px;color:rgba(230,238,252,.62)}
    .badgeBear,.badgeBase,.badgeBull{
      padding:3px 8px;border-radius:999px;font-weight:700;font-size:11px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .badgeBear{color:var(--red);border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.08)}
    .badgeBase{color:var(--yellow);border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08)}
    .badgeBull{color:var(--green);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.08)}
    .tipbox{
      border:1px solid rgba(96,165,250,.25);
      background: rgba(96,165,250,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .footer{
      margin-top:14px;
      color:rgba(230,238,252,.55);
      font-size:12px;
      text-align:center;
    }

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;font-size:12px}
    th{color:rgba(230,238,252,.75);text-align:left;font-weight:700}
    td{color:rgba(230,238,252,.88)}
    td.right, th.right{text-align:right}
    .nowrap{white-space:nowrap}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background: rgba(9,14,30,.90);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding:10px 14px;border-radius:999px;
      display:none;
      box-shadow: var(--shadow);
      z-index:9999;
      max-width:92vw;
    }

    .modalBackdrop{
      position:fixed;inset:0;
      background: rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:18px;
      z-index:9998;
    }
    .modal{
      width:min(560px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(16,26,51,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead .t{font-weight:800}
    .xbtn{background: rgba(255,255,255,.06)}
    .modalBody{padding:14px}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>Equity Analyzer</h1>
        <div class="sub" id="ui_sub">Educational valuation tool • Not financial advice</div>
      </div>

      <div class="controls">
        <div class="control">
          <label id="ui_langLbl">Language</label>
          <select id="langSel">
            <option value="en" selected>EN</option>
            <option value="cz">CZ</option>
          </select>
        </div>

        <div class="control">
          <label id="ui_modeLbl">Mode</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="modeSel">
              <option value="quick" selected>Quick</option>
              <option value="advanced">Advanced</option>
            </select>
            <span class="hint" data-help="mode">i</span>
          </div>
        </div>

        <div class="control">
          <label id="ui_currLbl">Currency</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="curSel">
              <option>USD</option>
              <option>EUR</option>
              <option>CZK</option>
            </select>
            <span class="hint" data-help="currency">i</span>
          </div>
        </div>

        <div class="control">
          <label id="ui_mosLbl">Margin of Safety</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="mosSel">
              <option value="off" selected>Off</option>
              <option value="10">10%</option>
              <option value="20">20%</option>
              <option value="30">30%</option>
            </select>
            <span class="hint" data-help="mos">i</span>
          </div>
        </div>

      </div>
    </div><div class="accordion">

      <!-- VALUATION -->
      <div class="acc open" id="acc_val">
        <div class="head" data-acc="val">
          <div class="title">
            <span id="ui_valTitle">Fair value</span>
            <span class="tag" id="ui_valTag">Models + 3 scenarios</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="valBody">

          <div class="card">
            <h3 id="ui_introTitle">What are we calculating?</h3>
            <div class="muted" id="ui_introText">
              Pick a company type (model) and compute fair value in 3 scenarios. Output is a scenario, not advice.
            </div>

            <div class="mini" id="ui_decimalTip" style="margin-top:10px;">
              Tip: You can type decimals with dot or comma (e.g., 5.5 or 5,5). Spaces are ignored.
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3 id="ui_modelTitle">Choose model</h3>
            <div class="models" style="margin-top:10px;">
              <div class="mBtn active" data-model="standard">
                <div class="t" id="ui_m_standard_t">Standard (FCF DCF)</div>
                <div class="d" id="ui_m_standard_d">Non-financials with stable positive FCF.</div>
              </div>
              <div class="mBtn" data-model="financial">
                <div class="t" id="ui_m_fin_t">Financial (RIM)</div>
                <div class="d" id="ui_m_fin_d">Banks/insurers/fintech – value via BVPS and ROE.</div>
              </div>
              <div class="mBtn" data-model="reit">
                <div class="t" id="ui_m_reit_t">REIT (AFFO)</div>
                <div class="d" id="ui_m_reit_d">REITs – AFFO per share instead of FCF.</div>
              </div>
              <div class="mBtn" data-model="growth">
                <div class="t" id="ui_m_growth_t">Growth (Pre-FCF)</div>
                <div class="d" id="ui_m_growth_d">Revenue & margin to FCF → DCF.</div>
              </div>
              <div class="mBtn" data-model="cyclical">
                <div class="t" id="ui_m_cyc_t">Cyclical</div>
                <div class="d" id="ui_m_cyc_d">Use normalized (cycle-average) FCF.</div>
              </div>
              <div class="mBtn" data-model="utility">
                <div class="t" id="ui_m_util_t">Utility (DDM)</div>
                <div class="d" id="ui_m_util_d">Dividend Discount Model.</div>
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top:12px;">

            <!-- LEFT: INPUTS -->
            <div class="card">
              <h3 id="ui_inputsMain">Core inputs</h3>

              <div class="row">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_tickerLbl">Ticker</span>
                    <span class="hint" data-help="ticker">i</span>
                  </div>
                  <input id="in_ticker" placeholder="e.g. AAPL" />
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_priceLbl">Current price</span>
                    <span class="hint" data-help="price">i</span>
                  </div>
                  <input id="in_price" placeholder="e.g. 180" />
                </div>
              </div>

              <!-- MOS explain box (click i on MoS) -->
              <div class="tipbox" id="mosExplainBox" style="display:none; margin-top:10px;">
                <div class="mini" id="mosExplainText" style="color:rgba(255,255,255,.9)"></div>
              </div>

              <!-- STANDARD (FCF DCF): firm-level FCF + shares -->
              <div id="sec_standard" style="margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_fcfLbl">Free Cash Flow (FCF) – total</span>
                      <span class="hint" data-help="fcf_total">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_fcf" placeholder="e.g. 10" />
                      <select id="unit_fcf">
                        <option value="1">Raw</option>
                        <option value="1000000">M</option>
                        <option value="1000000000" selected>B</option>
                      </select>
                    </div>
                    <div class="mini" id="ui_fcfMini">Annual total FCF (ideally 3–5y avg). Units via selector.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesLbl">Shares Outstanding</span>
                      <span class="hint" data-help="shares">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_shares" placeholder="e.g. 600" />
                      <select id="unit_shares">
                        <option value="1">Raw</option>
                        <option value="1000000" selected>M</option>
                        <option value="1000000000">B</option>
                      </select>
                    </div>
                    <div class="mini" id="ui_sharesMini">Used to convert firm value to per-share value.</div>
                  </div>
                </div>
              </div>

              <!-- FINANCIAL (RIM): BVPS + payout (ROE scenarios on the right) -->
              <div id="sec_financial" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_bvpsLbl">Book Value per Share (BVPS)</span>
                      <span class="hint" data-help="bvps">i</span>
                    </div>
                    <input id="in_bvps" placeholder="e.g. 6.95" />
                    <div class="mini" id="ui_bvpsMini">Core input for banks/insurers.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_payoutLbl">Payout ratio (%)</span>
                      <span class="hint" data-help="payout">i</span>
                    </div>
                    <input id="in_payout" placeholder="e.g. 20" value="20" />
                    <div class="mini" id="ui_payoutMini">% of earnings paid out. The rest grows BVPS.</div>
                  </div>
                </div>
              </div>

              <!-- REIT (AFFO): AFFO per share -->
              <div id="sec_reit" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_affoLbl">AFFO per share</span>
                      <span class="hint" data-help="affo">i</span>
                    </div>
                    <input id="in_affo" placeholder="e.g. 2.10" />
                    <div class="mini" id="ui_affoMini">REITs: use AFFO/FFO instead of FCF.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_reitNoteLbl">Note</span>
                      <span class="hint" data-help="reit_note">i</span>
                    </div>
                    <input id="in_reit_note" placeholder="(optional)" />
                    <div class="mini">Label only (e.g., “AFFO TTM”).</div>
                  </div>
                </div>
              </div>

              <!-- GROWTH (Pre-FCF): Revenue + FCF margin + shares -->
              <div id="sec_growth" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_revLbl">Revenue – total</span>
                      <span class="hint" data-help="revenue_total">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_rev" placeholder="e.g. 50" />
                      <select id="unit_rev">
                        <option value="1">Raw</option>
                        <option value="1000000">M</option>
                        <option value="1000000000" selected>B</option>
                      </select>
                    </div>
                    <div class="mini" id="ui_revMini">Annual revenue. We project revenue, then convert to FCF via margin.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_marginLbl">FCF margin (%)</span>
                      <span class="hint" data-help="fcf_margin">i</span>
                    </div>
                    <input id="in_margin" placeholder="e.g. 15" value="15" />
                    <div class="mini" id="ui_marginMini">Long-run FCF margin assumption (Revenue × margin = FCF).</div>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesGLbl">Shares Outstanding</span>
                      <span class="hint" data-help="shares">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_shares_g" placeholder="e.g. 600" />
                      <select id="unit_shares_g">
                        <option value="1">Raw</option>
                        <option value="1000000" selected>M</option>
                        <option value="1000000000">B</option>
                      </select>
                    </div>
                    <div class="mini">Used for per-share conversion.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_growthRampLbl">Margin ramp years</span>
                      <span class="hint" data-help="margin_ramp">i</span>
                    </div>
                    <input id="in_ramp" placeholder="e.g. 3" value="3" />
                    <div class="mini">Over how many years margin approaches target (smooth ramp).</div>
                  </div>
                </div>
              </div>

              <!-- CYCLICAL: Normalized FCF + shares -->
              <div id="sec_cyclical" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_normFcfLbl">Normalized FCF – total</span>
                      <span class="hint" data-help="norm_fcf">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_norm_fcf" placeholder="e.g. 5" />
                      <select id="unit_norm_fcf">
                        <option value="1">Raw</option>
                        <option value="1000000">M</option>
                        <option value="1000000000" selected>B</option>
                      </select>
                    </div>
                    <div class="mini">Cycle-average FCF (e.g., 5–10 year average).</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_sharesCLbl">Shares Outstanding</span>
                      <span class="hint" data-help="shares">i</span>
                    </div>
                    <div style="display:flex; gap:8px;">
                      <input id="in_shares_c" placeholder="e.g. 600" />
                      <select id="unit_shares_c">
                        <option value="1">Raw</option>
                        <option value="1000000" selected>M</option>
                        <option value="1000000000">B</option>
                      </select>
                    </div>
                    <div class="mini">Used for per-share conversion.</div>
                  </div>
                </div>
              </div>

              <!-- UTILITY: Dividend DDM -->
              <div id="sec_utility" style="display:none; margin-top:10px;">
                <div class="row">
                  <div class="field">
                    <div class="lbl">
                      <span id="ui_divLbl">Dividend per share (DPS)</span>
                      <span class="hint" data-help="dps">i</span>
                    </div>
                    <input id="in_dps" placeholder="e.g. 2.10" />
                    <div class="mini">Annual dividend per share.</div>
                  </div>

                  <div class="field">
                    <div class="lbl">
                      <span id="ui_divGrowLbl">Dividend growth (%)</span>
                      <span class="hint" data-help="div_g">i</span>
                    </div>
                    <input id="in_divg" placeholder="e.g. 4" value="4" />
                    <div class="mini">Growth used for projection years (then terminal growth applies).</div>
                  </div>
                </div>
              </div>

              <!-- shared projection settings -->
              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_yearsLbl">Projection years</span>
                    <span class="hint" data-help="years">i</span>
                  </div>
                  <input id="in_years" placeholder="10" value="10" />
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_discLbl">Discount rate (%)</span>
                    <span class="hint" data-help="disc">i</span>
                  </div>
                  <input id="in_disc" placeholder="9" value="9" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_termLbl">Terminal growth (%)</span>
                    <span class="hint" data-help="term">i</span>
                  </div>
                  <input id="in_term" placeholder="2.5" value="2.5" />
                  <div class="mini" id="ui_termMini">Used for Standard/REIT/Growth/Cyclical/Utility.</div>
                </div>
              </div>

              <div class="btns">
                <button id="btn_calc">Calculate</button>
                <button class="secondary" id="btn_save">Save to Watchlist</button>
                <button class="secondary" id="btn_fillDemo">Demo values</button>
              </div>

              <div class="mini" id="ui_saveNote">Saves latest result (Bear/Base/Bull).</div>
            </div>

            <!-- RIGHT: scenarios + results -->
            <div class="card">
              <h3 id="ui_inputsScen">Scenarios (annual)</h3>
              <div class="muted" id="ui_inputsScenText">
                Quick uses Base and auto-derives Bear/Bull (±2). Advanced lets you set all three.
              </div>

              <div class="tipbox" id="ui_scenTip" style="margin-top:10px;">
                <span id="ui_scenTipText">Meaning depends on model: growth % (DCF) or ROE % (Financial).</span>
              </div>

              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <div class="lbl">
                    <span id="ui_bearLbl">Bear</span>
                    <span class="hint" data-help="bear">i</span>
                  </div>
                  <input id="in_bear" placeholder="2" value="2" />
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_baseLbl">Base</span>
                    <span class="hint" data-help="base">i</span>
                  </div>
                  <input id="in_base" placeholder="5" value="5" />
                </div>

                <div class="field">
                  <div class="lbl">
                    <span id="ui_bullLbl">Bull</span>
                    <span class="hint" data-help="bull">i</span>
                  </div>
                  <input id="in_bull" placeholder="8" value="8" />
                </div>
              </div>

              <div class="results" id="resultGrid" style="margin-top:12px;">
                <div class="res">
                  <div class="k"><span class="badgeBear">BEAR</span><span id="r_bear_pct"></span></div>
                  <div class="v" id="r_bear">—</div>
                  <div class="s" id="r_bear_s">—</div>
                </div>
                <div class="res">
                  <div class="k"><span class="badgeBase">BASE</span><span id="r_base_pct"></span></div>
                  <div class="v" id="r_base">—</div>
                  <div class="s" id="r_base_s">—</div>
                </div>
                <div class="res">
                  <div class="k"><span class="badgeBull">BULL</span><span id="r_bull_pct"></span></div>
                  <div class="v" id="r_bull">—</div>
                  <div class="s" id="r_bull_s">—</div>
                </div>
              </div>

              <div class="card" style="margin-top:12px;">
                <h3 id="ui_targetsTitle">Target & Range</h3>
                <div class="muted" id="ui_targetsText">Target = Base with Margin of Safety. Range = Bear to Bull.</div>

                <div class="row" style="margin-top:10px;">
                  <div class="field">
                    <div class="lbl"><span id="ui_targetLbl">Target price</span></div>
                    <input id="out_target" readonly placeholder="—" />
                  </div>
                  <div class="field">
                    <div class="lbl"><span id="ui_rangeLbl">Fair value range</span></div>
                    <input id="out_range" readonly placeholder="—" />
                  </div>
                </div>
              </div>

              <div class="tipbox" id="ui_sanityBox" style="display:none; margin-top:12px;">
                <strong id="ui_sanityTitle">Sanity check:</strong>
                <div id="ui_sanityText" class="mini" style="margin-top:6px; color:rgba(255,255,255,.85)"></div>
              </div>

            </div>
          </div>
        </div>
                      </div><!-- WATCHLIST -->
      <div class="acc" id="acc_watch">
        <div class="head" data-acc="watch">
          <div class="title">
            <span id="ui_watchTitle">Watchlist</span>
            <span class="tag" id="ui_watchTag">Local storage</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="watchBody">
          <div class="card">
            <h3 id="ui_watchIntroTitle">Saved valuations</h3>
            <div class="muted" id="ui_watchIntroText">
              Saved tickers. Delete rows and export the table.
            </div>

            <div class="btns" style="margin-top:10px;">
              <button class="secondary" id="btn_export_csv">Export CSV</button>
              <button class="secondary" id="btn_print_pdf">Print / PDF</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div style="overflow:auto;">
              <table id="watchTable">
                <thead>
                  <tr>
                    <th id="th_date">Date</th>
                    <th id="th_ticker">Ticker</th>
                    <th class="right" id="th_price">Price</th>
                    <th class="right" id="th_model">Model</th>
                    <th class="right" id="th_bear">Bear</th>
                    <th class="right" id="th_base">Base</th>
                    <th class="right" id="th_bull">Bull</th>
                    <th class="right nowrap" id="th_target">Target</th>
                    <th class="right nowrap" id="th_range">Range</th>
                    <th class="right" id="th_action">Action</th>
                  </tr>
                </thead>
                <tbody id="watchTbody">
                  <tr><td colspan="10" class="muted" id="watchEmpty">No saved items yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="footer" id="ui_watchFooter">
            Note: Watchlist is stored locally in your browser (localStorage).
          </div>
        </div>
      </div>

      <!-- GUIDE -->
      <div class="acc" id="acc_guide">
        <div class="head" data-acc="guide">
          <div class="title">
            <span id="ui_guideTitle">How to choose a model</span>
            <span class="tag" id="ui_guideTag">Guide</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="guideBody">
          <div class="card">
            <div class="muted" id="ui_guideHtml"></div>
          </div>
        </div>
      </div>

    </div><!-- /accordion -->

    <div class="footer" id="ui_footer">
      Educational tool • Not investment advice
    </div>

  </div><!-- /wrap -->

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div class="t" id="modalTitle">Info</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div><script>
  const TEXTS = {
    en: {
      sub: "Educational valuation tool • Not financial advice",
      langLbl: "Language",
      modeLbl: "Mode",
      valTitle: "Fair value",
      valTag: "Models + 3 scenarios",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "How to choose a model",
      guideTag: "Guide",

      introTitle: "What are we calculating?",
      introText: "Pick a company type (model) and compute fair value in 3 scenarios. Output is a scenario, not advice.",
      decimalTip: "Tip: You can type decimals with dot or comma (e.g., 5.5 or 5,5). Spaces are ignored.",

      currLbl: "Currency",
      mosLbl: "Margin of Safety",

      modelTitle: "Choose model",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Non-financials with stable positive FCF.",
      m_fin_t:"Financial (RIM)",
      m_fin_d:"Banks/insurers/fintech – value via BVPS and ROE.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REITs – AFFO per share instead of FCF.",
      m_growth_t:"Growth (Pre-FCF)",
      m_growth_d:"Revenue & margin to FCF → DCF.",
      m_cyc_t:"Cyclical",
      m_cyc_d:"Use normalized (cycle-average) FCF.",
      m_util_t:"Utility (DDM)",
      m_util_d:"Dividend Discount Model.",

      inputsMain:"Core inputs",
      tickerLbl:"Ticker",
      priceLbl:"Current price",

      fcfLbl:"Free Cash Flow (FCF) – total",
      fcfMini:"Annual total FCF. Use unit selector (M/B) to avoid typing zeros.",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Used to convert firm value to per-share value (use M/B selector).",

      bvpsLbl:"Book Value per Share (BVPS)",
      bvpsMini:"Core input for banks/insurers/fintech.",
      payoutLbl:"Payout ratio (%)",
      payoutMini:"% of earnings paid out; remainder grows BVPS.",

      affoLbl:"AFFO per share",
      affoMini:"Preferred REIT cash metric (AFFO/FFO).",
      reitNoteLbl:"Note",

      revLbl:"Revenue – total",
      revMini:"Annual revenue; projected then converted to FCF via margin.",
      marginLbl:"FCF margin (%)",
      marginMini:"Long-run margin used to convert revenue to FCF.",
      growthRampLbl:"Margin ramp years",

      normFcfLbl:"Normalized FCF – total",
      sharesGLbl:"Shares Outstanding",
      sharesCLbl:"Shares Outstanding",

      divLbl:"Dividend per share (DPS)",
      divGrowLbl:"Dividend growth (%)",

      yearsLbl:"Projection years",
      discLbl:"Discount rate (%)",
      termLbl:"Terminal growth (%)",
      termMini:"Must be lower than discount rate.",

      inputsScen:"Scenarios (annual)",
      inputsScenText:"Quick uses Base and auto-derives Bear/Bull (±2). Advanced lets you set all three manually.",
      scenTipText:"Standard/REIT/Growth/Cyclical: growth %. Financial: ROE %. Utility: dividend growth % (uses Dividend growth input).",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base with Margin of Safety. Range = Bear to Bull.",
      targetLbl:"Target price",
      rangeLbl:"Fair value range",

      calc:"Calculate",
      save:"Save to Watchlist",
      demo:"Demo values",
      saveNote:"Saves latest result (Bear/Base/Bull).",

      watchIntroTitle:"Saved valuations",
      watchIntroText:"Saved tickers. Delete rows and export the table.",
      watchFooter:"Note: Watchlist is stored locally in your browser (localStorage).",
      empty:"No saved items yet.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Delete",
      footer:"Educational tool • Not financial advice",

      th:{date:"Date",ticker:"Ticker",price:"Price",model:"Model",bear:"Bear",base:"Base",bull:"Bull",target:"Target",range:"Range",action:"Action"},

      sanityTitle:"Sanity check:",
      sanityLow:"Result looks extremely low. Check model choice, units (total vs per-share) and shares.",
      sanityHigh:"Result looks extremely high. Check growth/discount assumptions and whether the company is cyclical.",

      mosExplainHtml: `
        <strong>Margin of Safety (MoS)</strong> applies a safety discount to the Base fair value to form a more conservative <em>Target price</em>.
        <ul>
          <li>Example: Base = 100 → MoS 20% ⇒ Target = 80</li>
        </ul>
        MoS helps account for uncertainty and estimation errors. <strong>It is not a prediction or guarantee.</strong>
      `,

      guideHtml: `
        <h3>About & Disclaimer</h3>
        <p><strong>Educational tool only.</strong> This app is for educational and informational purposes.</p>
        <ul>
          <li><strong>Not financial or investment advice.</strong> No financial, investment, legal, or tax advice is provided.</li>
          <li>No recommendations to buy/sell. Outputs are illustrative estimates based on user assumptions.</li>
          <li>Investing involves risk, including loss of capital.</li>
        </ul>

        <h3>Who is this app for?</h3>
        <ul>
          <li>Long-term investors learning valuation</li>
          <li>Students of fundamental analysis</li>
          <li>Self-directed investors building their own assumptions</li>
        </ul>

        <h3>Where to find input data?</h3>
        <ul>
          <li><strong>Company reports:</strong> annual/quarterly reports (10-K / annual report), investor presentations</li>
          <li><strong>Statements:</strong> Cash Flow (FCF), Income Statement (revenue), Balance Sheet (book value)</li>
          <li><strong>Market data:</strong> shares outstanding and price from reputable finance sources</li>
          <li><strong>REIT:</strong> AFFO/FFO usually in REIT supplemental / earnings release</li>
        </ul>

        <h3>How the 6 valuation models work</h3>

        <h4>1) Standard (FCF DCF)</h4>
        <p>Projects total FCF for N years, discounts it, adds terminal value, then converts to per-share using Shares Outstanding.</p>

        <h4>2) Financial (RIM)</h4>
        <p>Residual Income Model: value = BVPS + PV(residual income). Uses ROE scenarios and payout to grow BVPS.</p>

        <h4>3) REIT (AFFO)</h4>
        <p>DCF on AFFO per share. Often more meaningful than standard FCF for REITs.</p>

        <h4>4) Growth (Pre-FCF)</h4>
        <p>Projects revenue growth, converts revenue to FCF via margin (optionally ramps margin), then performs DCF and converts to per-share via shares.</p>

        <h4>5) Cyclical</h4>
        <p>Starts from normalized (cycle-average) FCF rather than a single year. Then DCF with conservative growth assumptions.</p>

        <h4>6) Utility (DDM)</h4>
        <p>Dividend Discount Model: discounts projected dividends plus terminal dividend value.</p>

        <p class="mini" style="margin-top:10px;opacity:.9">
          Note: Simplified educational models. Real-world valuation may also require debt/cash, reinvestment, dilution and sensitivity analysis.
        </p>
      `,

      helps:{
        ticker:{t:"Ticker",b:"Stock symbol for labeling your watchlist (e.g., AAPL)."},
        price:{t:"Current price",b:"Market price used to compute upside/downside vs fair value."},
        mode:{t:"Mode",b:"Quick: enter Base only; Bear/Bull auto (±2). Advanced: enter all three scenarios."},
        currency:{t:"Currency",b:"Formatting only. The app does not convert FX rates automatically."},
        mos:{t:"Margin of Safety",b:"Applies a safety discount to Base fair value to form Target price."},

        fcf_total:{t:"FCF (total)",b:"Enter annual total company FCF. Use M/B unit selector to avoid typing zeros."},
        shares:{t:"Shares Outstanding",b:"Total shares outstanding (use M/B selector)."},
        bvps:{t:"BVPS",b:"Book value per share. Key input for banks/insurers."},
        payout:{t:"Payout ratio",b:"Percent of earnings paid out; the rest increases BVPS."},
        affo:{t:"AFFO per share",b:"Adjusted Funds From Operations per share (or FFO/AFFO)."},
        reit_note:{t:"Note",b:"Optional label only; does not affect calculations."},

        revenue_total:{t:"Revenue (total)",b:"Annual total revenue. Growth model projects revenue and converts it to FCF via margin."},
        fcf_margin:{t:"FCF margin",b:"Assumed long-run FCF margin (%) used in Growth model."},
        margin_ramp:{t:"Margin ramp years",b:"How many years it takes for margin to approach target margin."},
        norm_fcf:{t:"Normalized FCF",b:"Cycle-average FCF for cyclical businesses (e.g., 5–10y avg)."},
        dps:{t:"Dividend per share",b:"Annual dividend per share used in DDM."},
        div_g:{t:"Dividend growth",b:"Annual dividend growth used during projection years (then terminal growth applies)."},

        years:{t:"Projection years",b:"How many years to project cash flows / dividends."},
        disc:{t:"Discount rate",b:"Required return. Must be higher than terminal growth."},
        term:{t:"Terminal growth",b:"Long-run growth after projection. Keep conservative (typically 0–3%)."},

        bear:{t:"Bear",b:"Conservative scenario. For DCF models: growth %. For Financial: ROE %."},
        base:{t:"Base",b:"Realistic scenario. For DCF models: growth %. For Financial: ROE %."},
        bull:{t:"Bull",b:"Optimistic scenario. For DCF models: growth %. For Financial: ROE %."}
      }
    },

    cz: {
      sub: "Vzdělávací valuace • Nejde o investiční doporučení",
      langLbl: "Jazyk",
      modeLbl: "Mód",
      valTitle: "Výpočet férové ceny",
      valTag: "Modely + 3 scénáře",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "Jak vybrat model",
      guideTag: "Návod",

      introTitle: "Co tady počítáme?",
      introText: "Vybereš typ firmy (model) a spočítáš férovou cenu ve 3 scénářích. Výsledek je scénář, ne doporučení.",
      decimalTip: "Tip: Můžeš psát čísla s desetinnou tečkou nebo čárkou (např. 5.5 nebo 5,5). Mezery ignorujeme.",

      currLbl: "Měna",
      mosLbl: "Margin of Safety",

      modelTitle: "Vyber model",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Klasické firmy se stabilním FCF.",
      m_fin_t:"Finanční (RIM)",
      m_fin_d:"Banky/pojišťovny/fintech – BVPS + ROE scénáře.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REIT – AFFO na akcii místo FCF.",
      m_growth_t:"Růstová (bez FCF)",
      m_growth_d:"Revenue & margin → FCF → DCF.",
      m_cyc_t:"Cyklická",
      m_cyc_d:"Normalizované FCF přes cyklus.",
      m_util_t:"Utility (DDM)",
      m_util_d:"Dividendový model.",

      inputsMain:"Základní vstupy",
      tickerLbl:"Ticker",
      priceLbl:"Aktuální cena",

      fcfLbl:"Free Cash Flow (FCF) – celkem",
      fcfMini:"Roční FCF celé firmy. Použij jednotky M/B, ať nepíšeš nuly.",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Počet akcií v oběhu (použij M/B).",

      bvpsLbl:"Book Value / akcii (BVPS)",
      bvpsMini:"Klíčový vstup pro banky/pojišťovny.",
      payoutLbl:"Payout ratio (%)",
      payoutMini:"Kolik % zisku se vyplatí. Zbytek zvyšuje BVPS.",

      affoLbl:"AFFO / akcii",
      affoMini:"U REIT je AFFO/FFO často vhodnější než FCF.",
      reitNoteLbl:"Poznámka",

      revLbl:"Revenue – celkem",
      revMini:"Roční revenue. Projektuje se a převádí na FCF přes margin.",
      marginLbl:"FCF margin (%)",
      marginMini:"Předpoklad dlouhodobé FCF marže (%).",
      growthRampLbl:"Roky rampy marže",

      normFcfLbl:"Normalizované FCF – celkem",
      sharesGLbl:"Shares",
      sharesCLbl:"Shares",

      divLbl:"Dividenda na akcii (DPS)",
      divGrowLbl:"Růst dividendy (%)",

      yearsLbl:"Délka projekce (roky)",
      discLbl:"Diskontní sazba (%)",
      termLbl:"Terminální růst (%)",
      termMini:"Diskont musí být vyšší než terminál.",

      inputsScen:"Scénáře (ročně)",
      inputsScenText:"Quick používá Base a Bear/Bull dopočítá (±2). Advanced dovolí zadat vše ručně.",
      scenTipText:"Standard/REIT/Growth/Cyklická: růst %. Finanční: ROE %. Utility: růst dividendy %.",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base se zapnutým Margin of Safety. Range = Bear až Bull.",
      targetLbl:"Target cena",
      rangeLbl:"Rozmezí férové ceny",

      calc:"Spočítat",
      save:"Uložit do Watchlistu",
      demo:"Demo hodnoty",
      saveNote:"Uloží poslední výsledek (Bear/Base/Bull).",

      watchIntroTitle:"Uložené výpočty",
      watchIntroText:"Zde se ukládají vypočítané akcie. Můžeš mazat položky a exportovat tabulku.",
      watchFooter:"Pozn.: Watchlist je uložen lokálně v prohlížeči (localStorage).",
      empty:"Zatím nic uloženého.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Smazat",
      footer:"Vzdělávací nástroj • Nejde o investiční doporučení",

      th:{date:"Datum",ticker:"Ticker",price:"Cena",model:"Model",bear:"Bear",base:"Base",bull:"Bull",target:"Target",range:"Range",action:"Akce"},

      sanityTitle:"Kontrola:",
      sanityLow:"Výsledek je extrémně nízký. Zkontroluj model, jednotky (celkem vs na akcii) a počet akcií.",
      sanityHigh:"Výsledek je extrémně vysoký. Zkontroluj růst/diskont a zda firma není cyklická.",

      mosExplainHtml: `
        <strong>Margin of Safety (bezpečnostní rezerva)</strong> je ochranná sleva z Base férové ceny pro výpočet konzervativnější <em>Target ceny</em>.
        <ul>
          <li>Příklad: Base = 100 → MoS 20 % ⇒ Target = 80</li>
        </ul>
        MoS pomáhá započítat nejistotu a chyby v odhadech. <strong>Není to predikce ani záruka.</strong>
      `,

      guideHtml: `
        <h3>O aplikaci & Upozornění</h3>
        <p><strong>Pouze vzdělávací nástroj.</strong> Aplikace slouží pro vzdělávací a informační účely.</p>
        <ul>
          <li><strong>Nejde o finanční/investiční doporučení</strong> ani poradenství (finanční, právní, daňové).</li>
          <li>Nedává doporučení koupit/prodat. Výstupy jsou orientační dle vstupů uživatele.</li>
          <li>Investování je rizikové a můžeš přijít o část nebo celý kapitál.</li>
        </ul>

        <h3>Pro koho je aplikace?</h3>
        <ul>
          <li>Pro dlouhodobé investory, kteří se chtějí učit valuaci</li>
          <li>Pro studenty fundamentální analýzy</li>
          <li>Pro investory, kteří si staví vlastní předpoklady</li>
        </ul>

        <h3>Kde hledat data (vstupy)?</h3>
        <ul>
          <li><strong>Reporty firmy:</strong> výroční/kvartální zprávy, prezentace pro investory</li>
          <li><strong>Výkazy:</strong> Cash Flow (FCF), Výsledovka (revenue), Rozvaha (book value)</li>
          <li><strong>Tržní data:</strong> počet akcií a cena z ověřených finančních webů</li>
          <li><strong>REIT:</strong> AFFO/FFO bývá v earnings release / supplemental</li>
        </ul>

        <h3>Jak funguje 6 modelů</h3>
        <h4>1) Standard (FCF DCF)</h4>
        <p>Projektuje FCF celé firmy, diskontuje a přidá terminál. Na 1 akcii přepočítá přes Shares.</p>

        <h4>2) Finanční (RIM)</h4>
        <p>Reziduální model: hodnota = BVPS + PV(reziduálních zisků). Scénáře jsou ROE, payout zvyšuje BVPS.</p>

        <h4>3) REIT (AFFO)</h4>
        <p>DCF nad AFFO na akcii – pro REIT je to často lepší než FCF.</p>

        <h4>4) Růstová bez FCF</h4>
        <p>Projektuje revenue, převede je na FCF přes margin (s rampou) a provede DCF + přepočet na akcii.</p>

        <h4>5) Cyklická</h4>
        <p>Použije normalizované FCF (průměr přes cyklus) místo jednoho roku a pak DCF konzervativně.</p>

        <h4>6) Utility (DDM)</h4>
        <p>Dividendový model: diskontuje dividendy a terminální dividendovou hodnotu.</p>

        <p class="mini" style="margin-top:10px;opacity:.9">
          Pozn.: Zjednodušené edukativní modely. V praxi často řešíš i dluh/hotovost, reinvestice, diluci a citlivost.
        </p>
      `,

      helps:{
        ticker:{t:"Ticker",b:"Zkratka akcie (např. AAPL). Slouží pro přehled ve watchlistu."},
        price:{t:"Aktuální cena",b:"Tržní cena akcie. Podle ní počítáme % rozdíl vůči férové hodnotě."},
        mode:{t:"Mód",b:"Quick: zadáš jen Base; Bear/Bull se dopočítá (±2). Advanced: zadáš všechny 3 scénáře ručně."},
        currency:{t:"Měna",b:"Pouze formátování. Aplikace nepřepočítává FX kurzy."},
        mos:{t:"Margin of Safety",b:"Bezpečnostní sleva z Base férové ceny pro výpočet Target ceny."},

        fcf_total:{t:"FCF – celkem",b:"Roční FCF celé firmy. Použij jednotky M/B."},
        shares:{t:"Shares Outstanding",b:"Počet akcií v oběhu (použij M/B)."},
        bvps:{t:"BVPS",b:"Účetní hodnota na akcii. Klíčové u bank."},
        payout:{t:"Payout ratio",b:"Kolik % zisku se vyplatí. Zbytek zvyšuje BVPS."},
        affo:{t:"AFFO/akcii",b:"AFFO/FFO na akcii – vhodné pro REIT."},
        reit_note:{t:"Poznámka",b:"Jen popisek pro tebe, výpočet neovlivní."},

        revenue_total:{t:"Revenue",b:"Roční revenue. Růstový model projektuje revenue a převádí je na FCF přes margin."},
        fcf_margin:{t:"FCF margin",b:"Předpoklad dlouhodobé FCF marže (%)."},
        margin_ramp:{t:"Rampa marže",b:"Počet let, za které se margin přiblíží cílové hodnotě."},
        norm_fcf:{t:"Normalizované FCF",b:"Průměrné FCF přes cyklus (např. 5–10 let)."},
        dps:{t:"Dividenda na akcii",b:"Roční dividenda na akcii pro dividendový model."},
        div_g:{t:"Růst dividendy",b:"Roční růst dividendy v projekční části."},

        years:{t:"Délka projekce",b:"Počet let projekce."},
        disc:{t:"Diskont",b:"Požadovaný výnos. Musí být vyšší než terminál."},
        term:{t:"Terminál",b:"Dlouhodobý růst po projekci. Konzervativně 0–3 %."},

        bear:{t:"Bear",b:"Pesimistický scénář. U DCF je to růst %, u finančních je to ROE %."},
        base:{t:"Base",b:"Realistický scénář. U DCF je to růst %, u finančních je to ROE %."},
        bull:{t:"Bull",b:"Optimistický scénář. U DCF je to růst %, u finančních je to ROE %."}
      }
    }
  };

  const LS_KEY = "ea_watchlist_v3";
  </script><!-- WATCHLIST -->
      <div class="acc" id="acc_watch">
        <div class="head" data-acc="watch">
          <div class="title">
            <span id="ui_watchTitle">Watchlist</span>
            <span class="tag" id="ui_watchTag">Local storage</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="watchBody">
          <div class="card">
            <h3 id="ui_watchIntroTitle">Saved valuations</h3>
            <div class="muted" id="ui_watchIntroText">
              Saved tickers. You can delete rows and export the table.
            </div>

            <div class="btns" style="margin-top:10px;">
              <button class="secondary" id="btn_export_csv">Export CSV</button>
              <button class="secondary" id="btn_print_pdf">Print / PDF</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div style="overflow:auto;">
              <table id="watchTable">
                <thead>
                  <tr>
                    <th id="th_date">Date</th>
                    <th id="th_ticker">Ticker</th>
                    <th class="right" id="th_price">Price</th>
                    <th class="right" id="th_model">Model</th>
                    <th class="right" id="th_bear">Bear</th>
                    <th class="right" id="th_base">Base</th>
                    <th class="right" id="th_bull">Bull</th>
                    <th class="right nowrap" id="th_target">Target</th>
                    <th class="right nowrap" id="th_range">Range</th>
                    <th class="right" id="th_action">Action</th>
                  </tr>
                </thead>
                <tbody id="watchTbody">
                  <tr><td colspan="10" class="muted" id="watchEmpty">No saved items yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="footer" id="ui_watchFooter">
            Note: Watchlist is stored locally in your browser (localStorage).
          </div>
        </div>
      </div>

      <!-- GUIDE (3rd drawer) -->
      <div class="acc" id="acc_guide">
        <div class="head" data-acc="guide">
          <div class="title">
            <span id="ui_guideTitle">How to choose a model</span>
            <span class="tag" id="ui_guideTag">Guide</span>
          </div>
          <div class="chev">▼</div>
        </div>

        <div class="body" id="guideBody">
          <div class="card">
            <div class="muted" id="ui_guideHtml"></div>
          </div>
        </div>
      </div>

    </div><!-- /accordion -->

    <div class="footer" id="ui_footer">
      Educational tool • Not financial advice
    </div>
  </div><!-- /wrap -->

  <div class="toast" id="toast"></div>

  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div class="t" id="modalTitle">Info</div>
        <button class="xbtn" id="modalClose">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div><script>
  const TEXTS = {
    en: {
      sub: "Multi-Model Fair Value • Watchlist • Guide",
      langLbl: "Language",
      modeLbl: "Mode",
      valTitle: "Fair value",
      valTag: "Models + 3 scenarios",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "How to choose a model",
      guideTag: "Guide",

      introTitle: "What are we calculating?",
      introText: "Pick a company type (model) and compute fair value in 3 scenarios. Output is a scenario, not advice.",
      currLbl: "Currency",
      mosLbl: "Margin of Safety",
      decimalTip: "Tip: You can type decimals with dot or comma (e.g., 5.5 or 5,5). Spaces are ignored.",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Non-financials with stable positive FCF.",
      m_fin_t:"Financial (RIM)",
      m_fin_d:"Banks/insurers/fintech – value via BVPS and ROE/EPS.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REITs – AFFO per share instead of FCF.",
      m_growth_t:"Pre-FCF growth",
      m_growth_d:"Revenue/margin-based DCF (included).",
      m_cyc_t:"Cyclical",
      m_cyc_d:"Normalized cycle FCF (included).",
      m_util_t:"Utility (DDM)",
      m_util_d:"Dividend discount model (included).",

      inputsMain:"Core inputs",
      tickerLbl:"Ticker",
      priceLbl:"Current price",

      fcfLbl:"Free Cash Flow (total)",
      fcfMini:"Annual total FCF (ideally 3–5y avg).",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Used to convert firm value to per-share value.",

      bvpsLbl:"Book Value per Share (BVPS)",
      roeLbl:"ROE (%)",
      payoutLbl:"Payout ratio (%)",
      sharesFinLbl:"Shares (optional)",

      affoLbl:"AFFO per share",

      yearsLbl:"Projection years",
      discLbl:"Discount rate (%)",
      termLbl:"Terminal growth (%)",
      termMini:"Used for Standard/REIT/Growth/Cyclical. Utility uses dividend terminal growth.",

      inputsScen:"Scenarios (annual)",
      inputsScenText:"Quick uses Base and auto derives Bear/Bull (±2). Advanced lets you set all three.",
      scenTipText:"Standard/REIT/Growth/Cyclical: growth %. Financial: ROE scenario. Utility: dividend growth scenario.",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base with Margin of Safety. Range = Bear to Bull.",
      targetLbl:"Target price",
      rangeLbl:"Fair value range",

      calc:"Calculate",
      save:"Save to Watchlist",
      demo:"Demo values",
      saveNote:"Saves latest result (Bear/Base/Bull).",

      watchIntroTitle:"Saved valuations",
      watchIntroText:"Saved tickers. Delete rows and export the table.",
      watchFooter:"Note: Watchlist is stored locally in your browser (localStorage).",
      empty:"No saved items yet.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Delete",
      footer:"Educational tool • Not financial advice",

      th:{date:"Date",ticker:"Ticker",price:"Price",model:"Model",bear:"Bear",base:"Base",bull:"Bull",target:"Target",range:"Range",action:"Action"},

      sanityTitle:"Sanity check:",
      sanityLow:"Result looks extremely low. Check model, units and Shares.",
      sanityHigh:"Result looks extremely high. Check growth/discount and company type.",

      mosExplainHtml: `
        <strong>Margin of Safety (MoS)</strong> applies a safety discount to the Base fair value to form a more conservative <em>Target price</em>.
        <ul>
          <li>Example: Base = 100 → MoS 20% ⇒ Target = 80</li>
        </ul>
        MoS helps account for uncertainty and estimation errors. <strong>Not a prediction or guarantee.</strong>
      `,

      guideHtml: `
        <h3>About & Disclaimer</h3>
        <p><strong>Educational tool only.</strong> This app is for educational and informational purposes.</p>
        <ul>
          <li><strong>Not financial or investment advice.</strong> No financial, investment, legal, or tax advice is provided.</li>
          <li>No recommendations to buy/sell. Outputs are illustrative estimates based on user assumptions.</li>
          <li>Investing involves risk, including loss of capital.</li>
        </ul>

        <h3>Who is this app for?</h3>
        <ul>
          <li>Long-term investors learning valuation</li>
          <li>Students of fundamental analysis</li>
          <li>Self-directed investors building their own assumptions</li>
        </ul>

        <h3>Where to find input data?</h3>
        <ul>
          <li><strong>Company reports:</strong> annual/quarterly reports and investor presentations</li>
          <li><strong>Financial statements:</strong> Cash Flow (FCF), Income Statement (revenue), Balance Sheet (book value)</li>
          <li><strong>Market data:</strong> shares outstanding and price from reputable finance sites</li>
          <li><strong>REIT metrics:</strong> AFFO/FFO in REIT supplemental or earnings release</li>
        </ul>

        <h3>How the 6 valuation models work</h3>
        <h4>1) Standard (FCF DCF)</h4>
        <p>Projects company-level FCF for N years, discounts it, adds terminal value, converts to per-share via Shares Outstanding.</p>

        <h4>2) Financial (RIM)</h4>
        <p>Residual Income Model: value = BVPS + PV(residual income). Residual income depends on ROE vs required return.</p>

        <h4>3) REIT (AFFO DCF)</h4>
        <p>DCF using AFFO per share (often better than FCF for REITs).</p>

        <h4>4) Growth (Pre-FCF)</h4>
        <p>Projects revenue and converts to FCF using an assumed margin, then DCF.</p>

        <h4>5) Cyclical</h4>
        <p>Uses normalized (cycle-average) FCF to avoid peak/trough distortions.</p>

        <h4>6) Utility (DDM)</h4>
        <p>Dividend Discount Model: discounts dividends plus terminal dividend value.</p>

        <p class="mini" style="margin-top:10px;opacity:.9">
          Note: simplified educational models. Real valuation often includes debt, reinvestment, dilution and sensitivity analysis.
        </p>
      `,

      helps:{
        ticker:{t:"Ticker",b:"Stock symbol used for labeling the watchlist."},
        price:{t:"Current price",b:"Market price used to compute upside/downside vs fair value."},
        fcf_total:{t:"FCF (total)",b:"Enter annual total company FCF. The app divides by shares at the end."},
        shares:{t:"Shares Outstanding",b:"Total shares outstanding. Use unit selector to avoid typing many zeros."},
        bvps:{t:"BVPS",b:"Book value per share. Core input for financials."},
        roe:{t:"ROE",b:"Return on equity. Scenarios for financials typically use ROE (e.g., 8/12/15%)."},
        payout:{t:"Payout ratio",b:"Percent of earnings paid out; remainder increases book value."},
        shares_fin:{t:"Shares (optional)",b:"Not required for RIM; leave empty."},
        affo:{t:"AFFO per share",b:"AFFO (or FFO/AFFO) per share is preferred for REIT valuation."},
        years:{t:"Projection years",b:"How many years to project."},
        disc:{t:"Discount rate",b:"Required return/risk. Higher = more conservative. Must be > terminal growth."},
        term:{t:"Terminal growth",b:"Long-run growth after projection. Keep conservative (e.g., 2–3%)."},
        bear:{t:"Bear",b:"Conservative scenario."},
        base:{t:"Base",b:"Realistic scenario."},
        bull:{t:"Bull",b:"Optimistic scenario."},
        mos:{t:"Margin of Safety",b:"Safety discount applied to Base fair value to calculate Target price."}
      },

      guideHead1:"1) Model switching",
      guideText1:"Use the big buttons in the first drawer. Inputs and scenario meaning will change accordingly.",
      guideHead2:"2) Which model to use",
      guideHead3:"3) Sanity check",
      guideText3:""
    },

    cz: {
      sub: "Multi-Model férová cena • Watchlist • Návod",
      langLbl: "Jazyk",
      modeLbl: "Mód",
      valTitle: "Férová cena",
      valTag: "Modely + 3 scénáře",
      watchTitle: "Watchlist",
      watchTag: "Local storage",
      guideTitle: "Jak vybrat model",
      guideTag: "Návod",

      introTitle: "Co tady počítáme?",
      introText: "Vybereš typ firmy (model) a spočítáš férovou cenu ve 3 scénářích. Výsledek je scénář, ne doporučení.",
      currLbl: "Měna",
      mosLbl: "Margin of Safety",
      decimalTip: "Tip: Můžeš psát desetinnou tečkou i čárkou (např. 5.5 nebo 5,5). Mezery ignorujeme.",

      m_standard_t:"Standard (FCF DCF)",
      m_standard_d:"Klasické firmy se stabilním FCF.",
      m_fin_t:"Finanční (RIM)",
      m_fin_d:"Banky/pojišťovny/fintech – přes BVPS a ROE.",
      m_reit_t:"REIT (AFFO)",
      m_reit_d:"REIT – AFFO na akcii místo FCF.",
      m_growth_t:"Růstová bez FCF",
      m_growth_d:"Revenue/margin DCF (doplněno).",
      m_cyc_t:"Cyklická",
      m_cyc_d:"Normalizované FCF (doplněno).",
      m_util_t:"Utility (DDM)",
      m_util_d:"Dividendový model (doplněno).",

      inputsMain:"Základní vstupy",
      tickerLbl:"Ticker",
      priceLbl:"Aktuální cena",

      fcfLbl:"Free Cash Flow (FCF) – celkem",
      fcfMini:"Roční FCF firmy (ideálně průměr 3–5 let).",
      sharesLbl:"Shares Outstanding",
      sharesMini:"Počet akcií v oběhu pro přepočet na 1 akcii.",

      bvpsLbl:"Book Value / akcii (BVPS)",
      roeLbl:"ROE (%)",
      payoutLbl:"Payout ratio (%)",
      sharesFinLbl:"Shares (volitelné)",

      affoLbl:"AFFO / akcii",

      yearsLbl:"Délka projekce (roky)",
      discLbl:"Diskontní sazba (%)",
      termLbl:"Terminální růst (%)",
      termMini:"Použije se u Standard/REIT/Růstová/Cyklická. Utility používá dividendový terminální růst.",

      inputsScen:"Scénáře (ročně)",
      inputsScenText:"Quick používá jen Base a Bear/Bull dopočítá (±2). Advanced umožní zadat vše ručně.",
      scenTipText:"Standard/REIT/Růstová/Cyklická: růst %. Finanční: ROE scénář. Utility: růst dividend.",
      bearLbl:"Bear",
      baseLbl:"Base",
      bullLbl:"Bull",

      targetsTitle:"Target & Range",
      targetsText:"Target = Base se zapnutým Margin of Safety. Range = Bear až Bull.",
      targetLbl:"Target cena",
      rangeLbl:"Rozsah férové hodnoty",

      calc:"Calculate",
      save:"Uložit do Watchlistu",
      demo:"Demo hodnoty",
      saveNote:"Uloží se poslední výsledek (Bear/Base/Bull).",

      watchIntroTitle:"Uložené výpočty",
      watchIntroText:"Zde se ukládají vypočítané akcie. Můžeš mazat položky a exportovat tabulku.",
      watchFooter:"Pozn.: Watchlist je uložen lokálně v prohlížeči (localStorage).",
      empty:"Zatím nic uloženého.",
      exportCsv:"Export CSV",
      printPdf:"Print / PDF",
      del:"Smazat",
      footer:"Vzdělávací nástroj • Nejde o investiční doporučení",

      th:{date:"Datum",ticker:"Ticker",price:"Cena",model:"Model",bear:"Bear",base:"Base",bull:"Bull",target:"Target",range:"Range",action:"Akce"},

      sanityTitle:"Sanity check:",
      sanityLow:"Výsledek vychází extrémně nízko. Zkontroluj model, jednotky a Shares.",
      sanityHigh:"Výsledek vychází extrémně vysoko. Zkontroluj růst/diskont a typ firmy.",

      mosExplainHtml: `
        <strong>Margin of Safety (bezpečnostní rezerva)</strong> je ochranná sleva z férové ceny Base pro konzervativnější <em>Target cenu</em>.
        <ul>
          <li>Příklad: Base = 100 → MoS 20 % ⇒ Target = 80</li>
        </ul>
        Pomáhá započítat nejistotu a chyby v odhadech. <strong>Není to predikce ani záruka.</strong>
      `,

      guideHtml: `
        <h3>O aplikaci & Upozornění</h3>
        <p><strong>Pouze vzdělávací nástroj.</strong> Slouží pro vzdělávání a informaci.</p>
        <ul>
          <li><strong>Nejde o finanční/investiční poradenství</strong> ani právní/daňové rady.</li>
          <li>Nedává doporučení koupit/prodat. Výstupy jsou orientační dle vstupů uživatele.</li>
          <li>Investování je rizikové a můžeš přijít o kapitál.</li>
        </ul>

        <h3>Pro koho je aplikace?</h3>
        <ul>
          <li>Dlouhodobí investoři, kteří se učí valuaci</li>
          <li>Studenti fundamentální analýzy</li>
          <li>Investoři, kteří si staví vlastní předpoklady</li>
        </ul>

        <h3>Kde hledat data?</h3>
        <ul>
          <li><strong>Reporty firmy:</strong> výroční/kvartální zprávy a prezentace</li>
          <li><strong>Výkazy:</strong> Cash Flow (FCF), Výsledovka (revenue), Rozvaha (book value)</li>
          <li><strong>Tržní data:</strong> cena a počet akcií z ověřených webů</li>
          <li><strong>REIT:</strong> AFFO/FFO v earnings release / supplemental</li>
        </ul>

        <h3>Jak funguje 6 modelů</h3>
        <h4>1) Standard (FCF DCF)</h4>
        <p>Projektuje FCF celé firmy, diskontuje a přepočte na akcii přes Shares.</p>

        <h4>2) Finanční (RIM)</h4>
        <p>Reziduální model: BVPS + PV(reziduálních zisků). Hodí se pro banky/pojišťovny.</p>

        <h4>3) REIT (AFFO DCF)</h4>
        <p>DCF nad AFFO na akcii – pro REIT často vhodnější než FCF.</p>

        <h4>4) Růstová bez FCF</h4>
        <p>Projektuje revenue a převádí na FCF přes margin, pak DCF.</p>

        <h4>5) Cyklická</h4>
        <p>Použije normalizované FCF (průměr přes cyklus), aby výsledek nezkreslil peak/trough.</p>

        <h4>6) Utility (DDM)</h4>
        <p>Dividendový model – diskontuje dividendy a terminál.</p>
      `,

      helps:{
        ticker:{t:"Ticker",b:"Zkratka akcie (např. AAPL) pro přehled ve watchlistu."},
        price:{t:"Aktuální cena",b:"Tržní cena pro výpočet % rozdílu vůči férové hodnotě."},
        fcf_total:{t:"FCF – celkem",b:"Zadej roční FCF celé firmy. Aplikace dělí počtem akcií až na konci."},
        shares:{t:"Shares",b:"Počet akcií v oběhu. Použij jednotky, ať nemusíš psát mnoho nul."},
        bvps:{t:"BVPS",b:"Účetní hodnota na akcii. Klíčové pro banky."},
        roe:{t:"ROE",b:"Návratnost vlastního kapitálu. U finančních firem jsou scénáře často ROE."},
        payout:{t:"Payout",b:"Kolik % zisku se vyplatí. Zbytek zvyšuje BVPS."},
        affo:{t:"AFFO/akcii",b:"AFFO na akcii je u REIT často lepší než FCF."},
        years:{t:"Délka projekce",b:"Počet let projekce (typicky 10)."},
        disc:{t:"Diskont",b:"Požadovaný výnos/riziko. Musí být > terminální růst."},
        term:{t:"Terminál",b:"Dlouhodobý růst po projekci (často 2–3 %)."},
        mos:{t:"Margin of Safety",b:"Bezpečnostní sleva z Base férové ceny pro výpočet Target ceny."}
      },

      guideHead1:"1) Přepínání modelu",
      guideText1:"Přepínáš přes velká tlačítka. Změní se vstupy i význam scénářů.",
      guideHead2:"2) Kdy použít který model",
      guideHead3:"3) Rychlá kontrola výsledku",
      guideText3:""
    }
  };

  const LS_KEY = "ea_watchlist_v3";
  </script><script>
  // ---------------- STATE + HELPERS ----------------
  const state = {
    lang: "en",          // EN as default
    mode: "quick",
    currency: "USD",
    mos: "off",
    model: "standard",
    lastResult: null
  };

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display="none", 2200);
  }

  function parseNum(v){
    if (v === null || v === undefined) return NaN;
    const s = String(v).trim().replace(/\s+/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtMoney(n, cur){
    if (!Number.isFinite(n)) return "—";
    try{
      return new Intl.NumberFormat(state.lang === "cz" ? "cs-CZ" : "en-US", {
        style:"currency", currency: cur, maximumFractionDigits: 2
      }).format(n);
    }catch{
      return `${n.toFixed(2)} ${cur}`;
    }
  }

  function fmtPct(n){
    if (!Number.isFinite(n)) return "—";
    const sign = n > 0 ? "+" : "";
    return `${sign}${n.toFixed(1)}%`;
  }

  function openModal(title, body){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = body;
    $("modalBackdrop").style.display = "flex";
  }
  function closeModal(){
    $("modalBackdrop").style.display = "none";
  }

  // Units (avoid typing many zeros)
  function unitMul(selId){
    const el = $(selId);
    const v = el ? Number(el.value) : 1;
    return Number.isFinite(v) ? v : 1;
  }
  function readWithUnit(inputId, unitSelId){
    const n = parseNum($(inputId)?.value);
    if (!Number.isFinite(n)) return NaN;
    return n * unitMul(unitSelId);
  }

  // ---------------- ACCORDION ----------------
  document.querySelectorAll(".acc .head").forEach(h=>{
    h.addEventListener("click", ()=>{
      h.closest(".acc").classList.toggle("open");
    });
  });

  $("modalBackdrop").addEventListener("click", (e)=>{
    if (e.target === $("modalBackdrop")) closeModal();
  });
  $("modalClose").addEventListener("click", closeModal);

  // ---------------- MODELS (VALUATION) ----------------

  // 1) Standard firm-level DCF -> per share
  function modelStandardDCF({ fcfTotal, shares, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(fcfTotal > 0) || !(shares > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let f = fcfTotal;

    for (let y=1; y<=years; y++){
      f = f * (1 + g);
      pv += f / Math.pow(1 + r, y);
    }

    const terminal = (f * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return (pv + pvTerminal) / shares;
  }

  // 2) REIT AFFO per share DCF
  function modelReitAffo({ affoPerShare, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(affoPerShare > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let a = affoPerShare;

    for (let y=1; y<=years; y++){
      a = a * (1 + g);
      pv += a / Math.pow(1 + r, y);
    }

    const terminal = (a * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);
    return pv + pvTerminal;
  }

  // 3) Financial RIM (terminal RI=0 conservative)
  function modelFinancialRIM({ bvps, roePct, payoutPct, years, discPct }){
    const r = discPct / 100;
    const roe = roePct / 100;
    const payout = Math.min(Math.max(payoutPct / 100, 0), 1);

    if (!(bvps > 0) || !(years >= 1) || !(r > 0)) return NaN;

    let BV = bvps;
    let pvRI = 0;

    for (let y=1; y<=years; y++){
      const EPS = roe * BV;
      const RI = EPS - r * BV;
      pvRI += RI / Math.pow(1 + r, y);
      BV = BV + EPS * (1 - payout);
    }
    return bvps + pvRI;
  }

  // 4) Growth (Pre-FCF): revenue -> FCF margin -> DCF per share
  // Inputs used:
  //   rev0 (annual revenue, total), marginPct (long-run FCF margin), shares
  function modelGrowthPreFCF({ rev0, marginPct, shares, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;
    const m = marginPct / 100;

    if (!(rev0 > 0) || !(shares > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;
    if (!(m > 0) || m > 1) return NaN;

    let pv = 0;
    let rev = rev0;

    for (let y=1; y<=years; y++){
      rev = rev * (1 + g);
      const fcf = rev * m;
      pv += fcf / Math.pow(1 + r, y);
    }

    const fcfN = (rev * (1 + gT)) * m;
    const terminal = fcfN / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return (pv + pvTerminal) / shares;
  }

  // 5) Cyclical: normalized FCF total -> DCF per share (use lower growth typically)
  function modelCyclical({ normFcfTotal, shares, years, discPct, termPct, growthPct }){
    // identical math to standard; semantic difference is input = normalized FCF
    return modelStandardDCF({
      fcfTotal: normFcfTotal,
      shares, years, discPct, termPct, growthPct
    });
  }

  // 6) Utility DDM: dividend per share, dividend growth, discount, terminal dividend growth
  function modelUtilityDDM({ divPerShare, years, discPct, termPct, growthPct }){
    const r = discPct / 100;
    const gT = termPct / 100;
    const g = growthPct / 100;

    if (!(divPerShare > 0) || !(years >= 1) || !(r > 0)) return NaN;
    if (r <= gT) return NaN;

    let pv = 0;
    let d = divPerShare;

    for (let y=1; y<=years; y++){
      d = d * (1 + g);
      pv += d / Math.pow(1 + r, y);
    }

    const terminal = (d * (1 + gT)) / (r - gT);
    const pvTerminal = terminal / Math.pow(1 + r, years);

    return pv + pvTerminal;
  }

  // ---------------- UI: MODEL SWITCH ----------------
  function setModel(m){
    state.model = m;

    document.querySelectorAll(".mBtn").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-model") === m);
    });

    // sections visibility
    $("sec_standard").style.display  = (m === "standard") ? "" : "none";
    $("sec_financial").style.display = (m === "financial") ? "" : "none";
    $("sec_reit").style.display      = (m === "reit") ? "" : "none";
    $("sec_growth").style.display    = (m === "growth") ? "" : "none";
    $("sec_cyclical").style.display  = (m === "cyclical") ? "" : "none";
    $("sec_utility").style.display   = (m === "utility") ? "" : "none";

    bindHintTitles();
  }

  document.querySelectorAll(".mBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      setModel(b.getAttribute("data-model"));
    });
  });

  // ---------------- i18n APPLY ----------------
  function applyLang(){
    const t = TEXTS[state.lang];

    $("ui_sub").textContent = t.sub;
    $("ui_langLbl").textContent = t.langLbl;
    $("ui_modeLbl").textContent = t.modeLbl;

    $("ui_valTitle").textContent = t.valTitle;
    $("ui_valTag").textContent = t.valTag;

    $("ui_watchTitle").textContent = t.watchTitle;
    $("ui_watchTag").textContent = t.watchTag;

    $("ui_guideTitle").textContent = t.guideTitle;
    $("ui_guideTag").textContent = t.guideTag;

    $("ui_introTitle").textContent = t.introTitle;
    $("ui_introText").textContent = t.introText;
    $("ui_currLbl").textContent = t.currLbl;
    $("ui_mosLbl").textContent = t.mosLbl;
    $("ui_decimalTip").textContent = t.decimalTip;

    $("ui_m_standard_t").textContent = t.m_standard_t;
    $("ui_m_standard_d").textContent = t.m_standard_d;
    $("ui_m_fin_t").textContent = t.m_fin_t;
    $("ui_m_fin_d").textContent = t.m_fin_d;
    $("ui_m_reit_t").textContent = t.m_reit_t;
    $("ui_m_reit_d").textContent = t.m_reit_d;
    $("ui_m_growth_t").textContent = t.m_growth_t;
    $("ui_m_growth_d").textContent = t.m_growth_d;
    $("ui_m_cyc_t").textContent = t.m_cyc_t;
    $("ui_m_cyc_d").textContent = t.m_cyc_d;
    $("ui_m_util_t").textContent = t.m_util_t;
    $("ui_m_util_d").textContent = t.m_util_d;

    $("ui_inputsMain").textContent = t.inputsMain;
    $("ui_tickerLbl").textContent = t.tickerLbl;
    $("ui_priceLbl").textContent = t.priceLbl;

    $("ui_fcfLbl").textContent = t.fcfLbl;
    $("ui_fcfMini").textContent = t.fcfMini;
    $("ui_sharesLbl").textContent = t.sharesLbl;
    $("ui_sharesMini").textContent = t.sharesMini;

    $("ui_bvpsLbl").textContent = t.bvpsLbl;
    $("ui_roeLbl").textContent = t.roeLbl;
    $("ui_payoutLbl").textContent = t.payoutLbl;
    $("ui_sharesFinLbl").textContent = t.sharesFinLbl;

    $("ui_affoLbl").textContent = t.affoLbl;

    $("ui_yearsLbl").textContent = t.yearsLbl;
    $("ui_discLbl").textContent = t.discLbl;
    $("ui_termLbl").textContent = t.termLbl;
    $("ui_termMini").textContent = t.termMini;

    $("ui_inputsScen").textContent = t.inputsScen;
    $("ui_inputsScenText").textContent = t.inputsScenText;
    $("ui_scenTipText").textContent = t.scenTipText;

    $("ui_bearLbl").textContent = t.bearLbl;
    $("ui_baseLbl").textContent = t.baseLbl;
    $("ui_bullLbl").textContent = t.bullLbl;

    $("ui_targetsTitle").textContent = t.targetsTitle;
    $("ui_targetsText").textContent = t.targetsText;
    $("ui_targetLbl").textContent = t.targetLbl;
    $("ui_rangeLbl").textContent = t.rangeLbl;

    $("btn_calc").textContent = t.calc;
    $("btn_save").textContent = t.save;
    $("btn_fillDemo").textContent = t.demo;
    $("ui_saveNote").textContent = t.saveNote;

    $("ui_watchIntroTitle").textContent = t.watchIntroTitle;
    $("ui_watchIntroText").textContent = t.watchIntroText;
    $("btn_export_csv").textContent = t.exportCsv;
    $("btn_print_pdf").textContent = t.printPdf;
    $("ui_watchFooter").textContent = t.watchFooter;

    $("th_date").textContent = t.th.date;
    $("th_ticker").textContent = t.th.ticker;
    $("th_price").textContent = t.th.price;
    $("th_model").textContent = t.th.model;
    $("th_bear").textContent = t.th.bear;
    $("th_base").textContent = t.th.base;
    $("th_bull").textContent = t.th.bull;
    $("th_target").textContent = t.th.target;
    $("th_range").textContent = t.th.range;
    $("th_action").textContent = t.th.action;

    if ($("ui_guideHtml")) $("ui_guideHtml").innerHTML = t.guideHtml || "";

    $("ui_footer").textContent = t.footer;

    renderWatchlist();
    bindHintTitles();
  }

  function applyMode(){
    const isQuick = state.mode === "quick";
    $("in_bear").disabled = isQuick;
    $("in_bull").disabled = isQuick;
    $("in_bear").style.opacity = isQuick ? 0.65 : 1;
    $("in_bull").style.opacity = isQuick ? 0.65 : 1;
  }

  $("langSel").addEventListener("change", ()=>{
    state.lang = $("langSel").value;
    applyLang();
  });

  $("modeSel").addEventListener("change", ()=>{
    state.mode = $("modeSel").value;
    applyMode();
    if (state.mode === "quick"){
      const base = parseNum($("in_base").value);
      if (Number.isFinite(base)){
        $("in_bear").value = String(Math.max(base - 2, -50));
        $("in_bull").value = String(base + 2);
      }
    }
  });

  $("curSel").addEventListener("change", ()=>{
    state.currency = $("curSel").value;
    if (state.lastResult) paintResults(state.lastResult);
    renderWatchlist();
  });

  $("mosSel").addEventListener("change", ()=>{
    state.mos = $("mosSel").value;
    if (state.lastResult) paintResults(state.lastResult);
  });

  function bindHintTitles(){
    document.querySelectorAll(".hint").forEach(h=>{
      h.onmouseenter = null;
      h.onclick = null;

      h.addEventListener("click", ()=>{
        const key = h.getAttribute("data-help");
        const help = TEXTS[state.lang].helps[key];
        if (!help) return;

        // special: MoS explanation under row if exists
        if (key === "mos" && $("mosExplainBox") && $("mosExplainText")){
          const box = $("mosExplainBox");
          const t = TEXTS[state.lang];
          $("mosExplainText").innerHTML = t.mosExplainHtml || help.b;
          box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
          return;
        }

        openModal(help.t, `<div style="color:rgba(255,255,255,.92)">${help.b}</div>`);
      });

      h.addEventListener("mouseenter", ()=>{
        if (state.mode !== "quick") return;
        const key = h.getAttribute("data-help");
        const help = TEXTS[state.lang].helps[key];
        if (!help) return;
        h.setAttribute("title", help.b);
      });
    });
  }

  <script>
/* ================================
   COMPUTE + RESULTS + WATCHLIST
   SAFE FULL BLOCK (REPLACE BOTTOM)
================================ */

function computeAll(){
  const t = TEXTS[state.lang];

  const ticker = String($("in_ticker").value || "").trim().toUpperCase();
  const price = parseNum($("in_price").value);
  const years = Math.round(parseNum($("in_years").value));
  const disc  = parseNum($("in_disc").value);
  const term  = parseNum($("in_term").value);

  let base = parseNum($("in_base").value);
  let bear = parseNum($("in_bear").value);
  let bull = parseNum($("in_bull").value);

  if (!Number.isFinite(base)) base = 5;

  if (state.mode === "quick"){
    bear = base - 2;
    bull = base + 2;
    $("in_bear").value = String(Math.max(bear, -50));
    $("in_bull").value = String(bull);
  }

  const errors = [];
  if (!ticker) errors.push("Ticker");
  if (!Number.isFinite(price) || price <= 0) errors.push("Price");
  if (!Number.isFinite(years) || years < 1) errors.push("Years");
  if (!Number.isFinite(disc) || disc <= 0) errors.push("Discount");

  let vBear = NaN, vBase = NaN, vBull = NaN;

  /* ---------- STANDARD (FCF DCF) ---------- */
  if (state.model === "standard"){
    const fcf = parseNum($("in_fcf").value);
    const shares = parseNum($("in_shares").value);

    if (!(fcf > 0)) errors.push("FCF");
    if (!(shares > 0)) errors.push("Shares");

    if (!errors.length){
      vBear = modelStandardDCF({ fcfTotal:fcf, shares, years, discPct:disc, termPct:term, growthPct:bear });
      vBase = modelStandardDCF({ fcfTotal:fcf, shares, years, discPct:disc, termPct:term, growthPct:base });
      vBull = modelStandardDCF({ fcfTotal:fcf, shares, years, discPct:disc, termPct:term, growthPct:bull });
    }
  }

  /* ---------- FINANCIAL (RIM) ---------- */
  if (state.model === "financial"){
    const bvps = parseNum($("in_bvps").value);
    const payout = parseNum($("in_payout").value);

    if (!(bvps > 0)) errors.push("BVPS");
    if (!(payout >= 0 && payout <= 100)) errors.push("Payout");

    if (!errors.length){
      vBear = modelFinancialRIM({ bvps, roePct:bear, payoutPct:payout, years, discPct:disc });
      vBase = modelFinancialRIM({ bvps, roePct:base, payoutPct:payout, years, discPct:disc });
      vBull = modelFinancialRIM({ bvps, roePct:bull, payoutPct:payout, years, discPct:disc });
    }
  }

  /* ---------- REIT (AFFO) ---------- */
  if (state.model === "reit"){
    const affo = parseNum($("in_affo").value);
    if (!(affo > 0)) errors.push("AFFO");

    if (!errors.length){
      vBear = modelReitAffo({ affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:bear });
      vBase = modelReitAffo({ affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:base });
      vBull = modelReitAffo({ affoPerShare:affo, years, discPct:disc, termPct:term, growthPct:bull });
    }
  }

  if (errors.length){
    toast(state.lang === "cz"
      ? "Chybí / neplatné: " + errors.join(", ")
      : "Missing / invalid: " + errors.join(", ")
    );
    return null;
  }

  if (![vBear, vBase, vBull].every(Number.isFinite)){
    toast(state.lang === "cz"
      ? "Výpočet selhal – zkontroluj vstupy."
      : "Calculation failed – check inputs."
    );
    return null;
  }

  return {
    id: crypto.randomUUID(),
    dt: new Date().toISOString(),
    ticker,
    currency: state.currency,
    model: state.model,
    inputs: { price },
    values: { bear:vBear, base:vBase, bull:vBull }
  };
}

/* ---------- PAINT RESULTS ---------- */
function paintResults(res){
  const cur = res.currency;
  const price = res.inputs.price;

  $("r_bear").textContent = fmtMoney(res.values.bear, cur);
  $("r_base").textContent = fmtMoney(res.values.base, cur);
  $("r_bull").textContent = fmtMoney(res.values.bull, cur);

  $("r_bear_pct").textContent = fmtPct((res.values.bear/price-1)*100);
  $("r_base_pct").textContent = fmtPct((res.values.base/price-1)*100);
  $("r_bull_pct").textContent = fmtPct((res.values.bull/price-1)*100);

  const mos = state.mos === "off" ? 0 : parseInt(state.mos,10)/100;
  $("out_target").value = fmtMoney(res.values.base * (1-mos), cur);
  $("out_range").value =
    `${fmtMoney(res.values.bear,cur)} – ${fmtMoney(res.values.bull,cur)}`;

  state.lastResult = res;
}

/* ---------- BUTTONS ---------- */
$("btn_calc").onclick = ()=>{
  const res = computeAll();
  if (res) paintResults(res);
};

$("btn_fillDemo").onclick = ()=>{
  $("in_ticker").value = "DEMO";
  $("in_price").value = "100";
  $("in_years").value = "10";
  $("in_disc").value = "9";
  $("in_term").value = "2.5";
  $("in_base").value = "6";
  toast(state.lang==="cz" ? "Demo vyplněno" : "Demo filled");
};

/* ---------- INIT ---------- */
(function init(){
  applyMode();
  applyLang();
  bindHintTitles();
  setModel("standard");
})();
</script>

</body>
</html>



  

  

    
    

    

    


  
    
    
    
      
    
        

      
          
  

    



    





  
  


  





        


        



  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





