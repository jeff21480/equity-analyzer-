<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#090a16" />
  <title>Equity Analyzer</title>
  <style>
    :root{
      --bg0:#060711;
      --bg1:#090a16;
      --card:#0e1030;
      --card2:#0b0d25;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.16);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.66);
      --mut2:rgba(255,255,255,.52);

      --p:#7b5cff;      /* purple */
      --b:#2bc5ff;      /* cyan */
      --g:#00e1a4;      /* mint */
      --w:#ffb020;
      --r:#ff4d7d;

      --shadow: 0 18px 45px rgba(0,0,0,.52);
      --radius: 18px;
      --radius2: 24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(123,92,255,.22), transparent 60%),
        radial-gradient(1100px 700px at 85% 25%, rgba(43,197,255,.18), transparent 62%),
        radial-gradient(900px 600px at 60% 92%, rgba(0,225,164,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      width:min(1100px, 94vw);
      margin: 18px auto 70px;
    }

    .top{
      position:sticky;
      top:10px;
      z-index:30;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(10,12,26,.72);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width: 250px;
    }
    .logo{
      width:44px;height:44px;border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, var(--p), var(--b));
      box-shadow: 0 18px 35px rgba(123,92,255,.22);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size:20px;
      line-height:1.05;
      letter-spacing:.3px;
    }
    .brand .sub{
      margin-top:3px;
      font-size:12px;
      color:var(--mut);
    }

    .rightTools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .seg{
      display:flex; overflow:hidden;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .seg button{
      border:0; background:transparent; color:var(--mut);
      padding:10px 12px; cursor:pointer; font-weight:800;
      min-width:56px;
    }
    .seg button.active{
      background: rgba(255,255,255,.08);
      color: var(--txt);
    }

    .btn{
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, var(--p), var(--b));
      box-shadow: 0 16px 34px rgba(123,92,255,.20);
    }
    .btn.danger{
      border:1px solid rgba(255,77,125,.35);
      background: rgba(255,77,125,.10);
    }

    .tabs{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 760px){
      .tabs{grid-template-columns:1fr}
    }
    .tab{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding: 14px 14px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      position:relative;
      overflow:hidden;
      min-height: 80px;
    }
    .tab:hover{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18)}
    .tab:active{transform: translateY(1px)}
    .tab.active{
      background:
        radial-gradient(900px 220px at 20% 10%, rgba(123,92,255,.22), transparent 60%),
        radial-gradient(700px 200px at 90% 40%, rgba(43,197,255,.16), transparent 60%),
        rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 16px 40px rgba(0,0,0,.38);
    }
    .tab h3{margin:0;font-size:15px}
    .tab p{margin:6px 0 0;font-size:12px;color:var(--mut);line-height:1.35}

    .panel{
      margin-top: 12px;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .pHead{
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .pHead b{font-size:15px}
    .pHead span{font-size:12px;color:var(--mut)}
    .pBody{padding: 14px 16px 16px}

    .grid{
      display:grid;
      grid-template-columns: 1.18fr .82fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(14,16,48,.62);
      border-radius: var(--radius);
      padding: 14px;
    }
    .card.soft{background: rgba(11,13,37,.52)}
    .card h4{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.25px;
      color: rgba(255,255,255,.88);
      display:flex; gap:8px; align-items:center;
    }
    .mut{color:var(--mut)}
    .mut2{color:var(--mut2)}
    .mono{font-family:var(--mono)}

    .row{
      display:grid;
      grid-template-columns: 1fr 160px;
      gap: 10px;
      margin-bottom: 10px;
      align-items:end;
    }
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--mut);margin:0 0 6px}
    .field{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      padding: 11px 12px;
      border-radius: 14px;
      outline:none;
      transition: border-color .15s ease, background .15s ease;
    }
    .field:focus{border-color: rgba(43,197,255,.40); background: rgba(0,0,0,.24)}
    .unit{
      display:inline-flex;align-items:center;justify-content:center;
      padding: 9px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--mut2);
      font-size: 11px;
      font-family: var(--mono);
      white-space:nowrap;
    }
    .help{
      font-size:12px;
      color: var(--mut2);
      line-height:1.35;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--mut);
      font-size: 12px;
    }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 10px;
    }
    .btnRow .L, .btnRow .R{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){ .kpi{grid-template-columns:1fr} }
    .big{
      font-size: 26px;
      font-weight: 950;
      letter-spacing:.2px;
    }

    .tableWrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;background: rgba(0,0,0,.14)}
    th,td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{color:var(--mut);font-weight:900}
    tr:last-child td{border-bottom:0}

    .toast{
      position:fixed; left:50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(10,12,26,.88);
      border:1px solid rgba(255,255,255,.14);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      z-index:999;
      max-width: 94vw;
      backdrop-filter: blur(10px);
      font-size: 13px;
    }

    .badge{
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-family: var(--mono);
      font-size: 12px;
    }
    .badge.good{border-color: rgba(0,225,164,.35); background: rgba(0,225,164,.10)}
    .badge.warn{border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10)}
    .badge.bad{border-color: rgba(255,77,125,.35); background: rgba(255,77,125,.10)}

    .divider{height:1px;background: rgba(255,255,255,.08); margin: 12px 0}

    .footerNote{
      margin-top: 12px;
      color: var(--mut2);
      font-size:12px;
      line-height:1.45;
    }
  </style>
</head><body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="t_title">Equity Analyzer</h1>
          <div class="sub" id="t_sub">DCF fair value • Watchlist • Education</div>
        </div>
      </div>

      <div class="rightTools">
        <div class="seg" aria-label="Language">
          <button id="btnEN" type="button" class="active">EN</button>
          <button id="btnCZ" type="button">CZ</button>
        </div>
        <button class="btn" id="btnDemo" type="button">Demo values</button>
        <button class="btn primary" id="btnSaveTop" type="button">Save to Watchlist</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabModel">
        <h3 id="t_tab1">DCF Model</h3>
        <p id="t_tab1s">Universal DCF for many company types (3 scenarios).</p>
      </div>
      <div class="tab" id="tabWatch">
        <h3 id="t_tab2">Watchlist</h3>
        <p id="t_tab2s">Saved calculations on this device (localStorage).</p>
      </div>
      <div class="tab" id="tabAbout">
        <h3 id="t_tab3">About</h3>
        <p id="t_tab3s">Educational app • Not financial advice.</p>
      </div>
    </div>

    <!-- PANEL 1: MODEL -->
    <section class="panel" id="panelModel">
      <div class="pHead">
        <div>
          <b id="t_p1h">DCF Model (3 scenarios)</b><br/>
          <span id="t_p1s">Choose company type + input method, then calculate Bear/Base/Bull.</span>
        </div>
        <div class="badge" id="badgeMode">MODE: Quick</div>
      </div>
      <div class="pBody">
        <div class="grid">

    <!-- LEFT: Inputs -->
          <div class="card">
            <h4 id="t_inH">Inputs</h4>

            <div class="row">
              <div>
                <label id="t_tickerL" for="in_ticker">Ticker / Name</label>
                <input class="field" id="in_ticker" placeholder="e.g., AAPL / SOFI / PLTR" />
                <div class="help" id="t_tickerH">Just for your notes (watchlist).</div>
              </div>
              <div>
                <label id="t_curL" for="in_cur">Currency</label>
                <select class="field" id="in_cur">
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="CZK">CZK</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label id="t_typeL" for="in_type">Company type</label>
                <select class="field" id="in_type">
                  <option value="growth">Growth / Tech</option>
                  <option value="mature">Mature / Blue-chip</option>
                  <option value="cyclical">Cyclical / Industrials</option>
                  <option value="reits">REIT / Yield</option>
                  <option value="financial">Financial (use conservative)</option>
                </select>
                <div class="help" id="t_typeH">Sets sensible defaults + warnings (you can override).</div>
              </div>
              <div>
                <label id="t_modeL" for="in_mode">Mode</label>
                <select class="field" id="in_mode">
                  <option value="quick">Quick (Bear/Bull auto)</option>
                  <option value="advanced">Advanced (edit all scenarios)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label id="t_priceL" for="in_price">Current price (optional)</label>
                <input class="field num" id="in_price" placeholder="e.g., 180.50" />
                <div class="help" id="t_priceH">Used for upside & margin of safety.</div>
              </div>
              <div>
                <label id="t_mosL" for="in_mos">Margin of Safety</label>
                <select class="field" id="in_mos">
                  <option value="0">OFF</option>
                  <option value="10">10%</option>
                  <option value="20">20%</option>
                  <option value="30">30%</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card soft">
              <h4 id="t_methodH">DCF input method</h4>

              <div class="row">
                <div>
                  <label id="t_methodL" for="in_method">Method</label>
                  <select class="field" id="in_method">
                    <option value="fcf">Direct FCF (recommended)</option>
                    <option value="rev">Revenue × FCF margin</option>
                  </select>
                  <div class="help" id="t_methodHelp">
                    If you do not know FCF, approximate using Revenue and a realistic FCF margin.
                  </div>
                </div>
                <div>
                  <label id="t_yearsL" for="in_years">Projection (years)</label>
                  <input class="field num" id="in_years" value="10" />
                </div>
              </div>

              <!-- METHOD: FCF -->
              <div id="blk_fcf">
                <div class="row">
                  <div>
                    <label id="t_fcfL" for="in_fcf">FCF (TTM or avg 3–5y)</label>
                    <input class="field num" id="in_fcf" placeholder="e.g., 110000000000" />
                    <div class="help" id="t_fcfH">Annual free cash flow in selected currency.</div>
                  </div>
                  <div class="unit" id="u_fcf">currency / year</div>
                </div>
              </div>

              <!-- METHOD: Revenue × Margin -->
              <div id="blk_rev" style="display:none">
                <div class="row">
                  <div>
                    <label id="t_revL" for="in_rev">Revenue (annual)</label>
                    <input class="field num" id="in_rev" placeholder="e.g., 350000000000" />
                    <div class="help" id="t_revH">Annual revenue in selected currency.</div>
                  </div>
                  <div class="unit" id="u_rev">currency / year</div>
                </div>

                <div class="row">
                  <div>
                    <label id="t_margL" for="in_marg">FCF margin (base)</label>
                    <input class="field num" id="in_marg" placeholder="e.g., 18" />
                    <div class="help" id="t_margH">FCF = Revenue × Margin. Margin is %.</div>
                  </div>
                  <div class="unit">%</div>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card soft">
              <h4 id="t_capH">Capital structure</h4>

              <div class="row">
                <div>
                  <label id="t_shL" for="in_shares">Shares (diluted)</label>
                  <input class="field num" id="in_shares" placeholder="e.g., 15500000000" />
                  <div class="help" id="t_shH">Used to convert total equity value into per-share fair value.</div>
                </div>
                <div class="unit">shares</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_cashL" for="in_cash">Cash</label>
                  <input class="field num" id="in_cash" placeholder="e.g., 50000000000" />
                  <div class="help" id="t_cashH">Added to enterprise value.</div>
                </div>
                <div class="unit" id="u_cash">currency</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_debtL" for="in_debt">Debt</label>
                  <input class="field num" id="in_debt" placeholder="e.g., 70000000000" />
                  <div class="help" id="t_debtH">Subtracted to get equity value.</div>
                </div>
                <div class="unit" id="u_debt">currency</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card soft">
              <h4 id="t_assH">Assumptions (3 scenarios)</h4>

              <div class="row">
                <div>
                  <label id="t_drL" for="in_dr">Discount rate (base)</label>
                  <input class="field num" id="in_dr" value="9" />
                  <div class="help" id="t_drH">Higher risk → higher discount rate → lower fair value.</div>
                </div>
                <div class="unit">%</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_tgL" for="in_tg">Terminal growth</label>
                  <input class="field num" id="in_tg" value="2.5" />
                  <div class="help" id="t_tgH">Long-term growth after projection. Keep conservative.</div>
                </div>
                <div class="unit">%</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_gBaseL" for="in_g_base">Base growth</label>
                  <input class="field num" id="in_g_base" placeholder="e.g., 8" />
                  <div class="help" id="t_gBaseH">Annual FCF growth during projection.</div>
                </div>
                <div class="unit">%</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_gBearL" for="in_g_bear">Bear growth</label>
                  <input class="field num" id="in_g_bear" placeholder="auto" />
                  <div class="help" id="t_gBearH">Quick mode: Base − 2pp (editable in Advanced).</div>
                </div>
                <div class="unit">%</div>
              </div>

              <div class="row">
                <div>
                  <label id="t_gBullL" for="in_g_bull">Bull growth</label>
                  <input class="field num" id="in_g_bull" placeholder="auto" />
                  <div class="help" id="t_gBullH">Quick mode: Base + 2pp (editable in Advanced).</div>
                </div>
                <div class="unit">%</div>
              </div>
            </div>

            <div class="btnRow">
              <div class="L">
                <button class="btn" type="button" id="btnCalc">Calculate</button>
                <button class="btn" type="button" id="btnReset">Reset</button>
              </div>
              <div class="R">
                <button class="btn primary" type="button" id="btnSave">Save result</button>
              </div>
            </div>

            <div class="footerNote" id="t_tip">
              Tip: In Quick mode, you enter only Base growth. Bear/Bull are derived automatically.
            </div>
          </div>

          <!-- RIGHT: Outputs -->
          <div class="card">
            <h4 id="t_outH">Outputs</h4>

            <div class="kpi">
              <div class="card soft">
                <div class="mut" id="t_baseFV">Base fair value</div>
                <div class="big" id="out_base">—</div>
                <div class="help" id="out_base_sub">—</div>
              </div>

              <div class="card soft">
                <div class="mut" id="t_rangeFV">Range (Bear → Bull)</div>
                <div class="big" id="out_range">—</div>
                <div class="help" id="out_range_sub">—</div>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="card soft">
              <div class="mut" id="t_upside">Upside vs price</div>
              <div class="big" id="out_upside">—</div>
              <div class="help" id="out_upside_sub">Enter current price to see upside & MOS target.</div>
            </div>

            <div style="height:10px"></div>

            <div class="card soft">
              <div class="mut" id="t_details">Details</div>
              <div class="help" id="out_details">
                Fill inputs → Calculate.
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="card soft">
              <div class="mut" id="t_warn">Warnings / checks</div>
              <div class="help" id="out_warn">—</div>
            </div>
          </div>

        </div><!-- grid -->
      </div><!-- body -->
    </section><!-- panelModel --><!-- PANEL 2: WATCHLIST -->
    <section class="panel" id="panelWatch" style="display:none">
      <div class="pHead">
        <div>
          <b id="t_wH">Watchlist</b><br/>
          <span id="t_wS">Saved calculations on this device (localStorage).</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnExport" type="button">Export CSV</button>
          <button class="btn danger" id="btnClear" type="button">Clear all</button>
        </div>
      </div>
      <div class="pBody">
        <div class="card soft">
          <h4 id="t_wTableH">Saved items</h4>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th id="t_wDate">Date</th>
                  <th id="t_wTicker">Ticker</th>
                  <th id="t_wCur">Cur</th>
                  <th id="t_wPrice">Price</th>
                  <th id="t_wBear">Bear</th>
                  <th id="t_wBase">Base</th>
                  <th id="t_wBull">Bull</th>
                  <th id="t_wMos">MOS</th>
                  <th id="t_wAct">Actions</th>
                </tr>
              </thead>
              <tbody id="watchBody"></tbody>
            </table>
          </div>
          <div class="footerNote" id="t_wNote">
            Watchlist is stored locally in your browser. If you clear browser data or switch devices, items disappear.
          </div>
        </div>
      </div>
    </section>

    <!-- PANEL 3: ABOUT -->
    <section class="panel" id="panelAbout" style="display:none">
      <div class="pHead">
        <div>
          <b id="t_aH">About & Disclaimer</b><br/>
          <span id="t_aS">Educational app • not financial advice.</span>
        </div>
      </div>
      <div class="pBody">
        <div class="card">
          <h4 id="t_a1">What this app is</h4>
          <div class="mut" id="t_a1p">
            Equity Analyzer is a learning tool. It estimates fair value using DCF scenarios (Bear/Base/Bull).
          </div>

          <div class="divider"></div>

          <h4 id="t_a2">For whom it is useful</h4>
          <div class="mut" id="t_a2p">
            For investors who want to practice valuation thinking, compare scenarios, and store notes in a watchlist.
          </div>

          <div class="divider"></div>

          <h4 id="t_a3">Disclaimer (important)</h4>
          <div class="mut" id="t_a3p">
            This is NOT financial advice. Outputs depend heavily on assumptions. Use at your own risk.
          </div>

          <div class="divider"></div>

          <h4 id="t_a4">How to use</h4>
          <div class="mut" id="t_a4p">
            Choose company type → fill inputs → Calculate → Save to Watchlist. Try conservative assumptions.
          </div>
        </div>
      </div>
    </section>

  </div><!-- wrap -->

  <div class="toast" id="toast"></div>

  <!-- JS will be in Part 5 --><script>
    // ========= State / Constants =========
    const LS_KEY = "equity_analyzer_watchlist_v2";
    const state = {
      lang: "en",
      last: null
    };

    // ========= i18n =========
    const T = {
      en: {
        title:"Equity Analyzer",
        sub:"DCF fair value • Watchlist • Education",
        tab1:"DCF Model",
        tab1s:"Universal DCF for many company types (3 scenarios).",
        tab2:"Watchlist",
        tab2s:"Saved calculations on this device (localStorage).",
        tab3:"About",
        tab3s:"Educational app • Not financial advice.",
        p1h:"DCF Model (3 scenarios)",
        p1s:"Choose company type + input method, then calculate Bear/Base/Bull.",
        inH:"Inputs",
        tickerL:"Ticker / Name",
        tickerH:"Just for your notes (watchlist).",
        curL:"Currency",
        typeL:"Company type",
        typeH:"Sets sensible defaults + warnings (you can override).",
        modeL:"Mode",
        priceL:"Current price (optional)",
        priceH:"Used for upside & margin of safety.",
        mosL:"Margin of Safety",
        methodH:"DCF input method",
        methodL:"Method",
        methodHelp:"If you do not know FCF, approximate using Revenue and a realistic FCF margin.",
        yearsL:"Projection (years)",
        fcfL:"FCF (TTM or avg 3–5y)",
        fcfH:"Annual free cash flow in selected currency.",
        revL:"Revenue (annual)",
        revH:"Annual revenue in selected currency.",
        margL:"FCF margin (base)",
        margH:"FCF = Revenue × Margin. Margin is %.",
        capH:"Capital structure",
        shL:"Shares (diluted)",
        shH:"Convert equity value into fair value per share.",
        cashL:"Cash",
        cashH:"Added to enterprise value.",
        debtL:"Debt",
        debtH:"Subtracted to get equity value.",
        assH:"Assumptions (3 scenarios)",
        drL:"Discount rate (base)",
        drH:"Higher risk → higher discount rate → lower fair value.",
        tgL:"Terminal growth",
        tgH:"Long-term growth after projection. Keep conservative.",
        gBaseL:"Base growth",
        gBaseH:"Annual FCF growth during projection.",
        gBearL:"Bear growth",
        gBearH:"Quick mode: Base − 2pp (editable in Advanced).",
        gBullL:"Bull growth",
        gBullH:"Quick mode: Base + 2pp (editable in Advanced).",
        tip:"Tip: In Quick mode, you enter only Base growth. Bear/Bull are derived automatically.",
        calc:"Calculate",
        reset:"Reset",
        save:"Save result",
        demo:"Demo values",
        saveTop:"Save to Watchlist",
        outH:"Outputs",
        baseFV:"Base fair value",
        rangeFV:"Range (Bear → Bull)",
        upside:"Upside vs price",
        details:"Details",
        warn:"Warnings / checks",
        wH:"Watchlist",
        wS:"Saved calculations on this device (localStorage).",
        wTableH:"Saved items",
        wNote:"Watchlist is stored locally in your browser. If you clear browser data or switch devices, items disappear.",
        export:"Export CSV",
        clearAll:"Clear all",
        wDate:"Date",
        wTicker:"Ticker",
        wCur:"Cur",
        wPrice:"Price",
        wBear:"Bear",
        wBase:"Base",
        wBull:"Bull",
        wMos:"MOS",
        wAct:"Actions",
        aboutH:"About & Disclaimer",
        aboutS:"Educational app • not financial advice.",
        a1:"What this app is",
        a1p:"Equity Analyzer is a learning tool. It estimates fair value using DCF scenarios (Bear/Base/Bull).",
        a2:"For whom it is useful",
        a2p:"For investors who want to practice valuation thinking, compare scenarios, and store notes in a watchlist.",
        a3:"Disclaimer (important)",
        a3p:"This is NOT financial advice. Outputs depend heavily on assumptions. Use at your own risk.",
        a4:"How to use",
        a4p:"Choose company type → fill inputs → Calculate → Save to Watchlist. Try conservative assumptions.",
        toastNeedCalc:"First calculate a result.",
        toastSaved:"Saved ✅",
        toastDeleted:"Deleted.",
        toastCleared:"Cleared.",
        toastInvalid:"Some inputs are missing/invalid.",
        modeQuick:"MODE: Quick",
        modeAdv:"MODE: Advanced",
        btnLoad:"Load",
        btnDel:"Delete"
      },

      cs: {
        title:"Equity Analyzer",
        sub:"DCF férová cena • Watchlist • Výuka",
        tab1:"DCF Model",
        tab1s:"Univerzální DCF pro více typů firem (3 scénáře).",
        tab2:"Watchlist",
        tab2s:"Uložené výpočty v zařízení (localStorage).",
        tab3:"O aplikaci",
        tab3s:"Výuková appka • Nejde o finanční doporučení.",
        p1h:"DCF Model (3 scénáře)",
        p1s:"Vyber typ firmy + způsob zadání, pak spočítej Bear/Base/Bull.",
        inH:"Vstupy",
        tickerL:"Ticker / Název",
        tickerH:"Jen pro poznámky (watchlist).",
        curL:"Měna",
        typeL:"Typ firmy",
        typeH:"Nastaví rozumné defaulty + upozornění (můžeš přepsat).",
        modeL:"Režim",
        priceL:"Aktuální cena (volitelné)",
        priceH:"Pro potenciál a margin of safety.",
        mosL:"Margin of Safety",
        methodH:"Zadání pro DCF",
        methodL:"Metoda",
        methodHelp:"Když neznáš FCF, můžeš ho odhadnout přes Tržby a FCF marži.",
        yearsL:"Projekce (roky)",
        fcfL:"FCF (TTM nebo průměr 3–5 let)",
        fcfH:"Roční FCF v zvolené měně.",
        revL:"Tržby (ročně)",
        revH:"Roční tržby v zvolené měně.",
        margL:"FCF marže (base)",
        margH:"FCF = Tržby × marže. Marže v %.",
        capH:"Kapitálová struktura",
        shL:"Počet akcií (diluted)",
        shH:"Přepočet equity value na férovku na akcii.",
        cashL:"Hotovost (Cash)",
        cashH:"Přičítá se k EV.",
        debtL:"Dluh (Debt)",
        debtH:"Odečítá se pro equity value.",
        assH:"Předpoklady (3 scénáře)",
        drL:"Diskontní sazba (base)",
        drH:"Vyšší riziko → vyšší diskont → nižší férovka.",
        tgL:"Terminální růst",
        tgH:"Dlouhodobý růst po projekci. Konzervativně.",
        gBaseL:"Base růst",
        gBaseH:"Roční růst FCF během projekce.",
        gBearL:"Bear růst",
        gBearH:"Quick: Base − 2 p.b. (v Advanced editovatelné).",
        gBullL:"Bull růst",
        gBullH:"Quick: Base + 2 p.b. (v Advanced editovatelné).",
        tip:"Tip: V Quick režimu zadáš jen Base. Bear/Bull se dopočítá.",
        calc:"Spočítat",
        reset:"Reset",
        save:"Uložit výsledek",
        demo:"Demo hodnoty",
        saveTop:"Uložit do Watchlistu",
        outH:"Výstupy",
        baseFV:"Férovka (Base)",
        rangeFV:"Rozsah (Bear → Bull)",
        upside:"Potenciál vs cena",
        details:"Detaily",
        warn:"Upozornění / kontrola",
        wH:"Watchlist",
        wS:"Uložené výpočty v tomto zařízení (localStorage).",
        wTableH:"Uložené položky",
        wNote:"Watchlist je lokální v prohlížeči. Vymazání dat nebo jiné zařízení = položky zmizí.",
        export:"Export CSV",
        clearAll:"Smazat vše",
        wDate:"Datum",
        wTicker:"Ticker",
        wCur:"Měna",
        wPrice:"Cena",
        wBear:"Bear",
        wBase:"Base",
        wBull:"Bull",
        wMos:"MOS",
        wAct:"Akce",
        aboutH:"O aplikaci & upozornění",
        aboutS:"Výuková appka • ne finanční doporučení.",
        a1:"Co to je",
        a1p:"Equity Analyzer je výukový nástroj. Odhaduje férovou cenu přes DCF scénáře (Bear/Base/Bull).",
        a2:"Pro koho je to",
        a2p:"Pro investory, kteří chtějí trénovat ocenění, porovnávat scénáře a ukládat si poznámky.",
        a3:"Upozornění (důležité)",
        a3p:"Tohle NENÍ finanční doporučení. Výsledek je extrémně citlivý na předpoklady. Používej na vlastní riziko.",
        a4:"Jak používat",
        a4p:"Vyber typ firmy → vyplň vstupy → Spočítat → Uložit do Watchlistu. Zkoušej konzervativní předpoklady.",
        toastNeedCalc:"Nejdřív něco spočítej.",
        toastSaved:"Uloženo ✅",
        toastDeleted:"Smazáno.",
        toastCleared:"Vymazáno.",
        toastInvalid:"Některé vstupy chybí / jsou špatně.",
        modeQuick:"REŽIM: Quick",
        modeAdv:"REŽIM: Advanced",
        btnLoad:"Nahrát",
        btnDel:"Smazat"
      }
    };

    // ========= DOM helpers =========
    const $ = (id)=>document.getElementById(id);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{el.style.display="none";}, 2200);
    }

    function nval(v){
      const s = String(v ?? "").trim().replace(/\s+/g,"").replace(",",".");
      if(!s) return NaN;
      const x = Number(s);
      return Number.isFinite(x) ? x : NaN;
    }

    function money(x, cur){
      if(!Number.isFinite(x)) return "—";
      try{ return new Intl.NumberFormat(undefined,{style:"currency",currency:cur,maximumFractionDigits:2}).format(x); }
      catch{ return `${x.toFixed(2)} ${cur}`; }
    }
    function pct(x){
      if(!Number.isFinite(x)) return "—";
      const v = x*100;
      return `${v>=0?"+":""}${v.toFixed(1)}%`;
    }
    function dateStr(iso){
      const d = new Date(iso);
      if(isNaN(d.getTime())) return "—";
      return d.toLocaleString(undefined,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }

    // ========= Apply language =========
    function applyLang(){
      const t = T[state.lang];

      $("t_title").textContent = t.title;
      $("t_sub").textContent = t.sub;

      $("t_tab1").textContent = t.tab1; $("t_tab1s").textContent = t.tab1s;
      $("t_tab2").textContent = t.tab2; $("t_tab2s").textContent = t.tab2s;
      $("t_tab3").textContent = t.tab3; $("t_tab3s").textContent = t.tab3s;

      $("t_p1h").textContent = t.p1h;
      $("t_p1s").textContent = t.p1s;

      $("t_inH").textContent = t.inH;
      $("t_tickerL").textContent = t.tickerL;
      $("t_tickerH").textContent = t.tickerH;
      $("t_curL").textContent = t.curL;
      $("t_typeL").textContent = t.typeL;
      $("t_typeH").textContent = t.typeH;
      $("t_modeL").textContent = t.modeL;
      $("t_priceL").textContent = t.priceL;
      $("t_priceH").textContent = t.priceH;
      $("t_mosL").textContent = t.mosL;

      $("t_methodH").textContent = t.methodH;
      $("t_methodL").textContent = t.methodL;
      $("t_methodHelp").textContent = t.methodHelp;
      $("t_yearsL").textContent = t.yearsL;

      $("t_fcfL").textContent = t.fcfL;
      $("t_fcfH").textContent = t.fcfH;
      $("t_revL").textContent = t.revL;
      $("t_revH").textContent = t.revH;
      $("t_margL").textContent = t.margL;
      $("t_margH").textContent = t.margH;

      $("t_capH").textContent = t.capH;
      $("t_shL").textContent = t.shL;
      $("t_shH").textContent = t.shH;
      $("t_cashL").textContent = t.cashL;
      $("t_cashH").textContent = t.cashH;
      $("t_debtL").textContent = t.debtL;
      $("t_debtH").textContent = t.debtH;

      $("t_assH").textContent = t.assH;
      $("t_drL").textContent = t.drL;
      $("t_drH").textContent = t.drH;
      $("t_tgL").textContent = t.tgL;
      $("t_tgH").textContent = t.tgH;
      $("t_gBaseL").textContent = t.gBaseL;
      $("t_gBaseH").textContent = t.gBaseH;
      $("t_gBearL").textContent = t.gBearL;
      $("t_gBearH").textContent = t.gBearH;
      $("t_gBullL").textContent = t.gBullL;
      $("t_gBullH").textContent = t.gBullH;

      $("t_tip").textContent = t.tip;

      $("btnCalc").textContent = t.calc;
      $("btnReset").textContent = t.reset;
      $("btnSave").textContent = t.save;
      $("btnDemo").textContent = t.demo;
      $("btnSaveTop").textContent = t.saveTop;

      $("t_outH").textContent = t.outH;
      $("t_baseFV").textContent = t.baseFV;
      $("t_rangeFV").textContent = t.rangeFV;
      $("t_upside").textContent = t.upside;
      $("t_details").textContent = t.details;
      $("t_warn").textContent = t.warn;

      $("t_wH").textContent = t.wH;
      $("t_wS").textContent = t.wS;
      $("t_wTableH").textContent = t.wTableH;
      $("t_wNote").textContent = t.wNote;
      $("btnExport").textContent = t.export;
      $("btnClear").textContent = t.clearAll;

      $("t_wDate").textContent = t.wDate;
      $("t_wTicker").textContent = t.wTicker;
      $("t_wCur").textContent = t.wCur;
      $("t_wPrice").textContent = t.wPrice;
      $("t_wBear").textContent = t.wBear;
      $("t_wBase").textContent = t.wBase;
      $("t_wBull").textContent = t.wBull;
      $("t_wMos").textContent = t.wMos;
      $("t_wAct").textContent = t.wAct;

      $("t_aH").textContent = t.aboutH;
      $("t_aS").textContent = t.aboutS;
      $("t_a1").textContent = t.a1; $("t_a1p").textContent = t.a1p;
      $("t_a2").textContent = t.a2; $("t_a2p").textContent = t.a2p;
      $("t_a3").textContent = t.a3; $("t_a3p").textContent = t.a3p;
      $("t_a4").textContent = t.a4; $("t_a4p").textContent = t.a4p;

      // Badge mode
      syncModeUI();
      renderWatchlist();
    }

    // ========= Tabs =========
    function showPanel(which){
      $("tabModel").classList.toggle("active", which==="model");
      $("tabWatch").classList.toggle("active", which==="watch");
      $("tabAbout").classList.toggle("active", which==="about");

      $("panelModel").style.display = (which==="model") ? "" : "none";
      $("panelWatch").style.display = (which==="watch") ? "" : "none";
      $("panelAbout").style.display = (which==="about") ? "" : "none";

      if(which==="watch") renderWatchlist();
    }

    // ========= Defaults by type =========
    function applyDefaultsByType(){
      const type = $("in_type").value;
      // only set defaults if fields are empty (so you can override)
      const setIfEmpty = (id,val)=>{
        const el = $(id);
        if(!String(el.value||"").trim()) el.value = String(val);
      };

      if(type==="growth"){
        setIfEmpty("in_dr", 10);
        setIfEmpty("in_tg", 2.5);
        setIfEmpty("in_g_base", 12);
      }else if(type==="mature"){
        setIfEmpty("in_dr", 8.5);
        setIfEmpty("in_tg", 2.0);
        setIfEmpty("in_g_base", 5);
      }else if(type==="cyclical"){
        setIfEmpty("in_dr", 10);
        setIfEmpty("in_tg", 1.8);
        setIfEmpty("in_g_base", 4);
      }else if(type==="reits"){
        setIfEmpty("in_dr", 8.5);
        setIfEmpty("in_tg", 2.0);
        setIfEmpty("in_g_base", 3.5);
      }else{ // financial
        setIfEmpty("in_dr", 10.5);
        setIfEmpty("in_tg", 1.8);
        setIfEmpty("in_g_base", 3.5);
      }

      syncModeUI();
    }

    // ========= Method switch =========
    function syncMethodUI(){
      const m = $("in_method").value;
      $("blk_fcf").style.display = (m==="fcf") ? "" : "none";
      $("blk_rev").style.display = (m==="rev") ? "" : "none";
    }

    function syncUnits(){
      const cur = $("in_cur").value;
      $("u_fcf").textContent = `${cur} / year`;
      $("u_rev").textContent = `${cur} / year`;
      $("u_cash").textContent = cur;
      $("u_debt").textContent = cur;
    }

    // ========= Mode (Quick / Advanced) =========
    function syncModeUI(){
      const t = T[state.lang];
      const mode = $("in_mode").value;
      $("badgeMode").textContent = (mode==="quick") ? t.modeQuick : t.modeAdv;

      const bear = $("in_g_bear");
      const bull = $("in_g_bull");

      if(mode==="quick"){
        bear.setAttribute("disabled","disabled");
        bull.setAttribute("disabled","disabled");
        // derive from base
        const base = nval($("in_g_base").value);
        if(Number.isFinite(base)){
          bear.value = String(Math.max(base - 2, -50));
          bull.value = String(Math.min(base + 2, 80));
        }else{
          bear.value = "";
          bull.value = "";
        }
      }else{
        bear.removeAttribute("disabled");
        bull.removeAttribute("disabled");
        // if empty, prefill from base ±2
        const base = nval($("in_g_base").value);
        if(Number.isFinite(base)){
          if(!String(bear.value||"").trim()) bear.value = String(Math.max(base - 2, -50));
          if(!String(bull.value||"").trim()) bull.value = String(Math.min(base + 2, 80));
        }
      }
    }

    // ========= Core DCF =========
    function impliedFCFBase(){
      const method = $("in_method").value;
      if(method==="fcf"){
        return nval($("in_fcf").value);
      }
      // revenue × margin
      const rev = nval($("in_rev").value);
      const marg = nval($("in_marg").value) / 100;
      if(!Number.isFinite(rev) || !Number.isFinite(marg)) return NaN;
      return rev * marg;
    }

    function dcfPerShare(fcf0, g, years, dr, tg, cash, debt, shares){
      // fcf0 is current annual FCF (base year)
      // We grow for N years, discount each year.
      let f = fcf0;
      let pv = 0;

      for(let y=1; y<=years; y++){
        f = f * (1 + g);
        pv += f / Math.pow(1 + dr, y);
      }

      const fN = f; // last projected year FCF
      // Terminal value (Gordon growth)
      const tv = (fN * (1 + tg)) / (dr - tg);
      const pvTV = tv / Math.pow(1 + dr, years);

      const ev = pv + pvTV;
      const eq = ev + cash - debt;
      const perShare = eq / shares;

      return { perShare, pv, pvTV, ev, eq, tv };
    }

    function calcAll(){
      const cur = $("in_cur").value;

      const ticker = ($("in_ticker").value || "").trim() || "—";
      const price = nval($("in_price").value);
      const mosPct = nval($("in_mos").value) / 100;

      const years = Math.max(1, Math.min(50, Math.floor(nval($("in_years").value) || 10)));
      const dr = nval($("in_dr").value) / 100;
      const tg = nval($("in_tg").value) / 100;

      const shares = nval($("in_shares").value);
      const cash = nval($("in_cash").value) || 0;
      const debt = nval($("in_debt").value) || 0;

      const gBase = nval($("in_g_base").value) / 100;
      const gBear = nval($("in_g_bear").value) / 100;
      const gBull = nval($("in_g_bull").value) / 100;

      const fcf0 = impliedFCFBase();

      // Validation
      const invalid =
        !Number.isFinite(fcf0) || fcf0<=0 ||
        !Number.isFinite(shares) || shares<=0 ||
        !Number.isFinite(dr) || dr<=0 ||
        !Number.isFinite(tg) ||
        tg >= dr ||
        !Number.isFinite(gBase) || !Number.isFinite(gBear) || !Number.isFinite(gBull);

      if(invalid){
        return { ok:false };
      }

      // Run 3 scenarios
      const bear = dcfPerShare(fcf0, gBear, years, dr, tg, cash, debt, shares);
      const base = dcfPerShare(fcf0, gBase, years, dr, tg, cash, debt, shares);
      const bull = dcfPerShare(fcf0, gBull, years, dr, tg, cash, debt, shares);

      // Upside & MOS
      let upside = NaN, mosTarget = NaN;
      if(Number.isFinite(price) && price>0){
        upside = (base.perShare / price) - 1;
        mosTarget = base.perShare * (1 - mosPct);
      }

      // Warnings / checks
      const warns = [];
      if(tg > 0.03) warns.push("Terminal growth is high (consider 1–3%).");
      if(dr < 0.07) warns.push("Discount rate is low. Risk may be understated.");
      if(base.pvTV/base.ev > 0.75) warns.push("Terminal value dominates (>75%). Consider more conservative growth/discount.");
      if(gBull - gBear > 0.15) warns.push("Scenario spread is very wide. Double-check growth assumptions.");

      return {
        ok:true,
        cur, ticker, price: Number.isFinite(price)?price:null, mosPct,
        inputs: snapshotInputs(),
        values: {
          bear: bear.perShare,
          base: base.perShare,
          bull: bull.perShare
        },
        debug: { fcf0, years, dr, tg, cash, debt, shares, gBear, gBase, gBull,
          pvBase: base.pv, pvTVBase: base.pvTV, evBase: base.ev, eqBase: base.eq },
        upside, mosTarget,
        warns
      };
    }

    function render(res){
      const t = T[state.lang];
      const cur = $("in_cur").value;

      if(!res.ok){
        $("out_base").textContent = "—";
        $("out_base_sub").textContent = "—";
        $("out_range").textContent = "—";
        $("out_range_sub").textContent = "—";
        $("out_upside").textContent = "—";
        $("out_upside_sub").textContent = t.toastInvalid;
        $("out_details").textContent = "—";
        $("out_warn").textContent = "—";
        return;
      }

      const bear = res.values.bear;
      const base = res.values.base;
      const bull = res.values.bull;

      $("out_base").textContent = money(base, cur);
      $("out_base_sub").textContent = `Bear ${money(bear, cur)} • Bull ${money(bull, cur)}`;

      $("out_range").textContent = `${money(bear, cur)} → ${money(bull, cur)}`;
      $("out_range_sub").textContent = `Base: ${money(base, cur)} (${res.ticker})`;

      if(res.price){
        $("out_upside").textContent = pct(res.upside);
        const mosLabel = (res.mosPct>0) ? `MOS target: ${money(res.mosTarget, cur)}` : "MOS: OFF";
        $("out_upside_sub").textContent = `Price: ${money(res.price, cur)} • ${mosLabel}`;
      }else{
        $("out_upside").textContent = "—";
        $("out_upside_sub").textContent = (state.lang==="cs")
          ? "Zadej cenu pro potenciál a MOS."
          : "Enter price to see upside & MOS.";
      }

      // details
      const d = res.debug;
      $("out_details").innerHTML =
        `<div class="mono">
          FCF0: ${money(d.fcf0, cur)}<br/>
          Years: ${d.years} • DR: ${(d.dr*100).toFixed(2)}% • TG: ${(d.tg*100).toFixed(2)}%<br/>
          PV(Proj): ${money(d.pvBase, cur)} • PV(Terminal): ${money(d.pvTVBase, cur)}<br/>
          EV: ${money(d.evBase, cur)} • Equity: ${money(d.eqBase, cur)}
        </div>`;

      // warnings
      if(res.warns.length){
        $("out_warn").innerHTML = res.warns.map(x=>`• ${escapeHtml(x)}`).join("<br/>");
      }else{
        $("out_warn").textContent = (state.lang==="cs")
          ? "Vypadá OK. Stejně si zkontroluj předpoklady."
          : "Looks OK. Still double-check assumptions.";
      }
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }

    // ========= Watchlist =========
    function loadWatchlist(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveWatchlist(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

    function snapshotInputs(){
      return {
        ticker: $("in_ticker").value,
        cur: $("in_cur").value,
        type: $("in_type").value,
        mode: $("in_mode").value,
        mos: $("in_mos").value,
        method: $("in_method").value,
        years: $("in_years").value,
        price: $("in_price").value,

        fcf: $("in_fcf").value,
        rev: $("in_rev").value,
        marg: $("in_marg").value,

        shares: $("in_shares").value,
        cash: $("in_cash").value,
        debt: $("in_debt").value,

        dr: $("in_dr").value,
        tg: $("in_tg").value,
        g_base: $("in_g_base").value,
        g_bear: $("in_g_bear").value,
        g_bull: $("in_g_bull").value
      };
    }

    function loadInputs(inputs){
      if(!inputs) return;

      $("in_ticker").value = inputs.ticker ?? "";
      $("in_cur").value = inputs.cur ?? "USD";
      $("in_type").value = inputs.type ?? "growth";
      $("in_mode").value = inputs.mode ?? "quick";
      $("in_mos").value = inputs.mos ?? "0";
      $("in_method").value = inputs.method ?? "fcf";
      $("in_years").value = inputs.years ?? "10";
      $("in_price").value = inputs.price ?? "";

      $("in_fcf").value = inputs.fcf ?? "";
      $("in_rev").value = inputs.rev ?? "";
      $("in_marg").value = inputs.marg ?? "";

      $("in_shares").value = inputs.shares ?? "";
      $("in_cash").value = inputs.cash ?? "";
      $("in_debt").value = inputs.debt ?? "";

      $("in_dr").value = inputs.dr ?? "9";
      $("in_tg").value = inputs.tg ?? "2.5";
      $("in_g_base").value = inputs.g_base ?? "";
      $("in_g_bear").value = inputs.g_bear ?? "";
      $("in_g_bull").value = inputs.g_bull ?? "";

      syncUnits();
      syncMethodUI();
      syncModeUI();

      const res = calcAll();
      state.last = res.ok ? res : null;
      render(res);
      showPanel("model");
      toast("Loaded ✅");
    }

    function addToWatchlist(){
      const t = T[state.lang];
      if(!state.last || !state.last.ok){
        toast(t.toastNeedCalc);
        return;
      }
      const now = new Date().toISOString();
      const item = {
        id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
        dt: now,
        ticker: state.last.ticker,
        cur: state.last.cur,
        price: state.last.price,
        mosPct: state.last.mosPct,
        values: state.last.values,
        inputs: state.last.inputs
      };
      const arr = loadWatchlist();
      arr.unshift(item);
      saveWatchlist(arr);
      renderWatchlist();
      toast(t.toastSaved);
    }

    function delItem(id){
      const t = T[state.lang];
      const arr = loadWatchlist().filter(x=>x.id!==id);
      saveWatchlist(arr);
      renderWatchlist();
      toast(t.toastDeleted);
    }

    function clearAll(){
      const t = T[state.lang];
      saveWatchlist([]);
      renderWatchlist();
      toast(t.toastCleared);
    }

    function exportCSV(){
      const arr = loadWatchlist();
      if(!arr.length){ toast(state.lang==="cs" ? "Watchlist je prázdný." : "Watchlist is empty."); return; }

      const rows = [];
      rows.push(["date","ticker","cur","price","bear","base","bull","mosPct"].join(","));
      for(const it of arr){
        rows.push([
          it.dt,
          safeCSV(it.ticker),
          it.cur,
          it.price ?? "",
          it.values?.bear ?? "",
          it.values?.base ?? "",
          it.values?.bull ?? "",
          it.mosPct ?? ""
        ].join(","));
      }
      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "equity-analyzer-watchlist.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast(state.lang==="cs" ? "CSV staženo ✅" : "CSV downloaded ✅");
    }

    function safeCSV(s){
      const v = String(s ?? "");
      if(v.includes(",") || v.includes('"') || v.includes("\n")){
        return `"${v.replaceAll('"','""')}"`;
      }
      return v;
    }

    function renderWatchlist(){
      const t = T[state.lang];
      const body = $("watchBody");
      body.innerHTML = "";

      const arr = loadWatchlist();
      if(!arr.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.className = "mut";
        td.textContent = (state.lang==="cs") ? "Zatím nic uloženého." : "Nothing saved yet.";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }

      for(const it of arr){
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = dateStr(it.dt);
        tr.appendChild(tdDate);

        const tdT = document.createElement("td");
        tdT.innerHTML = `<b>${escapeHtml(it.ticker || "—")}</b>`;
        tr.appendChild(tdT);

        const tdC = document.createElement("td");
        tdC.textContent = it.cur || "—";
        tr.appendChild(tdC);

        const tdP = document.createElement("td");
        tdP.textContent = (it.price!=null && Number.isFinite(it.price)) ? money(it.price, it.cur) : "—";
        tr.appendChild(tdP);

        const tdB1 = document.createElement("td");
        tdB1.textContent = money(it.values?.bear, it.cur);
        tr.appendChild(tdB1);

        const tdB2 = document.createElement("td");
        tdB2.textContent = money(it.values?.base, it.cur);
        tr.appendChild(tdB2);

        const tdB3 = document.createElement("td");
        tdB3.textContent = money(it.values?.bull, it.cur);
        tr.appendChild(tdB3);

        const tdMos = document.createElement("td");
        tdMos.textContent = it.mosPct ? `${(it.mosPct*100).toFixed(0)}%` : "OFF";
        tr.appendChild(tdMos);

        const tdA = document.createElement("td");
        const btnLoad = document.createElement("button");
        btnLoad.className = "btn";
        btnLoad.textContent = t.btnLoad;
        btnLoad.style.padding = "8px 10px";
        btnLoad.style.borderRadius = "12px";
        btnLoad.addEventListener("click", ()=> loadInputs(it.inputs));

        const btnDel = document.createElement("button");
        btnDel.className = "btn danger";
        btnDel.textContent = t.btnDel;
        btnDel.style.padding = "8px 10px";
        btnDel.style.borderRadius = "12px";
        btnDel.style.marginLeft = "8px";
        btnDel.addEventListener("click", ()=> delItem(it.id));

        tdA.appendChild(btnLoad);
        tdA.appendChild(btnDel);
        tr.appendChild(tdA);

        body.appendChild(tr);
      }
    }

    // ========= Buttons / Events =========
    function resetAll(){
      $("in_ticker").value = "";
      $("in_cur").value = "USD";
      $("in_type").value = "growth";
      $("in_mode").value = "quick";
      $("in_mos").value = "0";
      $("in_method").value = "fcf";
      $("in_years").value = "10";
      $("in_price").value = "";

      $("in_fcf").value = "";
      $("in_rev").value = "";
      $("in_marg").value = "";

      $("in_shares").value = "";
      $("in_cash").value = "";
      $("in_debt").value = "";

      $("in_dr").value = "9";
      $("in_tg").value = "2.5";
      $("in_g_base").value = "";
      $("in_g_bear").value = "";
      $("in_g_bull").value = "";

      syncUnits();
      syncMethodUI();
      applyDefaultsByType();
      syncModeUI();
      state.last = null;
      render({ok:false});
    }

    function demoValues(){
      // demo tuned for mobile testing
      $("in_ticker").value = "AAPL";
      $("in_cur").value = "USD";
      $("in_type").value = "mature";
      $("in_mode").value = "quick";
      $("in_method").value = "fcf";
      $("in_years").value = "10";
      $("in_price").value = "190";

      $("in_fcf").value = "100000000000";
      $("in_shares").value = "15500000000";
      $("in_cash").value = "60000000000";
      $("in_debt").value = "90000000000";

      $("in_dr").value = "9";
      $("in_tg").value = "2.5";
      $("in_g_base").value = "6";

      syncUnits();
      syncMethodUI();
      applyDefaultsByType();
      syncModeUI();

      const res = calcAll();
      state.last = res.ok ? res : null;
      render(res);
      toast(state.lang==="cs" ? "Demo nastaveno ✅" : "Demo set ✅");
    }

    // ========= Init =========
    function init(){
      // tabs
      $("tabModel").addEventListener("click", ()=>showPanel("model"));
      $("tabWatch").addEventListener("click", ()=>showPanel("watch"));
      $("tabAbout").addEventListener("click", ()=>showPanel("about"));

      // language
      $("btnEN").addEventListener("click", ()=>{
        state.lang = "en";
        $("btnEN").classList.add("active");
        $("btnCZ").classList.remove("active");
        applyLang();
      });
      $("btnCZ").addEventListener("click", ()=>{
        state.lang = "cs";
        $("btnCZ").classList.add("active");
        $("btnEN").classList.remove("active");
        applyLang();
      });

      // controls
      $("in_cur").addEventListener("change", syncUnits);
      $("in_method").addEventListener("change", ()=>{ syncMethodUI(); });
      $("in_mode").addEventListener("change", ()=>{ syncModeUI(); });
      $("in_type").addEventListener("change", ()=>{ applyDefaultsByType(); });

      $("in_g_base").addEventListener("input", ()=>{ syncModeUI(); });

      // buttons
      $("btnCalc").addEventListener("click", ()=>{
        const res = calcAll();
        if(!res.ok){
          toast(T[state.lang].toastInvalid);
          render({ok:false});
          state.last = null;
          return;
        }
        state.last = res;
        render(res);
      });

      $("btnSave").addEventListener("click", addToWatchlist);
      $("btnSaveTop").addEventListener("click", addToWatchlist);
      $("btnReset").addEventListener("click", resetAll);
      $("btnDemo").addEventListener("click", demoValues);

      $("btnExport").addEventListener("click", exportCSV);
      $("btnClear").addEventListener("click", clearAll);

      // enter = calculate
      $$(".num").forEach(inp=>{
        inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("btnCalc").click(); });
      });

      // initial
      syncUnits();
      syncMethodUI();
      applyDefaultsByType();
      syncModeUI();
      applyLang();
      renderWatchlist();
      render({ok:false});
    }

    init();
  </script>
</body>
</html>





    

    

  
        

    
    

  

  





