<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Equity Analyzer ‚Äî DCF & Watchlist</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#0a0820;
      --bg1:#0d0b26;
      --bg2:#14114a;

      --card:#151246cc;
      --card2:#17145bcc;
      --stroke:#ffffff22;

      --violet:#a78bfa;
      --violet2:#7c3aed;
      --blue:#60a5fa;
      --cyan:#22d3ee;

      --text:#f3f4ff;
      --muted:#c7c9ff;

      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(167,139,250,.25), transparent 55%),
        radial-gradient(900px 520px at 85% 0%, rgba(34,211,238,.20), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg0));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(0,0,0,.10)), var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      font-weight: 860;
      line-height: 1.15;
    }
    .brand .sub{
      margin:3px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .toggles{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.10));
      user-select:none;
    }

    .pill .lbl{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
    }
    .seg button{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      white-space: nowrap;
    }
    .seg button:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.55); }
    .seg button.on{
      background: rgba(167,139,250,.26);
      border-color: rgba(167,139,250,.65);
    }

    .menu{
      margin-top: 14px;
      display:grid;
      gap: 12px;
    }

    .drawer{
      width:100%;
      border:1px solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.12)),
        var(--card2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      text-align:left;
      color: var(--text);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .drawer:hover{ transform: translateY(-1px); border-color: rgba(96,165,250,.55); box-shadow: 0 22px 70px rgba(0,0,0,.62); }
    .drawer .left{ display:flex; gap:12px; align-items:center; min-width:0; }
    .icon{
      width:40px; height:40px;
      border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid var(--stroke);
      background: radial-gradient(60% 60% at 30% 20%, rgba(167,139,250,.28), rgba(96,165,250,.10));
      flex: 0 0 auto;
    }
    .drawer .title{
      font-weight: 900;
      font-size: 16px;
      margin:0;
    }
    .drawer .desc{
      margin:4px 0 0;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .chev{
      font-size: 22px;
      color: rgba(34,211,238,.95);
      flex: 0 0 auto;
    }

    .screen{
      display:none;
      margin-top: 14px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.14)),
        rgba(20,17,74,.65);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .screen.active{ display:block; }

    .screenHead{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .screenHead h2{
      margin:0;
      font-size: 16px;
      font-weight: 920;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.65); }
    .btn.primary{
      background: rgba(167,139,250,.26);
      border-color: rgba(167,139,250,.65);
    }
    .btn.danger{
      background: rgba(251,113,133,.16);
      border-color: rgba(251,113,133,.55);
    }

    .screenBody{ padding: 14px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .grid2{ grid-template-columns: 1.1fr .9fr; }
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
    }
    .card h3{
      margin:0 0 10px;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: .2px;
      text-transform: uppercase;
      font-weight: 900;
    }

    .fields{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 560px){
      .fields{ grid-template-columns: 1fr 1fr; }
    }

    .field{
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .field .meta{ min-width:0; flex:1; }
    .field label{
      display:block;
      font-size: 12px;
      font-weight: 900;
      margin:0 0 3px;
    }
    .field .hint{
      font-size: 11px;
      color: var(--muted);
      margin:0;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .field input{
      width: 130px;
      max-width: 42vw;
      border:1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      outline:none;
    }
    .field input:focus{
      border-color: rgba(34,211,238,.70);
      box-shadow: 0 0 0 4px rgba(34,211,238,.12);
    }
    .help{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 1000;
    }

    .resultsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px){
      .resultsGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }
    .res{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      border-radius: var(--radius);
      padding: 12px;
    }
    .res .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .res .name{
      font-weight: 950;
      letter-spacing: .2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      font-size: 12px;
      font-weight: 1000;
      background: rgba(255,255,255,.06);
    }
    .chip.ok{ border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.12); }
    .chip.warn{ border-color: rgba(251,191,36,.55); background: rgba(251,191,36,.12); }
    .chip.bad{ border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12); }

    .res .big{
      font-size: 24px;
      font-weight: 1000;
      margin: 6px 0 8px;
    }
    .muted{ color: var(--muted); font-size: 12px; }
    .line{ display:flex; justify-content:space-between; gap:10px; font-size: 12px; margin-top: 6px; color: var(--muted); }
    .line b{ color: var(--text); font-weight: 950; }

    .canvasWrap{
      margin-top: 12px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(255,255,255,.05);
    }

    .watchItem{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(0,0,0,.12);
      padding: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .watchItem + .watchItem{ margin-top: 10px; }
    .watchMain{
      flex:1;
      min-width:0;
    }
    .watchTitle{
      font-weight: 1000;
      font-size: 14px;
      margin:0 0 3px;
    }
    .watchSub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .watchBtns{
      display:flex;
      flex-direction:column;
      gap: 8px;
      flex: 0 0 auto;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,8,32,.92);
      border:1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 50;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Modal */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 16px;
    }
    .modalBack.show{ display:flex; }
    .modal{
      max-width: 720px;
      width: 100%;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.16)), rgba(20,17,74,.75);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modalHead h4{
      margin:0;
      font-size: 14px;
      font-weight: 1000;
    }
    .modalBody{
      padding: 14px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }
    .modalBody p{ margin: 0 0 10px; color: var(--muted); }
    .modalBody ul{ margin: 8px 0 0 18px; color: var(--muted); }
    .modalBody b{ color: var(--text); }

  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1 id="t_appTitle">Equity Analyzer</h1>
        <div class="sub" id="t_appSub">DCF v√Ωpoƒçet f√©rov√© ceny + Watchlist</div>
      </div>

      <div class="toggles">
        <div class="pill">
          <span class="lbl" id="t_lang">Jazyk</span>
          <div class="seg">
            <button id="btnCZ" class="on" type="button">CZ</button>
            <button id="btnEN" type="button">EN</button>
          </div>
        </div>

        <div class="pill">
          <span class="lbl" id="t_ccy">Mƒõna</span>
          <div class="seg">
            <button id="btnUSD" class="on" type="button">USD</button>
            <button id="btnEUR" type="button">EUR</button>
          </div>
        </div>

        <div class="pill" title="Margin of Safety (20% pod BASE)">
          <span class="lbl" id="t_mos">MoS</span>
          <div class="seg">
            <button id="btnMOSoff" class="on" type="button">OFF</button>
            <button id="btnMOSon" type="button">ON</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HOME: 3 ≈°upl√≠ky -->
    <div id="home">
      <div class="menu">
        <button class="drawer" type="button" onclick="showScreen('dcf')">
          <div class="left">
            <div class="icon">üìà</div>
            <div style="min-width:0">
              <div class="title" id="t_drawerDCF">DCF model</div>
              <div class="desc" id="t_drawerDCFsub">Bear / Base / Bull, v√Ωsledky + graf</div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </button>

        <button class="drawer" type="button" onclick="showScreen('watch')">
          <div class="left">
            <div class="icon">üëÄ</div>
            <div style="min-width:0">
              <div class="title" id="t_drawerWatch">Watchlist</div>
              <div class="desc" id="t_drawerWatchsub">Ulo≈æen√© v√Ωpoƒçty, maz√°n√≠ po jedn√©, PDF export</div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </button>

        <button class="drawer" type="button" onclick="showScreen('about')">
          <div class="left">
            <div class="icon">‚ÑπÔ∏è</div>
            <div style="min-width:0">
              <div class="title" id="t_drawerAbout">O aplikaci</div>
              <div class="desc" id="t_drawerAboutsub">Pro koho je, metodika DCF, jak to pou≈æ√≠vat</div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </button>
      </div>
    </div>

    <!-- ===================== D√çL 2/3 ‚Äì SCREEN: DCF + DCF LOGIKA ===================== -->

<!-- SCREEN: DCF -->
<section class="screen" id="screenDCF" aria-hidden="true">
  <div class="screenHead">
    <h2 id="t_dcfTitle">DCF anal√Ωza</h2>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" type="button" id="btnBackDCF">Zpƒõt</button>
      <button class="btn primary" type="button" id="btnCalc">Spoƒç√≠tat</button>
      <button class="btn" type="button" id="btnSave">Ulo≈æit do Watchlistu</button>
      <button class="btn" type="button" id="btnPdfDCF">PDF (tisk)</button>
    </div>
  </div>

  <div class="screenBody">
    <div class="grid2">
      <!-- INPUTS -->
      <div class="card">
        <div class="rowBetween">
          <h3 id="t_inputsTitle">Vstupy</h3>
          <div class="hint" id="t_hintHelp">Klikni na ‚Äú?‚Äù pro vysvƒõtlivku.</div>
        </div>

        <div class="fields">
          <!-- Ticker -->
          <div class="field">
            <div class="meta">
              <label id="t_tickerLbl">Ticker / N√°zev</label>
              <button class="helpBtn" type="button" data-help="ticker">?</button>
            </div>
            <input id="inTicker" inputmode="text" placeholder="nap≈ô. AAPL" autocomplete="off" />
            <div class="small" id="t_tickerSmall">Libovoln√Ω text ‚Äì ukl√°d√° se do Watchlistu.</div>
          </div>

          <!-- FCF0 -->
          <div class="field">
            <div class="meta">
              <label id="t_fcfLbl">Posledn√≠ roƒçn√≠ FCF</label>
              <button class="helpBtn" type="button" data-help="fcf">?</button>
            </div>
            <input id="inFCF" inputmode="decimal" placeholder="nap≈ô. 9500000" />
            <div class="small" id="t_fcfSmall">Free cash flow za posledn√≠ rok (v mƒõnƒõ p≈ôep√≠naƒçe).</div>
          </div>

          <!-- Years -->
          <div class="field">
            <div class="meta">
              <label id="t_yearsLbl">Poƒçet let projekce</label>
              <button class="helpBtn" type="button" data-help="years">?</button>
            </div>
            <input id="inYears" inputmode="numeric" placeholder="nap≈ô. 10" />
            <div class="small" id="t_yearsSmall">Typicky 5‚Äì10 let.</div>
          </div>

          <!-- Discount rate -->
          <div class="field">
            <div class="meta">
              <label id="t_rLbl">Diskontn√≠ sazba (r) %</label>
              <button class="helpBtn" type="button" data-help="r">?</button>
            </div>
            <input id="inR" inputmode="decimal" placeholder="nap≈ô. 9" />
            <div class="small" id="t_rSmall">Nap≈ô. 8‚Äì12 % podle rizika.</div>
          </div>

          <!-- Terminal growth -->
          <div class="field">
            <div class="meta">
              <label id="t_tgLbl">Terminal growth (tg) %</label>
              <button class="helpBtn" type="button" data-help="tg">?</button>
            </div>
            <input id="inTG" inputmode="decimal" placeholder="nap≈ô. 2.5" />
            <div class="small" id="t_tgSmall">Dlouhodob√Ω r≈Øst po projekci (obvykle 1‚Äì3 %).</div>
          </div>

          <!-- Net debt / cash -->
          <div class="field">
            <div class="meta">
              <label id="t_netdLbl">Net debt / Cash</label>
              <button class="helpBtn" type="button" data-help="netd">?</button>
            </div>
            <input id="inNetD" inputmode="decimal" placeholder="nap≈ô. 0" />
            <div class="small" id="t_netdSmall">Kladn√© = ƒçist√Ω dluh, z√°porn√© = ƒçist√° hotovost.</div>
          </div>

          <!-- Shares -->
          <div class="field">
            <div class="meta">
              <label id="t_sharesLbl">Poƒçet akci√≠ (Shares)</label>
              <button class="helpBtn" type="button" data-help="shares">?</button>
            </div>
            <input id="inShares" inputmode="decimal" placeholder="nap≈ô. 16000000" />
            <div class="small" id="t_sharesSmall">Shares outstanding (z annual reportu / 10-K).</div>
          </div>

          <!-- Current price -->
          <div class="field">
            <div class="meta">
              <label id="t_priceLbl">Aktu√°ln√≠ cena (voliteln√©)</label>
              <button class="helpBtn" type="button" data-help="price">?</button>
            </div>
            <input id="inPrice" inputmode="decimal" placeholder="nap≈ô. 190" />
            <div class="small" id="t_priceSmall">Pou≈æije se jen pro % podhodnocen√≠/nadhodnocen√≠.</div>
          </div>

          <div class="hr"></div>

          <!-- Growth Bear/Base/Bull -->
          <div class="grid3">
            <div class="field">
              <div class="meta">
                <label id="t_gBearLbl">R≈Øst FCF Bear %</label>
                <button class="helpBtn" type="button" data-help="g">?</button>
              </div>
              <input id="inGBear" inputmode="decimal" placeholder="nap≈ô. 4" />
              <div class="small" id="t_gBearSmall">Konzervativn√≠ sc√©n√°≈ô.</div>
            </div>

            <div class="field">
              <div class="meta">
                <label id="t_gBaseLbl">R≈Øst FCF Base %</label>
                <button class="helpBtn" type="button" data-help="g">?</button>
              </div>
              <input id="inGBase" inputmode="decimal" placeholder="nap≈ô. 8" />
              <div class="small" id="t_gBaseSmall">Z√°kladn√≠ sc√©n√°≈ô.</div>
            </div>

            <div class="field">
              <div class="meta">
                <label id="t_gBullLbl">R≈Øst FCF Bull %</label>
                <button class="helpBtn" type="button" data-help="g">?</button>
              </div>
              <input id="inGBull" inputmode="decimal" placeholder="nap≈ô. 12" />
              <div class="small" id="t_gBullSmall">Optimistick√Ω sc√©n√°≈ô.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="card">
        <div class="rowBetween">
          <h3 id="t_resultsTitle">V√Ωsledky</h3>
          <div class="hint" id="t_resultsHint">Bear / Base / Bull</div>
        </div>

        <div id="resBox" class="resultsBox">
          <div class="empty" id="t_emptyRes">Zat√≠m nic. Vypl≈à vstupy a klikni ‚ÄûSpoƒç√≠tat‚Äú.</div>
        </div>

        <div class="chartWrap">
          <canvas id="dcfChart" height="150"></canvas>
          <div class="small" id="t_chartSmall">Graf se zobraz√≠, pokud je dostupn√Ω Chart.js.</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== DCF SCRIPT (vlo≈æit do stejn√©ho <script> bloku jako zbytek) ===================== -->
<script>
/* =========================
   DCF helpers / protections
   (bezpeƒçn√© ‚Äì nevytvo≈ô√≠ duplicitnƒõ, pokud u≈æ existuj√≠)
========================= */

(function(){
  // --- lightweight escape (pokud u≈æ existuje, nech√°me)
  if(typeof window.escapeHtml !== "function"){
    window.escapeHtml = function(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    };
  }

  // --- parseNum: zvl√°d√° ƒç√°rku i mezery
  if(typeof window.parseNum !== "function"){
    window.parseNum = function(v){
      if(v === null || v === undefined) return NaN;
      const s = String(v).trim().replace(/\s+/g,"").replace(",",".");
      if(s === "") return NaN;
      return Number(s);
    };
  }

  // --- currency / lang fallback (pokud nen√≠ v 1. d√≠lu)
  if(typeof window.LANG !== "string") window.LANG = "cs";
  if(typeof window.CCY  !== "string") window.CCY  = "USD";

  // --- toast fallback
  if(typeof window.toast !== "function"){
    window.toast = function(title, msg){
      // jednoduch√Ω alert fallback (pokud nem√°≈° hezk√Ω toast v 1. d√≠lu)
      alert((title? title + "\n\n" : "") + (msg || ""));
    };
  }

  // --- modal fallback
  if(typeof window.openModal !== "function"){
    window.openModal = function(title, html){
      alert(title + "\n\n" + html.replace(/<[^>]*>/g,""));
    };
  }

  // --- money format
  function fmtMoney(n){
    if(n === null || n === undefined || !isFinite(Number(n))) return "‚Äî";
    const locale = (window.LANG === "cs") ? "cs-CZ" : "en-US";
    return Number(n).toLocaleString(locale, { maximumFractionDigits: 2 });
  }

  // --- DCF math
  function calcScenario(fcf0, years, r, g, tg){
    let pvSum = 0;
    let fcf = fcf0;

    for(let i=1; i<=years; i++){
      fcf = fcf * (1 + g);
      pvSum += fcf / Math.pow(1 + r, i);
    }

    const fcfN = fcf;
    const denom = (r - tg);
    const tv = denom > 0 ? (fcfN * (1 + tg) / denom) : NaN;
    const pvTv = isFinite(tv) ? tv / Math.pow(1 + r, years) : NaN;
    const ev = pvSum + (isFinite(pvTv) ? pvTv : 0);

    return { ev, pvSum, tv, pvTv };
  }

  // --- render result cards
  function renderResults(res){
    const box = document.getElementById("resBox");
    if(!box) return;

    const price = (res.inputs.price != null && isFinite(res.inputs.price)) ? res.inputs.price : null;

    function chip(fair){
      if(price === null) return "";
      const p = Number(price);
      const f = Number(fair);
      if(!isFinite(p) || !isFinite(f) || p <= 0) return "";
      const diff = (f - p) / p * 100;
      const sign = diff >= 0 ? "+" : "";
      const cls = diff >= 10 ? "chip good" : (diff <= -10 ? "chip bad" : "chip warn");
      return `<span class="${cls}">${sign}${diff.toFixed(2)}%</span>`;
    }

    function card(label, fairPS, ev, eq){
      return `
        <div class="resCard">
          <div class="resTop">
            <div class="resLabel">${escapeHtml(label)}</div>
            ${chip(fairPS)}
          </div>
          <div class="resValue">${fmtMoney(fairPS)} ${escapeHtml(window.CCY)}</div>
          <div class="resSub">
            <div>Enterprise value: <b>${fmtMoney(ev)}</b> ${escapeHtml(window.CCY)}</div>
            <div>Equity value: <b>${fmtMoney(eq)}</b> ${escapeHtml(window.CCY)}</div>
            ${price !== null ? `<div>Cena: <b>${fmtMoney(price)}</b> ${escapeHtml(window.CCY)} vs. cena</div>` : ""}
          </div>
        </div>
      `;
    }

    box.innerHTML = `
      <div class="resultsGrid">
        ${card(res.labels.bear, res.fairPS.bear, res.ev.bear, res.eq.bear)}
        ${card(res.labels.base, res.fairPS.base, res.ev.base, res.eq.base)}
        ${card(res.labels.bull, res.fairPS.bull, res.ev.bull, res.eq.bull)}
      </div>
    `;
  }

  // --- Chart.js (pokud existuje)
  let _chart = null;
  function drawChart(res){
    const canvas = document.getElementById("dcfChart");
    if(!canvas) return;

    if(typeof window.Chart !== "function"){
      // Chart.js nen√≠ naƒçten ‚Äì nic nedƒõl√°me
      return;
    }

    const ctx = canvas.getContext("2d");
    const labels = [res.labels.bear, res.labels.base, res.labels.bull];
    const data = [res.fairPS.bear, res.fairPS.base, res.fairPS.bull];

    if(_chart) { _chart.destroy(); _chart = null; }

    _chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{ label: "Fair value / share", data }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { ticks: { callback: (v)=> fmtMoney(v) } } }
      }
    });
  }

  // --- compute DCF (ochrany)
  function computeDCF(){
    const ticker = (document.getElementById("inTicker")?.value || "").trim();

    const fcf0   = parseNum(document.getElementById("inFCF")?.value);
    const years  = parseNum(document.getElementById("inYears")?.value);
    const rP     = parseNum(document.getElementById("inR")?.value);
    const tgP    = parseNum(document.getElementById("inTG")?.value);
    const netd   = parseNum(document.getElementById("inNetD")?.value);
    const shares = parseNum(document.getElementById("inShares")?.value);
    const price  = parseNum(document.getElementById("inPrice")?.value);

    const gBearP = parseNum(document.getElementById("inGBear")?.value);
    const gBaseP = parseNum(document.getElementById("inGBase")?.value);
    const gBullP = parseNum(document.getElementById("inGBull")?.value);

    // protections
    const errs = [];
    if(!isFinite(fcf0) || fcf0 <= 0) errs.push("FCF mus√≠ b√Ωt > 0");
    if(!isFinite(years) || years < 1 || years > 50) errs.push("Poƒçet let mus√≠ b√Ωt 1‚Äì50");
    if(!isFinite(rP) || rP <= 0 || rP > 50) errs.push("Diskont (r) mus√≠ b√Ωt 0‚Äì50 %");
    if(!isFinite(tgP) || tgP < -10 || tgP > 20) errs.push("Terminal growth (tg) mimo rozumn√Ω rozsah");
    if(isFinite(tgP) && isFinite(rP) && tgP >= rP) errs.push("tg mus√≠ b√Ωt men≈°√≠ ne≈æ r (jinak TV ned√°v√° smysl)");
    if(!isFinite(shares) || shares <= 0) errs.push("Poƒçet akci√≠ mus√≠ b√Ωt > 0");
    if(!isFinite(gBearP) || !isFinite(gBaseP) || !isFinite(gBullP)) errs.push("Vypl≈à r≈Østy Bear/Base/Bull");
    if(isFinite(gBearP) && isFinite(gBaseP) && isFinite(gBullP) && !(gBearP <= gBaseP && gBaseP <= gBullP)){
      errs.push("Doporuƒçen√≠: Bear ‚â§ Base ‚â§ Bull (kv≈Øli logice sc√©n√°≈ô≈Ø)");
    }

    if(errs.length){
      toast("Chyba ve vstupech", errs.join("\n"));
      return null;
    }

    const r  = rP / 100;
    const tg = tgP / 100;

    const gb = gBearP / 100;
    const g0 = gBaseP / 100;
    const gu = gBullP / 100;

    const bear = calcScenario(fcf0, years, r, gb, tg);
    const base = calcScenario(fcf0, years, r, g0, tg);
    const bull = calcScenario(fcf0, years, r, gu, tg);

    // EV -> Equity -> per share
    const ev = { bear: bear.ev, base: base.ev, bull: bull.ev };
    const eq = {
      bear: ev.bear - (isFinite(netd) ? netd : 0),
      base: ev.base - (isFinite(netd) ? netd : 0),
      bull: ev.bull - (isFinite(netd) ? netd : 0)
    };

    const fairPS = {
      bear: eq.bear / shares,
      base: eq.base / shares,
      bull: eq.bull / shares
    };

    const labels = (window.LANG === "cs")
      ? { bear:"Bear", base:"Base", bull:"Bull" }
      : { bear:"Bear", base:"Base", bull:"Bull" };

    const inputs = {
      ticker,
      fcf0, years,
      rP, tgP,
      netd: isFinite(netd) ? netd : 0,
      shares,
      price: isFinite(price) ? price : null,
      gBearP, gBaseP, gBullP,
      ccy: window.CCY,
      lang: window.LANG,
      ts: Date.now()
    };

    return { labels, fairPS, ev, eq, inputs };
  }

  // --- save to localStorage (DCF item)
  function saveToWatchlist(item){
    const key = "equity_analyzer_watchlist_v1";
    let arr = [];
    try { arr = JSON.parse(localStorage.getItem(key) || "[]"); } catch(e){ arr = []; }
    arr.unshift(item);
    // max 100
    if(arr.length > 100) arr = arr.slice(0, 100);
    localStorage.setItem(key, JSON.stringify(arr));
  }

  // --- PDF export (print)
function openPdf(item){
  const dt = new Date(item?.inputs?.ts || Date.now());
  const locale = (window.LANG === "cs") ? "cs-CZ" : "en-US";
  const dateStr = dt.toLocaleDateString(locale);

  const title = (window.LANG === "cs") ? "DCF report" : "DCF report";
  const subtitle = (window.LANG === "cs")
    ? "Odhad f√©rov√© ceny (Bear/Base/Bull)"
    : "Fair value estimate (Bear/Base/Bull)";

  const rows = [
    ["Ticker", item?.inputs?.ticker || "‚Äî"],
    ["Currency", item?.inputs?.ccy || window.CCY || "‚Äî"],
    ["FCF0", fmtMoney(item?.inputs?.fcf0)],
    ["Years", String(item?.inputs?.years ?? "‚Äî")],
    ["Discount rate r %", fmtMoney(item?.inputs?.rP)],
    ["Terminal growth tg %", fmtMoney(item?.inputs?.tgP)],
    ["Net debt / cash", fmtMoney(item?.inputs?.netd)],
    ["Shares", fmtMoney(item?.inputs?.shares)],
    ["Price (optional)", (item?.inputs?.price == null) ? "‚Äî" : fmtMoney(item.inputs.price)],
    ["Growth Bear %", fmtMoney(item?.inputs?.gBearP)],
    ["Growth Base %", fmtMoney(item?.inputs?.gBaseP)],
    ["Growth Bull %", fmtMoney(item?.inputs?.gBullP)],
  ];

  const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>${escapeHtml(title)}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:24px;}
    h1{margin:0 0 6px;}
    .muted{color:#555; margin:0 0 18px;}
    .box{border:1px solid #ddd; border-radius:12px; padding:14px; margin:12px 0;}
    table{width:100%; border-collapse:collapse;}
    td{padding:8px 6px; border-bottom:1px solid #eee;}
    td:first-child{width:240px; color:#444;}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(3,minmax(0,1fr));}
    .card{border:1px solid #ddd; border-radius:12px; padding:12px;}
    .label{font-weight:900;}
    .value{font-size:20px; font-weight:900;}
    .small{color:#555; font-size:12px; margin-top:6px;}
    @media print{button{display:none;}}
  </style>
</head>
<body>
  <h1>${escapeHtml(item?.inputs?.ticker || "‚Äî")} ‚Äì ${escapeHtml(title)}</h1>
  <p class="muted">${escapeHtml(subtitle)} ‚Ä¢ ${escapeHtml(dateStr)} ‚Ä¢ ${escapeHtml(item?.inputs?.ccy || window.CCY || "")}</p>

  <div class="box">
    <h3 style="margin:0 0 10px;">Inputs</h3>
    <table>
      ${rows.map(r => `<tr><td>${escapeHtml(r[0])}</td><td>${escapeHtml(String(r[1]))}</td></tr>`).join("")}
    </table>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Bear</div>
      <div class="value">${fmtMoney(item?.fairPS?.bear)} ${escapeHtml(item?.inputs?.ccy || window.CCY || "")}</div>
      <div class="small">EV: ${fmtMoney(item?.ev?.bear)} ‚Ä¢ Equity: ${fmtMoney(item?.eq?.bear)}</div>
    </div>
    <div class="card">
      <div class="label">Base</div>
      <div class="value">${fmtMoney(item?.fairPS?.base)} ${escapeHtml(item?.inputs?.ccy || window.CCY || "")}</div>
      <div class="small">EV: ${fmtMoney(item?.ev?.base)} ‚Ä¢ Equity: ${fmtMoney(item?.eq?.base)}</div>
    </div>
    <div class="card">
      <div class="label">Bull</div>
      <div class="value">${fmtMoney(item?.fairPS?.bull)} ${escapeHtml(item?.inputs?.ccy || window.CCY || "")}</div>
      <div class="small">EV: ${fmtMoney(item?.ev?.bull)} ‚Ä¢ Equity: ${fmtMoney(item?.eq?.bull)}</div>
    </div>
  </div>

  <p class="muted" style="margin-top:18px;">Generated by Equity Analyzer</p>
  <script>window.print();</script>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  if(!w){ toast("PDF", (window.LANG==="cs") ? "Povol pop-up okna pro tisk." : "Please allow pop-ups for printing."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// --- WATCHLIST (storage + UI)
function getWatchlist(){
  const key = "equity_analyzer_watchlist_v1";
  try{
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}

function setWatchlist(arr){
  const key = "equity_analyzer_watchlist_v1";
  localStorage.setItem(key, JSON.stringify(arr || []));
}

function removeWatchItem(idx){
  const arr = getWatchlist();
  arr.splice(idx, 1);
  setWatchlist(arr);
  renderWatchlist();
}

function loadWatchItem(idx){
  const arr = getWatchlist();
  const item = arr[idx];
  if(!item) return;

  // nahraj do input≈Ø (pokud existuj√≠)
  const I = item.inputs || {};
  const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = (v ?? ""); };

  setVal("inTicker", I.ticker || "");
  setVal("inFCF", I.fcf0);
  setVal("inYears", I.years);
  setVal("inR", I.rP);
  setVal("inTG", I.tgP);
  setVal("inNetD", I.netd);
  setVal("inShares", I.shares);
  setVal("inPrice", (I.price==null ? "" : I.price));
  setVal("inGBear", I.gBearP);
  setVal("inGBase", I.gBaseP);
  setVal("inGBull", I.gBullP);

  // nastav mƒõnu (pokud existuje infrastruktura)
  if(typeof window.CCY === "string" && I.ccy) window.CCY = I.ccy;

  // p≈ôepni na DCF screen a vykresli v√Ωsledky
  if(typeof showScreen === "function") showScreen("dcf");
  window.__LAST_DCF__ = item;
  if(typeof renderResults === "function") renderResults(item);
  if(typeof drawChart === "function") drawChart(item);
}

function openWatchlistPdf(){
  const arr = getWatchlist();
  const locale = (window.LANG === "cs") ? "cs-CZ" : "en-US";
  const title = (window.LANG === "cs") ? "Watchlist ‚Äì export" : "Watchlist ‚Äì export";
  const subtitle = (window.LANG === "cs")
    ? "Ulo≈æen√© DCF v√Ωpoƒçty"
    : "Saved DCF calculations";

  const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>${escapeHtml(title)}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:24px;}
    h1{margin:0 0 6px;}
    .muted{color:#555; margin:0 0 18px;}
    .item{border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0;}
    .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .t{font-weight:900; font-size:16px;}
    .small{color:#555; font-size:12px;}
    .row{margin-top:8px; display:grid; gap:6px; grid-template-columns:repeat(3,minmax(0,1fr));}
    .box{border:1px solid #eee; border-radius:10px; padding:10px;}
    .lbl{font-weight:800;}
    .val{font-weight:900; font-size:18px;}
    @media print{button{display:none;}}
  </style>
</head>
<body>
  <h1>${escapeHtml(title)}</h1>
  <p class="muted">${escapeHtml(subtitle)} ‚Ä¢ ${escapeHtml(new Date().toLocaleDateString(locale))}</p>

  ${arr.length ? arr.map((it)=>{
    const dt = new Date(it?.inputs?.ts || Date.now()).toLocaleDateString(locale);
    const ccy = it?.inputs?.ccy || window.CCY || "";
    const tick = it?.inputs?.ticker || "‚Äî";
    return `
      <div class="item">
        <div class="top">
          <div>
            <div class="t">${escapeHtml(tick)} <span class="small">(${escapeHtml(ccy)})</span></div>
            <div class="small">${escapeHtml(dt)}</div>
          </div>
        </div>
        <div class="row">
          <div class="box"><div class="lbl">Bear</div><div class="val">${fmtMoney(it?.fairPS?.bear)} ${escapeHtml(ccy)}</div></div>
          <div class="box"><div class="lbl">Base</div><div class="val">${fmtMoney(it?.fairPS?.base)} ${escapeHtml(ccy)}</div></div>
          <div class="box"><div class="lbl">Bull</div><div class="val">${fmtMoney(it?.fairPS?.bull)} ${escapeHtml(ccy)}</div></div>
        </div>
      </div>
    `;
  }).join("") : `<div class="muted">${escapeHtml(window.LANG==="cs" ? "Watchlist je pr√°zdn√Ω." : "Watchlist is empty.")}</div>`}

  <script>window.print();</script>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  if(!w){ toast("PDF", (window.LANG==="cs") ? "Povol pop-up okna pro tisk." : "Please allow pop-ups for printing."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

function renderWatchlist(){
  const box = document.getElementById("watchBox");
  if(!box) return;

  const arr = getWatchlist();
  if(!arr.length){
    box.innerHTML = `<div class="empty">${escapeHtml(window.LANG==="cs" ? "Watchlist je pr√°zdn√Ω." : "Watchlist is empty.")}</div>`;
    return;
  }

  const locale = (window.LANG === "cs") ? "cs-CZ" : "en-US";

  box.innerHTML = arr.map((it, idx)=>{
    const dt = new Date(it?.inputs?.ts || Date.now()).toLocaleDateString(locale);
    const ccy = it?.inputs?.ccy || window.CCY || "";
    const tick = it?.inputs?.ticker || "‚Äî";
    return `
      <div class="watchItem" data-idx="${idx}">
        <div class="watchMain">
          <div class="watchTitle">${escapeHtml(tick)}</div>
          <div class="watchSub">
            <span>${escapeHtml(dt)}</span>
            <span class="chip">${escapeHtml(ccy)}</span>
          </div>
          <div class="watchVals">
            <span>Bear: <b>${fmtMoney(it?.fairPS?.bear)} ${escapeHtml(ccy)}</b></span>
            <span>Base: <b>${fmtMoney(it?.fairPS?.base)} ${escapeHtml(ccy)}</b></span>
            <span>Bull: <b>${fmtMoney(it?.fairPS?.bull)} ${escapeHtml(ccy)}</b></span>
          </div>
        </div>
        <div class="watchBtns">
          <button class="btnMini" type="button" data-act="pdf">PDF</button>
          <button class="btnMini danger" type="button" data-act="del">${escapeHtml(window.LANG==="cs" ? "Smazat" : "Delete")}</button>
        </div>
      </div>
    `;
  }).join("");

  // event delegation
  box.onclick = (e)=>{
    const itemEl = e.target.closest(".watchItem");
    if(!itemEl) return;
    const idx = Number(itemEl.getAttribute("data-idx"));
    const act = e.target?.getAttribute("data-act");

    if(act === "del"){
      removeWatchItem(idx);
      return;
    }
    if(act === "pdf"){
      const arr = getWatchlist();
      const it = arr[idx];
      if(it) openPdf(it);
      return;
    }

    // klik na polo≈æku -> load
    loadWatchItem(idx);
  };
}

// --- bind WATCHLIST screen buttons (pokud existuj√≠)
document.addEventListener("DOMContentLoaded", ()=>{
  // Pokud m√°≈° tlaƒç√≠tko pro PDF export watchlistu:
  const btn = document.getElementById("btnPdfWatch");
  if(btn) btn.addEventListener("click", openWatchlistPdf);

  // Pokud renderuje≈° watchlist p≈ôi vstupu na screen:
  renderWatchlist();
});

/* ---------- NAV / SCREEN bindings (jen pokud existuj√≠ elementy) ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // Home buttons/cards
  const goDCF   = document.getElementById("goDCF");
  const goWatch = document.getElementById("goWatch");
  const goAbout = document.getElementById("goAbout");

  if(goDCF)   goDCF.addEventListener("click", ()=> showScreen("dcf"));
  if(goWatch) goWatch.addEventListener("click", ()=> { showScreen("watch"); renderWatchlist(); });
  if(goAbout) goAbout.addEventListener("click", ()=> showScreen("about"));

  // DCF back handled v DCF ƒç√°sti (btnBackDCF)

  // Watch back
  const btnBackWatch = document.getElementById("btnBackWatch");
  if (btnBackWatch) btnBackWatch.addEventListener("click", () => showScreen("home"));

  // About back
  const btnBackAbout = document.getElementById("btnBackAbout");
  if (btnBackAbout) btnBackAbout.addEventListener("click", () => showScreen("home"));
});

  /* ===================== END OF PART 3 ===================== */
</script>
</body>
</html>

        
    



    





  
  


  





        


        



  


 

            

        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





