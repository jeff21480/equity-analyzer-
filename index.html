<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Equity Analyzer</title>

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a35;
      --card2:#182255;
      --primary:#6d7cff;
      --secondary:#8a5cff;
      --text:#e8ebff;
      --muted:#aab0ff;
      --border:rgba(255,255,255,.08);
    }

    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}

    body{
      margin:0;
      background:radial-gradient(1200px 600px at 20% -10%, #1a2360 0%, var(--bg) 60%);
      color:var(--text);
    }

    .wrap{
      max-width:1100px;
      margin:auto;
      padding:24px 16px 64px;
    }

    /* HEADER */
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:28px;
    }

    .title{
      font-size:36px;
      font-weight:800;
      letter-spacing:.5px;
    }

    .lang{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
    }

    .lang select{
      background:transparent;
      color:var(--text);
      border:none;
      outline:none;
      font-size:14px;
    }

    /* ACCORDION */
    .acc{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border);
      border-radius:18px;
      margin-bottom:18px;
      overflow:hidden;
    }

    .acc .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 20px;
      cursor:pointer;
    }

    .acc .hleft{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .badge{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }

    .htitle{
      font-size:18px;
      font-weight:700;
    }

    .chev{
      font-size:18px;
      opacity:.7;
      transition:.2s;
    }

    .acc.open .chev{transform:rotate(180deg)}

    .acc .body{
      display:none;
      padding:0 20px 20px;
    }

    .acc.open .body{display:block}

    /* INFO ICON */
    .hint{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      width:18px;
      height:18px;
      border-radius:50%;
      background:rgba(255,255,255,.12);
      font-size:12px;
      cursor:pointer;
      margin-left:6px;
    }

    .footer{
      margin-top:40px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
      opacity:.8;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="top">
      <div class="title" id="ui_title">Equity Analyzer</div>
      <div class="lang">
        <select id="langSel">
          <option value="en">EN</option>
          <option value="cz">CZ</option>
        </select>
      </div>
    </div>

    <!-- ACC 1: ANALYZER -->
    <div class="acc open" id="acc_calc">
      <div class="head">
        <div class="hleft">
          <span class="badge" id="ui_calcBadge">Analyzer</span>
          <span class="htitle" id="ui_calcTitle">Valuation model</span>
        </div>
        <div class="chev">▾</div>
      </div>
      <div class="body">
        <!-- PART 2 will insert calculator UI here -->
      </div>
    </div>

    <!-- ACC 2: WATCHLIST -->
    <div class="acc" id="acc_watch">
      <div class="head">
        <div class="hleft">
          <span class="badge" id="ui_watchBadge">Watchlist</span>
          <span class="htitle" id="ui_watchTitle">Saved valuations</span>
        </div>
        <div class="chev">▾</div>
      </div>
      <div class="body">
        <!-- PART 3 will insert watchlist here -->
      </div>
    </div>

    <!-- ACC 3: GUIDE -->
    <div class="acc" id="acc_guide">
      <div class="head">
        <div class="hleft">
          <span class="badge" id="ui_guideBadge">Guide</span>
          <span class="htitle" id="ui_guideTitle">How this app works</span>
        </div>
        <div class="chev">▾</div>
      </div>
      <div class="body">
        <!-- PART 4 will insert guide + disclaimer here -->
      </div>
    </div>

    <div class="footer" id="ui_footer">
      Educational tool · Not investment advice
    </div>

  </div>

  <script>
    // accordion logic
    document.querySelectorAll(".acc .head").forEach(h=>{
      h.addEventListener("click",()=>{
        h.parentElement.classList.toggle("open");
      });
    });

    // language base (will be expanded later)
    const state={lang:"en"};
    const langSel=document.getElementById("langSel");
    langSel.addEventListener("change",()=>{
      state.lang=langSel.value;
      // PART 4 will handle translations
    });
  </script>

</body>
</html>

<!-- =========================
PART 1 END
========================= --><!-- =========================
PART 2 START (PUT INSIDE ACC 1 .body)
========================= -->

<div style="margin-top:14px;color:var(--muted);line-height:1.35" id="ui_calcDesc">
  Enter inputs, choose metric type, then calculate fair value per share. Use the (i) icons for help.
</div>

<div class="accInner" style="margin-top:14px">
  <style>
    /* PART2 scoped styles */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
    }
    @media (max-width:720px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:720px){
      .row{grid-template-columns:1fr;}
    }
    .field{
      background:rgba(0,0,0,.15);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .lbl{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-weight:700;
    }
    .mini{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top:6px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input::placeholder{color:rgba(232,235,255,.45)}
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:white;
      font-weight:800;
      cursor:pointer;
      letter-spacing:.2px;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    .btn.danger{
      background:rgba(255,80,120,.12);
      color:#ffd7e2;
    }
    .warn{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      display:none;
    }
    .results{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .results{grid-template-columns:1fr;}
    }
    .res{
      background:rgba(255,255,255,.05);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .res .k{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
      font-weight:700;
    }
    .res .v{
      font-size:24px;
      font-weight:900;
      letter-spacing:.3px;
    }
    .res .s{
      color:rgba(232,235,255,.7);
      font-size:12px;
      margin-top:8px;
      line-height:1.35;
    }
    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      max-width:520px;
      width:100%;
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
    }
    .modalTitle{
      font-weight:900;
      letter-spacing:.2px;
    }
    .xbtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
    }
    .modalBody{
      padding:14px 16px 18px;
      color:rgba(232,235,255,.85);
      line-height:1.45;
      font-size:14px;
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      display:none;
      z-index:60;
      max-width:92vw;
    }
  </style>

  <div class="card">
    <div class="row">
      <div class="field">
        <div class="lbl">
          <span id="ui_tickerLbl">Ticker</span>
          <span class="hint" data-help="ticker">i</span>
        </div>
        <input id="in_ticker" placeholder="AAPL, MSFT..." />
        <div class="mini" id="ui_tickerMini">Used only for saving into Watchlist.</div>
      </div>

      <div class="field">
        <div class="lbl">
          <span id="ui_curLbl">Currency</span>
          <span class="hint" data-help="cur">i</span>
        </div>
        <select id="in_cur">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="CZK">CZK</option>
          <option value="GBP">GBP</option>
        </select>
        <div class="mini" id="ui_curMini">Formatting only; does not change valuation math.</div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <div class="lbl">
          <span id="ui_priceLbl">Current price</span>
          <span class="hint" data-help="price">i</span>
        </div>
        <input id="in_price" inputmode="decimal" placeholder="e.g. 185.30" />
        <div class="mini" id="ui_priceMini">Used to compute upside/downside vs your fair value.</div>
      </div>

      <div class="field">
        <div class="lbl">
          <span id="ui_metricLbl">Metric type</span>
          <span class="hint" data-help="metric">i</span>
        </div>
        <select id="in_metric">
          <option value="fcf_ps" id="opt_fcf_ps">FCF per share</option>
          <option value="eps" id="opt_eps">Earnings (EPS)</option>
          <option value="div" id="opt_div">Dividend per share</option>
          <option value="rev_ps" id="opt_rev_ps">Revenue per share (rough)</option>
          <option value="fcf_total" id="opt_fcf_total">Total FCF (needs shares)</option>
          <option value="rev_total" id="opt_rev_total">Total Revenue (needs shares)</option>
        </select>
        <div class="mini" id="ui_metricMini">Pick the most stable “per share” metric for the business.</div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <div class="lbl">
          <span id="ui_metricValueLbl">Metric value</span>
          <span class="hint" data-help="metricValue">i</span>
        </div>
        <input id="in_metricValue" inputmode="decimal" placeholder="e.g. 7.5" />
        <div class="mini" id="ui_metricValueMini">Value for chosen metric. Example: FCF/share = 7.5 USD.</div>
      </div>

      <div class="field" id="sharesWrap" style="display:none">
        <div class="lbl">
          <span id="ui_sharesLbl">Shares outstanding</span>
          <span class="hint" data-help="shares">i</span>
        </div>
        <input id="in_shares" inputmode="decimal" placeholder="e.g. 15.7B or 15700M" />
        <div class="mini" id="ui_sharesMini">Used only when you enter TOTAL metrics (FCF total / Revenue total).</div>
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <div class="lbl">
          <span id="ui_yearsLbl">Projection years</span>
          <span class="hint" data-help="years">i</span>
        </div>
        <input id="in_years" inputmode="decimal" placeholder="e.g. 10" value="10" />
        <div class="mini" id="ui_yearsMini">How many years the metric grows before terminal value.</div>
      </div>

      <div class="field">
        <div class="lbl">
          <span id="ui_discLbl">Discount rate (r)</span>
          <span class="hint" data-help="disc">i</span>
        </div>
        <input id="in_disc" inputmode="decimal" placeholder="e.g. 0.09 (9%)" value="0.09" />
        <div class="mini" id="ui_discMini">Your required return (often 8–12%).</div>
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <div class="lbl">
          <span id="ui_termLbl">Terminal growth</span>
          <span class="hint" data-help="term">i</span>
        </div>
        <input id="in_term" inputmode="decimal" placeholder="e.g. 0.03 (3%)" value="0.03" />
        <div class="mini" id="ui_termMini">Long-term growth after projection (must be < discount rate).</div>
      </div>

      <div class="field">
        <div class="lbl">
          <span id="ui_mosLbl">Margin of safety</span>
          <span class="hint" data-help="mos">i</span>
        </div>
        <input id="in_mos" inputmode="decimal" placeholder="e.g. 0.20 (20%)" value="0.20" />
        <div class="mini" id="ui_mosMini">Optional discount applied to Base fair value for target buy price.</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="font-weight:900" id="ui_scenTitle">Scenario growth rates</div>
      <div style="color:var(--muted);margin-top:6px" id="ui_scenText">
        Set Bear/Base/Bull growth for your metric (per year).
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <div class="lbl">
            <span id="ui_bearLbl">Bear (%)</span>
            <span class="hint" data-help="bear">i</span>
          </div>
          <input id="in_bear" inputmode="decimal" placeholder="e.g. 0.02 (2%)" value="0.02" />
          <div class="mini" id="ui_bearMini">Conservative growth if things go poorly.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_baseLbl">Base (%)</span>
            <span class="hint" data-help="base">i</span>
          </div>
          <input id="in_base" inputmode="decimal" placeholder="e.g. 0.08 (8%)" value="0.08" />
          <div class="mini" id="ui_baseMini">Your realistic “most likely” path.</div>
        </div>

        <div class="field">
          <div class="lbl">
            <span id="ui_bullLbl">Bull (%)</span>
            <span class="hint" data-help="bull">i</span>
          </div>
          <input id="in_bull" inputmode="decimal" placeholder="e.g. 0.15 (15%)" value="0.15" />
          <div class="mini" id="ui_bullMini">Optimistic growth if execution is excellent.</div>
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="btn" id="btn_calc">Calculate</button>
      <button class="btn secondary" id="btn_save">Save to Watchlist</button>
      <button class="btn danger" id="btn_reset">Reset</button>
    </div>

    <div class="warn" id="warnBox"></div>

    <div class="results">
      <div class="res">
        <div class="k"><span id="ui_resBear">Bear</span> <span class="badge">FV</span></div>
        <div class="v" id="r_bear">—</div>
        <div class="s" id="r_bear_s">—</div>
      </div>
      <div class="res">
        <div class="k"><span id="ui_resBase">Base</span> <span class="badge">FV</span></div>
        <div class="v" id="r_base">—</div>
        <div class="s" id="r_base_s">—</div>
      </div>
      <div class="res">
        <div class="k"><span id="ui_resBull">Bull</span> <span class="badge">FV</span></div>
        <div class="v" id="r_bull">—</div>
        <div class="s" id="r_bull_s">—</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="field">
        <div class="lbl">
          <span id="ui_targetLbl">Target buy price (Base - MoS)</span>
          <span class="hint" data-help="target">i</span>
        </div>
        <input id="out_target" readonly />
        <div class="mini" id="ui_targetMini">A “safer” buy price after applying margin of safety.</div>
      </div>

      <div class="field">
        <div class="lbl">
          <span id="ui_rangeLbl">Fair value range</span>
          <span class="hint" data-help="range">i</span>
        </div>
        <input id="out_range" readonly />
        <div class="mini" id="ui_rangeMini">Bear → Bull fair value range.</div>
      </div>
    </div>

  </div>

  <!-- Toast + Modal -->
  <div class="toast" id="toast"></div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Info</div>
        <button class="xbtn" id="modalClose">×</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ===== PART 2 JS (calculator + help modal) =====
    const $ = (id)=>document.getElementById(id);

    // show/hide shares field based on metric
    const metricSel = $("in_metric");
    const sharesWrap = $("sharesWrap");
    function syncSharesVisibility(){
      const v = metricSel.value;
      const needsShares = (v === "fcf_total" || v === "rev_total");
      sharesWrap.style.display = needsShares ? "" : "none";
    }
    metricSel.addEventListener("change", syncSharesVisibility);
    syncSharesVisibility();

    // toast
    function toast(msg){
      const t=$("toast"); if(!t) return;
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.style.display="none", 2200);
    }

    // modal
    function openModal(title, bodyHtml){
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("modalBack").style.display = "flex";
    }
    function closeModal(){
      $("modalBack").style.display = "none";
    }
    $("modalBack").addEventListener("click",(e)=>{
      if(e.target === $("modalBack")) closeModal();
    });
    $("modalClose").addEventListener("click", closeModal);

    // number parser (supports spaces, comma decimals, suffix K/M/B)
    function parseNum(v){
      if(v===null || v===undefined) return NaN;
      let s = String(v).trim();
      if(!s) return NaN;
      s = s.replace(/\s+/g,"");   // remove spaces
      s = s.replace(",",".");     // comma decimal
      const last = s.slice(-1).toLowerCase();
      let mult = 1;
      if(last==="k"){ mult=1e3; s=s.slice(0,-1); }
      if(last==="m"){ mult=1e6; s=s.slice(0,-1); }
      if(last==="b"){ mult=1e9; s=s.slice(0,-1); }
      const n = Number(s);
      if(!Number.isFinite(n)) return NaN;
      return n*mult;
    }

    function fmtMoney(n, cur){
      if(!Number.isFinite(n)) return "—";
      const loc = (state.lang==="cz") ? "cs-CZ" : "en-US";
      try{
        return new Intl.NumberFormat(loc,{style:"currency",currency:cur,maximumFractionDigits:2}).format(n);
      }catch{
        return `${n.toFixed(2)} ${cur}`;
      }
    }
    function fmtPct(n){
      if(!Number.isFinite(n)) return "";
      const sign = n>0 ? "+" : "";
      return `${sign}${n.toFixed(1)}%`;
    }

    // PV of growing metric per share + terminal value (Gordon)
    function pvPerShare(metricPS, years, g, r, gTerm){
      let pv=0;
      let f=metricPS;
      for(let t=1; t<=years; t++){
        f = f*(1+g);
        pv += f/Math.pow(1+r, t);
      }
      const tv = (f*(1+gTerm))/(r-gTerm);
      pv += tv/Math.pow(1+r, years);
      return pv;
    }

    // warning UI
    function setWarn(msg){
      const w=$("warnBox");
      if(!msg){ w.style.display="none"; w.textContent=""; return; }
      w.style.display="block"; w.textContent=msg;
    }

    // calculate
    function calculate(){
      setWarn("");

      const cur = $("in_cur").value;
      const price = parseNum($("in_price").value);
      const metricType = $("in_metric").value;
      const metricRaw = parseNum($("in_metricValue").value);

      const years = Math.round(parseNum($("in_years").value));
      const r = parseNum($("in_disc").value);
      const gTerm = parseNum($("in_term").value);

      const gBear = parseNum($("in_bear").value);
      const gBase = parseNum($("in_base").value);
      const gBull = parseNum($("in_bull").value);

      const mos = parseNum($("in_mos").value);

      if(!Number.isFinite(metricRaw) || !Number.isFinite(r) || !Number.isFinite(gTerm) || !Number.isFinite(years)){
        setWarn(state.lang==="cz" ? "Chybí nebo jsou špatné vstupy." : "Missing or invalid inputs.");
        return null;
      }
      if(!(r > gTerm)){
        setWarn(state.lang==="cz"
          ? "Diskont (r) musí být větší než terminální růst."
          : "Discount rate (r) must be greater than terminal growth.");
        return null;
      }
      if(years<1 || years>40){
        setWarn(state.lang==="cz" ? "Roky projekce musí být 1–40." : "Projection years must be 1–40.");
        return null;
      }

      let metricPS = metricRaw;

      // if metric is TOTAL -> divide by shares
      if(metricType === "fcf_total" || metricType === "rev_total"){
        const shares = parseNum($("in_shares").value);
        if(!Number.isFinite(shares) || shares<=0){
          setWarn(state.lang==="cz" ? "U TOTAL metrik musíš zadat počet akcií." : "For TOTAL metrics you must enter shares outstanding.");
          return null;
        }
        metricPS = metricRaw / shares;
      }

      const bear = pvPerShare(metricPS, years, gBear, r, gTerm);
      const base = pvPerShare(metricPS, years, gBase, r, gTerm);
      const bull = pvPerShare(metricPS, years, gBull, r, gTerm);

      const target = base * (1 - (Number.isFinite(mos) ? mos : 0));
      const range = `${fmtMoney(bear,cur)} – ${fmtMoney(bull,cur)}`;

      $("r_bear").textContent = fmtMoney(bear,cur);
      $("r_base").textContent = fmtMoney(base,cur);
      $("r_bull").textContent = fmtMoney(bull,cur);

      const pct = (v)=> (Number.isFinite(price) && price>0) ? ((v/price)-1)*100 : NaN;

      $("r_bear_s").textContent =
        Number.isFinite(price) ? `${(state.lang==="cz"?"Cena":"Price")}: ${fmtMoney(price,cur)} · ${fmtPct(pct(bear))}` : "—";
      $("r_base_s").textContent =
        `${metricName(metricType)} · ${(state.lang==="cz"?"Roky":"Years")}: ${years}, ${(state.lang==="cz"?"Diskont":"Discount")}: ${(r*100).toFixed(1)}%`;
      $("r_bull_s").textContent =
        `${(state.lang==="cz"?"Terminál":"Terminal")}: ${(gTerm*100).toFixed(1)}% · MoS: ${Number.isFinite(mos)?(mos*100).toFixed(0):0}%`;

      $("out_target").value = fmtMoney(target,cur);
      $("out_range").value = range;

      const result = {
        ts: Date.now(),
        date: new Date().toISOString().slice(0,10),
        ticker: ($("in_ticker").value || "").trim().toUpperCase(),
        cur, price,
        metricType, metricRaw, metricPS,
        years, r, gTerm,
        gBear, gBase, gBull,
        mos, bear, base, bull, target, rangeText: range
      };

      state.last = result;
      return result;
    }

    function metricName(t){
      const L = state.lang;
      const map = {
        fcf_ps:  L==="cz" ? "FCF na akcii" : "FCF per share",
        eps:     L==="cz" ? "Zisk (EPS)" : "Earnings (EPS)",
        div:     L==="cz" ? "Dividenda na akcii" : "Dividend per share",
        rev_ps:  L==="cz" ? "Tržby na akcii" : "Revenue per share",
        fcf_total: L==="cz" ? "Celkové FCF" : "Total FCF",
        rev_total: L==="cz" ? "Celkové tržby" : "Total Revenue"
      };
      return map[t] || t;
    }

    // buttons
    $("btn_calc").addEventListener("click", ()=>{
      const r = calculate();
      if(r) toast(state.lang==="cz" ? "Spočítáno." : "Calculated.");
    });

    $("btn_reset").addEventListener("click", ()=>{
      ["in_ticker","in_price","in_metricValue","in_shares"].forEach(id=>$(id).value="");
      setWarn("");
      ["r_bear","r_base","r_bull"].forEach(id=>$(id).textContent="—");
      ["r_bear_s","r_base_s","r_bull_s"].forEach(id=>$(id).textContent="—");
      $("out_target").value="";
      $("out_range").value="";
      toast(state.lang==="cz" ? "Resetováno." : "Reset.");
    });

    // Save button will be wired to PART 3 watchlist
    
// ====================== WATCHLIST (localStorage) ======================
const KEY = "eq_watch_v1";

function loadWatch(){
  try{
    const raw = localStorage.getItem(KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}

function saveWatchArr(arr){
  localStorage.setItem(KEY, JSON.stringify(arr));
}

function escCsv(s){
  const str = String(s ?? "");
  if(/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
  return str;
}

function renderWatch(){
  const body = $("watchBody");
  const empty = $("watchEmpty");
  if(!body) return;

  const arr = loadWatch();
  body.innerHTML = "";

  if(arr.length === 0){
    if(empty) empty.style.display = "";
    return;
  }
  if(empty) empty.style.display = "none";

  arr
    .slice()
    .sort((a,b)=> (b.ts||0)-(a.ts||0))
    .forEach((it, idx)=>{
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = it.date || "";
      tr.appendChild(tdDate);

      const tdTicker = document.createElement("td");
      tdTicker.textContent = (it.ticker||"").toUpperCase();
      tr.appendChild(tdTicker);

      const tdPrice = document.createElement("td");
      tdPrice.textContent = fmtMoney(it.price, it.cur);
      tr.appendChild(tdPrice);

      const tdMetric = document.createElement("td");
      tdMetric.textContent = metricName(it.metricType || it.metric || "");
      tr.appendChild(tdMetric);

      const tdBear = document.createElement("td");
      tdBear.textContent = fmtMoney(it.bear, it.cur);
      tr.appendChild(tdBear);

      const tdBase = document.createElement("td");
      tdBase.textContent = fmtMoney(it.base, it.cur);
      tr.appendChild(tdBase);

      const tdBull = document.createElement("td");
      tdBull.textContent = fmtMoney(it.bull, it.cur);
      tr.appendChild(tdBull);

      const tdTarget = document.createElement("td");
      tdTarget.textContent = fmtMoney(it.target, it.cur);
      tr.appendChild(tdTarget);

      const tdRange = document.createElement("td");
      tdRange.textContent = it.rangeText || "";
      tr.appendChild(tdRange);

      const tdAct = document.createElement("td");
      const bDel = document.createElement("button");
      bDel.className = "btn secondary";
      bDel.style.padding = "8px 10px";
      bDel.textContent = state.lang === "cz" ? "Smazat" : "Delete";
      bDel.addEventListener("click", ()=>{
        const arr2 = loadWatch();
        // delete by ts if possible
        const ts = it.ts;
        let next;
        if(Number.isFinite(ts)){
          next = arr2.filter(x => x.ts !== ts);
        }else{
          // fallback delete by index in sorted view:
          next = arr2.slice();
          next.splice(idx,1);
        }
        saveWatchArr(next);
        renderWatch();
        toast(state.lang==="cz" ? "Smazáno." : "Deleted.");
      });
      tdAct.appendChild(bDel);
      tr.appendChild(tdAct);

      body.appendChild(tr);
    });
}

window.saveWatch = function(result){
  const it = result || state.last;
  if(!it){
    toast(state.lang==="cz" ? "Nejdřív spočítej výsledek." : "Calculate first.");
    return;
  }

  // minimal required
  const ticker = (it.ticker||$("in_ticker")?.value||"").trim().toUpperCase();
  if(!ticker){
    toast(state.lang==="cz" ? "Doplň ticker." : "Enter ticker.");
    return;
  }

  const arr = loadWatch();

  const normalized = {
    ts: Date.now(),
    date: new Date().toISOString().slice(0,10),
    ticker,
    cur: it.cur || $("in_cur")?.value || "USD",
    price: it.price,
    metricType: it.metricType || it.metric,
    bear: it.bear,
    base: it.base,
    bull: it.bull,
    target: it.target,
    rangeText: it.rangeText || ($("out_range")?.value || "")
  };

  arr.push(normalized);
  saveWatchArr(arr);
  renderWatch();
  toast(state.lang==="cz" ? "Uloženo do watchlistu." : "Saved to watchlist.");
};

function exportCSV(){
  const arr = loadWatch();
  if(arr.length === 0){
    toast(state.lang==="cz" ? "Watchlist je prázdný." : "Watchlist is empty.");
    return;
  }

  const header = ["date","ticker","currency","price","metric","bear","base","bull","target","range"];
  const lines = [header.join(",")];

  arr.slice().sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(it=>{
    const row = [
      it.date,
      it.ticker,
      it.cur,
      it.price,
      metricName(it.metricType || it.metric || ""),
      it.bear,
      it.base,
      it.bull,
      it.target,
      it.rangeText
    ].map(escCsv);
    lines.push(row.join(","));
  });

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "equity-analyzer-watchlist.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  toast(state.lang==="cz" ? "CSV export hotový." : "CSV exported.");
}

function clearAll(){
  if(!confirm(state.lang==="cz" ? "Opravdu smazat celý watchlist?" : "Delete entire watchlist?")) return;
  localStorage.removeItem(KEY);
  renderWatch();
  toast(state.lang==="cz" ? "Watchlist smazán." : "Watchlist cleared.");
}

// wire buttons if exist
$("btn_export_csv")?.addEventListener("click", exportCSV);
$("btn_clear_all")?.addEventListener("click", clearAll);

// re-render on language switch (so Delete button text updates)
const _applyLangOrig = window.applyLang;
window.applyLang = function(){
  if(typeof _applyLangOrig === "function") _applyLangOrig();
  renderWatch();
};

// first paint
renderWatch();

// ====================== WATCHLIST END ======================// ====================== PART 4: GUIDE + HELP + ACCORDION + I18N ======================

// ---------- modal fallback (pokud už nemáš) ----------
function openModal(title, bodyHtml){
  const bd = $("modalBackdrop");
  const t  = $("modalTitle");
  const b  = $("modalBody");
  if(!bd || !t || !b){
    // fallback: alert bez HTML
    alert(title + "\n\n" + bodyHtml.replace(/<[^>]*>/g,""));
    return;
  }
  t.textContent = title;
  b.innerHTML = bodyHtml;
  bd.style.display = "flex";
}
function closeModal(){
  const bd = $("modalBackdrop");
  if(bd) bd.style.display = "none";
}
$("modalClose")?.addEventListener("click", closeModal);
$("modalBackdrop")?.addEventListener("click",(e)=>{
  if(e.target === $("modalBackdrop")) closeModal();
});

// ---------- HELP TEXTS (CZ/EN) ----------
const HELP = {
  en: {
    ticker: {t:"Ticker", b:"Stock symbol, e.g. AAPL, MSFT, NVDA."},
    price:  {t:"Current price", b:"Market price per share at the time of analysis."},
    cur:    {t:"Currency", b:"Currency used for price and results (USD/EUR/…)."},
    metric: {t:"Metric", b:"Choose what you want to value: EPS, Dividend, Revenue, FCF…"},
    basis:  {t:"Metric basis", b:"Per-share = already per share. Total = total company value (needs shares)."},
    metricValue:{t:"Metric value", b:"Latest annual value (TTM or last FY). You can use k/m/b suffix."},
    shares: {t:"Shares outstanding", b:"Number of shares (only needed if Metric basis = Total)."},
    years:  {t:"Projection years", b:"How many years you project growth before terminal value."},
    disc:   {t:"Discount rate", b:"Your required return (e.g., 9% = 0.09). Must be > terminal growth."},
    term:   {t:"Terminal growth", b:"Long-term growth after projection (e.g., 2–3% for mature firms)."},
    bear:   {t:"Bear growth", b:"Conservative growth for the metric during projection."},
    base:   {t:"Base growth", b:"Most realistic growth assumption."},
    bull:   {t:"Bull growth", b:"Optimistic growth assumption."},
    mos:    {t:"Margin of safety", b:"Optional safety discount applied to the Base result (e.g. 20% = 0.20)."},
    target: {t:"Target price", b:"Base value reduced by margin of safety (if used)."},
    range:  {t:"Valuation range", b:"Bear–Bull value range per share."}
  },
  cz: {
    ticker: {t:"Ticker", b:"Symbol akcie, např. AAPL, MSFT, NVDA."},
    price:  {t:"Aktuální cena", b:"Tržní cena za 1 akcii v době analýzy."},
    cur:    {t:"Měna", b:"Měna pro cenu i výsledek (USD/EUR/…)."},
    metric: {t:"Metodika / metrika", b:"Vyber, co chceš oceňovat: EPS, dividendu, tržby, FCF…"},
    basis:  {t:"Jednotky metriky", b:"Na akcii = už přepočteno na akcii. Celkem = hodnota firmy (potřebuje počet akcií)."},
    metricValue:{t:"Hodnota metriky", b:"Poslední roční hodnota (TTM nebo poslední FY). Lze použít k/m/b."},
    shares: {t:"Počet akcií", b:"Počet vydaných akcií (jen když je metrika „Celkem“)."},
    years:  {t:"Délka projekce", b:"Kolik let promítáš růst před terminálem."},
    disc:   {t:"Diskont", b:"Požadovaný výnos (např. 9% = 0,09). Musí být > terminální růst."},
    term:   {t:"Terminální růst", b:"Dlouhodobý růst po projekci (např. 2–3% pro vyzrálé firmy)."},
    bear:   {t:"Bear růst", b:"Konzervativní růst metriky v projekci."},
    base:   {t:"Base růst", b:"Nejrealističtější odhad růstu."},
    bull:   {t:"Bull růst", b:"Optimistický růst metriky."},
    mos:    {t:"Bezpečnostní polštář", b:"Volitelná sleva na Base výsledek (např. 20% = 0,20)."},
    target: {t:"Cílová cena", b:"Base hodnota snížená o margin of safety (pokud je použit)."},
    range:  {t:"Rozpětí", b:"Rozmezí Bear–Bull hodnoty na akcii."}
  }
};

// ---------- GUIDE TEXTS (CZ/EN) ----------
const GUIDE = {
  en: {
    title: "Guide",
    desc:
      "How to use the Equity Analyzer (educational tool).",
    sections: [
      {
        h:"What this app is",
        b:
          "<ul>" +
          "<li>This is an <strong>educational valuation helper</strong>.</li>" +
          "<li>It estimates an intrinsic value range (Bear/Base/Bull) from a chosen metric.</li>" +
          "<li>It stores your saved calculations in a local watchlist (in your browser).</li>" +
          "</ul>"
      },
      {
        h:"Which metric to choose",
        b:
          "<ul>" +
          "<li><strong>EPS</strong>: common for stable profitable companies.</li>" +
          "<li><strong>Dividend</strong>: dividend-focused businesses / mature firms.</li>" +
          "<li><strong>FCF per share</strong>: best when cash flow is meaningful (many quality businesses).</li>" +
          "<li><strong>Revenue per share</strong>: early-stage or low-profit firms (use conservative margins).</li>" +
          "<li><strong>Total FCF / Total Revenue</strong>: if you input totals, use Shares to convert to per-share.</li>" +
          "</ul>"
      },
      {
        h:"Important disclaimer",
        b:
          "<p><strong>Not investment advice.</strong> This tool does not predict markets. " +
          "It only helps you stress-test assumptions.</p>" +
          "<ul>" +
          "<li>Results depend heavily on growth + discount rate assumptions.</li>" +
          "<li>Always verify units (per share vs total).</li>" +
          "<li>Use a margin of safety for uncertainty.</li>" +
          "</ul>"
      }
    ]
  },
  cz: {
    title: "Průvodce",
    desc:
      "Jak používat Equity Analyzer (edukační nástroj).",
    sections: [
      {
        h:"Co tahle appka je",
        b:
          "<ul>" +
          "<li>Je to <strong>edukační pomůcka</strong> pro odhad férové hodnoty.</li>" +
          "<li>Počítá rozpětí vnitřní hodnoty (Bear/Base/Bull) z vybrané metriky.</li>" +
          "<li>Uložené výpočty se ukládají do watchlistu (pouze v prohlížeči).</li>" +
          "</ul>"
      },
      {
        h:"Jakou metriku vybrat",
        b:
          "<ul>" +
          "<li><strong>EPS</strong>: stabilní ziskové firmy.</li>" +
          "<li><strong>Dividenda</strong>: dividendové / vyzrálé firmy.</li>" +
          "<li><strong>FCF na akcii</strong>: často nejlepší, když je cash flow relevantní.</li>" +
          "<li><strong>Tržby na akcii</strong>: firmy v růstu / nízká ziskovost (buď konzervativní).</li>" +
          "<li><strong>Celkové FCF / Tržby</strong>: když zadáš celkové hodnoty, musíš dodat počet akcií.</li>" +
          "</ul>"
      },
      {
        h:"Důležité upozornění",
        b:
          "<p><strong>Nejde o investiční doporučení.</strong> Nástroj nepředpovídá trh. " +
          "Pomáhá jen testovat scénáře.</p>" +
          "<ul>" +
          "<li>Výsledek závisí hlavně na růstu a diskontu.</li>" +
          "<li>Kontroluj jednotky (na akcii vs celkem).</li>" +
          "<li>Používej bezpečnostní polštář.</li>" +
          "</ul>"
      }
    ]
  }
};

// ---------- Accordion: make all .acc heads clickable ----------
function bindAccordion(){
  document.querySelectorAll(".acc .head").forEach(h=>{
    if(h.__bound) return;
    h.__bound = true;
    h.addEventListener("click", ()=>{
      const acc = h.closest(".acc");
      if(!acc) return;
      acc.classList.toggle("open");
    });
  });
}

// ---------- Help icons: any element with [data-help] opens modal ----------
function bindHelpIcons(){
  document.querySelectorAll("[data-help]").forEach(el=>{
    if(el.__bound) return;
    el.__bound = true;
    el.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const key = el.getAttribute("data-help");
      const L = state.lang === "cz" ? "cz" : "en";
      const item = HELP[L][key];
      if(!item) return;
      openModal(item.t, `<div style="line-height:1.5">${item.b}</div>`);
    });
  });
}

// ---------- Inject / update Guide accordion content ----------
function renderGuide(){
  const L = state.lang === "cz" ? "cz" : "en";
  const g = GUIDE[L];

  $("ui_guideTitle") && ($("ui_guideTitle").textContent = g.title);
  $("ui_guideDesc")  && ($("ui_guideDesc").textContent  = g.desc);

  // These IDs should exist in your HTML accordion items:
  // ui_g1h ui_g1b ui_g2h ui_g2b ui_g3h ui_g3b
  if($("ui_g1h")) $("ui_g1h").textContent = g.sections[0].h;
  if($("ui_g1b")) $("ui_g1b").innerHTML   = g.sections[0].b;

  if($("ui_g2h")) $("ui_g2h").textContent = g.sections[1].h;
  if($("ui_g2b")) $("ui_g2b").innerHTML   = g.sections[1].b;

  if($("ui_g3h")) $("ui_g3h").textContent = g.sections[2].h;
  if($("ui_g3b")) $("ui_g3b").innerHTML   = g.sections[2].b;
}

// ---------- Make sure language switch triggers EVERYTHING ----------
const __applyLang2 = window.applyLang;
window.applyLang = function(){
  if(typeof __applyLang2 === "function") __applyLang2();
  renderGuide();
  bindHelpIcons();
  bindAccordion();
};

// ---------- boot ----------
bindAccordion();
bindHelpIcons();
renderGuide();

// ====================== PART 4 END ======================<script>
/* ===============================
   ACCORDION (3 drawers)
=============================== */
document.querySelectorAll(".acc .head").forEach(h => {
  h.addEventListener("click", () => {
    const acc = h.closest(".acc");
    acc.classList.toggle("open");
  });
});

/* ===============================
   STATE
=============================== */
const state = {
  lang: "en"
};

/* ===============================
   TRANSLATIONS
=============================== */
const I18N = {
  en: {
    title: "Equity Analyzer",
    subtitle: "Universal intrinsic value calculator",
    accCalc: "Valuation model",
    accWatch: "Watchlist",
    accGuide: "Guide & Disclaimer",
    calcBtn: "Calculate value",
    saveBtn: "Save to watchlist",
    guideText: `
      <p><strong>What this app is:</strong><br>
      Educational tool for estimating intrinsic value of stocks.</p>
      <p><strong>How it works:</strong><br>
      Uses discounted future cash/earnings per share with Bear / Base / Bull scenarios.</p>
      <p><strong>For whom:</strong><br>
      Long-term investors who want structured thinking.</p>
      <p><strong>Disclaimer:</strong><br>
      This is NOT financial advice.</p>
    `
  },
  cz: {
    title: "Equity Analyzer",
    subtitle: "Univerzální výpočet vnitřní hodnoty",
    accCalc: "Výpočet hodnoty",
    accWatch: "Watchlist",
    accGuide: "Průvodce & Upozornění",
    calcBtn: "Spočítat hodnotu",
    saveBtn: "Uložit do watchlistu",
    guideText: `
      <p><strong>Co je tato aplikace:</strong><br>
      Vzdělávací nástroj pro odhad vnitřní hodnoty akcií.</p>
      <p><strong>Jak funguje:</strong><br>
      Diskontuje budoucí hodnotu (EPS / FCF) ve scénářích Bear / Base / Bull.</p>
      <p><strong>Pro koho je:</strong><br>
      Pro dlouhodobé investory.</p>
      <p><strong>Upozornění:</strong><br>
      Nejedná se o investiční doporučení.</p>
    `
  }
};

/* ===============================
   APPLY LANGUAGE
=============================== */
function applyLang(){
  const T = I18N[state.lang];

  document.getElementById("appTitle").textContent = T.title;
  document.getElementById("appSub").textContent = T.subtitle;

  document.getElementById("acc_calc_title").textContent = T.accCalc;
  document.getElementById("acc_watch_title").textContent = T.accWatch;
  document.getElementById("acc_guide_title").textContent = T.accGuide;

  document.getElementById("btn_calc").textContent = T.calcBtn;
  document.getElementById("btn_save").textContent = T.saveBtn;

  document.getElementById("guideBody").innerHTML = T.guideText;
}

/* ===============================
   LANGUAGE SWITCH
=============================== */
document.getElementById("langSwitch").addEventListener("click", () => {
  state.lang = state.lang === "en" ? "cz" : "en";
  applyLang();
});

/* ===============================
   PLACEHOLDER CALCULATION
=============================== */
document.getElementById("btn_calc").addEventListener("click", () => {
  alert(state.lang === "cz"
    ? "Výpočet proběhl (logika se doplní)"
    : "Calculation done (logic will be expanded)"
  );
});

/* ===============================
   INIT
=============================== */
applyLang();
</script>

</body>
</html>



  
  

    
        




          

        

          





  

  

  


  


    


      

  

    

          
    

    

    
    


    





    

    

  
        

    
    

  

  





